--Maxscript
--rollout AutoExportTool_Pro ;æ‰¹é‡å¯¼å‡ºFBX/BipåŠ¨ä½œèµ„æº-Pro"//ä¸“ä¸šç‰ˆæ–‡ä»¶æµè§ˆå™¨/æ‰¹é‡å¤„ç†maxæ–‡ä»¶ï¼ˆFBXï¼›BIP--æ‰¹é‡å¯¼å‡ºå¯¼å…¥;ä¸€é”®æ¢çš®ï¼ˆæ‰¹é‡å¯¼å…¥ BIP ,xaf)

--@Author1: Bullet.S å­å¼¹ï¼ˆçµæ„Ÿä»¥åŠæ ¸å¿ƒä»£ç ï¼‰BsOpenTools ï¼ˆå‚è€ƒåŠŸèƒ½å¸ƒå±€è”åŠ¨æ€è·¯ï¼ŒUIåŠŸèƒ½æ¡†æ¶ç­‰ï¼‰ps :æ¨è å­å¼¹çš„ å·¥å…·é›† ï¼ˆé€‚åˆ åŠ¨ç”»å¸ˆ æ—¥å¸¸ æ ¸å¿ƒ K å¸§ ï¼‰
--@Author2: å¤©æ™´ / NDTools ï¼ˆçµæ„Ÿä»¥åŠæ ¸å¿ƒä»£ç ï¼‰æ‰¹é‡å¯¼å‡º_FBXåŠ¨ä½œèµ„æº_v3.0 ï¼ˆå‚è€ƒæ¡†æ¶ï¼‰

--@author3: å¶ç§‹ä¸¶zZ / AutoExportTool_Pro_V1.0 / Emailï¼š240811498@qq.com 
 --Last Design Time : 2025.08.24 / Designed By Fchen ;

-- å…¨å±€å˜é‡å®šä¹‰ ================================================================
-- å…¨å±€å‡½æ•°å®šä¹‰ï¼ˆæ”¾åœ¨ rollout å¤–éƒ¨..
--FBXExportTools_Config.iniï¼ˆå¸¸ç”¨è·¯å¾„-ç›®å½•/å†™å…¥ä¿å­˜è¯»å–--true--åŠŸèƒ½æµ‹è¯•OK-/2025.03
--FBXExportTools_UI.ini ï¼ˆåˆ—è¡¨é¢œè‰²è®¾ç½®ï¼Œå‹¾é€‰é¡¹çŠ¶æ€è®°å½•ï¼Œéƒ¨åˆ†UI çŠ¶æ€è®°å½• ----true--åŠŸèƒ½æµ‹è¯•OK-/2025.03
--RecentDocuments.xmlï¼ˆæœ€è¿‘æ‰“å¼€æ–‡ä»¶/å†™å…¥ä¿å­˜è¯»å–--true--åŠŸèƒ½æµ‹è¯•OK-/2025.03
--processSkinReplacement (æ ¸å¿ƒæ¢çš®åŠŸèƒ½å‡½æ•°;ä¸€é”®æ¢çš®)--true--åŠŸèƒ½æµ‹è¯•OK-/2025.05
--åˆ—è¡¨æ–‡ä»¶å¯ç¼–è¾‘æ€§åŠŸèƒ½ï¼šå³é”®é€‰ä¸­ORæ¡†é€‰å•ä¸ª/æ‰¹é‡åˆ é™¤ï¼Œå¤åˆ¶ï¼Œå‰ªåˆ‡ï¼Œç²˜è´´æ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹ï¼Œæ‰“å¼€/è¿è¡Œ/å¯¼å…¥ï¼ŒæŸ¥çœ‹æ–‡ä»¶å±æ€§ï¼ˆæ–‡ä»¶å¤¹ä¸æ”¯æŒæŸ¥çœ‹å±æ€§ï¼ï¼‰ ; ä¾¿æ·åŒå‡»æ‰“å¼€/å¯¼å…¥  å„ç§ æ ¼å¼çš„æ–‡ä»¶ç­‰..

--è¯¦ç»†æ ¸å¿ƒåŠŸèƒ½æ¦‚æ‹¬ä»¥åŠä½¿ç”¨è¯´æ˜ä¹¦-è§--ï¼ˆAutoExportTool.text or åŠŸèƒ½ä»‹ç»+ä½¿ç”¨è¯´æ˜ï¼‰https://ladyicefox.github.io/autoexporttool-docs/  ï¼ˆå¸¸ç”¨æ’ä»¶-ä¸ªäººè§‰å¾—æ— éœ€çœ‹è¯´æ˜ä¹¦...ï¼‰

----------------------------------------------------------------
-- ===================== æ–°å¢åŠŸèƒ½æ¨¡å— ===========================
----------------------------------------------------------------
--ç‹¬ç«‹å‡½æ•°å¿…é¡»å£°æ˜ä¸ºå…¨å±€ï¼›å±€éƒ¨å‡½æ•°æ”¾åœ¨ rollout å†…éƒ¨ï¼ˆç›¸åŒçš„å‡½æ•°ä¸€èˆ¬å…ˆæ‰§è¡Œå±€éƒ¨çš„å‡½æ•°ï¼‰å…¨å±€å‡½æ•°è¯­æ³•ä¾‹å­ï¼šglobal xxx = fn xxx = (...
----------------------------------------------------------------
----------------------------------------------------------------

--å¼€å‘è€…æ—¥å¿—ï¼š-- false (æ²‰æ·€ä»£ç /å¤‡ç”¨)
--global g_debugMode = true  -- åœ¨å…¨å±€å˜é‡åŒºåŸŸæ·»åŠ 
--fn logDebug msg = (
    --if g_debugMode do (
        --format "DEBUG: %\n" msg
        --flushListener()
    --)
--)
--ç‰ˆæœ¬è®°å½• V1.0;V1.01ï¼›V1.02 ,V1.02-1/ V1.03ï¼›V1.03-1 ï¼›V1.04..V1.04-1 ;V1.05,V1.05-1ï¼›V1.06ï¼ŒV1.06-1ï¼›V1.07ï¼ŒV1.07-1ï¼›V1.08 ï¼› V1.09 ï¼›V1.10
-- ===== åœ¨è„šæœ¬å¼€å¤´å®šä¹‰å…¨å±€å˜é‡ =====
-- åˆå§‹åŒ–ç®¡ç†å™¨//FBXå±æ€§åˆå§‹åŒ–-------------------------------------
FbxExporterSetParam "ResetExport"         -- é‡ç½®FBXå¯¼å‡ºè®¾ç½®
----------------------------------------------------------------
-- å…¨å±€å˜é‡å®šä¹‰ / æ‰¹é‡åˆå¹¶åˆ—è¡¨çš„å…¬å…±æŒ‚ç‚¹æ–‡ä»¶ ç›®æ ‡ åˆ° åˆ—è¡¨çš„ æ‰€æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹å†…çš„æ‰€æœ‰æ–‡ä»¶ï¼Œåˆå¹¶æ–‡ä»¶å†…æ‰€æœ‰ä»¥åŠé€‰æ‹©é›†ï¼ŒæŒ‚ç‚¹å„è‡ªå¯¹é½é“¾æ¥åˆ°å¯¹åº”çš„ç›®æ ‡éª¨éª¼å¹¶ä¿å­˜æ–°æ–‡ä»¶è¦†ç›–åˆ°ç›®æ ‡æ–‡ä»¶å¤¹
----------------------------------------------------------------AutoExportTool_Pro.
-- ç‰ˆæœ¬ä¿¡æ¯ / çƒ­æ›´æ­£å¼ç‰ˆæœ¬ AutoExportTool_Pro / å…¨å±€

global g_currentVersion = "1.09"
global g_latestVersion = g_currentVersion
global g_updateAvailable = false 
global g_autoCheckUpdate = false -- é»˜è®¤å…³é—­è‡ªåŠ¨æ£€æŸ¥ï¼Œé¿å…å¯åŠ¨å¡é¡¿

-- ç›´æ¥è·å–ç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰
global getVersionInfoDirect = fn getVersionInfoDirect = (
    try (
        -- ç›´æ¥ä»å›ºå®šæ ¼å¼çš„ URL è·å–æœ€æ–°ç‰ˆæœ¬
        local latestVersion = "1.09" -- ç¡¬ç¼–ç æœ€æ–°ç‰ˆæœ¬å·
        
        -- æ„å»ºä¸‹è½½ URL
        local downloadUrl = "https://github.com/ladyicefox/AutoExportTool-Releases/releases/download/v" + 
                           latestVersion + "/AutoExportTool_Pro_V" + latestVersion + ".ms"
        
        -- æ„å»ºæ›´æ–°è¯´æ˜
        local changelog = "ç‰ˆæœ¬ " + latestVersion + " æ›´æ–°è¯´æ˜\n" +
                         "======================\n\n" +
                         "æ›´æ–°å†…å®¹:\n" +
                         "- ä¿®å¤äº†å·²çŸ¥é—®é¢˜\n" +
                         "- ä¼˜åŒ–äº†æ€§èƒ½\n" +
                         "- æ›´æ–°äº†ç”¨æˆ·ç•Œé¢"
        
        return #(latestVersion, downloadUrl, changelog)
    )
    catch (
        format "[ç›´æ¥è·å–é”™è¯¯] %\n" (getCurrentException())
    )
    undefined
)

-- å¤„ç†ç‰ˆæœ¬ä¿¡æ¯ / çƒ­æ›´ / ç‰ˆæœ¬æ£€æµ‹
global processVersionInfo = fn processVersionInfo versionInfo silent:false = (
    local latestVersion = versionInfo[1]
    local downloadUrl = versionInfo[2]
    local changelog = versionInfo[3]
    
    g_latestVersion = latestVersion
    
    -- ç®€å•ç‰ˆæœ¬æ¯”è¾ƒ
    fn compareVersions v1 v2 = (
        local v1Parts = filterString v1 "."
        local v2Parts = filterString v2 "."
        
        for i = 1 to (amax v1Parts.count v2Parts.count) do (
            local part1 = if i <= v1Parts.count then (execute v1Parts[i]) else 0
            local part2 = if i <= v2Parts.count then (execute v2Parts[i]) else 0
            
            if part2 > part1 do return true
            if part2 < part1 do return false
        )
        false
    )
    
    g_updateAvailable = compareVersions g_currentVersion latestVersion
    
    -- æ›´æ–°èœå•é¡¹æ–‡æœ¬
    local updateText = if g_updateAvailable then "ğŸ”„ æ£€æµ‹æ›´æ–° NEWâ— |ã€CheckUpdateã€‘" else "ğŸ”„ æ£€æµ‹æ›´æ–° |ã€CheckUpdateã€‘"
    
    if g_updateAvailable and not silent do (
        local msg = "å½“å‰ç‰ˆæœ¬: v" + g_currentVersion + "\næœ€æ–°ç‰ˆæœ¬: v" + latestVersion
        
        if changelog != "" and changelog != undefined do (
            msg += "\n\næ›´æ–°å†…å®¹:\n" + changelog
        )
        
        msg += "\n\næ˜¯å¦è¦æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Ÿ"
        
        local result = queryBox msg title:"å‘ç°æ–°ç‰ˆæœ¬"
        if result do (
            -- æ‰§è¡Œæ›´æ–°
            downloadAndUpdate downloadUrl
        )
    )
    
    if not g_updateAvailable and not silent do (
        messageBox "å½“å‰å·²ç»æ˜¯æœ€æ–°ç‰ˆæœ¬ã€‚" title:"æ›´æ–°æ£€æŸ¥"
    )
    
    -- è¿”å›æ›´æ–°çŠ¶æ€
    g_updateAvailable
)

-- ä¸‹è½½å¹¶æ›´æ–°æ’ä»¶ / çƒ­æ›´ / ç‰ˆæœ¬æ£€æµ‹
global downloadAndUpdate = fn downloadAndUpdate downloadUrl = (
    try (
        -- åˆ›å»ºå¤‡ä»½ç›®å½•
        local backupDir = (getDir #userScripts) + "\\AutoExportTool_Backup\\"
        makeDir backupDir all:true
        
        -- å¤‡ä»½å½“å‰ç‰ˆæœ¬
        local currentScript = getSourceFileName()
        local backupFile = backupDir + "AutoExportTool_Pro_V" + g_currentVersion + ".ms"
        copyFile currentScript backupFile
        
        -- ä¸‹è½½æ–°ç‰ˆæœ¬
        local webClient = dotNetObject "System.Net.WebClient"
        local tempFile = (getDir #temp) + "\\AutoExportTool_Pro_V" + g_latestVersion + ".ms"
        
        -- æ˜¾ç¤ºä¸‹è½½è¿›åº¦
        format "[ä¸‹è½½] å¼€å§‹ä¸‹è½½æ–°ç‰ˆæœ¬: %\n" downloadUrl
        webClient.DownloadFile downloadUrl tempFile
        
        -- éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
        if doesFileExist tempFile and (getFileSize tempFile) > 0 then (
            format "[ä¸‹è½½] æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼Œå¤§å°: % å­—èŠ‚\n" (getFileSize tempFile)
            
            -- å…³é—­å½“å‰å¯¹è¯æ¡†
            try (
                if (isDialogVisible AutoExportTool_Pro) do (
                    destroyDialog AutoExportTool_Pro
                )
            ) catch ()
            
            -- æ›¿æ¢å½“å‰æ–‡ä»¶
            deleteFile currentScript
            copyFile tempFile currentScript
            
            -- æ›´æ–°è‡ªå¯åŠ¨è„šæœ¬ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if g_autoStartEnabled do (
                local startupScripts = getDir #userStartupScripts
                local scriptPath = startupScripts + "\\AutoExportTool_Pro_AutoStart.ms"
                
                if doesFileExist scriptPath do (
                    deleteFile scriptPath
                )
                
                -- åˆ›å»ºæ–°çš„è‡ªå¯åŠ¨è„šæœ¬
                local loadCmd = "fileIn @\"" + currentScript + "\""
                local autoStartScript = 
                    "global g_autoStartPluginLoaded = true\n" +
                    "try ( \n" + 
                    "   " + loadCmd + " \n" + 
                    "   if (isDialogVisible AutoExportTool_Pro) do (destroyDialog AutoExportTool_Pro) \n" +
                    "   createDialog AutoExportTool_Pro \n" +
                    ") catch ( \n" +
                    "   format \"[æ’ä»¶åŠ è½½å¤±è´¥] %\\\\n\" (getCurrentException()) \n" +
                    ")"
                
                local f = createFile scriptPath
                format "%\n" autoStartScript to:f
                close f
            )
            
            -- é‡æ–°åŠ è½½æ’ä»¶
            fileIn currentScript
            createDialog AutoExportTool_Pro
            
            messageBox "æ›´æ–°æˆåŠŸï¼å·²æ›´æ–°åˆ° v" + g_latestVersion title:"æ›´æ–°å®Œæˆ"
            return true
        )
        else (
            messageBox "ä¸‹è½½çš„æ–‡ä»¶æ— æ•ˆï¼Œæ›´æ–°å¤±è´¥ã€‚" title:"æ›´æ–°é”™è¯¯"
            return false
        )
    )
    catch (
        format "[æ›´æ–°é”™è¯¯] %\n" (getCurrentException())
        messageBox "æ›´æ–°è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: " + (getCurrentException()) title:"æ›´æ–°é”™è¯¯"
        return false
    )
)

-- ç®€åŒ–ç‰ˆæœ¬æ£€æµ‹å‡½æ•° / çƒ­æ›´ / ç‰ˆæœ¬æ£€æµ‹
global checkForUpdates = fn checkForUpdates silent:false = (
    try (
        format "[ç‰ˆæœ¬æ£€æŸ¥] å¼€å§‹æ£€æŸ¥æ›´æ–°...\n"
        
        -- ä½¿ç”¨ç›´æ¥è·å–ç‰ˆæœ¬ä¿¡æ¯çš„æ–¹æ³•
        format "[ç‰ˆæœ¬æ£€æŸ¥] ä½¿ç”¨ç›´æ¥è·å–æ–¹æ³•\n"
        local versionInfo = getVersionInfoDirect()
        
        if versionInfo != undefined do (
            format "[ç‰ˆæœ¬æ£€æŸ¥] è·å–åˆ°ç‰ˆæœ¬ä¿¡æ¯: %\n" versionInfo
            -- æ¯”è¾ƒç‰ˆæœ¬å¹¶æç¤ºæ›´æ–°
            return processVersionInfo versionInfo silent:silent
        )
        
        if versionInfo == undefined and not silent do (
            format "[ç‰ˆæœ¬æ£€æŸ¥] æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯\n"
            messageBox "æ— æ³•æ£€æŸ¥æ›´æ–°ï¼Œè¯·ç¨åé‡è¯•ã€‚" title:"æ›´æ–°é”™è¯¯"
        )
    )
    catch (
        if not silent do (
            format "[ç‰ˆæœ¬æ£€æŸ¥é”™è¯¯] %\n" (getCurrentException())
            messageBox "æ£€æŸ¥æ›´æ–°æ—¶å‘ç”Ÿé”™è¯¯: " + (getCurrentException()) title:"æ›´æ–°é”™è¯¯"
        )
    )
    
    false
)

-- æ·»åŠ ç‰ˆæœ¬ç¼“å­˜åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
global g_versionCacheFile = (getDir #temp) + "\\AutoExportTool_VersionCache.txt"
global g_versionCacheTime = 24 * 60 * 60 * 1000 -- 24å°æ—¶ç¼“å­˜

global getCachedVersionInfo = fn getCachedVersionInfo = (
    if doesFileExist g_versionCacheFile and ((getFileModDate g_versionCacheFile) + g_versionCacheTime > currentTime) then (
        try (
            local f = openFile g_versionCacheFile
            local versionInfo = readValue f
            close f
            return versionInfo
        )
        catch (
            format "[ç¼“å­˜è¯»å–é”™è¯¯] %\n" (getCurrentException())
        )
    )
    undefined
)

global cacheVersionInfo = fn cacheVersionInfo versionInfo = (
    try (
        local f = createFile g_versionCacheFile
        writeValue versionInfo to:f
        close f
    )
    catch (
        format "[ç¼“å­˜å†™å…¥é”™è¯¯] %\n" (getCurrentException())
    )
)

-- å¢å¼ºç‰ˆæœ¬æ£€æµ‹å‡½æ•°ï¼ˆå¸¦ç¼“å­˜ï¼‰
global checkForUpdatesEnhanced = fn checkForUpdatesEnhanced silent:false = (
    try (
        format "[ç‰ˆæœ¬æ£€æŸ¥] å¼€å§‹æ£€æŸ¥æ›´æ–°ï¼ˆå¢å¼ºç‰ˆï¼‰...\n"
        
        -- é¦–å…ˆå°è¯•ä»ç¼“å­˜è·å–
        local versionInfo = getCachedVersionInfo()
        
        if versionInfo == undefined then (
            -- ç¼“å­˜ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸï¼Œä½¿ç”¨ç›´æ¥è·å–æ–¹æ³•
            format "[ç‰ˆæœ¬æ£€æŸ¥] ç¼“å­˜æœªå‘½ä¸­ï¼Œä½¿ç”¨ç›´æ¥è·å–æ–¹æ³•\n"
            versionInfo = getVersionInfoDirect()
            
            -- ç¼“å­˜ç»“æœ
            if versionInfo != undefined do (
                cacheVersionInfo versionInfo
            )
        )
        else (
            format "[ç‰ˆæœ¬æ£€æŸ¥] ä½¿ç”¨ç¼“å­˜ç‰ˆæœ¬ä¿¡æ¯\n"
        )
        
        if versionInfo != undefined do (
            format "[ç‰ˆæœ¬æ£€æŸ¥] è·å–åˆ°ç‰ˆæœ¬ä¿¡æ¯: %\n" versionInfo
            -- æ¯”è¾ƒç‰ˆæœ¬å¹¶æç¤ºæ›´æ–°
            return processVersionInfo versionInfo silent:silent
        )
        
        if versionInfo == undefined and not silent do (
            format "[ç‰ˆæœ¬æ£€æŸ¥] æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯\n"
            messageBox "æ— æ³•æ£€æŸ¥æ›´æ–°ï¼Œè¯·ç¨åé‡è¯•ã€‚" title:"æ›´æ–°é”™è¯¯"
        )
    )
    catch (
        if not silent do (
            format "[ç‰ˆæœ¬æ£€æŸ¥é”™è¯¯] %\n" (getCurrentException())
            messageBox "æ£€æŸ¥æ›´æ–°æ—¶å‘ç”Ÿé”™è¯¯: " + (getCurrentException()) title:"æ›´æ–°é”™è¯¯"
        )
    )
    
    false
)

-- åˆå§‹åŒ–æ—¶ä¸è‡ªåŠ¨æ£€æŸ¥æ›´æ–°ï¼Œé¿å…å¡é¡¿
-- ç”¨æˆ·å¯ä»¥é€šè¿‡èœå•æ‰‹åŠ¨æ£€æŸ¥æ›´æ–°

-- å…¨å±€å‡½æ•°ï¼šé«˜äº®æ˜¾ç¤ºå½“å‰æ‰“å¼€çš„æ–‡ä»¶ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
global highlightCurrentFile = fn highlightCurrentFile = (
    try (
        if AutoExportTool_Pro.Lv_model != undefined and not AutoExportTool_Pro.Lv_model.IsDisposed do (
            -- æ¸…é™¤æ‰€æœ‰ç°æœ‰é«˜äº®
            for i = 0 to (AutoExportTool_Pro.Lv_model.Items.Count - 1) do (
                local item = AutoExportTool_Pro.Lv_model.Items.Item[i]
                item.BackColor = AutoExportTool_Pro.Lv_model.BackColor  -- æ¢å¤é»˜è®¤èƒŒæ™¯è‰²
            )
            
            -- è·å–å½“å‰æ‰“å¼€çš„æ–‡ä»¶å
            local currentFileName = maxFileName
            if currentFileName != undefined and currentFileName != "" do (
                -- åœ¨åˆ—è¡¨ä¸­æŸ¥æ‰¾å½“å‰æ–‡ä»¶
                for i = 0 to (AutoExportTool_Pro.Lv_model.Items.Count - 1) do (
                    local item = AutoExportTool_Pro.Lv_model.Items.Item[i]
                    local itemPath = item.Tag as String
                    
                    -- æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡ä»¶ï¼ˆä¸æ˜¯æ–‡ä»¶å¤¹ï¼‰å¹¶ä¸”æ–‡ä»¶ååŒ¹é…
                    if not (matchPattern itemPath pattern:"*[DIR]*") and (filenameFromPath itemPath) == currentFileName do (
                        -- é€‰ä¸­è¯¥é¡¹
                        item.Selected = true
                        item.Focused = true
                        
                        -- ç¡®ä¿è¯¥é¡¹å¯è§ï¼ˆæ»šåŠ¨åˆ°è§†å›¾ï¼‰
                        item.EnsureVisible()
                        
                        -- è®¾ç½®é«˜äº®é¢œè‰²
                        item.BackColor = (dotNetClass "System.Drawing.Color").FromArgb 70 130 180 -- é’¢è“è‰²
                        
                        format "[è‡ªåŠ¨é«˜äº®] å½“å‰æ–‡ä»¶: %\n" currentFileName
                        exit -- æ‰¾åˆ°åé€€å‡ºå¾ªç¯
                    )
                )
            )
        )
    )
    catch (
        format "[é«˜äº®é”™è¯¯] %\n" (getCurrentException())
    )
)

-- åˆ›å»ºæ–‡ä»¶æ‰“å¼€å›è°ƒå‡½æ•°ï¼Œåœ¨æ–‡ä»¶æ‰“å¼€åè‡ªåŠ¨æ›´æ–°é’¢å°
global setupFileOpenCallback = fn setupFileOpenCallback = (
    -- ä¿å­˜åŸå§‹çš„æ–‡ä»¶æ‰“å¼€å‡½æ•°
    global originalFileOpen = fileOpen
    
    -- é‡å†™æ–‡ä»¶æ‰“å¼€å‡½æ•°
    fn newFileOpen filename useFileUnits:false quiet:false = (
        local result = originalFileOpen filename useFileUnits:useFileUnits quiet:quiet
        
        -- æ–‡ä»¶æ‰“å¼€åï¼Œå»¶è¿Ÿä¸€æ®µæ—¶é—´ç„¶åæ›´æ–°é’¢å°
        if result do (
            dotNet.invokeMethod (dotNetClass "System.Threading.Thread") "Sleep" 300
            highlightCurrentFile()
        )
        
        return result
    )
    
    -- æ›¿æ¢åŸå§‹å‡½æ•°
    fileOpen = newFileOpen
)

----------------------------------------------------------------
-- å…¨å±€å˜é‡ï¼šå­˜å‚¨åˆå¹¶æ–‡ä»¶è·¯å¾„
global g_mergeFilePath = undefined

-- ç»“æ„ä½“ï¼šå­˜å‚¨æŒ‚ç‚¹å¯¹é½ä¿¡æ¯
struct SocketAlignmentInfo (
    socketNode,
    targetBone,
    originalTransform,
    originalParent
)
----------------------------------------------------------------
--å…¨å±€å˜é‡å£°æ˜ / å¸¸ç”¨ç›®å½•è‡ªåŠ¨å¡«å……ç›¸å…³ 
global g_tempPathForManager = ""
global g_pathManagerDialogOpen = false
----------------------------------------------------------------
-- åœ¨å…¨å±€å˜é‡åŒºåŸŸæ·»åŠ è§’è‰²æ˜ å°„è¡¨ / å¯¼å‡ºåˆ°å¼•æ“ / å¤‡ç”¨ / æ²‰æ·€ä»£ç  ï¼ˆ å½“å‰ç‰ˆæœ¬V1.0 å®é™… ä¸ç”¨ ï¼‰
struct CharacterMapping (name, dir)
global g_characterMappings = #()  -- å­˜å‚¨ #(localName, engineName) çš„æ•°ç»„
global g_characterMappingPath = (getDir #plugcfg) + "\\CharacterMappings.ini"
global g_engineProjectPath = ""
global g_exportToEngine = false
----------------------------------------------------------------
-- åŠ è½½è§’è‰²æ˜ å°„
global loadCharacterMappings = fn loadCharacterMappings = (
    g_characterMappings = #()
    if doesFileExist g_characterMappingPath do (
        local count = getINISetting g_characterMappingPath "Mappings" "Count" as integer
        for i = 1 to count do (
            local name = getINISetting g_characterMappingPath ("Mapping" + i as string) "Local"
            local dir = getINISetting g_characterMappingPath ("Mapping" + i as string) "Engine"
            if name != "" and dir != "" do (
                append g_characterMappings (CharacterMapping name:name dir:dir)
            )
        )
    )
)
----------------------------------------------------------------
-- åœ¨å…¨å±€åŒºåŸŸæ·»åŠ å¤‡ä»½è·¯å¾„å˜é‡
global g_pluginPath = getSourceFileName()  -- è‡ªåŠ¨è·å–å½“å‰è„šæœ¬è·¯å¾„
global g_backupPluginPath = (getDir #userScripts) + "\\AutoExportTool_Backup\\" + filenameFromPath g_pluginPath + getFilenameType g_pluginPath
global g_backupPluginPath1 = (getDir #userScripts) 
global g_autoStartEnabled = false
------------------------------------------------------------
-- æ’ä»¶çª—å£çš„æ‹–åŠ¨åŠŸèƒ½ / åŠŸèƒ½æµ‹è¯• = true
-- ====== å…¨å±€å˜é‡ ======
global g_dragging = false
global g_dragStartPos = [0,0]
global g_windowStartPos = [0,0]
----------------------------------------------------------------
-- æ–°å¢å…¨å±€å˜é‡ / åŠŸèƒ½æµ‹è¯• = true
global g_clipboard = #()  -- å­˜å‚¨å¤åˆ¶çš„æ–‡ä»¶/æ–‡ä»¶å¤¹è·¯å¾„
global g_clipboardType = "copy" -- "copy" æˆ– "cut" = å¤åˆ¶çŠ¶æ€ *2
global g_autoStartEnabled = false  -- æ˜¯å¦éš3ds Maxè‡ªå¯
global g_toolbarAdded = false  -- å·¥å…·æ æ˜¯å¦å·²æ·»åŠ 

--å·¦é”®å•å‡»è§¦å‘é‡å‘½å
global g_lastClickItem = undefined   -- ç‚¹å‡»åˆ—è¡¨æ–‡ä»¶/æ“ä½œé¡¹
global g_lastClickTime = 0            -- ç‚¹å‡»åˆ—è¡¨æ–‡ä»¶/æ—¶é—´é¡¹

----------------------------------------------------------------
-- å…¨å±€å˜é‡å­˜å‚¨ç¼–è¾‘çŠ¶æ€
global g_editingItem = undefined      -- å³é”®æ–‡ä»¶ / èœå• é‡å‘½å ï¼ˆåŸåœ°ç¼–è¾‘åˆ—è¡¨æ–‡ä»¶+æ–‡ä»¶å¤¹ï¼‰
global g_editTextBox = undefined        -- å³é”®æ–‡ä»¶ / èœå• é‡å‘½å ï¼ˆåŸåœ°ç¼–è¾‘æ·»åŠ +ç¼–è¾‘æ¡†/åˆ—è¡¨æ–‡ä»¶+æ–‡ä»¶å¤¹ï¼‰
global g_UIConfigPath = (getDir #plugcfg) + "\\AutoExportTool_Pro.ini"
-- åˆå§‹åŒ–æ—¶è¯»å–è‡ªå¯çŠ¶æ€/åˆå§‹åŒ– è¯»å– è®°å½• è‡ªå¯ èœå• å‹¾é€‰ / æŒä¹…åŒ– è®¾å®š / åŠŸèƒ½æµ‹è¯• = true
global initAutoStartSetting = fn initAutoStartSetting = (
    g_autoStartEnabled = (getINISetting g_UIConfigPath "Settings" "AutoStart") == "true"
)

-- åˆå§‹åŒ–å·¥å…·æ çŠ¶æ€
global initToolbarSetting = fn initToolbarSetting = (
    try (
        local setting = getINISetting g_UIConfigPath "Settings" "ToolbarAdded"
        if setting == "" then (
            setINISetting g_UIConfigPath "Settings" "ToolbarAdded" "false"
            g_toolbarAdded = false
        ) else (
            g_toolbarAdded = setting == "true"
        )
    )
    catch (
        format "[å·¥å…·æ è®¾ç½®åˆå§‹åŒ–é”™è¯¯] %\n" (getCurrentException())
        g_toolbarAdded = false
    )
)
-- å·¥å…·æ -å¸è½½å‡½æ•° / å¤‡ç”¨1
global removeToolbarFromMax1 = fn removeToolbarFromMax1 = (
    try (
        local mainMenu = menuMan.getMainMenuBar()
        local subMenu = menuMan.findMenu "AutoExportTool"
        
        if subMenu != undefined do (
            menuMan.unRegisterMenu subMenu
            menuMan.updateMenuBar()
            g_toolbarAdded = false
            setINISetting g_UIConfigPath "Settings" "ToolbarAdded" "false"
            messageBox "å·¥å…·æ å·²æˆåŠŸç§»é™¤" title:"æˆåŠŸ"
        )
      -- æ›´æ–°å·¥å…·æ çŠ¶æ€
        g_toolbarAdded = false
        setINISetting g_UIConfigPath "Settings" "ToolbarAdded" "false"
    ) catch (
        format "[å·¥å…·æ ç§»é™¤é”™è¯¯] %\n" (getCurrentException())
        messageBox ("å·¥å…·æ ç§»é™¤å¤±è´¥: " + (getCurrentException())) title:"é”™è¯¯"
    )
)
-- å·¥å…·æ -å¸è½½å‡½æ•° / å¤–éƒ¨ èœå• æ  å·¥å…·å®  
global removeToolbarFromMax = fn removeToolbarFromMax = (
    try (
        local mainMenu = menuMan.getMainMenuBar()
        local subMenu = menuMan.findMenu "AutoExportTool"
        
        if subMenu != undefined do (
            menuMan.unRegisterMenu subMenu
            menuMan.updateMenuBar()
            messageBox "å·¥å…·æ å·²æˆåŠŸç§»é™¤" title:"æˆåŠŸ"
        )
      
        -- æ›´æ–°å·¥å…·æ çŠ¶æ€
        g_toolbarAdded = false
        setINISetting g_UIConfigPath "Settings" "ToolbarAdded" "false"
        
        -- åŒæ—¶ç§»é™¤è‡ªå¯åŠ¨è„šæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        local startupScripts = getDir #userStartupScripts
        local scriptPath = startupScripts + "\\AutoExportTool_Pro_AutoStart.ms"
        if doesFileExist scriptPath do (
            deleteFile scriptPath
            format "[è‡ªå¯è„šæœ¬] å·²ç§»é™¤: %\n" scriptPath
        )
    ) catch (
        format "[å·¥å…·æ ç§»é™¤é”™è¯¯] %\n" (getCurrentException())
        messageBox ("å·¥å…·æ ç§»é™¤å¤±è´¥: " + (getCurrentException())) title:"é”™è¯¯"
    )
)

--å·¥å…·æ -è‡ªå¯è·Ÿéš MAX / å¤–éƒ¨ èœå• æ  å·¥å…·å® + å†…éƒ¨Roullout
global toggleAutoStart = fn toggleAutoStart = (
    g_autoStartEnabled = not g_autoStartEnabled
    setINISetting g_UIConfigPath "Settings" "AutoStart" (g_autoStartEnabled as string)
    
    local startupScripts = getDir #userStartupScripts
    local scriptPath = startupScripts + "\\AutoExportTool_Pro_AutoStart.ms"
    
    if g_autoStartEnabled then (
        AutoExportTool_Pro.addToolbarToMax()
        -- åˆ›å»ºè‡ªå¯è„šæœ¬
        local loadCmd = "fileIn @\"" + g_pluginPath + "\""
        
        local autoStartScript = 
            "global g_autoStartPluginLoaded = true\n" +
            "try ( \n" + 
            "   " + loadCmd + " \n" + 
            "   if (isDialogVisible AutoExportTool_Pro) do (destroyDialog AutoExportTool_Pro) \n" +
            "   createDialog AutoExportTool_Pro \n" +
            ") catch ( \n" +
            "   format \"[æ’ä»¶åŠ è½½å¤±è´¥] %\\\\n\" (getCurrentException()) \n" +
            ")"
        
        try (
            local f = createFile scriptPath
            format "%\n" autoStartScript to:f
            close f
            format "[è‡ªå¯è„šæœ¬] å·²åˆ›å»º: %\n" scriptPath
        ) catch (
            format "[è‡ªå¯è„šæœ¬åˆ›å»ºå¤±è´¥] %\n" (getCurrentException())
        )
    ) else (
        -- åªç¦ç”¨è‡ªå¯ä½†ä¸åˆ é™¤æ–‡ä»¶ï¼Œä¿æŒå·¥å…·æ å¯ç”¨ 
        try (
            removeToolbarFromMax1()
            g_toolbarAdded = false
           -- ä¸åˆ é™¤è‡ªå¯åŠ¨è„šæœ¬ï¼Œè€Œæ˜¯ä¿®æ”¹å…¶å†…å®¹ä¸ºç¦ç”¨çŠ¶æ€
            local disableScript = 
                "-- è‡ªå¯åŠŸèƒ½å·²ç¦ç”¨\n" +
                "-- å¦‚éœ€é‡æ–°å¯ç”¨ï¼Œè¯·ä½¿ç”¨AutoExportToolæ’ä»¶è®¾ç½®\n" +
                "format \"AutoExportToolè‡ªå¯åŠŸèƒ½å½“å‰å·²ç¦ç”¨\\n\"\n" +
                "-- ä½†ä»ç„¶ä¿ç•™å·¥å…·æ åŠŸèƒ½\n" +
                "try (\n" +
                "   fileIn (getDir #userScripts + \"\\\\AutoExportTool_Backup\\\\\" + (getFiles (getDir #userScripts + \"\\\\AutoExportTool_Backup\\\\AutoExportTool_Pro*.ms\"))[1])\n" +
                "   if not (isDialogVisible AutoExportTool_Pro) do createDialog AutoExportTool_Pro\n" +
                ") catch (\n" +
                "   format \"[å·¥å…·æ åŠ è½½å¤±è´¥] %\\\\n\" (getCurrentException())\n" +
                ")"
            
            local f = createFile scriptPath
            
            format "%\n" disableScript to:f
            close f
            format "[è‡ªå¯è„šæœ¬] å·²ç¦ç”¨ä½†å·¥å…·æ ä¿æŒå¯ç”¨\n"
        ) catch (
            format "[è‡ªå¯è„šæœ¬ç¦ç”¨å¤±è´¥] %\n" (getCurrentException())
        )
    )
    
    -- æ›´æ–°çŠ¶æ€
    if (isKindOf AutoExportTool_Pro rolloutClass) and (isDialogVisible AutoExportTool_Pro) do (
        g_lastAction = "è‡ªå¯è®¾ç½®: " + (if g_autoStartEnabled then "å¼€å¯" else "å…³é—­")
        AutoExportTool_Pro.updateModeStatus()
    )
)

-- å¸®åŠ©èœå•åŠŸèƒ½/åŠŸèƒ½æµ‹è¯•OK- true( å¯¹æ¥ å¤–éƒ¨å®èœå•/å·¥å…·æ é“¾æ¥ ï¼Œéœ€è®¾å®šä¸ºå…¨å±€å‡½æ•°ï¼ï¼ï¼)
global openHelpLink = fn openHelpLink url = (
    try (
        if url == undefined or url == "" then (
            messageBox "é“¾æ¥æœªè®¾ç½®" title:"æç¤º"
        ) else (
            shellLaunch "explorer.exe" url
        )
    ) catch (
        format "[é“¾æ¥æ‰“å¼€é”™è¯¯] %\n" (getCurrentException())
    )
)

-- ===================== MAX  æ–‡ä»¶æ•´ç†æ¨¡å— =====================
-- æ–‡ä»¶å½’æ¡£//åœ¨å…¨å±€ç»“æ„ä½“å®šä¹‰åŒºåŸŸæ·»åŠ 
struct FileGroup (
    baseName,      -- åŸºç¡€æ–‡ä»¶åï¼ˆä¸å«ç‰ˆæœ¬æ ‡è¯†ï¼‰
    originalFile,  -- åŸå§‹æ–‡ä»¶ï¼ˆæ— æ•°å­—åç¼€ï¼‰
    latestFile,    -- æœ€æ–°ç‰ˆæœ¬æ–‡ä»¶
    maxNumber      -- æœ€å¤§ç‰ˆæœ¬å·
)
----------------------------------------------------------------
--æ·»åŠ å…¨å±€å˜é‡è®°å½•æœ€åæ“ä½œ ----------------------------------------
global g_lastAction = "ğŸ¦¾å¾…å‘½âŒ˜ğŸ’¤"
----------------------------------------------------------------
-- åœ¨å…¨å±€å˜é‡åŒºåŸŸ//ä¸€é”®æ¢çš®-æ–‡ä»¶è½¬å­˜è·¯å¾„/æ–‡ä»¶å¤¹åˆ›å»ºåç§°..
-- å…¨å±€å˜é‡è®°å½•æ’ä»¶è·¯å¾„
global g_pluginPath = getSourceFileName()  -- è‡ªåŠ¨è·å–å½“å‰è„šæœ¬è·¯å¾„
global g_skinExportPath = ""
global g_skinNewFolderName = "SkinReplace_Output"  --  ä¸€é”®æ¢çš®å‚¨å­˜ // æ–‡ä»¶å¤¹ / åç§° 
global g_rotationMode = #tcb  -- #tcbæˆ–#euler
global g_useCustomRotation = false
global g_excludePrefix = "v_"  -- æ’é™¤å‰ç¼€
----------------------------------------------------------------
-- é…ç½®æ–‡ä»¶è·¯å¾„/BIP æ‰¹é‡å¯¼å…¥ï¼ˆé€šç”¨è¿›åº¦æ¡æ›´æ–°ï¼‰
global g_currentBipProgress = 0
-- è¿›åº¦å®šæ—¶å™¨ï¼ˆä¿æŒä¸å…¶ä»–æ¨¡å—ä¸€è‡´ï¼‰ -- æ²‰æ·€å‡½æ•° -false (ä¸€èˆ¬false è¡¨ç¤º å¯èƒ½æ²¡æœ‰å¼•ç”¨ æˆ–è€… æ²‰æ·€å‡½æ•° ä½œå¤‡ç”¨,or åŠŸèƒ½æœªå®ç°)
global g_bipProgressTimer = dotNetObject "System.Windows.Forms.Timer"
g_bipProgressTimer.Interval = 500
dotNet.addEventHandler g_bipProgressTimer "Tick" (
    fn updateBipProgress = (
        if g_currentBipProgress > 0 and g_currentBipProgress < 100 do (
            pbProgress.value = g_currentBipProgress
            lblProgressInfo.text += "."
            if lblProgressInfo.text.count > 50 do lblProgressInfo.text = substring lblProgressInfo.text 1 50
        )
    )
)

-- ç‰ˆæœ¬å…¼å®¹çš„Bipedåˆ›å»ºï¼ˆæ‰©å±•ç‰ˆï¼‰
global createCompatibleBiped = fn createCompatibleBiped = (
    case (maxVersion())[1] of (
        24000: BipedSys.createBiped showMenu:false  -- 2023+
        23000: BipedSys.createBiped()              -- 2022
        21000: BipedSys.createBiped()              -- 2021
        default: BipedSys.CreateBipedNode "Bip001" -- 2018åŠä»¥ä¸‹
    )
)

-- åœ¨å…¨å±€å˜é‡åŒºåŸŸæ·»åŠ BIPç‰ˆæœ¬æ§åˆ¶å˜é‡
global g_bipImportVersion = 24000 -- æ ¹æ®å½“å‰Maxç‰ˆæœ¬è®¾ç½®
global g_sceneSetsCache = #()
global g_processPaused = false

----------------------------------------------------------------
-- å…¨å±€å‡½æ•°å®šä¹‰ / ç‰ˆæœ¬å…¼å®¹ï¼ˆæ”¾åœ¨ rollout å¤–éƒ¨ï¼‰/ false / æœªéªŒè¯ / æ²‰æ·€ä»£ç  / å¤‡ç”¨
global getConvertUnitParam = fn getConvertUnitParam =  
(
    case (maxVersion())[1] of
    (
        19000: true    -- 2019 (å¯¹åº”ä»£ç 19000)
        20000: true    -- 2020 (å¯¹åº”ä»£ç 20000)
        21000: #cm     -- 2021 (ä»£ç 21000)
        22000: #cm     -- 2022 (ä»£ç 24000)
        23000: #cm     -- 2023 (ä»£ç 25000)
        24000: #cm     -- 2024 (ä»£ç 26000)
        default: #cm   -- æœªæ¥ç‰ˆæœ¬é»˜è®¤
    )
)
----------------------------------------------------------------
try(global saveConfig = undefined)catch()  -- å¼ºåˆ¶æ¸…é™¤æ—§å®šä¹‰--ä¿å­˜    
try(global loadConfig = undefined)catch()   -- å¼ºåˆ¶æ¸…é™¤æ—§å®šä¹‰--è¯»å–
----------------------------------------------------------------
-- åœ¨ç»“æ„ä½“å®šä¹‰åŒºåŸŸæ·»åŠ //æ‰¹é‡é€‰æ‹©é›†
struct selsetBatchConfig (
    autoCreateDir = true,
    targetFolder = "",
    overwrite = false
)
global g_selsetBatchCfg = selsetBatchConfig()
----------------------------------------------------------------
-- é¢œè‰²é…ç½®ç»“æ„//æ–‡ä»¶/æ–‡ä»¶å¤¹-é¢œè‰²è®¾ç½®
struct colorConfig (
    folderNameColor = (dotNetClass "System.Drawing.Color").Yellow,  -- æ–‡ä»¶å¤¹åç§°é¢œè‰² -- true = file = set colour/all (æ–‡ä»¶å¤¹+å›¾æ ‡/é¢œè‰²ä¸€èµ·è®¾ç½®)
    --folderIconColor = (dotNetClass "System.Drawing.Color").SlateGray,  -- æ–‡ä»¶å¤¹å›¾æ ‡é¢œè‰² -- false
    fileNameColor = (dotNetClass "System.Drawing.Color").White  -- æ–‡ä»¶åç§°é¢œè‰²      -- true = file = set colour/all (æ–‡ä»¶+å›¾æ ‡/é¢œè‰²ä¸€èµ·è®¾ç½®)
    --fileIconColor = (dotNetClass "System.Drawing.Color").SteelBlue, -- æ–‡ä»¶å›¾æ ‡é¢œè‰²
    --maxFileColor = (dotNetClass "System.Drawing.Color").DarkBlue, -- æš—è“ false
    --fbxFileColor = (dotNetClass "System.Drawing.Color").DarkGreen  -- æš—ç»¿ false
    --modeAutoColor = (dotNetClass "System.Drawing.Color").Blue,      -- è“è‰² false
    --modeSkinColor = (dotNetClass "System.Drawing.Color").Pink,       -- ç»¿è‰² false
    --modeBakeColor = (dotNetClass "System.Drawing.Color").Yellow       -- æ©™è‰² false
)
-- åœ¨é¢œè‰²é…ç½®ç»“æ„ä½“åæ·»åŠ //æœ€è¿‘æ‰“å¼€æ–‡ä»¶ æ•°é‡ä¸Šé™ ï¼›æ»šåŠ¨æ¡ä¸Šé™
struct performanceConfig (
    maxRecentFiles = 10000,  -- å¯é…ç½®é¡¹
    virtualScrollThreshold = 500  -- è¶…è¿‡500æ¡å¯ç”¨è™šæ‹Ÿæ»šåŠ¨
)
global g_PerfConfig = performanceConfig()
global g_ColorConfig = colorConfig()  -- å…¨å±€é¢œè‰²é…ç½®å®ä¾‹
-- åœ¨åˆå§‹åŒ–éƒ¨åˆ†æ·»åŠ å…¨å±€çŠ¶æ€å˜é‡
global g_forceCustomLayout = false -- æ˜¯å¦å¼ºåˆ¶ä¿æŒè‡ªå®šä¹‰å¸ƒå±€
--lvåˆ—è¡¨åˆ—å®½ä¸»è°ƒæ•´ï¼ï¼ï¼
global LISTVIEW_WIDTH = 500
global COLUMN_CK_WIDTH = 55   -- CK/ICONåˆ—åŸºå‡†å®½åº¦
global COLUMN_FILE_WIDTH = 305  -- æ–‡ä»¶åˆ—åŸºå‡†å®½åº¦
global COLUMN_TYPE_WIDTH = 100   -- ç±»å‹åˆ—åŸºå‡†å®½åº¦

global g_defaultBgValue = 45  -- é»˜è®¤ç°åº¦å€¼ (LVåˆ—è¡¨ é»˜è®¤ èƒŒæ™¯è‰²)
global g_gridLineColor = (dotNetClass "System.Drawing.Color").White -- é»˜è®¤ç½‘æ ¼çº¿é¢œè‰²

global g_defaultFont = dotNetObject "System.Drawing.Font" "å¾®è½¯é›…é»‘" 8 ((dotNetClass "System.Drawing.FontStyle").Bold)
global g_alternateFont = dotNetObject "System.Drawing.Font" "Arial" 8 ((dotNetClass "System.Drawing.FontStyle").Regular)
----------------------------------------------------------------
-- åˆ›å»ºåŠ¨æ€å³é”®èœå•ç»“æ„
global g_contextMenu = dotNetObject "System.Windows.Forms.ContextMenuStrip"
global g_menuItems = #(
    #("åˆ é™¤æ–‡ä»¶", "Delete"),
    #("æ‰“å¼€æ–‡ä»¶", "Open"),
    #("å¯¼å…¥BIP", "ImportBip"),
    #("è¿è¡Œè„šæœ¬", "RunScript"),
    #("å¯¼å…¥XAF", "ImportXaf"),
    #("å±æ€§", "Properties"),
    #("ç”¨FBXæŸ¥çœ‹å™¨æ‰“å¼€", "FbxViewer")
)
-- åˆå§‹åŒ–èœå•é¡¹ / false / æœªéªŒè¯ / å¤‡ç”¨ ï¼ˆä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼‰
for itemDef in g_menuItems do (
    local menuItem = g_contextMenu.Items.Add(itemDef[1])
    menuItem.Tag = itemDef[2]
)

-------------------------------------------------------------------------
struct itemsFolder (name,dir)  --Fileåˆ—è¡¨æ–‡ä»¶ç›®å½•(ini å†™å…¥ æ ¼å¼  å‘½å/æ¡†æ¶)     
-------------------------------------------------------------------------

-- æ–‡ä»¶ç®¡ç†ç»“æ„ä½“å®šä¹‰ï¼ˆå¿…é¡»å‰ç½®å£°æ˜ï¼‰- åˆå§‹åŒ–æ–‡ä»¶ç®¡ç†å™¨
struct stFileManager (

    -- è‡ªç„¶æ’åºç®—æ³•
    fn pseudoNaturalSort a b = (
        fn getFilesequenceFile f &base &digits = (
            f = getFilenameFile f
            base = trimRight f "0123456789"
            digits = subString f (base.count + 1) -1
        )
        
        local aBase, aDigits, bBase, bDigits
        getFilesequenceFile a &aBase &aDigits
        getFilesequenceFile b &bBase &bDigits
        
        aDigits = subString (( (aDigits as integer)) as string) 2 -1
        bDigits = subString (( (bDigits as integer)) as string) 2 -1
        
        case of (
            (a == b): 0
            (a < b): -1
            (a > b): 1
        )
    ),
    
    -- ä¿®æ”¹åçš„è·å–æ–‡ä»¶å’Œç›®å½•æ–¹æ³•
    public fn getFilesAndDirs root filterType = (
        root = pathConfig.normalizePath root
        local dirs = GetDirectories (root + "\\*")
        local files = getFiles (root + "\\*" + filterType)
        
        -- ä½¿ç”¨è‡ªç„¶æ’åº
        qsort dirs pseudoNaturalSort
        qsort files pseudoNaturalSort
        
        #(dirs, files)
    ),

    -- æ–°å¢å±‚çº§æ˜¾ç¤ºå‡½æ•°
    fn getDisplayName fullPath baseDepth = (
        local arrPath = filterString fullPath "\\"
        local depth = arrPath.count - baseDepth
        local indent = ""
        for i = 1 to depth do indent += "    "
        indent + filenameFromPath fullPath
    ),

    fn refreshFileList path filterType:"*.max" = (
        if not doesDirectoryExist path do return #()
        files = getFiles (path + "\\" + filterType)
        qsort files pseudoNaturalSort
        files
    )
)
----------------------------------------------------------------
-- å…¨å±€åˆå§‹åŒ–ï¼ˆå¿…é¡»åœ¨ç»“æ„ä½“ä¹‹åï¼‰
global g_fileManager = stFileManager()
----------------------------------------------------------------
-- é…ç½®ç®¡ç†æ¨¡å— ---------------------------------------------------------
global g_UIConfigPath = pathConfig.normalizePath ((getDir #maxData) + "\\AutoExportTool.pro_UI.ini")
global g_ConfigPath = pathConfig.normalizePath ((getDir #maxData) + "\\AutoExportTool.pro_Config.ini")    --ini-ç›®å½•è·¯å¾„ä¿å­˜æ–‡ä»¶ 
global g_likedFolders = #()                      -- ini å†™å…¥ å¸¸ç”¨è·¯å¾„æ–‡ä»¶å¤¹-åç§°/è·¯å¾„-å‘½å+å‚¨å­˜
global g_maxRecentFiles = 10000                    -- å°†æœ€å¤§é™åˆ¶æ”¹ä¸º10000 // --æœ€è¿‘æ‰“å¼€æœ€å¤§æ–‡ä»¶æ•°
global g_recentFiles = #()                           --å†™å…¥ æœ€è¿‘æ‰“å¼€æ–‡ä»¶å¤¹-åç§°/æ–‡ä»¶å-è®°å½•/åŠ¨æ€è®°å¿†/2025--false---- æ”¹ä¸ºå­˜å‚¨äºŒç»´æ•°ç»„ [#(è·¯å¾„, æ˜¯å¦å­˜åœ¨), ...]
----------------------------------------------------------------
global g_showRecentFiles = false -- æ–°å¢ï¼šæ ‡è®°æ˜¯å¦å¤„äºâ€œæœ€è¿‘æ‰“å¼€â€æ¨¡å¼
----------------------------------------------------------------
global g_cyclePath = undefined -- å¾ªç¯è·¯å¾„è®°å½•
----------------------------------------------------------------
----------------------------------------------------------------
--ç‰¹æ®Šæ–‡ä»¶å¤¹åˆ—è¡¨åŒå‡»/å¯¼èˆªå¹¶æ­£ç¡®è®¾ç½®æ–‡ä»¶ç±»å‹å¸…é€‰ï¼ˆmax ,fbx,bip,ms,xaf = 1 2 3 4 5 / æ”¯æŒ æ™®é€š æ–‡ä»¶å¤¹ åç§°/æ–‡ä»¶ç±»å‹ç­›é€‰-å¯¼èˆªè®¾ç½® å’Œ ç‰¹æ®Šåç§° æ–‡ä»¶å¤¹ åç§°/æ–‡ä»¶ç±»å‹ç­›é€‰-å¯¼èˆªè®¾ç½®
-- æ·»åŠ ç±»å‹ç¼“å­˜æœºåˆ¶
global g_fileTypeCache = #()
global g_fileTypes = #("*.max", "*.fbx", "*.ms;*.mse", "*.bip", "*.mzp") -- æ”¯æŒçš„æ–‡ä»¶ç±»å‹æ•°ç»„
global g_fileTypeCache = #()
--ç‰¹æ®Šæ–‡ä»¶å¤¹åˆ—è¡¨åŒå‡»/å¯¼èˆªå¹¶æ­£ç¡®è®¾ç½®æ–‡ä»¶ç±»å‹å¸…é€‰ï¼ˆmax ,fbx,bip,ms,xaf = 1 2 3 4 5
global cacheFileTypes folderPath = fn cacheFileTypes folderPath = (
    g_fileTypeCache = #()
    local allFiles = getFiles (folderPath + "\\*.*")
    for f in allFiles do (
        append g_fileTypeCache (toLower (getFilenameType f))
    )
    g_fileTypeCache
)
----------------------------------------------------------------

----------------------------------------------------------------
--ç‰¹æ®Šæ–‡ä»¶å¤¹åˆ—è¡¨åŒå‡»/å¯¼èˆªå¹¶æ­£ç¡®è®¾ç½®æ–‡ä»¶ç±»å‹å¸…é€‰ï¼ˆmax ,fbx,bip,ms,mzp,xaf = 1 2 3 4 5 6..
-- æ–°å¢æ¨¡å¼åŒ¹é…è¯­æ³• / åŒå‡»ç‚¹å‡»æ–‡ä»¶å¤¹ï¼ˆæ ¹æ®æ–‡ä»¶å¤¹åç§°æ–‡ä»¶ç±»å‹æ™ºèƒ½ç­›é€‰æ˜¾ç¤ºï¼‰
struct PatternSettings (
    
    script = #("*script*","*maxscript*","*Startup*","*ms*","*mzp*","*mcr*","*tool*"),  -- æ‰©å±•è„šæœ¬ç›¸å…³å…³é”®è¯
    maxFiles = #("*max*","*ani*","*csanim*","*scene*","*animation*"),  -- åŒ…å«æ›´å¤šmaxç›¸å…³å…³é”®è¯
    bip = #("*bip*","*biped*","*rig*","*csbiped*"),
    fbx = #("*fbx*","*mesh*","*model*","*asset*"),
    xaf = #("*xaf*","*bone*","*anim*","*attach*")
)
--ç‰¹æ®Šæ–‡ä»¶å¤¹åˆ—è¡¨åŒå‡»/å¯¼èˆªå¹¶æ­£ç¡®è®¾ç½®æ–‡ä»¶ç±»å‹ç­›é€‰ï¼ˆmax ,fbx,bip,ms,xaf = 1 2 3 4 5..
fn getFilterPattern = (
    case rdoFileFilter.state of (
        1: "*.max"                   -- Maxåœºæ™¯
        2: "*.fbx"                   -- FBXèµ„æº
        3: "*.ms;*.mse"  -- Maxè„šæœ¬/åŠ å¯†è„šæœ¬/å®è„šæœ¬   
        4: "*.bip"                   -- Bipedæ•°æ®
        5: "*.mzp"                   -- å®è„šæœ¬
        6: "*.xaf"                   -- é™„ä»¶æ•°æ®
        default: "*"                 -- é»˜è®¤å…¨æ˜¾ç¤º 
        
        --default: rdoFileFilter.state -- ä¿æŒåŸçŠ¶æ€  false
    )
)

global g_patterns = PatternSettings()

-- ä¼˜åŒ–ç‰¹æ®Šæ–‡ä»¶å¤¹æ£€æµ‹å‡½æ•°
fn isSpecialFolder folderName patternType = (
    local patterns = case patternType of (
        
        #script: g_patterns.script  -- æ–°å¢scriptå¤„ç†
        #max: g_patterns.max
        #bip: g_patterns.bip
        #fbx: g_patterns.fbx
        #xaf: g_patterns.xaf
        default: #()
    )
    
    for p in patterns where (matchPattern folderName pattern:p) do return true
    false
)

-- é‡æ„æ™ºèƒ½ç±»å‹æ£€æµ‹é€»è¾‘
fn autoDetectFilterType path = (
    local folderName = toLower (filenameFromPath path)
    
    case of (
        (isSpecialFolder folderName #script): 3   -- è„šæœ¬ç±»å‹ä¼˜å…ˆ/-- æœ€é«˜ä¼˜å…ˆçº§
        (isSpecialFolder folderName #xaf): 6      -- é™„ä»¶æ•°æ®
        (isSpecialFolder folderName #bip): 4      -- Bipedæ•°æ®
        (isSpecialFolder folderName #fbx): 2      -- FBXèµ„æº
        (isSpecialFolder folderName #maxFiles): 1 -- MAXåœºæ™¯/ä½¿ç”¨æ–°æˆå‘˜åç§°
        default: 1  -- æœªåŒ¹é…æ—¶é»˜è®¤MAXç±»å‹          --default: rdoFileFilter.state -- ä¿æŒåŸçŠ¶æ€/false
        --default: rdoFileFilter.state
    )
)
----------------------------------------------------------------
----------------------------------------------------------------
global g_bipExportPath = ""     -- BIP å¯¼å‡º ç›®å½•åœ°å€
global g_bipImportPath = ""     -- BIP å¯¼å…¥ ç›®å½•åœ°å€
global g_bipProcessMode = 1     -- BIP æ¨¡å¼ï¼ˆ1:å¯¼å‡º 2:å¯¼å…¥ï¼‰
global g_autoCreateBip = true   -- è‡ªåŠ¨åˆ›å»ºBipedå¼€å…³
----------------------------------------------------------------
-- åˆ—è¡¨æ–‡ä»¶ç±»å‹åç§°è‡ªåŠ¨åˆ¤æ–­æ ‡æ³¨/å¯æ‹“å±•-å¤šç±»å‹æ–‡ä»¶å³é”®æ‰“å¼€ or åŒå‡»å¯æ‰“å¼€..
global getFileType fPath = fn getFileType fPath = (

    if classOf fPath != String do return "æ— æ•ˆè·¯å¾„"
    if not doesFileExist fPath do return "æ–‡ä»¶ä¸å­˜åœ¨"
    
    case (toLower (getFilenameType fPath)) of (
        ".max": (
            local fName = toLower (getFilenameFile fPath)
            case of (
                (findString fName "skin" != undefined): "è§’è‰²æ¨¡å‹"
                (findString fName "ani" != undefined): "åŠ¨ç”»æ–‡ä»¶"
                (findString fName "scene" != undefined): "åœºæ™¯æ–‡ä»¶"
                
                (findString fName "merge" != undefined): "åˆå¹¶æ–‡ä»¶"
                (findString fName "socket" != undefined): "æŒ‚ç‚¹æ–‡ä»¶"
                (findString fName "æŒ‚ç‚¹" != undefined): "æŒ‚ç‚¹æ–‡ä»¶"
                
                (findString fName "start" != undefined): "åˆ†æ®µ(èµ·å§‹)"
                (findString fName "loop" != undefined): "åˆ†æ®µ(å¾ªç¯)"
                (findString fName "end" != undefined): "åˆ†æ®µ(ç»“æŸ)"
                
                default: "Maxæ–‡ä»¶"
            )
        )
        ".fbx": "FBXèµ„æº" 
        ".ms": "Maxè„šæœ¬"
        ".mzp": "å®è„šæœ¬z"
		".mcr": "å®è„šæœ¬c"
        ".mse": "åŠ å¯†è„šæœ¬"
        ".bip": "Bipedæ•°æ®"
        ".xaf": "é™„ä»¶æ•°æ®"
        ".png": "PNGå›¾åƒ"
        ".jpg": "JPEGå›¾åƒg"
        ".jpeg": "JPEGå›¾åƒeg"
        ".txt": "æ–‡æœ¬æ–‡ä»¶"
        ".doc": "Wordæ–‡æ¡£c"
        ".docx": "Wordæ–‡æ¡£cx"
        ".xls": "Excelè¡¨æ ¼s"
        ".xlsx": "Excelè¡¨æ ¼sx"
        ".pdf": "PDFæ–‡æ¡£"
        ".zip": "ZIPå‹ç¼©åŒ…"
        ".rar": "RARå‹ç¼©åŒ…"
        ".7z": "7-Zipå‹ç¼©åŒ…"
        ".ini": "é…ç½®æ–‡ä»¶"
        ".json": "JSONæ–‡ä»¶"
        ".xml": "XMLæ–‡ä»¶"
        default: "å…¶ä»–æ–‡ä»¶"
    )
)
----------------------------------------------------------------
-- æ·»åŠ è‡ªåŠ¨ä¿å­˜è·¯å¾„ç›‘æ§ - å®æµ‹ åŠŸèƒ½ç¨³å®š true
global g_autoSavePath = pathConfig.normalizePath (getDir #autoback) -- è‡ªåŠ¨ä¿å­˜è·¯å¾„
global g_autoSaveWatcher = undefined                                   -- æ–‡ä»¶ç›‘æ§å¯¹è±¡
global g_autoSaveWatcher = dotNetObject "System.IO.FileSystemWatcher"
----------------------------------------------------------------
-- ä½¿ç”¨é—­åŒ…å°è£…INIæ“ä½œå‡½æ•°é¿å…æ±¡æŸ“å…¨å±€ä½œç”¨åŸŸ-- true --ï¼ˆéªŒè¯å®ç°ï¼‰
-- æ–°å¢å…¨å±€å˜é‡ï¼šå¸¸ç”¨ç›®å½•/å­˜å‚¨ç»“æ„
----------------------------------------------------------------
--è®°å½•å¸¸ç”¨ç›®å½•/ POS-æ’ä»¶ä½ç½® /Main ini ( æ ¸å¿ƒ ini /config-è®°å½•ä¿å­˜ ) --  å®æµ‹ åŠŸèƒ½ç¨³å®š true
-- ========== é…ç½®ä¿å­˜å‡½æ•° (ä¸­æ–‡å…¼å®¹) ==========
global saveConfig = fn saveConfig = (
    try (
        -- åˆ›å»ºé…ç½®ç›®å½•
        makeDir (getFilenamePath g_ConfigPath) all:true
        
        -- æ¸…é™¤æ—§é…ç½®
        delINISetting g_ConfigPath "LikedFolders"  -- åˆ é™¤æ•´ä¸ªåŒºå—
        
        -- å­˜å‚¨ç›®å½•æ•°é‡
        setINISetting g_ConfigPath "LikedFolders" "Count" (g_likedFolders.count as string)
        
        -- å¾ªç¯å­˜å‚¨æ¯ä¸ªç›®å½•
        for i=1 to g_likedFolders.count do (
            setINISetting g_ConfigPath "LikedFolders" ("Name" + i as string) g_likedFolders[i].name
            setINISetting g_ConfigPath "LikedFolders" ("Dir" + i as string) g_likedFolders[i].dir
        )
        true  -- è¿”å›æˆåŠŸ
    ) 
    catch (false)  -- è¿”å›å¤±è´¥
)
----------------------------------------------------------------
-- æ–°å¢å…¨å±€å˜é‡ï¼šå¸¸ç”¨ç›®å½•/è¯»å–ç»“æ„
-- åŠ è½½é…ç½®å‡½æ•°-- true --ï¼ˆéªŒè¯å®ç°ï¼‰
----------------------------------------------------------------
--è®°å½•å¸¸ç”¨ç›®å½•/ POS-æ’ä»¶ä½ç½® /Main ini ( æ ¸å¿ƒ ini /config-è¯»å–åŠ è½½ ) --  å®æµ‹ åŠŸèƒ½ç¨³å®š true
-- ========== é…ç½®åŠ è½½å‡½æ•° (ä¸­æ–‡å…¼å®¹) ==========
-- ========== é…ç½®åŠ è½½å‡½æ•° (ä½¿ç”¨ç‹¬ç«‹å‡½æ•°) ==========
global loadConfig = fn loadConfig = (
    g_likedFolders = #()  -- æ¸…ç©ºå½“å‰ç›®å½•
    
    if doesFileExist g_ConfigPath do (
        -- è¯»å–ç›®å½•æ•°é‡
        local count = (getINISetting g_ConfigPath "LikedFolders" "Count") as integer
        
        -- å¾ªç¯åŠ è½½ç›®å½•
        for i=1 to count do (
            local name = getINISetting g_ConfigPath "LikedFolders" ("Name" + i as string)
            local dir = getINISetting g_ConfigPath "LikedFolders" ("Dir" + i as string)
            
            if name != "" and dir != "" do (
                append g_likedFolders (itemsFolder name:name dir:dir)
            )
        )
    )
    
    -- é»˜è®¤ç›®å½•ï¼ˆé¦–æ¬¡è¿è¡Œæ—¶ï¼‰
    if g_likedFolders.count == 0 do (
        append g_likedFolders (itemsFolder name:"é»˜è®¤åœºæ™¯" dir:(getDir #scene))
    )
)
----------------------------------------------------------------
----------------------------------------------------------------

--æ—¥æœŸæ˜¾ç¤º- true -ï¼ˆéªŒè¯å®ç°ï¼‰
global DateTime = (dotNetClass "System.DateTime").Now
global arrDayWeek = #("æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­")                --éœ€è¦ç¡®ä¿arrDayWeekæ•°ç»„æ­£ç¡®å®šä¹‰ï¼ˆæ—¥æœŸï¼‰
global g_refreshTimer = undefined  -- æ˜¾å¼å£°æ˜å®šæ—¶å™¨å˜é‡
----------------------------------------------------------------
--çª—å£ä½ç½®è®°å¿†-- true --ï¼ˆéªŒè¯å®ç°ï¼‰
global g_WindowPosPath = (getDir #scripts) + "\\AutoExportTool.pro_pos.ini"       -- è®°å¿†çª—å£ä½ç½®é…ç½®ï¼ˆpos-remember)
global g_lastError = ""
try (
    -- ä¸»è„šæœ¬å†…å®¹ï¼ˆåŒ…æ‹¬ rollout å®šä¹‰å’Œ CreateDialogï¼‰
) catch (
    g_lastError = getCurrentException()
    format "[è‡´å‘½é”™è¯¯] æ’ä»¶åˆå§‹åŒ–å¤±è´¥ï¼š%\n" g_lastError
    messageBox "æ’ä»¶å¯åŠ¨å¤±è´¥ï¼Œè¯·è”ç³»å¼€å‘è€…ï¼" title:"é”™è¯¯" beep:true
)
global g_lastDialogPos = [100, 100]  -- é»˜è®¤ä½ç½®-- å…¨å±€å˜é‡ç”¨äºä¿å­˜çª—å£ä½ç½®-- true --ï¼ˆéªŒè¯å®ç°ï¼‰
----------------------------------------------------------------
global g_exportAbortFlag = false -- å…¨å±€ä¸­æ–­æ ‡å¿— Esc-ä¸­æ–­å¯¼å‡ºè¿›ç¨‹-- true -- (éªŒè¯å®ç°ï¼‰ 
----------------------------------------------------------------
global g_sceneSetsCache = #()                  --true--éªŒè¯å®ç°
----------------------------------------------------------------
global g_exportTypes = #("skin", "ani", "animrange") -- æ–‡ä»¶ç±»å‹
global g_autoOpenFolder = true                   -- è‡ªåŠ¨æ‰“å¼€ç›®å½•å¼€å…³ï¼ˆæ–°å¢ï¼‰
global g_lastExportPath = undefined              -- æœ€åå¯¼å‡ºè·¯å¾„è®°å½•ï¼ˆæ–°å¢ï¼‰
----------------------------------------------------------------
----------------------------------------------------------------
----------------------------------------------------------------
-- FBX å¯¼å‡º ä¸‰ä¸ª æ¨¡å¼å‚æ•° å®æµ‹ åŠŸèƒ½ç¨³å®š true
global refreshModeDisplay = fn refreshModeDisplay = (
    try (
     
        -- çŠ¶æ€è·å–ï¼ˆå¸¦é”™è¯¯å›é€€ï¼‰
        local fbxState = try(rdo_exportMode.state)catch(1)
        local bipState = try(rdo_bipMode.state)catch(1)
        
        -- æ¨¡å¼åç§°æ˜ å°„
        local modeMap = #(
            #("Autoé»˜è®¤", "Skinæ¨¡å‹", "BakeåŠ¨ç”»"),  -- FBXæ¨¡å¼
            #("å¯¼å‡ºBIP", "å¯¼å…¥BIP")                -- BIPæ¨¡å¼
        )
        --lblModeStatus.text = infoText - false / æ²‰æ·€ä»£ç  
        -- æ„å»ºæ˜¾ç¤ºæ–‡æœ¬
        local infoText = "FBXæ¨¡å¼ï¼š" + modeMap[1][fbxState] + \  -- true
                       "  |  BIPæ¨¡å¼ï¼š" + modeMap[2][bipState]   -- false (æ­¤éƒ¨åˆ†æ”¹æˆäº† Last Action : æŒ‰é’®ç‚¹å‡»æ‰§è¡Œæ“ä½œåç§°æ˜¾ç¤º=æ‰§è¡Œäº‹ä»¶åç§°æç¤ºå…·ä½“çŠ¶æ€ï¼)
        
        -- å¸¦æœ‰æ•ˆæ€§æ£€æŸ¥çš„æ§ä»¶æ›´æ–°
        if isValidNode ModeStatus do (
            ModeStatus.caption = infoText
            format "[ç•Œé¢æ›´æ–°] å½“å‰çŠ¶æ€ï¼š%\n" infoText
        )
    )
    catch (
        format "[ä¸¥é‡é”™è¯¯] çŠ¶æ€æ›´æ–°å¤±è´¥ï¼š%\n" (getCurrentException())
    )
)

-- è¡¨æƒ…ç¬¦å·åº“  -- false / æ²‰æ·€ä»£ç  / æœªéªŒè¯ / å¤‡ç”¨
global emojiLib = #(
    "â™“",  -- é»˜è®¤
    "â˜½",  -- æ‚¬åœæ—¶
    "â™›"   -- ç‚¹å‡»æ—¶
)

-- åœ¨å…¨å±€åŒºåŸŸæ·»åŠ éª¨éª¼æ£€æµ‹/å‡½æ•°
global isBoneObject = fn isBoneObject obj = (
    if obj == undefined do return false
    local objClass = classOf obj
    return (objClass == BoneGeometry or objClass == Biped_Object)
)
-- å…¨å±€XAFè®¾ç½®å‡½æ•°
global saveXAFSettings = fn saveXAFSettings boneList = (
    try (
        local boneNames = ""
        for bone in boneList do (
            boneNames += bone + ","
        )
        setINISetting g_UIConfigPath "XAFSettings" "SelectedBones" boneNames
        format "[XAFè®¾ç½®ä¿å­˜æˆåŠŸ] å·²ä¿å­˜ % ä¸ªéª¨éª¼\n" boneList.count
        true
    )
    catch (
        format "[XAFè®¾ç½®ä¿å­˜é”™è¯¯] %\n" (getCurrentException())
        false
    )
)

global loadXAFSettings = fn loadXAFSettings = (
    try (
        local savedBones = getINISetting g_UIConfigPath "XAFSettings" "SelectedBones"
        if savedBones != "" then (
            return filterString savedBones ","
        )
        #()
    )
    catch (
        format "[XAFè®¾ç½®åŠ è½½é”™è¯¯] %\n" (getCurrentException())
        #()
    )
)

----------------------------------------------------------------
----------------------------------------------------------------
--å¯¹è¯æ¡†åˆ›å»ºå‰é”€æ¯æ—§å®ä¾‹ / true
try (
    loadConfig() -- ç¡®ä¿åœ¨åˆ›å»ºUIå‰åŠ è½½é…ç½®
    format "[å¸¸ç”¨è·¯å¾„åˆå§‹åŒ–] é…ç½®åŠ è½½å®Œæˆï¼Œå…± % ä¸ªè·¯å¾„\n" g_likedFolders.count
) catch (
    format "[åˆå§‹åŒ–é”™è¯¯] %\n" (getCurrentException())
)

--try(AutoExportTool_Pro.ddlLikedPaths.selection = 1) catch()  -- å¯é€‰ï¼šé‡ç½®é€‰ä¸­é¡¹ -- false / æ²‰æ·€ä»£ç  / æœªéªŒè¯
----------------------------------------------------------------
----------------------------------------------------------------
try(destroyDialog rolXAFEditor)catch()
try(destroyDialog rolCharacterMapping)catch()
try(destroyDialog rolPathManager)catch()
try(destroyDialog AutoExportTool_Pro)catch()
----------------------------------------------------------------
----------------------------------------------------------------
-- XAFéª¨éª¼é€‰æ‹©é›†ç¼–è¾‘å™¨ // rolXAFEditor 
rollout rolXAFEditor "XAFéª¨éª¼é€‰æ‹©é›†ç¼–è¾‘å™¨" width:500 height:620
(
    dotNetControl lvBones "System.Windows.Forms.ListView" width:460 height:350 align:#center offset:[0,10]
    
    -- æ–°å¢ç­›é€‰æŒ‰é’®
    group "éª¨éª¼ç±»å‹ç­›é€‰"
    (
        button btnBones "Bones" width:60 height:22 across:5 tooltip:"åªæ˜¾ç¤ºæ ‡å‡†éª¨éª¼"
        button btnBipeds "Bipeds" width:60 height:22 tooltip:"åªæ˜¾ç¤ºBipedéª¨éª¼"
        button btnPoints "Points" width:60 height:22 tooltip:"åªæ˜¾ç¤ºPointè¾…åŠ©å¯¹è±¡"
        button btnDummies "Dummies" width:60 height:22 tooltip:"åªæ˜¾ç¤ºDummyè™šæ‹Ÿä½“"
        button btnAll "All" width:60 height:22 tooltip:"æ˜¾ç¤ºæ‰€æœ‰ç±»å‹"
    )
    -- æ–°å¢äº‹ä»¶æŒ‰é’®
    group "XAFæ“ä½œæ‰§è¡Œ"
    (
    button btnSelectAll "âœ… å…¨é€‰" width:60 height:25 across:4 tooltip:"å…¨å‹¾é€‰éª¨éª¼"
    button btnDeselectAll "âŒ å…¨ä¸é€‰" width:60 height:25 tooltip:"ä¸å‹¾é€‰éª¨éª¼"
    button btnSave "ğŸ’¾ ä¿å­˜" width:60 height:25 tooltip:"ä¿å­˜éª¨éª¼é…ç½®"
    button btnClose "å…³é—­" width:60 height:25 tooltip:"å…³é—­ç¼–è¾‘å™¨"
    
    -- æ–°å¢åŒæ­¥æŒ‰é’®
    button btnSyncSelection "åŒæ­¥é€‰æ‹©" width:80 height:25 across:2 offset:[0,5] tooltip:"å°†åœºæ™¯ä¸­é€‰æ‹©çš„éª¨éª¼åŒæ­¥åˆ°åˆ—è¡¨"
    button btnRefresh "ğŸ”„ åˆ·æ–°" width:70 height:25  offset:[0,5] tooltip:"åˆ·æ–°åˆ—è¡¨ "
    button btnSyncSelectionSet "é€‰æ‹©é›†åŒæ­¥" width:80 height:25 tooltip:"å°†é€‰æ‹©é›†ä¸­çš„éª¨éª¼åŒæ­¥åˆ°åˆ—è¡¨"
    )
    label lblBoneCount "éª¨éª¼æ€»æ•°: 0 | å·²é€‰æ‹©: 0" align:#center offset:[0,10]
    
    label lblStatus "å‡†å¤‡å°±ç»ª..." align:#center offset:[0,5]  -- æ–°å¢çŠ¶æ€æ ‡ç­¾
    
    label edtUserExPath "Ë–â© â„³ â€ Íœâ™¡ï¸ â€ºãƒ½(â—Â´âˆ€â—)ï¾‰`-éª¨éª¼XAFç¼–è¾‘å™¨/-XAF Bone Selection Set Editorï¼" width:475 align:#center offset:[75,5]  
    
    local boneList = #()
    local selectedBones = #()
    local currentFilter = "All" -- å½“å‰ç­›é€‰ç±»å‹
    local g_selSetName = "" -- å…¨å±€å˜é‡å­˜å‚¨é€‰æ‹©é›†åç§°
    
    -- åˆå§‹åŒ–éª¨éª¼åˆ—è¡¨è§†å›¾
    fn initBoneListView = (
        lvBones.View = (dotNetClass "System.Windows.Forms.View").Details
        lvBones.CheckBoxes = true
        lvBones.FullRowSelect = true
        lvBones.MultiSelect = true
        lvBones.GridLines = true
        lvBones.HideSelection = false
        
        -- æ·»åŠ åˆ—
        lvBones.Columns.Add "é€‰æ‹©" 50
        lvBones.Columns.Add "éª¨éª¼åç§°" 250
        lvBones.Columns.Add "ç±»å‹" 100
        
        -- åŠ è½½ä¿å­˜çš„è®¾ç½®
        selectedBones = loadXAFSettings()
    )
    
    -- åˆ·æ–°éª¨éª¼åˆ—è¡¨ï¼ˆå¸¦ç­›é€‰åŠŸèƒ½ï¼‰
    fn refreshBoneList filterType:currentFilter = (
        lvBones.Items.Clear()
        boneList = #()
        
        -- æ ¹æ®ç­›é€‰ç±»å‹æ”¶é›†éª¨éª¼
        case filterType of (
            "Bones": (
                boneList = for obj in objects where (classOf obj == BoneGeometry) collect obj
            )
            "Bipeds": (
                boneList = for obj in objects where (classOf obj == Biped_Object) collect obj
            )
            "Points": (
                boneList = for obj in objects where (classOf obj == Point) collect obj
            )
            "Dummies": (
                boneList = for obj in objects where (classOf obj == Dummy) collect obj
            )
            "All": (
                boneList = for obj in objects where (isBoneObject obj or classOf obj == Dummy or classOf obj == Point) collect obj
            )
        )
        
        local selectedCount = 0
        
        for bone in boneList do (
            local isSelected = (findItem selectedBones bone.name) > 0
            if isSelected do selectedCount += 1
            
            local li = dotNetObject "System.Windows.Forms.ListViewItem" ""
            li.Checked = isSelected
            li.SubItems.Add(bone.name)
            li.SubItems.Add((classOf bone) as string)
            li.Tag = bone.name
            lvBones.Items.Add(li)
        )
        
        -- æ›´æ–°éª¨éª¼è®¡æ•°æ ‡ç­¾
        lblBoneCount.text = "éª¨éª¼æ€»æ•°: " + (boneList.count as string) + " | å·²é€‰æ‹©: " + (selectedCount as string)
        currentFilter = filterType
    )
    
    -- æ›´æ–°éª¨éª¼è®¡æ•°
    fn updateBoneCount = (
        local selectedCount = 0
        for i = 0 to (lvBones.Items.Count - 1) do (
            if lvBones.Items.Item[i].Checked do selectedCount += 1
        )
        lblBoneCount.text = "éª¨éª¼æ€»æ•°: " + (boneList.count as string) + " | å·²é€‰æ‹©: " + (selectedCount as string)
    )
    
    -- åŒæ­¥åœºæ™¯é€‰æ‹©åˆ°åˆ—è¡¨
    fn syncSelectionToXAFList = (
        local sel = getCurrentSelection()
        -- å…ˆåˆ‡æ¢åˆ°æ‰€æœ‰éª¨éª¼æ˜¾ç¤º
        refreshBoneList filterType:"All"
        
        for i = 0 to (lvBones.Items.Count - 1) do (
            local item = lvBones.Items.Item[i]
            local boneName = item.Tag as string
            local found = false
            
            for obj in sel while not found do (
                if obj.name == boneName do (
                    item.Checked = true
                    found = true
                )
            )
            
            if not found do item.Checked = false
        )
        updateBoneCount()
    )
    
    -- åŒæ­¥é€‰æ‹©é›†åˆ°åˆ—è¡¨ - ä½¿ç”¨å…¨å±€å˜é‡ä¿®å¤
    fn syncSelectionSetToXAFList = (
        local selSets = #()
        for i = 1 to (getNumNamedSelSets()) do (
            append selSets (getNamedSelSetName i)
        )
        
        if selSets.count > 0 then (
            -- ä½¿ç”¨å…¨å±€å˜é‡å­˜å‚¨é€‰æ‹©é›†åç§°
            g_selSetName = selSets[1] -- é»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ªé€‰æ‹©é›†
            
            if selSets.count > 1 do (
                -- å¦‚æœæœ‰å¤šä¸ªé€‰æ‹©é›†ï¼Œå¼¹å‡ºé€‰æ‹©å¯¹è¯æ¡†
                try (
                    -- åˆ›å»ºé€‰æ‹©é›†é€‰æ‹©å¯¹è¯æ¡†
                    rollout selSetDialog "é€‰æ‹©é€‰æ‹©é›†" width:200 height:100
                    (
                        dropdownlist ddlSets "é€‰æ‹©é›†:" items:selSets width:180
                        button btnOK "ç¡®å®š" width:80 across:2
                        button btnCancel "å–æ¶ˆ" width:80
                        
                        on btnOK pressed do (
                            -- ä½¿ç”¨å…¨å±€å˜é‡å­˜å‚¨é€‰æ‹©
                            g_selSetName = ddlSets.selected
                            destroyDialog selSetDialog
                        )
                        on btnCancel pressed do (
                            g_selSetName = undefined
                            destroyDialog selSetDialog
                        )
                    )
                    
                    createDialog selSetDialog modal:true
                )
                catch (
                    format "[é€‰æ‹©é›†å¯¹è¯æ¡†é”™è¯¯] %\n" (getCurrentException())
                    g_selSetName = undefined
                )
            )
            
            if g_selSetName != undefined do (
                try (
                    local selSetObjs = selectionSets[g_selSetName]
                    -- å…ˆåˆ‡æ¢åˆ°æ‰€æœ‰éª¨éª¼æ˜¾ç¤º
                    refreshBoneList filterType:"All"
                    
                    for i = 0 to (lvBones.Items.Count - 1) do (
                        local item = lvBones.Items.Item[i]
                        local boneName = item.Tag as string
                        local found = false
                        
                        for obj in selSetObjs while not found do (
                            if obj.name == boneName do (
                                item.Checked = true
                                found = true
                            )
                        )
                        
                        if not found do item.Checked = false
                    )
                    updateBoneCount()
                )
                catch (
                    format "[é€‰æ‹©é›†å¤„ç†é”™è¯¯] %\n" (getCurrentException())
                    messageBox ("å¤„ç†é€‰æ‹©é›†æ—¶å‡ºé”™: " + (getCurrentException())) title:"é”™è¯¯"
                )
            )
        ) else (
            messageBox "åœºæ™¯ä¸­æ²¡æœ‰é€‰æ‹©é›†!" title:"æç¤º"
        )
    )
    
    on rolXAFEditor open do (
        initBoneListView()
        refreshBoneList()
    )
    
    on btnRefresh pressed do refreshBoneList()
    
    on btnSelectAll pressed do (
        for i = 0 to (lvBones.Items.Count - 1) do (
            lvBones.Items.Item[i].Checked = true
        )
        updateBoneCount()
    )
    
    on btnDeselectAll pressed do (
        for i = 0 to (lvBones.Items.Count - 1) do (
            lvBones.Items.Item[i].Checked = false
        )
        updateBoneCount()
    )
    
    -- ä¿®æ”¹ä¿å­˜æŒ‰é’®äº‹ä»¶å¤„ç†ï¼ˆä½¿ç”¨çŠ¶æ€æ ‡ç­¾ï¼‰
    on btnSave pressed do (
        -- æ”¶é›†é€‰ä¸­çš„éª¨éª¼
        selectedBones = #()
        for i = 0 to (lvBones.Items.Count - 1) do (
            if lvBones.Items.Item[i].Checked do (
                append selectedBones (lvBones.Items.Item[i].Tag as string)
            )
        )
        
        -- ä¿å­˜è®¾ç½®
        saveXAFSettings selectedBones
        local saveResult = saveXAFSettings selectedBones
        
        if saveResult then (
            local selectedCount = selectedBones.count as string
            lblBoneCount.text = "éª¨éª¼æ€»æ•°: " + (boneList.count as string) + " | å·²é€‰æ‹©: " + selectedCount
            lblStatus.text = "XAFè®¾ç½®å·²ä¿å­˜: " + selectedCount + " ä¸ªéª¨éª¼"
        ) else (
            lblStatus.text = "XAFè®¾ç½®ä¿å­˜å¤±è´¥"
        )
    )
    
    on btnClose pressed do destroyDialog rolXAFEditor
    
    -- æ·»åŠ å¤é€‰æ¡†çŠ¶æ€æ”¹å˜äº‹ä»¶
    on lvBones ItemChecked arg do (
        updateBoneCount()
    )
    
    on rolXAFEditor open do (
        initBoneListView()
        refreshBoneList()
        lblStatus.text = "å‡†å¤‡å°±ç»ª"
    )
    
    on btnRefresh pressed do (
        refreshBoneList()
        lblStatus.text = "åˆ—è¡¨å·²åˆ·æ–°"
    )
    
    on btnSelectAll pressed do (
        for i = 0 to (lvBones.Items.Count - 1) do (
            lvBones.Items.Item[i].Checked = true
        )
        updateBoneCount()
        lblStatus.text = "å·²å…¨é€‰æ‰€æœ‰éª¨éª¼"
    )
    
    on btnDeselectAll pressed do (
        for i = 0 to (lvBones.Items.Count - 1) do (
            lvBones.Items.Item[i].Checked = false
        )
        updateBoneCount()
        lblStatus.text = "å·²å–æ¶ˆæ‰€æœ‰é€‰æ‹©"
    )
    
    -- ä¿®æ”¹ä¿å­˜æŒ‰é’®äº‹ä»¶å¤„ç†ï¼ˆä½¿ç”¨çŠ¶æ€æ ‡ç­¾ï¼‰
    on btnSave pressed do (
        -- æ”¶é›†é€‰ä¸­çš„éª¨éª¼
        selectedBones = #()
        for i = 0 to (lvBones.Items.Count - 1) do (
            if lvBones.Items.Item[i].Checked do (
                append selectedBones (lvBones.Items.Item[i].Tag as string)
            )
        )
        
        -- ä¿å­˜è®¾ç½®
        local saveResult = saveXAFSettings selectedBones
        
        if saveResult then (
            local selectedCount = selectedBones.count as string
            lblBoneCount.text = "éª¨éª¼æ€»æ•°: " + (boneList.count as string) + " | å·²é€‰æ‹©: " + selectedCount
            lblStatus.text = "XAFè®¾ç½®å·²ä¿å­˜: " + selectedCount + " ä¸ªéª¨éª¼"
        ) else (
            lblStatus.text = "XAFè®¾ç½®ä¿å­˜å¤±è´¥"
        )
    )
    
    on btnClose pressed do destroyDialog rolXAFEditor
    
    -- æ·»åŠ å¤é€‰æ¡†çŠ¶æ€æ”¹å˜äº‹ä»¶
    on lvBones ItemChecked arg do (
        updateBoneCount()
    )
    
    -- æ–°å¢ç­›é€‰æŒ‰é’®äº‹ä»¶
    on btnBones pressed do (
        refreshBoneList filterType:"Bones"
        lblStatus.text = "æ˜¾ç¤ºæ ‡å‡†éª¨éª¼"
    )
    on btnBipeds pressed do (
        refreshBoneList filterType:"Bipeds"
        lblStatus.text = "æ˜¾ç¤ºBipedéª¨éª¼"
    )
    on btnPoints pressed do (
        refreshBoneList filterType:"Points"
        lblStatus.text = "æ˜¾ç¤ºPointè¾…åŠ©å¯¹è±¡"
    )
    on btnDummies pressed do (
        refreshBoneList filterType:"Dummies"
        lblStatus.text = "æ˜¾ç¤ºDummyè™šæ‹Ÿä½“"
    )
    on btnAll pressed do (
        refreshBoneList filterType:"All"
        lblStatus.text = "æ˜¾ç¤ºæ‰€æœ‰ç±»å‹"
    )
    
    -- æ–°å¢åŒæ­¥æŒ‰é’®äº‹ä»¶
    on btnSyncSelection pressed do (
        lblStatus.text = "æ­£åœ¨åŒæ­¥é€‰æ‹©..."
        syncSelectionToXAFList()
        lblStatus.text = "é€‰æ‹©å·²åŒæ­¥åˆ°åˆ—è¡¨"
    )
    on btnSyncSelectionSet pressed do (
        lblStatus.text = "æ­£åœ¨åŒæ­¥é€‰æ‹©é›†..."
        syncSelectionSetToXAFList()
        lblStatus.text = "é€‰æ‹©é›†å·²åŒæ­¥åˆ°åˆ—è¡¨"
    )
)

-- è§’è‰²æ˜ å°„ç®¡ç†å¯¹è¯æ¡†
rollout rolCharacterMapping "è§’è‰²åç§°æ˜ å°„" width:300 height:300 (
    listbox lbMappings "å½“å‰æ˜ å°„:" height:10 width:280
    edittext edtLocal "æœ¬åœ°åç§°:" width:280
    edittext edtEngine "å¼•æ“åç§°:" width:280
    button btnAdd "æ·»åŠ /æ›´æ–°" width:80 across:2
    button btnRemove "åˆ é™¤" width:80
    button btnClose "å…³é—­" width:80 align:#center offset:[0,10]
    
    fn refreshList = (
        lbMappings.items = for map in g_characterMappings collect map.name + " -> " + map.dir
    )
    
    on rolCharacterMapping open do (
        refreshList()
    )
    
    on btnAdd pressed do (
        if edtLocal.text != "" and edtEngine.text != "" do (
            -- æ›´æ–°æˆ–æ·»åŠ æ˜ å°„
            local found = false
            for i in g_characterMappings do (
                if i.name == edtLocal.text do (
                    i.dir = edtEngine.text
                    found = true
                    exit
                )
            )
            
            if not found do (
                append g_characterMappings (CharacterMapping name:edtLocal.text dir:edtEngine.text)
            )
            
            -- ä¿å­˜åˆ°INI
            setINISetting g_characterMappingPath "Mappings" "Count" (g_characterMappings.count as string)
            for i = 1 to g_characterMappings.count do (
                setINISetting g_characterMappingPath ("Mapping" + i as string) "Local" g_characterMappings[i].name
                setINISetting g_characterMappingPath ("Mapping" + i as string) "Engine" g_characterMappings[i].dir
            )
            
            refreshList()
            edtLocal.text = ""
            edtEngine.text = ""
        )
    )
    
    on btnRemove pressed do (
        if lbMappings.selection > 0 do (
            deleteItem g_characterMappings lbMappings.selection
            refreshList()
            
            -- æ›´æ–°INI
            setINISetting g_characterMappingPath "Mappings" "Count" (g_characterMappings.count as string)
            for i = 1 to g_characterMappings.count do (
                setINISetting g_characterMappingPath ("Mapping" + i as string) "Local" g_characterMappings[i].name
                setINISetting g_characterMappingPath ("Mapping" + i as string) "Engine" g_characterMappings[i].dir
            )
        )
    )
    
    on btnClose pressed do (
        destroyDialog rolCharacterMapping
    )
)
----------------------------------------------------------------
--  ==============================-rollout-æ‰¹é‡æ–‡ä»¶æ”¹åå·¥å…·--åŒºåŸŸ-================================
-- æ‰¹é‡æ–‡ä»¶æ”¹åå·¥å…· Rollout
rollout RenameToolRollout "æ‰¹é‡æ–‡ä»¶æ”¹åç¥âššå‰‘ğŸ—¡ï¸Batch Renameâ€‹â€‹ Tool_V1.01" width:1000 height:780
(
    -- UI æ§ä»¶å®šä¹‰
    group "è·¯å¾„è®¾ç½®" 
    (
        edittext edtCurrentPath "å½“å‰è·¯å¾„:" width:690 height:18 labelOnTop:true align:#left across:3
        button btnOpenExportPath "æ‰“å¼€æ–‡ä»¶å¤¹" width:100 height:20 align:#center offset:[300,18] toolTip:"æ‰“å¼€å½“å‰ç›®å½•æ–‡ä»¶å¤¹"
        button btnSyncPath "åŒæ­¥ä¸»æ’ä»¶è·¯å¾„" width:100 height:20 align:#right offset:[0,18] toolTip:"ä»ä¸»æ’ä»¶åŒæ­¥å½“å‰è·¯å¾„" tooltip:"åŒæ­¥ä¸»æ’ä»¶çš„åˆ—è¡¨æ–‡ä»¶"
    )
        
    group "æ”¹åè®¾ç½®" 
    (
        edittext edtSuffix "æ·»åŠ åç¼€:" width:200 across:2 labelOnTop:false offset:[-5,0] tooltip:"é»˜è®¤è‡ªåŠ¨æ·»åŠ æ–‡ä»¶åç¼€ _ "
        button btnAddSuffix "æ‰§è¡Œåç¼€ä¿®æ”¹" width:100 height:22 offset:[-370,-2] align:#center tooltip:"å¼€å§‹å¤„ç†/ä¿®æ”¹æ–‡ä»¶åç¼€"
        
        edittext edtFindText "æŸ¥æ‰¾æ–‡æœ¬:" width:200 across:2 labelOnTop:false offset:[-5,0]
        edittext edtReplaceText "æ›¿æ¢ä¸º:" width:200 labelOnTop:false offset:[-250,-2]
        button btnReplace "æ›¿æ¢æ–‡æœ¬" width:80 height:22 offset:[-128,-2] tooltip:"å¼€å§‹å¤„ç†/æ›¿æ¢æ–‡ä»¶åç§°å­—ç¬¦"
        
        button btnRevert "æ¢å¤å‘½å" width:100 height:30 offset:[0,5] tooltip:"ä»é»˜è®¤å¤‡ä»½çš„æ–‡ä»¶è·å–æ–‡ä»¶åŸå§‹åç§°å¹¶æ¢å¤"
        
        --button btnSortByExtension "æŒ‰æ‰©å±•åæ’åº" width:100 height:22 offset:[10,0] tooltip:"æŒ‰æ–‡ä»¶æ‰©å±•åæ’åºåˆ—è¡¨" 
        
        button btnCleanBackup "æ¸…ç†å¤‡ä»½" width:85 height:22 tooltip:"æ¸…ç†æ‰€æœ‰å¤‡ä»½æ–‡ä»¶"
        
        button btnBackup "å¤‡ä»½æ–‡ä»¶" width:80 height:22 across:3 offset:[-50,0] tooltip:"é¦–æ¬¡ä¿®æ”¹è‡ªåŠ¨å¤‡ä»½"
        
        button btnRefreshList "åˆ·æ–°åˆ—è¡¨" width:70 height:22 offset:[0,0]
        button btnClearList "æ¸…ç©ºåˆ—è¡¨" width:80 height:22 offset:[50,0] tooltip:"æ¸…ç©ºåˆ—è¡¨ClearAll"
    )
    
    group "æ–‡ä»¶åˆ—è¡¨" 
    (
        dotNetControl lvFiles "System.Windows.Forms.ListView" width:960 height:350 offset:[-5,0]
        button btnBrowse "æµè§ˆæ–‡ä»¶å¤¹" width:100 height:22 across:3 offset:[-50,0] tooltip:"æµè§ˆå¹¶é€‰æ‹©éœ€è¦çš„æ–‡ä»¶å¤¹ç›®å½•"
        button btnAddFiles "æ·»åŠ æ–‡ä»¶" width:100 height:22 offset:[0,0] tooltip:"æ·»åŠ éœ€è¦æ”¹åçš„æ–‡ä»¶åˆ°åˆ—è¡¨"
        button btnRemoveSelected "ç§»é™¤é€‰ä¸­" width:100 height:22 offset:[50,0] tooltip:"ä»…ä»åˆ—è¡¨ç§»é™¤/éçœŸå®åˆ é™¤æ–‡ä»¶"
    )
    
    group "çŠ¶æ€ä¿¡æ¯" 
    (
        label lblStatus "å‡†å¤‡å°±ç»ª..." align:#left
        progressbar pbRename width:960 height:20
    )
    
    label edtUserExPath "Ë–â© â„³ â€ Íœâ™¡ï¸ â€ºãƒ½(â—Â´âˆ€â—)ï¾‰`ä¿®æ”¹-åˆ—è¡¨æ–‡ä»¶â‡åç¼€oræ›¿æ¢/åç§°-renamedFilesï¼" offset:[0,0] width:980 align:#center
    
    -- å†…éƒ¨å˜é‡
    local originalFiles = #()
    local renamedFiles = #()
    local backupPath = ""
    local mainPlugin = undefined
    local backupCreated = false
        
        
    -- ç§»é™¤é€‰ä¸­æ–‡ä»¶ / éçœŸå®åˆ é™¤ /ç§»é™¤é€‰ä¸­çš„åˆ—è¡¨æ–‡ä»¶
    fn removeSelectedItemsFromList = 
        (
            local selItems = lvFiles.SelectedItems
            if selItems.Count == 0 do return false
            
            for i = selItems.Count - 1 to 0 by -1 do
            (
                local item = selItems.Item[i]
                local index = lvFiles.Items.IndexOf(item)
                
                deleteItem originalFiles (index + 1)
                deleteItem renamedFiles (index + 1)
                lvFiles.Items.Remove(item)
            )
            -- æ›´æ–°æ–‡ä»¶è®¡æ•°
            local fileCount = 0
            for i = 0 to (lvFiles.Items.Count - 1) do
            (
                if lvFiles.Items.Item[i].SubItems.Item[2].Text != "æ–‡ä»¶å¤¹" do fileCount += 1
            )
            --lblStatus.text = "å·²ç§»é™¤ï¼" 
            lblStatus.text = "å½“å‰åˆ—è¡¨å·²åŠ è½½" + (lvFiles.Items.Count as string) + " ä¸ªæ–‡ä»¶"
            true
        )
    
    -- æ‰“å¼€é€‰ä¸­æ–‡ä»¶æ‰€åœ¨æ–‡ä»¶å¤¹
    fn openSelectedFileFolder = 
    (
        local selItems = lvFiles.SelectedItems
        if selItems.Count == 0 do 
        (
            messageBox "è¯·å…ˆé€‰æ‹©æ–‡ä»¶!" title:"æç¤º"
            return false
        )
        
        for i=0 to selItems.Count-1 do (
            local itemPath = selItems.Item[i].Tag as String
            if doesFileExist itemPath or doesDirectoryExist itemPath then (
                shellLaunch "explorer.exe" ("/select," + itemPath)
            )
        )
        true
    )
    -- åˆ é™¤é€‰ä¸­æ–‡ä»¶ / ç³»ç»Ÿæ–‡ä»¶ çœŸå® åˆ é™¤ 
        fn deleteSelectedFiles = 
        (
            local selItems = lvFiles.SelectedItems
            if selItems.Count == 0 do 
            (
                messageBox "è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶!" title:"æç¤º"
                return false
            )
            
            -- æ„å»ºæ–‡ä»¶åˆ—è¡¨å­—ç¬¦ä¸²
            local fileList = ""
            for i=0 to selItems.Count-1 do (
                local path = selItems.Item[i].Tag as String
                fileList += filenameFromPath path + "\n"
            )
            
            -- ç¡®è®¤å¯¹è¯æ¡†
            local msg = "ç¡®å®šæ°¸ä¹…åˆ é™¤ä»¥ä¸‹é¡¹ç›®ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼\n\n" + fileList
            if not (queryBox msg title:"å±é™©æ“ä½œ" beep:true) do return false
            
            -- åˆ é™¤æ‰€æœ‰é€‰ä¸­çš„é¡¹ç›®
            local deletedItems = #()
            local failedItems = #()
            
            for i=selItems.Count-1 to 0 by -1 do (
                local path = selItems.Item[i].Tag as String
                local isNetworkPath = matchPattern path pattern:"\\\\*"
                local success = false
                local isDir = doesDirectoryExist path
                
                try (
                    if isDir then (
                        -- åˆ é™¤æ–‡ä»¶å¤¹
                        if isNetworkPath then (
                            -- æœåŠ¡å™¨è·¯å¾„ä½¿ç”¨DOSå‘½ä»¤
                            local cmd = "cmd /c rmdir /s /q \"" + path + "\""
                            hiddenDOSCommand cmd
                        ) else (
                            -- æœ¬åœ°è·¯å¾„ä½¿ç”¨.NETæ–¹æ³•
                            local dir = dotNetClass "System.IO.Directory"
                            dir.Delete path true
                        )
                    ) else (
                        -- åˆ é™¤æ–‡ä»¶
                        if isNetworkPath then (
                            -- æœåŠ¡å™¨è·¯å¾„ä½¿ç”¨DOSå‘½ä»¤
                            local cmd = "cmd /c del /f /q \"" + path + "\""
                            hiddenDOSCommand cmd
                        ) else (
                            deleteFile path
                        )
                    )
                    
                    -- éªŒè¯åˆ é™¤
                    if (isDir and not doesDirectoryExist path) or (not isDir and not doesFileExist path) then (
                        success = true
                    )
                ) catch (
                    success = false
                )
                
                -- è®°å½•ç»“æœ
                if success then (
                    append deletedItems path
                    lvFiles.Items.Remove(selItems.Item[i])
                ) else (
                    append failedItems path
                )
            )
            
            -- æ˜¾ç¤ºæ“ä½œç»“æœ
            local resultMsg = ""
            if deletedItems.count > 0 then (
                resultMsg = "å·²åˆ é™¤ " + (deletedItems.count as string) + " ä¸ªé¡¹ç›®\n"
            )
            if failedItems.count > 0 then (
                resultMsg += "åˆ é™¤å¤±è´¥ " + (failedItems.count as string) + " ä¸ªé¡¹ç›®:\n"
                for i=1 to (amin 5 failedItems.count) do (  -- æœ€å¤šæ˜¾ç¤º5ä¸ªå¤±è´¥é¡¹
                    resultMsg += failedItems[i] + "\n"
                )
                if failedItems.count > 5 do resultMsg += "......\n"
            )
            
            if resultMsg != "" do messageBox resultMsg title:"åˆ é™¤ç»“æœ"
            lblStatus.text = resultMsg
            true
        )
        
-- åˆå§‹åŒ–å‡½æ•°
fn initListView = 
(
    lvFiles.View = (dotNetClass "System.Windows.Forms.View").Details
    lvFiles.FullRowSelect = true
    lvFiles.MultiSelect = true
    lvFiles.GridLines = true
    lvFiles.HideSelection = false
    lvFiles.AllowDrop = true
    
    -- æ·»åŠ åˆ—
    lvFiles.Columns.Add "åŸæ–‡ä»¶å" 380
    lvFiles.Columns.Add "æ–°æ–‡ä»¶å" 400
    lvFiles.Columns.Add "å¤„ç†çŠ¶æ€" 90
    lvFiles.Columns.Add "æ–‡ä»¶ç±»å‹" 100
    
    -- è®¾ç½®å³é”®èœå•
    local contextMenu = dotNetObject "System.Windows.Forms.ContextMenuStrip"
    local deleteItem = contextMenu.Items.Add("âŒ åˆ é™¤é€‰ä¸­æ–‡ä»¶")
    local openFolderItem = contextMenu.Items.Add("ğŸ”œâ†’ æ‰“å¼€æ‰€åœ¨æ–‡ä»¶å¤¹")
    
    -- ä½¿ç”¨æ­£ç¡®çš„å‡½æ•°å¼•ç”¨
    dotNet.addEventHandler deleteItem "Click" (fn s e = (deleteSelectedFiles()))
    dotNet.addEventHandler openFolderItem "Click" (fn s e = (openSelectedFileFolder()))
    
    lvFiles.ContextMenuStrip = contextMenu
)
    -- åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„å¤‡ä»½ç›®å½•
    fn createBackupDir = 
    (
        local timeArray = getLocalTime()
        local dateStamp = formattedPrint timeArray[1] format:"04d" +  
                          formattedPrint timeArray[2] format:"02d" +   
                          formattedPrint timeArray[4] format:"02d"
        backupPath = (getDir #temp) + "\\RenameBackup_" + dateStamp + "\\"
        makeDir backupPath all:true
        return backupPath
    )
    
    -- ç¡®ä¿å¤‡ä»½ç›®å½•å­˜åœ¨
    fn ensureBackupDir = 
    (
        if not backupCreated do
        (
            backupPath = createBackupDir()
            backupCreated = true
            format "[å¤‡ä»½ç›®å½•] å·²åˆ›å»º: %\n" backupPath
        )
        backupPath
    )
    
-- æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º - ç¡®ä¿åªæ˜¾ç¤ºåŸå§‹æ–‡ä»¶å’Œæœ€æ–°ä¿®æ”¹çš„æ–‡ä»¶
fn updateFileList = 
(
    lvFiles.Items.Clear()
    renamedFiles = #() -- æ¸…ç©ºé‡å‘½åæ–‡ä»¶æ•°ç»„
    
    for i = 1 to originalFiles.count do
    (
        local filePath = originalFiles[i]
        if doesFileExist filePath then
        (
            local fileName = filenameFromPath filePath
            local fileType = getFilenameType filePath
            
            local li = dotNetObject "System.Windows.Forms.ListViewItem" fileName
            li.SubItems.Add(fileName)  -- æ–°æ–‡ä»¶ååˆå§‹ä¸åŸæ–‡ä»¶åç›¸åŒ
            li.SubItems.Add("æœªå¤„ç†")
            li.SubItems.Add(fileType)
            li.Tag = filePath
            
            lvFiles.Items.Add(li)
            append renamedFiles fileName -- åˆå§‹åŒ–ä¸ºåŸå§‹æ–‡ä»¶å
        )
    )
    
    -- æ›´æ–°æ–‡ä»¶è®¡æ•°
    local fileCount = 0
    for i = 0 to (lvFiles.Items.Count - 1) do
    (
        if lvFiles.Items.Item[i].SubItems.Item[2].Text != "æ–‡ä»¶å¤¹" do fileCount += 1
    )
    
    lblStatus.text = "å·²åŠ è½½ " + (fileCount as string) + " ä¸ªæ–‡ä»¶"
)
    
    fn OpenExportFromRenameTool = 
    (
        local path = edtCurrentPath.text
        if doesDirectoryExist path then
        (
            ShellLaunch "explorer.exe" path
        )
        else
        (
            messageBox "å½“å‰è·¯å¾„ä¸å­˜åœ¨ï¼" title:"é”™è¯¯"
        )
    )
    
    fn clearList = 
    (
        originalFiles = #()
        renamedFiles = #()
        lvFiles.Items.Clear()
        lblStatus.text = "åˆ—è¡¨å·²æ¸…ç©ºï¼Œ0 ä¸ªæ–‡ä»¶"
    )
    -- ä»ä¸»æ’ä»¶åŒæ­¥æ–‡ä»¶
    fn syncFilesFromMainPlugin = 
    (
        if isDialogVisible AutoExportTool_Pro and isProperty AutoExportTool_Pro #model_files_array then
        (
            mainPlugin = AutoExportTool_Pro
            originalFiles = for f in mainPlugin.model_files_array where not matchPattern f pattern:"*[DIR]*" collect f
            
            -- åŒæ­¥è·¯å¾„
            if isProperty mainPlugin #edtExportPath then
            (
                edtCurrentPath.text = mainPlugin.edtExportPath.text
            )
            
            updateFileList()
        )
        else
        (
            messageBox "ä¸»æ’ä»¶æœªæ‰“å¼€æˆ–ä¸å¯ç”¨!" title:"è­¦å‘Š"
        )
    )
    
    -- ä»å½“å‰è·¯å¾„åŠ è½½æ–‡ä»¶
    fn loadFilesFromCurrentPath = 
    (
        if edtCurrentPath.text != "" and doesDirectoryExist edtCurrentPath.text then
        (
            originalFiles = #()
            local fileTypes = #("*.max", "*.fbx", "*.bip", "*.xaf", "*.ms", "*.mse")
            
            for ft in fileTypes do
            (
                local files = getFiles (edtCurrentPath.text + "\\" + ft)
                join originalFiles files
            )
            
            updateFileList()
            
            -- æ›´æ–°æ–‡ä»¶è®¡æ•°
            local fileCount = 0
            for i = 0 to (lvFiles.Items.Count - 1) do
            (
                if lvFiles.Items.Item[i].SubItems.Item[2].Text != "æ–‡ä»¶å¤¹" do fileCount += 1
            )
            
            lblStatus.text = "å·²åŠ è½½ " + (fileCount as string) + " ä¸ªæ–‡ä»¶"
        )
        else
        (
            messageBox "å½“å‰è·¯å¾„æ— æ•ˆæˆ–ä¸å­˜åœ¨!" title:"é”™è¯¯"
        )
    )
    
-- æ·»åŠ åç¼€å¤„ç† - å§‹ç»ˆåŸºäºåŸå§‹æ–‡ä»¶å
fn addSuffix = 
(
    local suffix = edtSuffix.text
    if suffix == "" do 
    (
        messageBox "è¯·è¾“å…¥åç¼€!" title:"æç¤º"
        return false
    )
    
    -- ç¡®ä¿å¤‡ä»½ç›®å½•å­˜åœ¨
    ensureBackupDir()
    
    local successCount = 0
    pbRename.value = 0
    
    for i = 0 to (lvFiles.Items.Count - 1) do
    (
        local item = LvFiles.Items.Item[i]
        local originalPath = item.Tag as String
        local originalName = item.Text  -- å§‹ç»ˆä½¿ç”¨åŸå§‹æ–‡ä»¶å
        
        -- ä»åŸå§‹æ–‡ä»¶åæ„å»ºæ–°åç§°ï¼ˆä¸åŸºäºå½“å‰æ˜¾ç¤ºçš„åç§°ï¼‰
        local baseName = getFilenameFile originalName
        local fileType = getFilenameType originalPath
        local newName = baseName + "_" + suffix + fileType
        local dirPath = getFilenamePath originalPath
        local newPath = dirPath + newName
        
        try
        (
            -- å¤‡ä»½åŸæ–‡ä»¶ï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡æ“ä½œæ—¶å¤‡ä»½ï¼‰
            if not doesFileExist (backupPath + filenameFromPath originalPath) do
            (
                local backupFile = backupPath + filenameFromPath originalPath
                copyFile originalPath backupFile
            )
            
            -- æ‰§è¡Œé‡å‘½å
            renameFile originalPath newPath
            
            -- æ›´æ–°åˆ—è¡¨æ˜¾ç¤º
            item.SubItems.Item[1].Text = newName
            item.SubItems.Item[2].Text = "æˆåŠŸ"
            successCount += 1
            
            -- æ›´æ–°é‡å‘½åæ–‡ä»¶æ•°ç»„
            renamedFiles[i+1] = newName
            
            -- æ›´æ–°ä¸»æ’ä»¶åˆ—è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if mainPlugin != undefined and isProperty mainPlugin #model_files_array then
            (
                local index = findItem mainPlugin.model_files_array originalPath
                if index > 0 do
                (
                    mainPlugin.model_files_array[index] = newPath
                )
            )
        )
        catch
        (
            item.SubItems.Item[2].Text = "å¤±è´¥: " + (getCurrentException())
        )
        
        pbRename.value = i + 1  -- æ›´æ–°è¿›åº¦æ¡
        windows.processPostedMessages()  -- ç¡®ä¿UIæ›´æ–°
    )
    
    lblStatus.text = "æ·»åŠ åç¼€å®Œæˆ! æˆåŠŸ: " + (successCount as string) + " / " + (LvFiles.Items.Count as string)
    true
)
    
-- æ›¿æ¢æ–‡æœ¬å¤„ç† - ä¹ŸåŸºäºåŸå§‹æ–‡ä»¶å
fn replaceText = 
(
    local findText = edtFindText.text
    local replaceText = edtReplaceText.text
    if findText == "" do 
    (
        messageBox "è¯·è¾“å…¥è¦æŸ¥æ‰¾çš„æ–‡æœ¬!" title:"æç¤º"
        return false
    )
    
    -- ç¡®ä¿å¤‡ä»½ç›®å½•å­˜åœ¨
    ensureBackupDir()
    
    local successCount = 0
    pbRename.value = 0
    
    for i = 0 to (LvFiles.Items.Count - 1) do
    (
        local item = LvFiles.Items.Item[i]
        local originalPath = item.Tag as String
        local originalName = item.Text  -- ä½¿ç”¨åŸå§‹æ–‡ä»¶å
        
        if findString originalName findText != undefined then
        (
            local newName = substituteString originalName findText replaceText
            local dirPath = getFilenamePath originalPath
            local newPath = dirPath + newName
            
            try
            (
                -- å¤‡ä»½åŸæ–‡ä»¶ï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡æ“ä½œæ—¶å¤‡ä»½ï¼‰
                if not doesFileExist (backupPath + filenameFromPath originalPath) do
                (
                    local backupFile = backupPath + filenameFromPath originalPath
                    copyFile originalPath backupFile
                )
                
                -- æ‰§è¡Œé‡å‘½å
                renameFile originalPath newPath
                
                item.SubItems.Item[1].Text = newName
                item.SubItems.Item[2].Text = "æˆåŠŸ"
                successCount += 1
                
                -- æ›´æ–°é‡å‘½åæ–‡ä»¶æ•°ç»„
                renamedFiles[i+1] = newName
                
                -- æ›´æ–°ä¸»æ’ä»¶åˆ—è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if mainPlugin != undefined and isProperty mainPlugin #model_files_array then
                (
                    local index = findItem mainPlugin.model_files_array originalPath
                    if index > 0 do
                    (
                        mainPlugin.model_files_array[index] = newPath
                    )
                )
            )
            catch
            (
                item.SubItems.Item[2].Text = "å¤±è´¥: " + (getCurrentException())
            )
        )
        else
        (
            item.SubItems.Item[2].Text = "æœªæ‰¾åˆ°åŒ¹é…"
        )
        
        pbRename.value = i + 1
    )
    
    lblStatus.text = "æ›¿æ¢æ–‡æœ¬å®Œæˆ! æˆåŠŸ: " + (successCount as string) + " / " + (LvFiles.Items.Count as string)
    true
)
    
    
-- æ¸…ç†å¤‡ä»½æ–‡ä»¶ - åªä¿ç•™åŸå§‹æ–‡ä»¶å¤‡ä»½

fn cleanBackupFiles = 
(
    try
    (
        -- å¢å¼ºè·¯å¾„éªŒè¯
        local isValidBackupPath = (
            backupPath != undefined and 
            backupPath != "" and 
            doesDirectoryExist backupPath
        )
        
        if not isValidBackupPath do
        (
            messageBox "æ²¡æœ‰å¯æ¸…ç†çš„å¤‡ä»½æˆ–å¤‡ä»½è·¯å¾„æ— æ•ˆ!" title:"æç¤º"
            return false
        )
        
        -- è·å–å¤‡ä»½ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
        local backupFiles = getFiles (backupPath + "\\*")
        
        if backupFiles.count == 0 do
        (
            messageBox "å¤‡ä»½ç›®å½•ä¸ºç©ºï¼Œæ²¡æœ‰æ–‡ä»¶éœ€è¦æ¸…ç†!" title:"æç¤º"
            return false
        )
        
        local deletedCount = 0
        
        for f in backupFiles do
        (
            try
            (
                deleteFile f
                deletedCount += 1
            )
            catch
            (
                format "[åˆ é™¤æ–‡ä»¶å¤±è´¥] %: %\n" f (getCurrentException())
            )
        )
        
        -- åˆ é™¤å¤‡ä»½ç›®å½•
        try
        (
            deleteDir backupPath
        )
        catch
        (
            format "[åˆ é™¤ç›®å½•å¤±è´¥] %: %\n" backupPath (getCurrentException())
            -- å³ä½¿ç›®å½•åˆ é™¤å¤±è´¥ï¼Œä¹Ÿç»§ç»­æ‰§è¡Œ
        )
        
        -- æ›´æ–°çŠ¶æ€
        backupPath = ""
        backupCreated = false
        
        -- ç¡®ä¿UIæ›´æ–°
        lblStatus.text = "å¤‡ä»½å·²æ¸…ç†, åˆ é™¤äº† " + (deletedCount as string) + " ä¸ªå¤‡ä»½æ–‡ä»¶"
        windows.processPostedMessages() -- å¼ºåˆ¶UIåˆ·æ–°
        
        -- æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
        messageBox ("å¤‡ä»½æ–‡ä»¶å·²æˆåŠŸæ¸…ç†, åˆ é™¤äº† " + (deletedCount as string) + " ä¸ªå¤‡ä»½æ–‡ä»¶") title:"å®Œæˆ"
        
        -- åˆ·æ–°å³é”®èœå•ç»‘å®š
        refreshContextMenu()
        
        true
    )
    catch
    (
        --local errMsg = "æ¸…ç†å¤‡ä»½å¤±è´¥: " + (getCurrentException())
        format "%\n" errMsg
        --messageBox errMsg title:"é”™è¯¯"
        false
    )
)
    
-- æ¢å¤å‘½å - ä»å¤‡ä»½æ¢å¤åŸå§‹æ–‡ä»¶
fn revertNames = 
(
    if backupPath == "" or not doesDirectoryExist backupPath do
    (
        messageBox "æ²¡æœ‰æ‰¾åˆ°å¤‡ä»½æ–‡ä»¶!" title:"é”™è¯¯"
        return false
    )
    
    pbRename.value = 0
    local successCount = 0
    
    for i = 0 to (LvFiles.Items.Count - 1) do
    (
        local item = LvFiles.Items.Item[i]
        local currentPath = item.Tag as String
        local originalName = item.Text
        local dirPath = getFilenamePath currentPath
        
        local backupFile = backupPath + originalName
        
        try
        (
            if doesFileExist backupFile do
            (
                -- æ¢å¤æ–‡ä»¶
                deleteFile currentPath
                copyFile backupFile currentPath
                
                item.SubItems.Item[1].Text = originalName
                item.SubItems.Item[2].Text = "å·²æ¢å¤"
                successCount += 1
                
                -- æ›´æ–°é‡å‘½åæ–‡ä»¶æ•°ç»„
                renamedFiles[i+1] = originalName
                
                -- æ›´æ–°ä¸»æ’ä»¶åˆ—è¡¨
                if mainPlugin != undefined and isProperty mainPlugin #model_files_array then
                (
                    local index = findItem mainPlugin.model_files_array currentPath
                    if index > 0 do
                    (
                        mainPlugin.model_files_array[index] = currentPath
                    )
                )
            )
        )
        catch
        (
            item.SubItems.Item[2].Text = "æ¢å¤å¤±è´¥: " + (getCurrentException())
        )
        
        pbRename.value = i + 1
    )
    
    lblStatus.text = "æ¢å¤å®Œæˆ! æˆåŠŸæ¢å¤: " + (successCount as string) + " ä¸ªæ–‡ä»¶"
    
    -- è¯¢é—®æ˜¯å¦æ¸…ç†å¤‡ä»½
    if successCount > 0 and (queryBox "æ˜¯å¦æ¸…ç†å¤‡ä»½æ–‡ä»¶?" title:"æ¸…ç†å¤‡ä»½") do
    (
        cleanBackupFiles()
    )
    true
)
    
     
    --æ’åºåŠŸèƒ½ä¼˜åŒ– / å¤‡ç”¨
    fn sortByExtension = 
    (
        local items = for i=0 to (lvFiles.Items.Count-1) collect lvFiles.Items.Item[i]
        
        local folders = #()
        local files = #()
        
        -- åˆ†ç¦»æ–‡ä»¶å¤¹å’Œæ–‡ä»¶
        for item in items do
        (
            local path = item.Tag as String
            if matchPattern path pattern:"*[DIR]*" or doesDirectoryExist path then
                append folders item
            else
                append files item
        )
        
        -- å¯¹æ–‡ä»¶å¤¹æŒ‰åç§°æ’åº
        fn folderCompare a b = (
            local nameA = a.SubItems.Item[1].Text
            local nameB = b.SubItems.Item[1].Text
            case of (
                (nameA < nameB): -1
                (nameA > nameB): 1
                default: 0
            )
        )
        
        -- å¯¹æ–‡ä»¶æŒ‰æ‰©å±•åæ’åº
        fn fileCompare a b = (
            local pathA = a.Tag as String
            local pathB = b.Tag as String
            local extA = toLower (getFilenameType pathA)
            local extB = toLower (getFilenameType pathB)
            
            -- å…ˆæŒ‰æ‰©å±•åæ’åº
            if extA != extB then (
                case of (
                    (extA < extB): -1
                    (extA > extB): 1
                )
            ) 
            -- æ‰©å±•åç›¸åŒåˆ™æŒ‰æ–‡ä»¶åæ’åº
            else (
                local nameA = filenameFromPath pathA
                local nameB = filenameFromPath pathB
                case of (
                    (nameA < nameB): -1
                    (nameA > nameB): 1
                    default: 0
                )
            )
        )
        
        -- æ’åº
        qsort folders folderCompare
        qsort files fileCompare
        
        -- æ¸…ç©ºå¹¶é‡æ–°æ·»åŠ é¡¹ç›®
        lvFiles.BeginUpdate()
        lvFiles.Items.Clear()
        
        for folder in folders do lvFiles.Items.Add folder
        for file in files do lvFiles.Items.Add file
        
        lvFiles.EndUpdate()
        lblStatus.text = "å·²æŒ‰æ–‡ä»¶æ‰©å±•åæ’åº"
    )
    -- æµè§ˆæ–‡ä»¶å¤¹
    fn browseFolder = 
    (
        local initialDir = if edtCurrentPath.text != "" then edtCurrentPath.text else (getDir #scene)
        local folderPath = getSavePath caption:"é€‰æ‹©æ–‡ä»¶å¤¹" initialDir:initialDir
        
        if folderPath != undefined do
        (
            edtCurrentPath.text = folderPath
            loadFilesFromCurrentPath()
        )
    )
    
    -- æ·»åŠ æ–‡ä»¶
    fn addFiles = 
    (
        local fileTypes = "All Supported Types|*.max;*.fbx;*.bip;*.xaf;*.ms;*.mse|Max Files (*.max)|*.max|FBX Files (*.fbx)|*.fbx|BIP Files (*.bip)|*.bip|XAF Files (*.xaf)|*.xaf|Script Files (*.ms)|*.ms|Encrypted Scripts (*.mse)|*.mse"
        local files = getOpenFileName caption:"é€‰æ‹©æ–‡ä»¶" types:fileTypes multi:true
        
        if files != undefined do
        (
            -- å¤„ç†å•ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶
            if classOf files == String then
            (
                append originalFiles files
            )
            else if classOf files == Array then
            (
                for f in files do append originalFiles f
            )
            
            updateFileList()
            
            -- æ›´æ–°æ–‡ä»¶è®¡æ•°
            local fileCount = 0
            for i = 0 to (lvFiles.Items.Count - 1) do
            (
                if lvFiles.Items.Item[i].SubItems.Item[2].Text != "æ–‡ä»¶å¤¹" do fileCount += 1
            )
            
            lblStatus.text = "å·²æ·»åŠ  " + (files.count as string) + " ä¸ªæ–‡ä»¶ï¼Œæ€»å…± " + (fileCount as string) + " ä¸ªæ–‡ä»¶"
        )
    )
    
    -- åˆ›å»ºå¤‡ä»½ï¼ˆä½¿ç”¨ä¸»æ’ä»¶çš„æ–‡ä»¶å½’æ¡£é€»è¾‘ï¼‰
    fn createBackupFiles = 
    (
        if originalFiles.count == 0 do
        (
            messageBox "æ²¡æœ‰æ–‡ä»¶éœ€è¦å¤‡ä»½!" title:"æç¤º"
            return false
        )
        
        -- åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„å¤‡ä»½ç›®å½•
        local timeArray = getLocalTime()
        local dateStamp = formattedPrint timeArray[1] format:"04d" +  
                          formattedPrint timeArray[2] format:"02d" +   
                          formattedPrint timeArray[4] format:"02d"
        
        -- ä½¿ç”¨ç»Ÿä¸€çš„ä¸´æ—¶å¤‡ä»½ç›®å½•                  
        local backupDir = (getDir #temp) + "\\RenameBackup_" + dateStamp + "\\"
        makeDir backupDir all:true
        
        local successCount = 0
        
        for i = 1 to originalFiles.count do
        (
            local filePath = originalFiles[i]
            if doesFileExist filePath then
            (
                local fileName = filenameFromPath filePath
                local targetPath = backupDir + fileName
                
                try
                (
                    copyFile filePath targetPath
                    successCount += 1
                )
                catch
                (
                    format "[å¤‡ä»½å¤±è´¥] %\n" filePath
                )
            )
        )
        
        lblStatus.text = "å¤‡ä»½å®Œæˆ! æˆåŠŸå¤‡ä»½ " + (successCount as string) + " / " + (originalFiles.count as string) + " ä¸ªæ–‡ä»¶åˆ°: " + backupDir
        ShellLaunch "explorer.exe" backupDir
        true
    )
    
    -- äº‹ä»¶å¤„ç†
    on RenameToolRollout open do
    (
        initListView()
        
        -- å®‰å…¨åœ°è·å–è·¯å¾„
        local mainPluginPath = ""
        if (isValidObj AutoExportTool_Pro) and (isDialogVisible AutoExportTool_Pro) and (isProperty AutoExportTool_Pro #edtExportPath) then
        (
            mainPluginPath = AutoExportTool_Pro.edtExportPath.text
        )
        else
        (
            mainPluginPath = getDir #scene
        )
        
        edtCurrentPath.text = mainPluginPath
    )
    on btnCleanBackup  pressed do cleanBackupFiles ()
    on btnSortByExtension pressed do sortByExtension()
    on btnOpenExportPath pressed do OpenExportFromRenameTool()
    on btnSyncPath pressed do syncFilesFromMainPlugin()
    on btnAddSuffix pressed do addSuffix()
    on btnReplace pressed do replaceText()
    on btnRevert pressed do revertNames()
    on btnBackup pressed do createBackupFiles()
    on btnRefreshList pressed do loadFilesFromCurrentPath()
    on btnClearList pressed do (originalFiles = #(); updateFileList())
    on btnBrowse pressed do browseFolder()
    on btnAddFiles pressed do addFiles()
    on btnRemoveSelected pressed do removeSelectedItemsFromList()
    
    -- æ‹–æ”¾æ”¯æŒ
    on lvFiles DragOver sender args do
    (
        args.Effect = args.Effect.Copy
    )
    
    on lvFiles DragDrop sender args do
    (
        local files = args.Data.GetData((dotNetClass "System.Windows.Forms.DataFormats").FileDrop)
        if files != undefined do
        (
            for f in files do
            (
                if doesFileExist f do
                (
                    append originalFiles f
                )
            )
            updateFileList()
        )
    )
)

--  ==============================-rollout-å¸¸ç”¨è·¯å¾„-åŒºåŸŸ-================================
-- è·¯å¾„æ·»åŠ å¯¹è¯æ¡†å®Œæ•´é€»è¾‘ / true
-- ========== ç›®å½•ç®¡ç†å¯¹è¯æ¡† ==========
rollout rolPathManager "è·¯å¾„ç®¡ç†" width:300 height:130 (
    
    edittext edtPathName "è·¯å¾„åç§°:" pos:[10,15] width:280 height:20
    edittext edtPathDir "ç›®å½•è·¯å¾„:" pos:[10,45] width:210 height:20 readOnly:true
    button btnBrowse "æµè§ˆ..." pos:[225,45] width:65 height:20
    button btnAdd "æ·»åŠ " pos:[10,75] width:135 height:25
    button btnCancel "å–æ¶ˆ" pos:[155,75] width:135 height:25
    label edtUserExPath "Ë–â© â„³ â€ Íœâ™¡ï¸ â€ºâ—•â€¿â—•æ·»åŠ -Add-å¸¸ç”¨è·¯å¾„â‡UserPathï¼" align:#center
    
    -- æµè§ˆæŒ‰é’®
    on btnBrowse pressed do (
        local initDir = if g_likedFolders.count > 0 then g_likedFolders[1].dir else getDir #scene
        local dir = getSavePath caption:"é€‰æ‹©ç›®å½•" initialDir:initDir
        if dir != undefined do (
            edtPathDir.text = pathConfig.normalizePath dir
        )
    )
    
    -- æ·»åŠ æŒ‰é’®
    on btnAdd pressed do (
        clearlistener()
        try (
            case of (
                (edtPathName.text == ""): (messageBox "åç§°ä¸èƒ½ä¸ºç©ºï¼" title:"é”™è¯¯")
                (edtPathDir.text == ""): (messageBox "è·¯å¾„ä¸èƒ½ä¸ºç©ºï¼" title:"é”™è¯¯")
                default: (
                    local newName = trimRight (trimLeft edtPathName.text)
                    local newDir = pathConfig.normalizePath edtPathDir.text
                    
                    if not doesDirectoryExist newDir do (
                        messageBox "è·¯å¾„ä¸å­˜åœ¨ï¼Œè¯·é€‰æ‹©æœ‰æ•ˆç›®å½•ï¼" title:"é”™è¯¯"
                        return undefined
                    )
                    
                    local exists = false
                    for f in g_likedFolders where (
                        stricmp f.name newName == 0 or 
                        (stricmp (pathConfig.normalizePath f.dir) newDir) == 0
                    ) do (exists = true; exit)
               
                    if not exists do (
                        append g_likedFolders (itemsFolder name:newName dir:newDir)
                        
                        -- ä½¿ç”¨ä¿®å¤åçš„ä¿å­˜å‡½æ•°
                        if saveConfig() do (
                            try (
                                -- åˆ·æ–°ä¸»ç•Œé¢ä¸‹æ‹‰åˆ—è¡¨
                                AutoExportTool_Pro.ddlLikedPaths.items = for f in g_likedFolders collect f.name
                                
                                -- è‡ªåŠ¨é€‰ä¸­æ–°æ·»åŠ çš„é¡¹
                                local newIndex = findItem AutoExportTool_Pro.ddlLikedPaths.items newName
                                if newIndex > 0 do (
                                    AutoExportTool_Pro.ddlLikedPaths.selection = newIndex
                                )
                                
                                destroydialog rolPathManager
                                try (destroydialog rolPathManager) catch ()
                            ) catch (
                                -- å¼‚å¸¸å¤„ç†ï¼šæ·»åŠ å¤±è´¥æ—¶è‡ªåŠ¨é‡å¯æ’ä»¶
                                local scriptPath = getSourceFileName()
                                local pluginDir = getFilenamePath scriptPath
                                append g_likedFolders (itemsFolder name:"FBX_MainScript_Pro" dir:pluginDir)
                                saveConfig()
                                destroyDialog AutoExportTool_Pro
                                fileIn scriptPath
                                createDialog AutoExportTool_Pro
                            )
                        )
                    )
                )
            )
        ) catch (
            format "[è·¯å¾„æ·»åŠ å¤±è´¥] %\n" (getCurrentException())
        )
    )
    
    on rolPathManager open do (
        try (
            if g_tempPathForManager != "" do (
                edtPathDir.text = g_tempPathForManager
                setFocus edtPathName
            )
        )
        catch (
            format "[è·¯å¾„ç®¡ç†åˆå§‹åŒ–é”™è¯¯] %\n" (getCurrentException())
        )
    )
    
    on rolPathManager close do (
        try (
            g_tempPathForManager = ""
            g_pathManagerDialogOpen = false
        ) catch ()
    )
    
    on btnCancel pressed do (destroydialog rolPathManager)
)


----------------------------------------------------------------
----------------------------------------------------------------
----------------------------------------------------------------


--  ==============================-rollout-ä¸»åŒºåŸŸ-================================

rollout AutoExportTool_Pro "AutoExportTool_Pro" width:500 height:1050 -- width--å®½åº¦  åœ¨FNå®šä¹‰é‡Œä¿®æ”¹--( fn updateButtonLayout ; AutoExportTool_Pro.width )

(
    -- ============================UIå…ƒç´ å®šä¹‰==================================

    -- æ‹–åŠ¨åŒºåŸŸæ ‡ç­¾ï¼ˆé€æ˜èƒŒæ™¯ï¼Œä½äºé¡¶å±‚ï¼‰
    label lblDragArea "ğŸ‘‘ AutoExportTool_Pro" height:15 width:450 align:#center \
        offset:[-20,0] \
        tooltip:"Plugin Title/AutoExportTool/AniTool For Animatorâ€‹/åŠ¨ç”»å¸ˆå·¥å…·" \
        color:(color 100 100 150) \
        transparent:true  -- è®¾ç½®ä¸ºé€æ˜èƒŒæ™¯ / true 
    -- å…³é—­æ’ä»¶æŒ‰é’® / æ ‡é¢˜ æ  è®¾è®¡ / X / true
    button btnClose "âœ•" width:18 height:18 align:#right offset:[8,-20] tooltip:"å…³é—­æ’ä»¶"
    
    -- ä½¿ç”¨ DotNet æ ‡ç­¾ä½œä¸ºæ‹–åŠ¨åŒºåŸŸ
    dotNetControl lblTitle "System.Windows.Forms.Label" height:22 width:490 align:#center \
    offset:[0,0] \
    tooltip:"å·¦é”®æ‹–åŠ¨çª—å£"
    --transparent:true \ -- è®¾ç½®ä¸ºé€æ˜èƒŒæ™¯ / false 
	
    group "ğŸŒŸ å¯¼å‡ºè·¯å¾„è®¾ç½®" (
       
        -- åœ¨UIä¸­æ·»åŠ è¯´æ˜
        --label lblEngineNote "æ³¨æ„: å¯¼å‡ºåˆ°å¼•æ“æ—¶ï¼Œè§’è‰²æ–‡ä»¶å¤¹å°†æ ¹æ®æ˜ å°„é…ç½®è‡ªåŠ¨è½¬æ¢" align:#left offset:[0,5] \
        --tooltip:"æœ¬åœ°ä¸­æ–‡å â†’ å¼•æ“è‹±æ–‡å"
        --checkbox chkExportToEngine "ğŸƒå¯¼å‡ºåˆ°å¼•æ“" checked:false align:#right offset:[3,0] tooltip:"ç›´æ¥å¯¼å‡ºåˆ°å¼•æ“é¡¹ç›®"
		--edittext edtEnginePath "ğŸ“¡å¼•æ“é¡¹ç›®è·¯å¾„:" width:350 height:18 labelOnTop:true align:#left across:3 offset:[0,-15]
        --button btnBrowseEngine "..." width:20 height:20 align:#center offset:[127,3] toolTip:"è®¾ç½®å¼•æ“é¡¹ç›®è·¯å¾„"
        --button btnBrowseEngine1 "ğŸ”¶" width:20 height:20 align:#center offset:[-5,3] toolTip:"æ’ç‰ˆå ä½æ— åŠŸèƒ½"
		
		--button btnCharacterMapping "ğŸ˜ˆè§’è‰²æ˜ å°„" width:70 height:22 align:#right offset:[0,-26] tooltip:"ç®¡ç†è§’è‰²åç§°æ˜ å°„"
        
        
        edittext edtExportPath "ğŸ´ä¿å­˜/FilePath:" width:345 height:18 labelOnTop:true align:#left across:4
        button btnBrowsePath "../+" width:25 height:20 align:#right across:4 offset:[138,18] toolTip:"å·¦é”®ï¼šè®¾ç½®å¯¼å‡ºè·¯å¾„\nå³é”®ï¼šè‡ªåŠ¨å¡«å……å¸¸ç”¨path"
		button btnOpenExportPath "opğŸ“¨" width:32 height:20 tooltip:"æ‰“å¼€å½“å‰è·¯å¾„" across:2 align:#right offset:[55,18]
        button btn_resetFBXPath "ğŸ§šå®šä½FBX" width:60 tooltip:"è‡ªåŠ¨ç”ŸæˆFBXè·¯å¾„" align:#right offset:[2,18]
        
		checkbox chkAutoFolder "Auto" checked:false across:4 align:#left offset:[-100,3] tooltip:"è‡ªåŠ¨ç”Ÿæˆè·¯å¾„/FBX"  -- UIä½ç§»éšè— / æ— å…³ç´§è¦çš„åŠŸèƒ½ï¼Œä½†æœ‰å…³è”/å¤‡ç”¨
		
		button btnRenameTool "ğŸ“ReNm" width:50 checked:false align:#left offset:[-120,3] tooltip:"æ‰¹é‡æ–‡ä»¶æ”¹åå·¥å…·"
		
		checkbox chkAddDateSuffix "ğŸ”º.Ext_/" width:60 checked:false align:#left offset:[-185,7] tooltip:"å½’æ¡£æ—¶åœ¨æ–‡ä»¶ååæ·»åŠ -å¹´-æœˆ-æ—¥"
		button btn_resetScene "ğŸ¦‰â„›eset" width:60 height:20 align:#right offset:[3,5] align:#right toolTip:"é‡ç½®Maxåœºæ™¯"
	    
        button btnResetPath "ğŸƒPathâ" width:52 offset:[145,-25] tooltip:"é‡ç½®ä¸ºæœ‰æ•ˆè·¯å¾„" 
        button btnGC "â™»ï¸GCæ¸…ç†" width:70 align:#center offset:[-5,-26] tooltip:"æ¸…ç†åœºæ™¯åƒåœ¾å†…å­˜"
        button btnRestartPlugin "ğŸ’é‡å¯æ’ä»¶" width:70 align:#right offset:[-130,-26] tooltip:"æ‰‹åŠ¨é‡å¯æ’ä»¶"
        button btnArchive "ğŸ§¤æ–‡ä»¶å½’æ¡£" width:65 align:#left offset:[115,-26] tooltip:"æŒ‰æ—¶é—´ç­›é€‰æœ€æ–°æ–‡ä»¶å¹¶å½’æ¡£"
        
    ) 

    group "ğŸ¤– æ–‡ä»¶ç®¡ç†" (
        
        label edtmaxfilePath "Ë–â© â™¡ï¸ğŸ“ â€º æ‹–æ‹½oræ·»åŠ -max/æ–‡ä»¶//Read/Rslv//-åˆ—è¡¨æ›´æ–°//-åŒå‡»æ‰“å¼€/å¯¼å…¥æ–‡ä»¶:" offset:[0,-6] align:#left toolTip:"æ”¯æŒå¤§éƒ¨åˆ†æ–‡ä»¶æ‹–æ‹½åˆ°åˆ—è¡¨ï¼ŒåŒå‡»å³å¯æ‰“å¼€/å¯¼å…¥"
		button btnParentPath "âª" width:25 height:20 offset:[150,-17] tooltip:"è¿”å›ä¸Šä¸€å±‚ç›®å½•"
	    button btn_autoRead "  à½ºğŸ‰â„Read" width:60 height:18 align:#right offset:[2,-22] toolTip:"è¯»å–å½“å‰"
		
		colorPicker cpFolder "â„±old-C:" width:80 color:(color 245 245 125) offset:[5,-3] align:#left      -- é»˜è®¤æ·¡é»„ æ–‡ä»¶å¤¹ /fold
        colorPicker cpFile "â„±ile-P:" width:75 color:(color 255 225 255) offset:[100,-25] align:#left      -- é»˜è®¤ç™½è‰² æ–‡ä»¶/file
     
        button btnCleanRecent "ğŸ›¡ï¸R" width:30 height:18 align:#center offset:[15,-23] tooltip:"å·¦é”®ï¼šè®¾ç½®æ˜¾ç¤ºæ•°é‡ä¸º10ä¸ª\nå³é”®ï¼šå½»åº•æ¸…ç©ºè®°å½•æ–‡ä»¶"
        button btnResetColor "ğŸ­CP" width:30 height:18 align:#center offset:[-23,-23] toolTip:"æ¢å¤åˆå§‹é¢œè‰²CP"
        
        checkbox chkGridLines "GL" checked:false align:#right offset:[260,-16] across:3 toolTip:"åˆ—è¡¨ç½‘æ ¼çº¿æ˜¾ç¤º"
		checkbox chkChangeFont "â„±R" checked:true align:#right offset:[65,-16] toolTip:"åˆ‡æ¢å­—ä½“åˆ—å®½æ ·å¼"
		slider sldBgColor "" width:75 height:20 range:[0,255,180] offset:[-44,-30] type:#integer  
        label lblBgValue "ğŸŒ¸" width:35 height:15 offset:[162,-25]  
		button btnApplyColor "ğŸ¨Setâ€¢â„‚P " width:55 offset:[208,-23] tooltip:"åº”ç”¨æ–°é¢œè‰²"
        
        dropdownlist ddlLikedPaths "ğŸ”±å¸¸ç”¨è·¯å¾„ğŸŒâ™¾ï¸:" width:95 height:12 align:#left offset:[0,-10] across:5 toolTip:"å¸¸ç”¨è·¯å¾„/ListBox" items:(for f in g_likedFolders collect f.name) -- æ­£ç¡®éå† g_likedFolders
		
        button btnManagePaths "âš”å¸¸ç”¨ç›®å½•" width:70 height:22 align:#left offset:[20,8] tooltip:"å·¦-Lï¼šæ·»åŠ Add/è·¯å¾„\nå³-Rï¼šåˆ é™¤Selete/é€‰ä¸­\nCtrl+å³é”®=ClearAll-!!!"
        button btnRecentFiles "ğŸ“…æœ€è¿‘æ‰“å¼€" width:68 height:22  offset:[145,8] tooltip:"æ˜¾ç¤ºæœ€è¿‘æ‰“å¼€çš„MAXæ–‡ä»¶"
        button btnPluginDir "ğŸ§©æ’ä»¶ç›®å½•" width:70 height:22 align:#center offset:[-97,8] tooltip:"L-å·¦é”®: æ’ä»¶ç›®å½•\nR-å³é”®: å¤‡ä»½ç›®å½•"
        button btnAutoSave "â±ï¸è‡ªåŠ¨ä¿å­˜" width:65 height:22 offset:[-115,8] tooltip:"ç›‘æ§è‡ªåŠ¨ä¿å­˜ç›®å½•MAXæ–‡ä»¶"
        button btnRefreshList "ğŸ”„RsLv" width:50 height:22 align:#right offset:[-3,-27] tooltip:"åˆ·æ–°å½“å‰è·¯å¾„åˆ—è¡¨"
        -- ä¿®æ”¹æ–‡ä»¶ç±»å‹ç­›é€‰/å•é€‰æŒ‰é’®å£°æ˜
        label rdoFileFilterType "âğŸ“Šâ‘â€ºFtypeâ€¤âŒââ€¢â€£" align:#left 
        radiobuttons rdoFileFilter "" \
        labels:#("MAX","FBX","MS","BIP","MZP","XAF","å…¨æ˜¾ç¤º")\
        columns:7 \  -- 7åˆ—å¸ƒå±€ï¼ˆ6/ç±»å‹+1/å…¨æ˜¾ç¤ºï¼‰
        align:#center \
        width:480 \  -- æ ¹æ®å®é™…è°ƒæ•´å®½åº¦
        offset:[90,-15] \
        tooltip:"æ–‡ä»¶ç±»å‹ç­›é€‰"

        dotNetControl lvHeader "System.Windows.Forms.ListView" width:480 height:22 aelign:#center offset:[-3,0]
        Dotnetcontrol Lv_model "system.windows.forms.listview" Width:480 Height:270 offset:[-3,-6]
        button btnBrowseFolder "ğŸ“ æ·»åŠ MAXæ–‡ä»¶" width:100 height:22 align:#left offset:[15,0] tooltip:"æ·»åŠ æ–‡ä»¶è·¯å¾„-åˆ—è¡¨åªæ˜¾ç¤ºæ–‡ä»¶"
    
        button btn_removeSelected "âŒ ç§»é™¤é€‰ä¸­é¡¹" width:90 height:22  offset:[0,-26] tooltip:"ç§»é™¤åˆ—è¡¨æ˜¾ç¤ºé¡¹/MoveItems"
        button btn_model_close "ğŸ—‘ï¸ æ¸…ç©ºåˆ—è¡¨" width:100 height:22 align:#right offset:[-15,-26] tooltip:"æ¸…ç©ºåˆ—è¡¨æ‰€æœ‰/ClearLv.."
		label lblCount "æ–‡ä»¶ï¼š0" align:#right offset:[1000,0] tooltip:"æ–‡ä»¶æ€»æ•°"
        

        dotNetControl ModeStatus "System.Windows.Forms.ListView" width:480 height:22 aelign:#center offset:[-3,-20]
    )

    group "âšœï¸ FBX/æ‰¹é‡/å¯¼å‡ºé…ç½®âš™ï¸" (
        
        dropDownList selec_set ""  Width:128 labelOnTop:false across:4 offset:[-1,0]
        button btn_reset "â²ï¸åˆ·æ–°" width:50 height:25 offset:[-8,0]
        button btn_add_set "â•æ·»åŠ "  height:25 offset:[-60,0]
        button btn_del_set "â–ç§»é™¤"  height:25 offset:[-110,0]
        
        button btn_add_all "â•å…¨é€‰" width:60 height:25 offset:[135,-30]
        button btn_clear_all "â–æ¸…ç©º" width:60 height:25 align:#right offset:[0,-30]
		
		edittext set_names "ğŸŒˆé€‰æ‹©é›†å¯¼å‡º#â˜¾ğŸ¥‘â˜½:" fieldWidth:350 readOnly:true offset:[0,5]               
        
		-- å¯¼å‡ºæ¨¡å¼å•é€‰æŒ‰é’®ï¼ˆå‚æ•°ä¿®æ­£ï¼‰
        radiobuttons rdo_exportMode "ğŸ’¦å¯¼å‡ºæ¨¡å¼ " \
        labels:#("Autoé»˜è®¤", "Skinæ¨¡å‹", "BakeåŠ¨ç”»") \
        default:1 \
        align:#left \
        offset:[0,0] \
        toolTip:"é€‰æ‹©FBXå¯¼å‡ºé…ç½®æ–¹æ¡ˆ" \
        --button btn_selsetBatch "Seté€‰æ‹©é›†" width:60 height:20 align:#right offset:[-15,-25] tooltip:"æ‰¹é‡åŒæ­¥é€‰æ‹©é›†åˆ°å…¶ä»–MAXæ–‡ä»¶"  -- false
        --button btnSelSetManager "âš˜S/é€‰æ‹©é›†" width:60 offset:[0,0] align:#left tooltip:"æ‰“å¼€é€‰æ‹©é›†ç®¡ç†é¢æ¿"  -- false
		button btnOpenExportPath1 "op/ğŸ’Œ" width:42 height:20 tooltip:"æ‰“å¼€å½“å‰è·¯å¾„" align:#center offset:[0,-25]
        
        button btnExportBip "ğŸ’¾ä¿å­˜BIP" width:60 offset:[65,-25] tooltip:"ä¿å­˜ å½“å‰åœºæ™¯ BIP æ–‡ä»¶"
        button btnImportBip "ğŸ®åŠ è½½BIP" width:60 offset:[135,-25] tooltip:"åŠ è½½ å½“å‰åœºæ™¯ BIP æ–‡ä»¶"
        button btnBatchSkinReplace "ğŸ¦ŠRestyle" width:60 height:20 align:#right offset:[0,-25] tooltip:" ä¸€é”®æ¢çš® / new (max,bip,xaf) "
        
        checkbox auto_socket "è‡ªåŠ¨æŒ‚ç‚¹å½’é›¶" across:5 offset:[25,5] tooltip:" é™„ä»¶æŒ‚ç‚¹ / viewè½´ (p/xyz:0;r/x:90,y,z:0) "
        button btnBatchMerge "ğŸŒ¸æ— é™å½’å¹¶" width:70 height:20 align:#center offset:[10,3] tooltip:"æ‰¹é‡åˆå¹¶æŒ‚ç‚¹æ–‡ä»¶/æŒ‚ç‚¹å¯¹é½é“¾æ¥ğŸ”—åˆ°éª¨éª¼"
		checkbox chk_autoOpenDir "â†— AutoOpenâ€‹" width:80 checked:true height:20 align:#center offset:[0,03] tooltip:"å®Œæˆåè‡ªåŠ¨æ‰“å¼€ç›®å½•"
        button btnBatchSyncSelSets "ğŸ’ å…¨åŸŸå½’é›†" width:70 align:#right offset:[-15,3] toolTip:"å°†å½“å‰åœºæ™¯æ–‡ä»¶çš„é€‰æ‹©é›†åŒæ­¥æ›´æ–°åˆ°åˆ—è¡¨MAXæ–‡ä»¶"
		checkbox auto_makedir_set "æŒ‰é€‰æ‹©é›†åˆ†ç›®å½•" checked:false align:#right offset:[10,7] tooltip:" é»˜è®¤å¤šä¸ªé€‰æ‹©é›†åç§°ä½œä¸ºå¯¼å‡ºFBXæ–‡ä»¶å¤¹"
    )
    
    --UI æ’ç‰ˆä½ç½® ç©ºé—´æœ‰é™ / å¤‡ç”¨ / ä¸å½±å“ æ ¸å¿ƒåŠŸèƒ½ / XAF å¯¼å‡ºå¯¼å…¥
      --checkBox chk_useRotation "å¯ç”¨æ—‹è½¬æ¨¡å¼æ§åˆ¶" pos:[20,400]  -- false / å¤‡ç”¨ / æœªéªŒè¯
       --radiobuttons rdo_rotation "" labels:#("TCB","Euler") pos:[150,400] visible:false  -- false / å¤‡ç”¨ / æœªéªŒè¯
        --editText edt_excludePrefix "æ’é™¤å‰ç¼€:" text:"v_" pos:[250,400]  -- false / å¤‡ç”¨ / æœªéªŒè¯
    
    group "BIPâ†¹ğŸ“¥å¯¼å‡º/å…¥" (
		
        -- BIPæ¨¡å¼å•é€‰æŒ‰é’®
        radiobuttons rdo_bipMode "BIPæ¨¡å¼" 
        labels:#("å¯¼å‡ºBIP") \
        default:1 \
        align:#left \
        offset:[-100,5] \
        toolTip:"æ§åˆ¶BIPæ–‡ä»¶æ“ä½œæ–¹å‘" \
        
        --checkbox chkExportBones "â†¸å¯¼å‡ºXAFé™„ä»¶" checked:true across:2 offset:[135,-20] - flase
        --checkbox chkExportBip "â†¸å¯¼å‡ºBipedéª¨éª¼" checked:true align:#center offset:[-50,-20] - flase
        --checkbox chkAutoBip "â˜ˆAutoBiped" checked:true offset:[-17,-20] tooltip:"å¯¼å…¥æ—¶è‡ªåŠ¨åˆ›å»ºéª¨éª¼ç³»ç»Ÿ" - flase
		
        button btn_bipBatchAll "âœ¨ALL-å¯¼å‡ºBIP" width:80 height:20 align:#left offset:[25,-40] toolTip:"å¤„ç†åˆ—è¡¨å…¨éƒ¨æ–‡ä»¶//å¯¼å‡ºBipedåŠ¨ç”»"
        button btn_bipBatchChecked "ğŸï¸CK-å¯¼å‡ºBIP" width:80 height:20 align:#center offset:[-45,-25] toolTip:"æ‰¹é‡å¤„ç†å‹¾é€‰æ–‡ä»¶//å¯¼å‡ºBipedåŠ¨ç”»"
        button btnBatchImportBip "ğŸ¹æ‰¹é‡BIPå¯¼å…¥" width:80 align:#right offset:[-145,-25] toolTip:"æ‰¹é‡å¯¼å…¥åˆ—è¡¨//å…¨éƒ¨BIPæ–‡ä»¶"
        button btnMergeSegments "ğŸ§ªåˆå¹¶åˆ†æ®µåŠ¨ç”»" width:90 align:#right offset:[-20,-25] toolTip:"å°†å‹¾é€‰çš„åˆ†æ®µMAXæ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªå®Œæ•´çš„MAXæ–‡ä»¶"
        
        --button btn_exportCurrentBIP "ğŸš©SC" width:45 height:20 align:#right offset:[-70,-25] toolTip:"å¯¼å‡ºå½“å‰åœºæ™¯çš„BipedåŠ¨ç”»" -- æ–°å¢æŒ‰é’® - flase / æ²‰æ·€ä»£ç  / å¤‡ç”¨
	)                       
    
    group "XAFğŸ´â€â˜ ï¸ç¼–è¾‘å™¨â†¹å¯¼å‡º/å…¥" (
        button btnBatchExportXAF "ğŸ†æ‰¹é‡å¯¼å‡ºXAF" width:90 height:22 across:5 toolTip:"æ‰¹é‡å¯¼å‡ºåˆ—è¡¨/å…¨éƒ¨MAXæ–‡ä»¶çš„xafæ•°æ®"
        button btnBatchExportXAFChecked "ğŸ¦¾å‹¾é€‰å¯¼å‡ºXAF" width:90 height:22 toolTip:"æ‰¹é‡å‹¾é€‰å¯¼å‡ºåˆ—è¡¨/å…¨éƒ¨MAXæ–‡ä»¶çš„xafæ•°æ®"
        button btnOpenXAFEditor "ğŸ§¬XAFç¼–è¾‘å™¨" width:90 height:22 toolTip:"æ ¸å¿ƒæ“ä½œ/xaféª¨éª¼ç¼–è¾‘/ä¿å­˜é…ç½®-å…³è”xafå¯¼å‡º/å…¥"
        checkbox chkXAFOverwrite "ğŸŒªï¸è¦†ç›–æ–‡ä»¶/XAF" checked:true width:80 offset:[5,5] toolTip:"xafå¯¼å…¥/å‹¾é€‰è¦†ç›–MAXåŸæ–‡ä»¶;æœªå‹¾é€‰åˆ™æ–°å»ºæ–‡ä»¶å¤¹"
        button btnBatchImportXAF "ğŸ‡æ‰¹é‡å¯¼å…¥XAF" width:90 height:22 toolTip:"æ‰¹é‡å¯¼å…¥XAF_Exports/xafæ•°æ®åˆ°åˆ—è¡¨MAXæ–‡ä»¶"
    )
    
    group "FBX ğŸŒ™ æ“ä½œæ§åˆ¶" (
        
        --label edtExPath "Ë–â© à½º Ò‰ â™¡ï¸ â€ºæŒ‰-ESC-â‡å¯ä¸­æ–­å¯¼å‡ºè¿›ç¨‹ï¼" align:#left
        
        button btn_aotu_model "âš¡æ‰¹é‡å¯¼å‡º" width:180 height:30 across:3 align:#left offset:[25,5] align:#left toolTip:"æ‰¹é‡å¯¼å‡ºåˆ—è¡¨å…¨éƒ¨æ–‡ä»¶/æ”¯æŒæ–‡ä»¶å¤¹"
        
        button btn_export_checked "ğŸš€å¯¼å‡ºå‹¾é€‰" width:80 height:30 align:#center offset:[0,5] toolTip:"å¯¼å‡ºå‹¾é€‰çš„æ–‡ä»¶/ä¸æ”¯æŒæ–‡ä»¶å¤¹"         -- æ–°å¢æŒ‰é’®ï¼šå¯¼å‡ºå‹¾é€‰æ–‡ä»¶     
        
        button btn_exp_M_fbx "ğŸ¯å¯¼å‡ºå½“å‰" width:170 height:30 align:#right offset:[70,5] toolTip:"å¯¼å‡ºå½“å‰æ‰“å¼€çš„åœºæ™¯æ–‡ä»¶"
        
	)
	
    --â–¶ æ‰¹é‡å¯¼å‡º;â˜… å‹¾é€‰å¯¼å‡º;â˜… å¯¼å‡ºå½“å‰;
    -- è¿›åº¦æ¡æ§ä»¶ ---------------------------------------------------------
    dotNetControl pbProgress "System.Windows.Forms.ProgressBar" width:470 height:20 offset:[0,5]
	label lblProgressInfo "â™å‡†å¤‡å°±ç»ª..." align:#center offset:[0,5] color:(color 200 100 0)
    hyperLink lbl_01 "(â€¢â—¡â€¢)ê¦¿à¹ŠğŸáƒ¦Íœ à½¼YQiu_ğŸ§°AutoExportToolo-V1.09Ø„â™“â•°â˜†â•®" \
    align:#Center \
    offset:[10,0] \
    color:(color 323 178 223) \  -- ä¸»è‰²è°ƒ (èµ›åšè“)
    hoverColor:(color 255 105 180) \  -- æ‚¬åœåŠ æ·±--ï¼ˆæ³¡ç³–ç²‰ï¼‰
    address:"https://space.bilibili.com/327573825" \
    tooltip:"ç‚¹å‡»è®¿é—®å¼€å‘è€…çš„Bç«™ä¸»é¡µ" \
    
    label lblDateTime "" align:#center offset:[177,-3] --ï¼ˆå…¨æ˜¾ç¤º/æ—¶åˆ†posä½ç½®ï¼‰ï¼›  

--/* æŒ‰é’®æ ·å¼ç¤ºä¾‹ */ colour / é¢œè‰²å‚è€ƒ 
--æ³¡ç³–ç²‰--RGB:color( 255 105 180 ) ï¼›æ¨±èŠ±ç²‰-- RGB:color ( 255 182 193 ) ï¼› -- å¤å¤è“ RGB:color( 135 206 250 )ï¼›å©´å„¿è“ RGB:color( 135 206 235 )ï¼›
--é“¶ç° RGB:color( 192 192 192) ï¼› --è–°è¡£è‰ç´« RGB:color( 216 191 216 )ï¼› -- sèµ›åšè“ RGB:color( 0 184 255 )ï¼›
---- ç´«æ™¶è‰²RGB:color( 160 0 255 )  (RGBï¼›-- éœ“è™¹ç²‰ (RGB:(color( 255 95 155 )ï¼›-- äº®é»„ RGB:color( 255 255 0)
--147 197 253..
--button.btn_aotu_model (
    --foregroundColor: (color 255 255 255)  -- ç™½è‰²æ–‡å­—
    --images: #("icon_export.png", undefined, 1, 1, 1, 1, 1) -- å¯é€‰çš„å›¾æ ‡æ”¯æŒ
--)

-- rollout å±€éƒ¨å˜é‡ ================================================================

local model_files_array = #()  -- å¯¼å‡ºåˆ—è¡¨-ç¨³å®šé€»è¾‘ä»£ç 
local sele_set_list = #()       -- æ·»åŠ é€‰æ‹©é›†-ç¨³å®šé€»è¾‘ä»£ç 
local export_setsets = #()        -- å¯¼å‡ºé€‰æ‹©é›†-ç¨³å®šé€»è¾‘ä»£ç 

-- å‡½æ•°å®šä¹‰ ================================================================
-- æ‰¹é‡å¤„ç†ä¸»å‡½æ•°ï¼ˆFBXï¼›BIP - ï¼šé»˜è®¤åˆ—è¡¨å…¨éƒ¨/å‹¾é€‰/å½“å‰-å¯¼å‡º,åˆ—è¡¨åŒå‡»å¯¼å…¥ï¼›ä¸€é”®æ¢çš®ç­‰...

-- è·å–å¼•æ“å¯¼å‡ºè·¯å¾„ï¼ˆå¸¦è§’è‰²æ˜ å°„ï¼‰/ å¤‡ç”¨ / æ²‰æ·€ä»£ç 
fn getEngineExportPath sourcePath = (
    if not g_exportToEngine or g_engineProjectPath == "" do return undefined
    
    -- æå–è§’è‰²åç§°ï¼ˆä½¿ç”¨æ–‡ä»¶åæˆ–æ–‡ä»¶å¤¹åï¼‰
    local charName = ""
    if matchPattern sourcePath pattern:"*[DIR]*" then (
        -- æ–‡ä»¶å¤¹è·¯å¾„
        local dirPath = substring sourcePath 6 -1
        charName = filenameFromPath dirPath
    ) else (
        -- æ–‡ä»¶è·¯å¾„
        charName = getFilenameFile sourcePath
    )
    
    -- ç§»é™¤å¯èƒ½çš„åç¼€
    charName = substituteString charName "_skin" ""
    charName = substituteString charName "_anim" ""
    
    -- åœ¨æ˜ å°„è¡¨ä¸­æŸ¥æ‰¾
    local mappedDir = undefined
    for mapping in g_characterMappings do (
        if matchPattern charName pattern:("*" + mapping.name + "*") do (
            mappedDir = mapping.dir
            exit
        )
    )
    
    -- è¿”å›æ˜ å°„è·¯å¾„æˆ–é»˜è®¤å¼•æ“è·¯å¾„
    if mappedDir != undefined then (
        return pathConfig.appendPath g_engineProjectPath mappedDir
    )
    g_engineProjectPath
)

-- é€’å½’è·å–æ–‡ä»¶å¤¹å†…æ‰€æœ‰.maxæ–‡ä»¶
fn getAllMaxFilesInFolder folderPath = (
    local maxFiles = #()
    local files = getFiles (folderPath + "\\*.max")
    join maxFiles files
    
    -- é€’å½’å­æ–‡ä»¶å¤¹
    local subDirs = getDirectories (folderPath + "\\*")
    for dir in subDirs do (
        join maxFiles (getAllMaxFilesInFolder dir)
    )
    maxFiles
)

-- å±•å¼€åˆ—è¡¨ä¸­çš„æ–‡ä»¶å¤¹é¡¹
fn expandFolderItems items = (
    local expanded = #()
    for item in items do (
        if matchPattern item pattern:"[DIR]*" then (
            local folderPath = substring item 6 -1
            if doesDirectoryExist folderPath then (
                join expanded (getAllMaxFilesInFolder folderPath)
            )
        ) else (
            append expanded item
        )
    )
    expanded
)

-- ä¿å­˜æ’ä»¶è·¯å¾„åˆ°INI
fn savePluginPath = (
    setINISetting g_UIConfigPath "Plugin" "Path" g_pluginPath
)

-- é‡å¯æ’ä»¶å‡½æ•°
fn restartPlugin = (
    if doesFileExist g_pluginPath do (
        destroyDialog AutoExportTool_Pro  -- å…³é—­å½“å‰çª—å£
        fileIn g_pluginPath                -- é‡æ–°åŠ è½½æ’ä»¶
    )
)

--åœ¨Bipedå¯¼å…¥/å¯¼å‡ºåï¼Œå¼ºåˆ¶æ¸…ç†æ— æ•ˆéª¨éª¼èŠ‚ç‚¹ï¼šåœ¨ processBipImport å’Œ SilentBipedImport çš„æœ«å°¾è°ƒç”¨æ­¤å‡½æ•°ï¼ˆä¿®å¤8.12ï¼Œmax2014.2020åœºæ™¯å¼‚å¸¸åˆ é™¤éª¨éª¼/æ³¨é”€)
--fn cleanupBipedNodes = (
    -- åˆ é™¤æ‰€æœ‰æœªé“¾æ¥çš„Bipedéª¨éª¼
    --for obj in objects where (classOf obj == Biped_Object and obj.parent == undefined) do (
        --try (delete obj) catch ()
    --)
    --gc()
--)

-- æ–°å¢å‡½æ•°ï¼šè·å–å®‰å…¨æ–‡ä»¶å/-æ›¿æ¢æ‰€æœ‰ loadMaxFile è°ƒç”¨ä¸º loadMaxFile ï¼Œè§„é¿åœºæ™¯å¼‚å¸¸ï¼Œåœ¨åŠ è½½æˆ–é‡ç½®åœºæ™¯å‰ï¼Œå¼ºåˆ¶é‡Šæ”¾å½“å‰åœºæ™¯èµ„æºå¹¶æ¢å¤è§†å›¾çŠ¶æ€ï¼š
 -- è·å–XAFæ–‡ä»¶ä¸­çš„éª¨éª¼åˆ—è¡¨ï¼ˆç”¨äºç²¾ç¡®å¯¼å…¥ï¼‰
fn getXAFBoneList xafPath = (
    local boneList = #()
    
    try (
        local xDoc = dotNetObject "System.Xml.XmlDocument"
        xDoc.Load xafPath
        
        local nodes = xDoc.SelectNodes "//Node"
        for i = 0 to (nodes.Count - 1) do (
            local nameAttr = nodes.Item[i].SelectSingleNode "Properties/Property[@name='name']"
            if nameAttr != undefined do (
                append boneList nameAttr.InnerText
            )
        )
    )
    catch (
        format "[è¯»å–XAFéª¨éª¼åˆ—è¡¨é”™è¯¯] % : %\n" xafPath (getCurrentException())
    )
    
    boneList
)

-- æ‰¹é‡å¯¼å‡ºXAFå‡½æ•° / ä½¿ç”¨ç²¾ç¡®çš„éª¨éª¼æ”¶é›†å’Œå¤„ç†æ–¹æ³•
fn batchExportXAF = (
    -- æ£€æŸ¥XAFè®¾ç½®æ˜¯å¦é…ç½®
    local boneList = loadXAFSettings()
    local exportMode = ""  -- è®°å½•å¯¼å‡ºæ¨¡å¼
    
    -- ç¡®å®šå¯¼å‡ºæ¨¡å¼
    if boneList.count == 0 then (
        exportMode = "è‡ªåŠ¨æ”¶é›†æ‰€æœ‰éª¨éª¼å’Œè™šæ‹Ÿä½“"
    ) else (
        exportMode = "ä½¿ç”¨XAFé…ç½®çš„éª¨éª¼"
    )
    
    -- æ˜¾ç¤ºå¯¼å‡ºæ¨¡å¼ç¡®è®¤å¯¹è¯æ¡†
    local confirmMsg = "å³å°†å¼€å§‹XAFå¯¼å‡º!\n\n"
    confirmMsg += "å¯¼å‡ºæ¨¡å¼: " + exportMode + "\n"
    confirmMsg += (if boneList.count > 0 then "å¯¼å‡ºéª¨éª¼æ•°é‡: " + (boneList.count as string) + "\n" else "")
    confirmMsg += "ä½¿ç”¨MAXåŸç”ŸSaveAnimationæ–¹æ³•ï¼Œç¡®ä¿æ‰€æœ‰å˜æ¢æ•°æ®ç²¾å‡†ã€‚\n"
    confirmMsg += "æ˜¯å¦å¼€å§‹å¯¼å‡º?"
    
    if not (queryBox confirmMsg title:"XAFå¯¼å‡ºç¡®è®¤") do (
        lblProgressInfo.text = "XAFå¯¼å‡ºå·²å–æ¶ˆ"
        return undefined
    )
    
    -- é‡ç½®ä¸­æ–­æ ‡å¿—
    g_exportAbortFlag = false
    clearlistener()
    
    -- è®¡ç®—æ€»è¿›åº¦ï¼ˆåªè®¡ç®—.maxæ–‡ä»¶ï¼‰
    local maxFileCount = 0
    local maxFiles = #()  -- å­˜å‚¨æ‰€æœ‰.maxæ–‡ä»¶
    
    for item in model_files_array where not (matchPattern item pattern:"[DIR]*") and (getFilenameType item) == ".max" do (
        maxFileCount += 1
        append maxFiles item
    )
    
    if maxFileCount == 0 do (
        messageBox "æ–‡ä»¶åˆ—è¡¨ä¸­æ²¡æœ‰æ‰¾åˆ°.maxæ–‡ä»¶ï¼" title:"æ“ä½œä¸­æ­¢" beep:true
        return undefined
    )
    
    pbProgress.value = 0
    pbProgress.maximum = maxFileCount
    pbProgress.Refresh()
    btnBatchExportXAF.enabled = false
    
    local successCount = 0
    local exportBaseDir = ""  -- å¯¼å‡ºåŸºç¡€ç›®å½•
    
    -- ç¡®å®šå¯¼å‡ºåŸºç¡€ç›®å½•
    if maxFilePath != "" then (
        -- ä½¿ç”¨å½“å‰æ‰“å¼€æ–‡ä»¶çš„ç›®å½•
        exportBaseDir = maxFilePath + "XAF_Exports\\"
    ) else if maxFiles.count > 0 then (
        -- ä½¿ç”¨ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„ç›®å½•
        exportBaseDir = (getFilenamePath maxFiles[1]) + "XAF_Exports\\"
    ) else (
        -- ä½¿ç”¨åœºæ™¯ç›®å½•ä½œä¸ºåå¤‡
        exportBaseDir = (getDir #scene) + "XAF_Exports\\"
    )
    
    -- åˆ›å»ºå¯¼å‡ºç›®å½•
    if not doesDirectoryExist exportBaseDir do (
        makeDir exportBaseDir all:true
        format "[åˆ›å»ºç›®å½•] %\n" exportBaseDir
    )
    
    -- æ˜¾ç¤ºå¯¼å‡ºæ¨¡å¼ä¿¡æ¯
    lblProgressInfo.text = "XAFå¯¼å‡ºæ¨¡å¼: " + exportMode + " | æ–‡ä»¶æ•°é‡: " + (maxFileCount as string)
    windows.processPostedMessages()
    sleep 1.0  -- çŸ­æš‚æ˜¾ç¤ºä¿¡æ¯
    
    -- ä¸»å¤„ç†å¾ªç¯ - åªå¤„ç†.maxæ–‡ä»¶
    for i = 1 to maxFiles.count where not g_exportAbortFlag do (
        -- ESCé”®æ£€æµ‹
        if keyboard.escPressed do (
            g_exportAbortFlag = true
            format "[ç”¨æˆ·ä¸­æ–­] XAFå¯¼å‡ºè¿›ç¨‹å·²è¢«æ‰‹åŠ¨ç»ˆæ­¢\n"
            lblProgressInfo.text = "æ“ä½œå·²ä¸­æ–­ï¼" 
            windows.processPostedMessages()
            messageBox "XAFå¯¼å‡ºè¿›ç¨‹å·²è¢«ç”¨æˆ·ä¸­æ–­ï¼" title:"æ“ä½œæç¤º" beep:true
            exit
        )

        -- å¤„ç†å½“å‰æ–‡ä»¶
        local currentFile = maxFiles[i]
        local currentMaxFileName = getFilenameFile currentFile
        lblProgressInfo.text = "æ­£åœ¨å¤„ç†æ–‡ä»¶ï¼š" + currentMaxFileName + " (" + (i as string) + "/" + (maxFiles.count as string) + ")"
        
        -- åŠ è½½æ–‡ä»¶
        if (loadMaxFile currentFile quiet:true) then (
            -- ä½¿ç”¨ç²¾ç¡®çš„éª¨éª¼æ”¶é›†æ–¹æ³•
            local saveBoneAni = for obj in objects where (
                classof obj == BoneGeometry or 
                classof obj == Dummy or 
                classof obj == Point
            ) collect obj
            
            -- å»é™¤é‡å¤éª¨éª¼ï¼ˆæŒ‰åç§°ï¼‰- ç²¾ç¡®å»é‡é€»è¾‘
            local tempArr = #()
            for j = 1 to saveBoneAni.count-1 do (
                for k = j+1 to saveBoneAni.count do (
                    if saveBoneAni[j].name == saveBoneAni[k].name do (
                        append tempArr (if saveBoneAni[k] == undefined then saveBoneAni[k] else saveBoneAni[j])
                    )
                )
            )
            
            -- åˆ é™¤é‡å¤é¡¹
            if tempArr.count != 0 do (
                for obj in tempArr do (
                    for p = saveBoneAni.count to 1 by -1 do (
                        if saveBoneAni[p] == obj do deleteItem saveBoneAni p
                    )
                )
            )
            
            -- å¦‚æœä½¿ç”¨XAFé…ç½®ï¼Œè¿‡æ»¤éª¨éª¼
            if exportMode == "ä½¿ç”¨XAFé…ç½®çš„éª¨éª¼" and boneList.count > 0 do (
                local filteredBones = #()
                for bone in saveBoneAni do (
                    if findItem boneList bone.name > 0 do append filteredBones bone
                )
                saveBoneAni = filteredBones
                
                -- é€‰æ‹©è¿™äº›éª¨éª¼ä»¥ä¾¿ç”¨æˆ·éªŒè¯
                select saveBoneAni
                format "[é€‰æ‹©éª¨éª¼] å·²é€‰æ‹© % ä¸ªé…ç½®çš„éª¨éª¼è¿›è¡Œå¯¼å‡º\n" saveBoneAni.count
            )
            
            -- ç¡®ä¿æ‰€æœ‰å¯¹è±¡éƒ½æœ‰æœ‰æ•ˆçš„å˜æ¢æ§åˆ¶å™¨ï¼ˆä¿æŒåŸæœ‰æ§åˆ¶å™¨ï¼‰
            for obj in saveBoneAni do (
                try (
                    -- ç¡®ä¿ä½ç½®æ§åˆ¶å™¨æœ‰æ•ˆ
                    if obj.pos.controller == undefined do (
                        obj.pos.controller = Bezier_Position()
                    )
                    
                    -- ç¡®ä¿æ—‹è½¬æ§åˆ¶å™¨æœ‰æ•ˆ
                    if obj.rotation.controller == undefined do (
                        obj.rotation.controller = Euler_XYZ()
                    )
                    
                    -- ç¡®ä¿ç¼©æ”¾æ§åˆ¶å™¨æœ‰æ•ˆ
                    if obj.scale.controller == undefined do (
                        obj.scale.controller = Bezier_Scale()
                    )
                ) catch (
                    format "[è­¦å‘Š] æ— æ³•ä¸º % è®¾ç½®å˜æ¢æ§åˆ¶å™¨\n" obj.name
                )
            )

            if saveBoneAni.count > 0 then (
                -- æ„å»ºXAFæ–‡ä»¶è·¯å¾„
                local xafPath = exportBaseDir + currentMaxFileName + ".xaf"
                
                -- ä½¿ç”¨MAXåŸç”Ÿæ–¹æ³•ä¿å­˜åŠ¨ç”»
                local userAttr = #()
                local userVal = #()
                
                try (
                    -- æ¨¡æ‹ŸMAXåŸç”Ÿå¯¼å‡ºé€‰é¡¹ - ä½¿ç”¨ä¸åŸç”ŸSave Animationç›¸åŒçš„å‚æ•°
                    LoadSaveAnimation.saveAnimation xafPath saveBoneAni &userAttr &userVal
                    
                    -- éªŒè¯å¯¼å‡ºæ–‡ä»¶
                    if doesFileExist xafPath then (
                        format "[XAFå¯¼å‡ºæˆåŠŸ] å·²å¯¼å‡ºåˆ°: % | éª¨éª¼æ•°é‡: %\n" xafPath saveBoneAni.count
                        successCount += 1
                        
                        -- ä¿å­˜æ—¶é—´èŒƒå›´ä¿¡æ¯
                        local timeRangeFile = exportBaseDir + currentMaxFileName + "_time.txt"
                        try (
                            local fs = createFile timeRangeFile
                            local sourceTimeRange = #(animationRange.start, animationRange.end)
                            format "%\n" sourceTimeRange to:fs
                            close fs
                            format "[æ—¶é—´èŒƒå›´ä¿å­˜] %\n" timeRangeFile
                        ) catch (
                            format "[è­¦å‘Š] æ—¶é—´èŒƒå›´ä¿å­˜å¤±è´¥: %\n" (getCurrentException())
                        )
                    ) else (
                        format "[XAFå¯¼å‡ºé”™è¯¯] æ–‡ä»¶åˆ›å»ºå¤±è´¥: %\n" xafPath
                    )
                )
                catch (
                    format "[XAFå¯¼å‡ºé”™è¯¯] æ–‡ä»¶: % é”™è¯¯: %\n" currentFile (getCurrentException())
                )
            )
            else (
                format "[è­¦å‘Š] æ–‡ä»¶ % ä¸­æ²¡æœ‰æ‰¾åˆ°å¯å¯¼å‡ºçš„éª¨éª¼æˆ–è™šæ‹Ÿä½“\n" currentMaxFileName
            )
            
            -- é‡ç½®åœºæ™¯
            resetMaxFile #noPrompt
        )
        else (
            format "[é”™è¯¯] æ— æ³•åŠ è½½æ–‡ä»¶ï¼š%\n" currentFile
        )
        
        -- æ›´æ–°è¿›åº¦
        pbProgress.value = i
        
        -- æ›´æ–°è¿›åº¦æ˜¾ç¤º
        local progressPercent = (i as float / maxFiles.count * 100) as integer
        lblProgressInfo.text = "è¿›åº¦ï¼š" + (progressPercent as string) + "% | æˆåŠŸï¼š" + (successCount as string)
        windows.processPostedMessages()
    )
    
    -- åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
    AutoExportTool_Pro.refreshFileListView()
    
    -- å®Œæˆå¤„ç† - ç¡®ä¿è¿›åº¦æ¡æ»¡æ ¼
    pbProgress.value = pbProgress.maximum
    
    local completionMsg = "XAFæ‰¹é‡å¯¼å‡ºå®Œæˆï¼æˆåŠŸå¯¼å‡º " + (successCount as string) + " ä¸ªæ–‡ä»¶"
    lblProgressInfo.text = completionMsg
    btnBatchExportXAF.enabled = true
    
    -- æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
    messageBox ("XAFå¯¼å‡ºå®Œæˆï¼\n\nå¯¼å‡ºæ¨¡å¼: " + exportMode + "\næˆåŠŸå¯¼å‡º: " + (successCount as string) + " ä¸ªæ–‡ä»¶\nå¯¼å‡ºç›®å½•: " + exportBaseDir) title:"XAFå¯¼å‡ºå®Œæˆ"
    
    if chk_autoOpenDir.checked do ShellLaunch "explorer.exe" exportBaseDir
)

-- æ‰¹é‡XAFå¯¼å‡ºå‹¾é€‰æ–‡ä»¶ / ä½¿ç”¨ç²¾ç¡®çš„éª¨éª¼æ”¶é›†å’Œå¤„ç†æ–¹æ³•
fn batchExportXAFChecked = (
    -- æ£€æŸ¥æ˜¯å¦æœ‰å‹¾é€‰çš„æ–‡ä»¶
    local checkedFiles = #()
    for i = 0 to (Lv_model.Items.Count - 1) do (
        if Lv_model.Items.Item[i].Checked and not (matchPattern (Lv_model.Items.Item[i].Tag as String) pattern:"[DIR]*") then (
            append checkedFiles (Lv_model.Items.Item[i].Tag as String)
        )
    )
    
    -- è¿‡æ»¤å‡º.maxæ–‡ä»¶
    local maxFiles = for f in checkedFiles where (getFilenameType f) == ".max" collect f
    
    if maxFiles.count == 0 do (
        messageBox "è¯·å…ˆå‹¾é€‰è¦å¯¼å‡ºçš„.maxæ–‡ä»¶ï¼" title:"æ“ä½œæç¤º"
        return false
    )
    
    -- ä¸´æ—¶æ›¿æ¢å…¨å±€æ–‡ä»¶åˆ—è¡¨ï¼Œç„¶åè°ƒç”¨ä¸»å¯¼å‡ºå‡½æ•°
    local originalFiles = model_files_array
    model_files_array = maxFiles
    batchExportXAF()
    model_files_array = originalFiles  -- æ¢å¤åŸå§‹åˆ—è¡¨
)

-- æ¸…é™¤éª¨éª¼ä¸Šçš„åŠ¨ç”»æ•°æ® /   æå‡ xaf å¯¼å…¥ æ•°æ® ç²¾å‡†åº¦ ç§»é™¤ æ—§æ•°æ® ï¼ˆå¯¹åº”çš„ xafæ•°æ® ç›¸å…³ éª¨éª¼ åŠ¨ç”»å¸§çš„åˆ é™¤ï¼Œå¯¼å…¥å‰åšä¸€æ¬¡ç²¾å‡†å¯¼å…¥ï¼‰

fn clearBoneAnimation boneObjects = (
    try (
        for bone in boneObjects do (
            if isValidNode bone do (
                -- æ¸…é™¤å˜æ¢æ§åˆ¶å™¨ä¸Šçš„æ‰€æœ‰å…³é”®å¸§
                if bone.transform.controller != undefined do (
                    try (
                        deleteKeys bone.transform.controller #allKeys
                    )
                    catch (
                        format "[æ¸…é™¤å…³é”®å¸§é”™è¯¯] %: %\n" bone.name (getCurrentException())
                    )
                )
                
                -- å¯¹äºBipedéª¨éª¼ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
                if classOf bone == Biped_Object do (
                    try (
                        biped.deleteKeys bone.controller #allKeys
                    )
                    catch (
                        format "[æ¸…é™¤Bipedå…³é”®å¸§é”™è¯¯] %: %\n" bone.name (getCurrentException())
                    )
                )
            )
        )
        true
    )
    catch (
        format "[æ¸…é™¤åŠ¨ç”»é”™è¯¯] %\n" (getCurrentException())
        false
    )
)

-- ä»XAFæ–‡ä»¶ä¸­æå–éª¨éª¼åç§°åˆ—è¡¨ï¼ˆæ–°å‡½æ•°ï¼Œé¿å…åç§°å†²çªï¼‰
fn extractBoneNamesFromXAF xafPath = (
    local boneNames = #()
    
    try (
        -- ä¿å­˜å½“å‰åœºæ™¯çŠ¶æ€
        local holdState = holdMaxFile()
        
        -- åˆ›å»ºä¸€ä¸ªä¸´æ—¶åœºæ™¯æ¥è¯»å–XAFä¿¡æ¯
        resetMaxFile #noPrompt
        
        -- åˆ›å»ºå‡ ä¸ªä¸´æ—¶éª¨éª¼æ¥è¯»å–XAFä¿¡æ¯
        local tempBones = #()
        for i = 1 to 5 do (
            local tempBone = BoneSys.createBone [i*20,0,0] [(i+1)*20,0,0] [0,0,1]
            tempBone.name = "TempBoneForXAFRead_" + (i as string)
            append tempBones tempBone
        )
        
        -- å°è¯•åŠ è½½XAFæ–‡ä»¶
        local userAttr = #()
        local userVal = #()
        LoadSaveAnimation.loadAnimation xafPath tempBones relative:true insert:true
        
        -- è·å–XAFæ–‡ä»¶ä¸­çš„éª¨éª¼ä¿¡æ¯
        -- è¿™é‡Œæˆ‘ä»¬å‡è®¾XAFæ–‡ä»¶ä¼šä¿®æ”¹ä¸´æ—¶éª¨éª¼çš„åç§°æˆ–å±æ€§
        -- ä½†å®é™…ä¸Šï¼Œæˆ‘ä»¬éœ€è¦æ›´ç›´æ¥çš„æ–¹æ³•æ¥è¯»å–XAFå†…å®¹
        
        -- åˆ é™¤ä¸´æ—¶éª¨éª¼
        for bone in tempBones do (
            try (delete bone) catch ()
        )
        
        -- æ¢å¤åŸå§‹åœºæ™¯
        fetchMaxFile quiet:true
    )
    catch (
        format "[XAFè¯»å–é”™è¯¯] %: %\n" xafPath (getCurrentException())
    )
    
    boneNames
)

-- æ›¿ä»£æ–¹æ¡ˆï¼šç›´æ¥ä»XAFé…ç½®è·å–éª¨éª¼åç§°ï¼ˆæ›´å¯é çš„æ–¹æ³•ï¼‰
fn getBoneNamesFromXAFConfig = (
    local boneNames = loadXAFSettings()
    if boneNames.count == 0 do (
        -- å¦‚æœæ²¡æœ‰é…ç½®ï¼Œå°è¯•ä»åœºæ™¯ä¸­è·å–æ‰€æœ‰éª¨éª¼åç§°
        boneNames = for obj in objects where (
            classof obj == BoneGeometry or 
            classof obj == Dummy or 
            classof obj == Point or
            classof obj == Biped_Object
        ) collect obj.name
    )
    boneNames
)

-- æ”¹è¿›çš„æ‰¹é‡å¯¼å…¥XAFå‡½æ•° / ç»“åˆ xaf ç¼–è¾‘å™¨
fn batchImportXAF = (
    -- é‡ç½®ä¸­æ–­æ ‡å¿—
    g_exportAbortFlag = false
    clearlistener()
    
    -- æ£€æŸ¥XAFè®¾ç½®æ˜¯å¦é…ç½®
    local boneList = loadXAFSettings()
    local importMode = if boneList.count == 0 then "å…¨éƒ¨å¯¼å…¥" else "XAFé…ç½®å¯¼å…¥"
    
    -- ç¡®å®šæ–‡ä»¶ä¿å­˜æ¨¡å¼
    local saveMode = if chkXAFOverwrite.checked then "è¦†ç›–åŸæ–‡ä»¶" else "æ–°å»ºæ–‡ä»¶(XAF_Import)"
    
    -- æ˜¾ç¤ºå¯¼å…¥æ¨¡å¼ç¡®è®¤å¯¹è¯æ¡†
    local confirmMsg = "å³å°†å¼€å§‹XAFå¯¼å…¥!\n\n"
    confirmMsg += "å¯¼å…¥æ¨¡å¼: " + importMode + "\n"
    confirmMsg += "æ–‡ä»¶ä¿å­˜æ¨¡å¼: " + saveMode + "\n"
    confirmMsg += (if boneList.count > 0 then "å¯¼å…¥éª¨éª¼æ•°é‡: " + (boneList.count as string) + "\n" else "")
    confirmMsg += "ä½¿ç”¨MAXåŸç”ŸLoadAnimationæ–¹æ³•ï¼Œç¡®ä¿æ‰€æœ‰å˜æ¢æ•°æ®ç²¾å‡†ã€‚\n"
    confirmMsg += "æ˜¯å¦å¼€å§‹å¯¼å…¥?"
    
    if not (queryBox confirmMsg title:"XAFå¯¼å…¥ç¡®è®¤") do (
        lblProgressInfo.text = "XAFå¯¼å…¥å·²å–æ¶ˆ"
        return undefined
    )
    
    -- åˆå§‹åŒ–è¿›åº¦æ§åˆ¶
    pbProgress.value = 0
    
    -- è®¡ç®—æ€»è¿›åº¦ï¼ˆåªè®¡ç®—.maxæ–‡ä»¶ï¼‰
    local maxFileCount = 0
    local maxFiles = #()
    
    for item in model_files_array where not (matchPattern item pattern:"[DIR]*") and (getFilenameType item) == ".max" do (
        maxFileCount += 1
        append maxFiles item
    )
    
    if maxFileCount == 0 do (
        messageBox "æ–‡ä»¶åˆ—è¡¨ä¸­æ²¡æœ‰æ‰¾åˆ°.maxæ–‡ä»¶ï¼" title:"æ“ä½œä¸­æ­¢" beep:true
        return undefined
    )
    
    pbProgress.maximum = maxFileCount
    pbProgress.Refresh()
    btnBatchImportXAF.enabled = false
    
    local successCount = 0
    
    -- ä¸»å¤„ç†å¾ªç¯
    for i = 1 to maxFiles.count where not g_exportAbortFlag do (
        -- ESCé”®æ£€æµ‹
        if keyboard.escPressed do (
            g_exportAbortFlag = true
            format "[ç”¨æˆ·ä¸­æ–­] XAFå¯¼å…¥è¿›ç¨‹å·²è¢«æ‰‹åŠ¨ç»ˆæ­¢\n"
            lblProgressInfo.text = "æ“ä½œå·²ä¸­æ–­ï¼" 
            windows.processPostedMessages()
            messageBox "XAFå¯¼å…¥è¿›ç¨‹å·²è¢«ç”¨æˆ·ä¸­æ–­ï¼" title:"æ“ä½œæç¤º" beep:true
            exit
        )

        -- å¤„ç†å½“å‰æ–‡ä»¶
        local currentFile = maxFiles[i]
        local currentFileName = getFilenameFile currentFile
        lblProgressInfo.text = "æ­£åœ¨å¤„ç†æ–‡ä»¶ï¼š" + currentFileName + " (" + (i as string) + "/" + (maxFiles.count as string) + ")"
        
        -- ç¡®å®šXAFæ–‡ä»¶è·¯å¾„
        local xafPath = ""
        
        -- é¦–å…ˆå°è¯•åœ¨XAF_Exportsç›®å½•ä¸­æŸ¥æ‰¾
        local exportDir = (getFilenamePath currentFile) + "XAF_Exports\\"
        local xafFile1 = exportDir + currentFileName + ".xaf"
        
        -- å…¶æ¬¡å°è¯•åœ¨å½“å‰ç›®å½•æŸ¥æ‰¾
        local xafFile2 = (getFilenamePath currentFile) + currentFileName + ".xaf"
        
        if doesFileExist xafFile1 then (
            xafPath = xafFile1
        ) else if doesFileExist xafFile2 then (
            xafPath = xafFile2
        ) else (
            format "[è­¦å‘Š] æ‰¾ä¸åˆ°XAFæ–‡ä»¶: %\n" currentFileName
            pbProgress.value = i
            continue
        )
        
        -- ç¡®å®šç›®æ ‡æ–‡ä»¶è·¯å¾„
        local targetFilePath = currentFile
        if not chkXAFOverwrite.checked do (
            -- åˆ›å»ºæ–°æ–‡ä»¶å¤¹å¹¶ä¿å­˜æ–‡ä»¶
            local importDir = (getFilenamePath currentFile) + "XAF_Import\\"
            if not doesDirectoryExist importDir do (
                makeDir importDir all:true
                format "[åˆ›å»ºç›®å½•] %\n" importDir
            )
            
            -- åˆ›å»ºæ–°æ–‡ä»¶å
            local newFileName = currentFileName + ".max"
            targetFilePath = importDir + newFileName
            
            -- æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™æ·»åŠ åºå·
            local counter = 1
            while doesFileExist targetFilePath do (
                newFileName = currentFileName + "_" + (counter as string) + ".max"
                targetFilePath = importDir + newFileName
                counter += 1
            )
        )
        
        -- åŠ è½½MAXæ–‡ä»¶
        if (loadMaxFile currentFile quiet:true) then (
            -- æ”¶é›†è¦å¯¼å…¥åŠ¨ç”»çš„éª¨éª¼
            local importBones = #()
            
            if importMode == "XAFé…ç½®å¯¼å…¥" and boneList.count > 0 then (
                -- ä½¿ç”¨XAFé…ç½®çš„éª¨éª¼åˆ—è¡¨
                for boneName in boneList do (
                    local boneObj = getNodeByName boneName
                    if isValidNode boneObj do append importBones boneObj
                )
                
                -- é€‰æ‹©è¿™äº›éª¨éª¼ä»¥ä¾¿ç”¨æˆ·éªŒè¯
                select importBones
                format "[é€‰æ‹©éª¨éª¼] å·²é€‰æ‹© % ä¸ªé…ç½®çš„éª¨éª¼è¿›è¡Œå¯¼å…¥\n" importBones.count
            ) else (
                -- è‡ªåŠ¨æ”¶é›†æ‰€æœ‰éª¨éª¼å’Œè™šæ‹Ÿä½“
                importBones = for obj in objects where (
                    classof obj == BoneGeometry or 
                    classof obj == Dummy or 
                    classof obj == Point or
                    classof obj == Biped_Object
                ) collect obj
                
                -- å°è¯•ä»XAFæ–‡ä»¶ä¸­æå–éª¨éª¼åç§°ï¼ˆä½¿ç”¨æ–°å‡½æ•°ï¼‰
                local xafBoneNames = extractBoneNamesFromXAF xafPath
                if xafBoneNames.count > 0 do (
                    -- å¦‚æœæˆåŠŸä»XAFæ–‡ä»¶ä¸­æå–åˆ°éª¨éª¼åç§°ï¼Œè¿‡æ»¤éª¨éª¼åˆ—è¡¨
                    local filteredBones = #()
                    for bone in importBones do (
                        if findItem xafBoneNames bone.name > 0 do append filteredBones bone
                    )
                    if filteredBones.count > 0 do importBones = filteredBones
                )
            )
            
            if importBones.count > 0 do (
                -- æ¸…é™¤éª¨éª¼ä¸Šçš„åŸæœ‰åŠ¨ç”»
                if clearBoneAnimation importBones then (
                    format "[æ¸…é™¤åŠ¨ç”»æˆåŠŸ] å·²æ¸…é™¤ % ä¸ªéª¨éª¼çš„åŠ¨ç”»æ•°æ®\n" importBones.count
                ) else (
                    format "[æ¸…é™¤åŠ¨ç”»å¤±è´¥] å¯èƒ½æ— æ³•å®Œå…¨æ¸…é™¤æ‰€æœ‰éª¨éª¼çš„åŠ¨ç”»\n"
                )
                
                -- å¯¼å…¥XAF
                try (
                    local userAttr = #()
                    local userVal = #()
                    
                    LoadSaveAnimation.loadAnimation xafPath importBones relative:true insert:true
                    format "[XAFå¯¼å…¥æˆåŠŸ] å·²å¯¼å…¥: %\n" xafPath
                    
                    -- ä¿å­˜æ–‡ä»¶
                    saveMaxFile targetFilePath
                    successCount += 1
                    
                    -- æ˜¾ç¤ºä¿å­˜ä¿¡æ¯
                    if not chkXAFOverwrite.checked do (
                        format "[æ–‡ä»¶ä¿å­˜] å·²ä¿å­˜åˆ°: %\n" targetFilePath
                    )
                )
                catch (
                    format "[XAFå¯¼å…¥é”™è¯¯] æ–‡ä»¶: % é”™è¯¯: %\n" xafPath (getCurrentException())
                )
            )
            
            -- é‡ç½®åœºæ™¯
            resetMaxFile #noPrompt
        )
        else (
            format "[é”™è¯¯] æ— æ³•åŠ è½½æ–‡ä»¶ï¼š%\n" currentFile
        )
        
        -- æ›´æ–°è¿›åº¦
        pbProgress.value = i
        
        -- æ›´æ–°è¿›åº¦æ˜¾ç¤º
        local progressPercent = (i as float / maxFiles.count * 100) as integer
        lblProgressInfo.text = "è¿›åº¦ï¼š" + (progressPercent as string) + "% | æˆåŠŸï¼š" + (successCount as string)
        windows.processPostedMessages()
    )
    
    -- å®Œæˆå¤„ç†
    lblProgressInfo.text = "XAFæ‰¹é‡å¯¼å…¥å®Œæˆï¼æˆåŠŸå¯¼å…¥ " + (successCount as string) + " ä¸ªæ–‡ä»¶"
    btnBatchImportXAF.enabled = true
    
    -- æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
    local completionMsg = "XAFå¯¼å…¥å®Œæˆï¼\n\n"
    completionMsg += "å¯¼å…¥æ¨¡å¼: " + importMode + "\n"
    completionMsg += "æ–‡ä»¶ä¿å­˜æ¨¡å¼: " + saveMode + "\n"
    completionMsg += "æˆåŠŸå¯¼å…¥: " + (successCount as string) + " ä¸ªæ–‡ä»¶"
    
    messageBox completionMsg title:"XAFå¯¼å…¥å®Œæˆ"
)

-- ä¸€é”®æ¢çš®- å®‰å…¨è·å–/skin åç§°å­—ç¬¦ä¸²å½¢å¼è¯†åˆ«-/å®šä¹‰/ è¯†åˆ« å¸¦ skin çš„ æ–‡ä»¶ ä¸ä½œå¤„ç† 
fn getSafeSkinName fPath = (
    local baseName = getFilenameFile fPath
    -- ç§»é™¤äº†å¯¹"@"çš„æ›¿æ¢ï¼Œåªæ›¿æ¢ç©ºæ ¼
    substituteString baseName " " "_"
    baseName
)

-- ä¸€é”®æ¢çš®/ä¿®æ­£åçš„æŠ¥å‘Šç”Ÿæˆå‡½æ•°ï¼ˆä¿æŒstringStreamç»“æ„ï¼‰
fn generateReplacementReport processFiles outputDir = (
    local reportData = stringStream "" -- ä¿æŒstringStreamç±»å‹
    
    try (
        -- å‚æ•°æ ¡éªŒå¢å¼º
        if classOf processFiles != Array OR processFiles.count == 0 do (
            format "[æŠ¥å‘Šé”™è¯¯] æ— æ•ˆçš„æ–‡ä»¶åˆ—è¡¨å‚æ•°\n"
            return reportData
        )
        
        if not doesDirectoryExist outputDir do (
            makeDir outputDir all:true -- è‡ªåŠ¨åˆ›å»ºç›®å½•
            format "[æŠ¥å‘Šæç¤º] å·²åˆ›å»ºè¾“å‡ºç›®å½•ï¼š%\n" outputDir
        )

        -- æŠ¥å‘Šå¤´ä¿¡æ¯ï¼ˆä½¿ç”¨æ ‡å‡†æ ¼å¼ï¼‰
        format "====== æ‰¹é‡æ¢çš®æ“ä½œæŠ¥å‘Š ======\n" to:reportData
        format "ç”Ÿæˆæ—¶é—´ï¼š%\n" (localTime as string) to:reportData
        format "çš®è‚¤æ¨¡æ¿æ–‡ä»¶ï¼š%\n" (maxFilePath + maxFileName) to:reportData
        format "å¤„ç†æ–‡ä»¶æ€»æ•°ï¼š%\n\n" processFiles.count to:reportData

        -- å…¨å±€ç»Ÿè®¡
        local totalOldBones = 0
        local totalNewBones = 0
        local totalDiffBones = 0
        local versionInfo = #()

        -- å®‰å…¨å¤„ç†æ¯ä¸ªæ–‡ä»¶
        for i=1 to processFiles.count do (
            local oldFile = processFiles[i]
            if not doesFileExist oldFile do (
                format "[è·³è¿‡] æ–‡ä»¶ä¸å­˜åœ¨ï¼š%\n" oldFile
                continue
            )
            
            try (
                -- æ–‡ä»¶åŸºç¡€ä¿¡æ¯
                local oldFileName = getFilenameFile oldFile
                local newFilePath = pathConfig.appendPath outputDir (oldFileName + "_Replaced.max")
                
                -- ç‰ˆæœ¬ä¿¡æ¯é‡‡é›†
                local fileVersion = try(getFileVersion oldFile)catch("æœªçŸ¥ç‰ˆæœ¬")
                append versionInfo #(oldFileName, fileVersion)

                -- éª¨éª¼ä¿¡æ¯å¯¹æ¯”
                local oldBones = #()
                local newBones = #()
                local diffBones = #()

                -- æ—§æ–‡ä»¶éª¨éª¼æ”¶é›†
                if loadMaxFile oldFile quiet:true do (
                    oldBones = for obj in objects where isAttachmentBone obj collect obj.name
                    resetMaxFile #noPrompt
                )

                -- æ–°æ–‡ä»¶éª¨éª¼æ”¶é›†
                if doesFileExist newFilePath AND loadMaxFile newFilePath quiet:true do (
                    newBones = for obj in objects where isAttachmentBone obj collect obj.name
                    resetMaxFile #noPrompt
                )

                -- å·®å¼‚è®¡ç®—
                diffBones = for b in newBones where findItem oldBones b == 0 collect b

                -- æ›´æ–°ç»Ÿè®¡
                totalOldBones += oldBones.count
                totalNewBones += newBones.count
                totalDiffBones += diffBones.count

                -- å†™å…¥æŠ¥å‘Š
                format "\n=== æ–‡ä»¶ï¼š% ===\n" oldFileName to:reportData
                format "MAXç‰ˆæœ¬ï¼š%\n" (fileVersion as string) to:reportData
                format "æ—§éª¨éª¼æ•°ï¼š% | æ–°éª¨éª¼æ•°ï¼š% | å·®å¼‚éª¨éª¼æ•°ï¼š%\n" \
                    oldBones.count \
                    newBones.count \
                    diffBones.count \
                    to:reportData
                
                if diffBones.count > 0 do (
                    format "å·®å¼‚éª¨éª¼åˆ—è¡¨ï¼š%\n" (diffBones as string) to:reportData
                )
            )
            catch (
                format "[æ–‡ä»¶å¤„ç†é”™è¯¯] % : %\n" oldFile (getCurrentException()) to:reportData
            )
        )

        -- å…¨å±€ç»Ÿè®¡ï¼ˆæ·»åŠ å®¹é”™å¤„ç†ï¼‰
        format "\n====== å…¨å±€ç»Ÿè®¡ ======\n" to:reportData
        format "æ€»å¤„ç†æ–‡ä»¶ï¼š%\n" processFiles.count to:reportData
        if processFiles.count > 0 do (
            format "å¹³å‡æ—§éª¨éª¼æ•°ï¼š%.1f\n" (totalOldBones as float / processFiles.count) to:reportData
            format "å¹³å‡æ–°éª¨éª¼æ•°ï¼š%.1f\n" (totalNewBones as float / processFiles.count) to:reportData
        )
        format "æ€»å·®å¼‚éª¨éª¼æ•°ï¼š%\n" totalDiffBones to:reportData

        -- ç‰ˆæœ¬ä¿¡æ¯è¾“å‡º
        format "\n====== æ–‡ä»¶ç‰ˆæœ¬ä¿¡æ¯ ======\n" to:reportData
        for entry in versionInfo do (
            format "æ–‡ä»¶ï¼š% | ç‰ˆæœ¬ï¼š%\n" entry[1] (entry[2] as string) to:reportData
        )
    )
    catch (
        format "\n[æŠ¥å‘Šç”Ÿæˆè‡´å‘½é”™è¯¯] %\n" (getCurrentException()) to:reportData
    )
    
    reportData -- è¿”å›stringStreamå¯¹è±¡
)

-- ä¸€é”®æ¢çš®/åœ¨ç»“æ„ä½“å®šä¹‰åæ·»åŠ é™„ä»¶éª¨éª¼è¿‡æ»¤å™¨
fn isAttachmentBone obj = (
    classOf obj == BoneGeometry or 
    classOf obj == Dummy or 
    classOf obj == Point
)

-- ä¸€é”®æ¢çš®/ä½¿ç”¨ç‰ˆæœ¬æ— å…³çš„Bipedæ¥å£
fn getBipedRoot = (
    try(biped.getRootNode selection[1])catch(
        try(BipedSys.getRootNode())catch(undefined)
    )
)

-- ä¸€é”®æ¢çš®/æ·»åŠ æ–‡ä»¶ä¿å­˜é‡è¯•é€»è¾‘
fn safeSaveFile path retry = (
    for i=1 to retry do (
        try (
            saveMaxFile path
            return true
        ) catch (
            format "ä¿å­˜å¤±è´¥(å°è¯•%æ¬¡)ï¼Œç­‰å¾…é‡è¯•...\n" i
            sleep 1.0
        )
    )
    false
)

-- ä¸€é”®æ¢çš®//æ–‡ä»¶æ•´ç†å‡½æ•°
fn organizeXafFiles outputDir = (
    local xafDir = pathConfig.appendPath outputDir "SkinReplace_Xaf"
    makeDir xafDir all:true
    
    -- æœç´¢æ‰€æœ‰å±‚çº§çš„XAFæ–‡ä»¶ï¼ˆåŒ…æ‹¬é”™è¯¯åµŒå¥—çš„æƒ…å†µï¼‰
    local allXafFiles = getFiles (pathConfig.appendPath outputDir "**/*.xaf") 
    
    for f in allXafFiles do (
        -- æå–çº¯æ–‡ä»¶å
        local fileName = filenameFromPath f
        local targetPath = pathConfig.appendPath xafDir fileName
        
        -- å¼ºåˆ¶è¦†ç›–å·²å­˜åœ¨æ–‡ä»¶
        if copyFile f targetPath then (
            deleteFile f
            format "[æ–‡ä»¶æ•´ç†] è¿ç§»ï¼š% â” %\n" f targetPath
        )
    )
    
    -- æ¸…ç†ç©ºç›®å½•ï¼ˆå¢å¼ºç‰ˆï¼‰
    local subDirs = getDirectories (pathConfig.appendPath outputDir "*")
    for d in subDirs where d != xafDir do (
        try (deleteDir d all:true) catch (
            format "[è­¦å‘Š] æ— æ³•åˆ é™¤ç›®å½•ï¼š%\n" d
        )
    )
)

fn exportAttachmentBones fPath exportDir = (
    try (
        -- ç¡®ä¿å¯¼å‡ºç›®å½•å­˜åœ¨
        if not doesDirectoryExist exportDir do (
            makeDir exportDir all:true
            format "[åˆ›å»ºç›®å½•] %\n" exportDir
        )
        
        -- åŠ è½½æ–‡ä»¶
        if not (loadMaxFile fPath quiet:true) do return false
        
        -- ä½¿ç”¨ä¸batchExportXAFç›¸åŒçš„éª¨éª¼æ”¶é›†æ–¹æ³•
        local saveBoneAni = for obj in objects where (
            classof obj == BoneGeometry or 
            classof obj == Dummy or 
            classof obj == Point or
            classof obj == Biped_Object
        ) collect obj
        
        -- å»é™¤é‡å¤éª¨éª¼ï¼ˆæŒ‰åç§°ï¼‰- ç²¾ç¡®å»é‡é€»è¾‘
        local tempArr = #()
        for j = 1 to saveBoneAni.count-1 do (
            for k = j+1 to saveBoneAni.count do (
                if saveBoneAni[j].name == saveBoneAni[k].name do (
                    append tempArr (if saveBoneAni[k] == undefined then saveBoneAni[k] else saveBoneAni[j])
                )
            )
        )
        
        -- åˆ é™¤é‡å¤é¡¹
        if tempArr.count != 0 do (
            for obj in tempArr do (
                for p = saveBoneAni.count to 1 by -1 do (
                    if saveBoneAni[p] == obj do deleteItem saveBoneAni p
                )
            )
        )
        
        -- ç¡®ä¿æ‰€æœ‰å¯¹è±¡éƒ½æœ‰æœ‰æ•ˆçš„å˜æ¢æ§åˆ¶å™¨
        for obj in saveBoneAni do (
            try (
                -- ç¡®ä¿ä½ç½®æ§åˆ¶å™¨æœ‰æ•ˆ
                if obj.pos.controller == undefined do (
                    obj.pos.controller = Bezier_Position()
                )
                
                -- ç¡®ä¿æ—‹è½¬æ§åˆ¶å™¨æœ‰æ•ˆ
                if obj.rotation.controller == undefined do (
                    obj.rotation.controller = Euler_XYZ()
                )
                
                -- ç¡®ä¿ç¼©æ”¾æ§åˆ¶å™¨æœ‰æ•ˆ
                if obj.scale.controller == undefined do (
                    obj.scale.controller = Bezier_Scale()
                )
            ) catch (
                format "[è­¦å‘Š] æ— æ³•ä¸º % è®¾ç½®å˜æ¢æ§åˆ¶å™¨\n" obj.name
            )
        )

        if saveBoneAni.count > 0 do (
            -- æ„å»ºXAFæ–‡ä»¶è·¯å¾„
            local baseName = getFilenameFile fPath
            local xafPath = exportDir + "\\" + baseName + ".xaf"  -- ç›´æ¥ä¿å­˜åˆ°æŒ‡å®šç›®å½•
            
            -- ä½¿ç”¨MAXåŸç”Ÿæ–¹æ³•ä¿å­˜åŠ¨ç”»
            local userAttr = #()
            local userVal = #()
            
            try (
                LoadSaveAnimation.saveAnimation xafPath saveBoneAni &userAttr &userVal
                format "[XAFå¯¼å‡ºæˆåŠŸ] è·¯å¾„ï¼š%\n" xafPath
                
                -- ä¿å­˜æ—¶é—´èŒƒå›´ä¿¡æ¯
                local timeRangeFile = exportDir + "\\" + baseName + "_time.txt"
                try (
                    local fs = createFile timeRangeFile
                    local sourceTimeRange = #(animationRange.start, animationRange.end)
                    format "%\n" sourceTimeRange to:fs
                    close fs
                    format "[æ—¶é—´èŒƒå›´ä¿å­˜] %\n" timeRangeFile
                ) catch (
                    format "[è­¦å‘Š] æ—¶é—´èŒƒå›´ä¿å­˜å¤±è´¥: %\n" (getCurrentException())
                )
                
                return true
            )
            catch (
                format "[XAFå¯¼å‡ºé”™è¯¯] æ–‡ä»¶: % é”™è¯¯: %\n" fPath (getCurrentException())
                return false
            )
        )
        
        -- é‡ç½®åœºæ™¯
        resetMaxFile #noPrompt
        return false
    )
    catch (
        format "[XAFå¯¼å‡ºå¤±è´¥] % : %\n" fPath (getCurrentException())
        resetMaxFile #noPrompt
        return false
    )
)

-- ä¸€é”®æ¢çš® / ä½¿ç”¨ç¨³å®šçš„XAFå¯¼å…¥åŠŸèƒ½
fn importXafAnimation fPath = (
    try (
        -- æ£€æŸ¥XAFè®¾ç½®æ˜¯å¦é…ç½®
        local boneList = loadXAFSettings()
        local importMode = if boneList.count == 0 then "å…¨éƒ¨å¯¼å…¥" else "XAFé…ç½®å¯¼å…¥"
        
        -- æ”¶é›†è¦å¯¼å…¥åŠ¨ç”»çš„éª¨éª¼
        local importBones = #()
        
        if importMode == "XAFé…ç½®å¯¼å…¥" and boneList.count > 0 then (
            -- ä½¿ç”¨XAFé…ç½®çš„éª¨éª¼åˆ—è¡¨
            for boneName in boneList do (
                local boneObj = getNodeByName boneName
                if isValidNode boneObj do append importBones boneObj
            )
        ) else (
            -- è‡ªåŠ¨æ”¶é›†æ‰€æœ‰éª¨éª¼å’Œè™šæ‹Ÿä½“
            importBones = for obj in objects where (
                classof obj == BoneGeometry or 
                classof obj == Dummy or 
                classof obj == Point or
                classof obj == Biped_Object
            ) collect obj
        )
        
        if importBones.count == 0 do (
            messageBox "åœºæ™¯ä¸­æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„éª¨éª¼æˆ–è™šæ‹Ÿä½“ï¼" title:"é”™è¯¯"
            return false
        )
        
        -- æ¸…é™¤éª¨éª¼ä¸Šçš„åŸæœ‰åŠ¨ç”»
        if not clearBoneAnimation importBones do (
            format "[è­¦å‘Š] æ— æ³•å®Œå…¨æ¸…é™¤æ‰€æœ‰éª¨éª¼çš„åŠ¨ç”»\n"
        )
        
        -- åŠ è½½åŠ¨ç”»
        LoadSaveAnimation.loadAnimation fPath importBones relative:true insert:true
        format "[æˆåŠŸ] å·²å¯¼å…¥XAFåŠ¨ç”»ï¼š%\n" fPath
        return true
    ) catch (
        format "[XAFå¯¼å…¥é”™è¯¯] %\n" (getCurrentException())
        return false
    )
)
-- ä¸€é”®æ¢çš®//åœ¨BIPå¯¼å…¥å‡½æ•°åæ·»åŠ é™„ä»¶/éª¨éª¼å¯¼å…¥å‡½æ•°

fn importAttachmentBones fPath = (
    try (
        local loadBoneAni = #()
        local regex = (dotnetclass "System.Text.RegularExpressions.Regex")
        
        -- å®Œå…¨ä½¿ç”¨newçš„UIæ§ä»¶å¼•ç”¨æ–¹å¼
        local excludePrefix = Bip_batchTool.batchUtil_R.ed_text_name.text
        
        for obj in geometry where (
            classOf obj == BoneGeometry and 
            (
                excludePrefix == "" or 
                not regex.IsMatch obj.name ("^" + excludePrefix) -- new
            )
        ) collect obj
        
        -- æ—‹è½¬æ¨¡å¼æ§åˆ¶(ä¿æŒnewé€»è¾‘)
        if Bip_batchTool.batchUtil_R.tcbEuler_chk.checked do (
            case Bip_batchTool.batchUtil_R.tcbEulerStyle_rdo.state of (
                1: (for o in loadBoneAni do o.rotation.controller = TCB_Rotation())
                2: (for o in loadBoneAni do o.rotation.controller = Euler_XYZ())
            )
        )

        -- ä¸¥æ ¼éµå¾ªnewçš„åŠ è½½æ–¹å¼
        LoadSaveAnimation.loadAnimation fPath loadBoneAni relative:true insert:true
        true
    )
    catch (
        format "Error: %\n" (getCurrentException())
        false
    )
)

-- ä¸€é”®æ¢çš®//æ ¸å¿ƒæ¢çš®åŠŸèƒ½å‡½æ•°
fn processSkinReplacement = (
    g_exportAbortFlag = false
    pbProgress.value = 0
    lblProgressInfo.text = "å‡†å¤‡å¼€å§‹æ¢çš®..."
    
    -- è‡ªåŠ¨æŸ¥æ‰¾æ ¹éª¨éª¼é€»è¾‘
    fn findRootBones = (
        local allBones = for obj in objects where isAttachmentBone obj collect obj
        local rootBones = #()
        
        -- æ·»åŠ Bipedç³»ç»Ÿæ£€æµ‹
        local bipedRoots = for obj in objects where classOf obj == Biped_Object collect obj
        if bipedRoots.count > 0 do (
            append rootBones bipedRoots[1]  -- ä¼˜å…ˆä½¿ç”¨Bipedæ ¹éª¨éª¼
            return rootBones
        )
        
        -- æ ‡å‡†éª¨éª¼æ£€æµ‹
        for b in allBones do (
            if b.parent == undefined or (findItem allBones b.parent) == 0 do (
                append rootBones b
            )
        )
        
        -- æ·»åŠ ç©ºå€¼ä¿æŠ¤
        if rootBones.count == 0 do (
            messageBox "æœªæ‰¾åˆ°ä»»ä½•æœ‰æ•ˆæ ¹éª¨éª¼ï¼" title:"éª¨éª¼é”™è¯¯"
            return #()
        )
        rootBones
    )
    
    -- éªŒè¯åœºæ™¯éª¨éª¼
    local rootBones = findRootBones()
    if rootBones.count == 0 do (
        return false
    )
    
    -- è·å–å½“å‰çš®è‚¤æ–‡ä»¶ä¿¡æ¯ï¼ˆä¼˜å…ˆä½¿ç”¨å½“å‰æ‰“å¼€çš„åœºæ™¯ä½œä¸ºæ¨¡æ¿ï¼‰
    local currentSkinFile = maxFilePath + maxFileName
    local currentSkinName = getFilenameFile currentSkinFile
    
    -- åˆ›å»ºæ ‡å‡†ç›®å½•ç»“æ„
    local outputDir = pathConfig.appendPath (getDir #scene) g_skinNewFolderName
    local bipDir = pathConfig.appendPath outputDir "SkinReplace_Bip"  -- BIPå­˜å‚¨ç›®å½•
    local boneDir = pathConfig.appendPath outputDir "SkinReplace_Xaf" -- é™„ä»¶éª¨éª¼ç›®å½•
    makeDir outputDir all:true
    makeDir bipDir all:true
    makeDir boneDir all:true
    
    -- è¿‡æ»¤å¤„ç†åˆ—è¡¨ï¼šè·å–æ‰€æœ‰éskinçš„maxæ–‡ä»¶
    local processFiles = #()
    for i=0 to (Lv_model.Items.Count-1) do (
        local item = Lv_model.Items.Item[i]
        local rawPath = item.Tag as String
        
        -- è·³è¿‡æ‰€æœ‰ç›®å½•é¡¹
        local isDirectory = matchPattern rawPath pattern:"*[DIR]*" or (getFilenameType rawPath) == ""
        if isDirectory do continue
        
        -- æ ‡å‡†åŒ–è·¯å¾„å¤„ç†
        local filePath = pathConfig.normalizePath rawPath
        
        -- æœ‰æ•ˆæ€§éªŒè¯
        if not doesFileExist filePath or (toLower (getFilenameType filePath)) != ".max" do continue
        
        -- è¿‡æ»¤SKINç›¸å…³æ–‡ä»¶ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
        local fileNameCheck = toLower (getFilenameFile filePath)
        local isSkinFile = findString fileNameCheck "skin" != undefined
        
        -- æ’é™¤skinæ–‡ä»¶
        if not isSkinFile do (
            append processFiles filePath
            format "[é€šè¿‡è¿‡æ»¤] æœ‰æ•ˆæ–‡ä»¶ï¼š%\n" filePath
        )
    )
    
    -- å¦‚æœå½“å‰æ‰“å¼€çš„æ–‡ä»¶ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œä¸”ä¸æ˜¯skinæ–‡ä»¶ï¼Œåˆ™æ·»åŠ åˆ°å¤„ç†åˆ—è¡¨
    if currentSkinFile != undefined and currentSkinFile != "" and doesFileExist currentSkinFile then (
        local currentFileNameCheck = toLower (getFilenameFile currentSkinFile)
        local isCurrentSkinFile = findString currentFileNameCheck "skin" != undefined
        
        if not isCurrentSkinFile do (
            -- æ£€æŸ¥å½“å‰æ‰“å¼€çš„æ–‡ä»¶æ˜¯å¦å·²ç»åœ¨å¤„ç†åˆ—è¡¨ä¸­
            local found = false
            for f in processFiles do (
                if (pathConfig.normalizePath f) == (pathConfig.normalizePath currentSkinFile) do (
                    found = true
                    exit
                )
            )
            if not found do (
                append processFiles currentSkinFile
                format "[æ·»åŠ å½“å‰æ–‡ä»¶] æœ‰æ•ˆæ–‡ä»¶ï¼š%\n" currentSkinFile
            )
        )
    )
    
    if processFiles.count == 0 do (
        messageBox "æœ‰æ•ˆæ–‡ä»¶åˆ—è¡¨ä¸ºç©ºï¼" title:"æ“ä½œä¸­æ­¢"
        return false
    )
    
    -- è®¾ç½®è¿›åº¦æ¡æœ€å¤§å€¼
    pbProgress.maximum = processFiles.count
    
    local successCount = 0
    local reportData = generateReplacementReport processFiles outputDir
    
    for i=1 to processFiles.count where not g_exportAbortFlag do (
        if keyboard.escPressed do (
            g_exportAbortFlag = true
            lblProgressInfo.text = "ç”¨æˆ·ä¸­æ–­æ“ä½œï¼"
            exit
        )

        local oldFile = processFiles[i]
        local oldFileName = getFilenameFile oldFile
        if classOf oldFileName != String do (
            format "[é”™è¯¯] æ— æ•ˆæ–‡ä»¶åç±»å‹ï¼š%\n" (classOf oldFileName)
            continue
        )
        lblProgressInfo.text = "å¤„ç†ä¸­ï¼š" + oldFileName + " (" + (i as string) + "/" + (processFiles.count as string) + ")"
        
        -- å¯¼å‡ºæ—§æ–‡ä»¶æ•°æ®
        if loadMaxFile oldFile quiet:true do (
            -- å¯¼å‡ºBIPåˆ°ç»Ÿä¸€ç›®å½•
            local bipRoots = for obj in objects where classOf obj == Biped_Object collect obj
            if bipRoots.count > 0 do (
                local bipPath = bipDir + "\\" + oldFileName + ".bip"
                format "[å¯¼å‡ºBIP] è·¯å¾„ï¼š%\n" bipPath
                try (
                    biped.saveBipFile bipRoots[1].controller bipPath
                    format "[BIPå¯¼å‡ºæˆåŠŸ] %\n" bipPath
                ) catch (
                    format "[BIPå¯¼å‡ºå¤±è´¥] %\n" bipPath
                )
            )
            
            -- å¯¼å‡ºé™„ä»¶éª¨éª¼åˆ°ç»Ÿä¸€ç›®å½•ï¼ˆä½¿ç”¨ç¨³å®šçš„XAFå¯¼å‡ºå‡½æ•°ï¼‰
            try (
                exportAttachmentBones oldFile boneDir  -- ç›´æ¥å¯¼å‡ºåˆ°boneDir
            ) catch (
                format "[XAFå¯¼å‡ºå¤±è´¥] %\n" oldFile
            )
            
            resetMaxFile #noPrompt
        )
        
        -- å¯¼å…¥åˆ°æ–°çš®è‚¤æ–‡ä»¶ï¼ˆå½“å‰æ‰“å¼€çš„åœºæ™¯ï¼‰
        if loadMaxFile currentSkinFile quiet:true do (
            -- å¯¼å…¥BIPæ•°æ®
            local targetBip = findRootBones()
            if targetBip.count > 0 do (
                local bipPath = bipDir + "\\" + oldFileName + ".bip"
                if doesFileExist bipPath do (
                    format "[å¯¼å…¥BIP] è·¯å¾„ï¼š%\n" bipPath
                    try (
                        biped.loadBipFile targetBip[1].controller bipPath
                        format "[BIPå¯¼å…¥æˆåŠŸ] %\n" bipPath
                    ) catch (
                        format "[BIPå¯¼å…¥å¤±è´¥] %\n" bipPath
                    )
                )
            )
            
            -- å¯¼å…¥é™„ä»¶éª¨éª¼ï¼ˆä½¿ç”¨ç¨³å®šçš„XAFå¯¼å…¥å‡½æ•°ï¼‰
            -- ç›´æ¥åœ¨SkinReplace_Xafç›®å½•ä¸­æŸ¥æ‰¾XAFæ–‡ä»¶
            local xafPath = boneDir + "\\" + oldFileName + ".xaf"
            
            if doesFileExist xafPath do (
                try (
                    importXafAnimation xafPath
                    format "[XAFå¯¼å…¥æˆåŠŸ] %\n" xafPath
                ) catch (
                    format "[XAFå¯¼å…¥å¤±è´¥] %\n" xafPath
                )
            )
            
            -- ä¿å­˜æ–°æ–‡ä»¶åˆ°ä¸»ç›®å½•ï¼ˆä½¿ç”¨åŸæ–‡ä»¶åï¼Œä¸åŠ å‰ç¼€ï¼‰
            local newFileName = oldFileName + "_Replaced.max"
            local newFilePath = outputDir + "\\" + newFileName
            
            -- æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™æ·»åŠ åºå·
            local counter = 1
            while doesFileExist newFilePath do (
                newFileName = oldFileName + "_Replaced_" + (counter as string) + ".max"
                newFilePath = outputDir + "\\" + newFileName
                counter += 1
            )
            
            format "[ä¿å­˜æ–‡ä»¶] è·¯å¾„ï¼š%\n" newFilePath
            try (
                saveMaxFile newFilePath
                successCount += 1
            ) catch (
                format "[æ–‡ä»¶ä¿å­˜å¤±è´¥] %\n" newFilePath
            )
        )
        
        -- è¿›åº¦æ›´æ–°
        pbProgress.value = i
        lblProgressInfo.text = "è¿›åº¦ï¼š" + ((100.0*i/processFiles.count) as integer) as string + "% | æˆåŠŸï¼š" + (successCount as string)
        windows.processPostedMessages()
        gc()
    )
    
    -- ä¿å­˜æŠ¥å‘Šæ–‡ä»¶
    if classOf reportData == StringStream do (
        try (
            local reportPath = outputDir + "\\Replacement_Report.txt"
            local reportFile = createFile reportPath
            format "%" (reportData as string) to:reportFile
            close reportFile
            format "[æŠ¥å‘Šä¿å­˜æˆåŠŸ] è·¯å¾„ï¼š%\n" reportPath
        )
        catch (
            format "[æŠ¥å‘Šä¿å­˜å¤±è´¥] é”™è¯¯ï¼š%\n" (getCurrentException())
        )
    )
    
    -- åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
    AutoExportTool_Pro.refreshFileListView()
    
    -- å®Œæˆå¤„ç†
    lblProgressInfo.text = "ä¸€é”®æ¢çš®å®Œæˆï¼æˆåŠŸå¤„ç† " + (successCount as string) + " ä¸ªæ–‡ä»¶"
    if chk_autoOpenDir.checked do ShellLaunch "explorer.exe" outputDir
    
    -- æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
    messageBox ("æ“ä½œå®Œæˆï¼\næˆåŠŸæ–‡ä»¶: " + (successCount as string) + " ä¸ª\nå¤±è´¥æ–‡ä»¶: " + ((processFiles.count - successCount) as string) + " ä¸ª") title:"ä¸€é”®æ¢çš®æŠ¥å‘Š"
    -- ä¸å†éœ€è¦organizeXafFilesï¼Œå› ä¸ºXAFæ–‡ä»¶å·²ç»ç›´æ¥ä¿å­˜åœ¨SkinReplace_Xafæ–‡ä»¶å¤¹
)

-- UI æŒä¹…åŒ– / å®‰å…¨é¢œè‰²åŠ è½½å‡½æ•° 
fn loadColorSettings section defaultColor = (
    local col = copy defaultColor
    try (
        col.r = execute (getINISetting g_UIConfigPath section "R")
        col.g = execute (getINISetting g_UIConfigPath section "G")
        col.b = execute (getINISetting g_UIConfigPath section "B")
    ) catch (
        format "[é¢œè‰²åŠ è½½é”™è¯¯] ä½¿ç”¨é»˜è®¤å€¼ï¼š%\n" defaultColor
    )
    col
)

-- UI æŒä¹…åŒ– / å®‰å…¨ä¿å­˜æ‰€æœ‰UIçŠ¶æ€ / è®°å½• äº‹ä»¶æŒ‰é’®å‹¾é€‰çŠ¶æ€ 
fn saveUIConfig = (
    try (
        -- ä¿å­˜å‹¾é€‰çŠ¶æ€ chkXAFOverwrite
        --setINISetting g_UIConfigPath "Checkboxes" "chkExportToEngine" (chkExportToEngine.checked as string)
        setINISetting g_UIConfigPath "Checkboxes" "chkXAFOverwrite" (chkXAFOverwrite.checked as string)
        setINISetting g_UIConfigPath "Checkboxes" "chkAddDateSuffix" (chkAddDateSuffix.checked as string)
        setINISetting g_UIConfigPath "Checkboxes" "chkAutoFolder" (chkAutoFolder.checked as string)
        setINISetting g_UIConfigPath "Checkboxes" "chkChangeFont" (chkChangeFont.checked as string)
        setINISetting g_UIConfigPath "Checkboxes" "chkGridLines" (chkGridLines.checked as string)
        setINISetting g_UIConfigPath "Checkboxes" "auto_socket" (auto_socket.checked as string)
        setINISetting g_UIConfigPath "Checkboxes" "auto_makedir_set" (auto_makedir_set.checked as string)
        setINISetting g_UIConfigPath "Checkboxes" "chk_autoOpenDir" (chk_autoOpenDir.checked as string)
        
        -- ä¿å­˜é¢œè‰²åˆ†é‡
        setINISetting g_UIConfigPath "FolderColor" "R" (cpFolder.color.r as string)
        setINISetting g_UIConfigPath "FolderColor" "G" (cpFolder.color.g as string)
        setINISetting g_UIConfigPath "FolderColor" "B" (cpFolder.color.b as string)
        
        setINISetting g_UIConfigPath "FileColor" "R" (cpFile.color.r as string)
        setINISetting g_UIConfigPath "FileColor" "G" (cpFile.color.g as string)
        setINISetting g_UIConfigPath "FileColor" "B" (cpFile.color.b as string)

        -- ä¿å­˜æ»‘å—å€¼ï¼ˆå¢åŠ èŒƒå›´éªŒè¯ï¼‰
        local currentValue = sldBgColor.value
        local bgValue = amax 0 (amin 255 sldBgColor.value)
        setINISetting g_UIConfigPath "Settings" "BgGrayValue" (bgValue as string)
        
        format "[SaveUIConfig] Saved BgValue: %\n" currentValue
    )
    catch (
        format "[SaveUIConfig Error] %\n" (getCurrentException())
    )
)

-- UI æŒä¹…åŒ– /è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨è½¬æ¢INIå€¼ä¸ºæ•´æ•°
fn getSafeInteger iniSection iniKey defaultVal = (
    try (
        local valStr = getINISetting g_UIConfigPath iniSection iniKey
        if valStr == "" do return defaultVal
        valInt = valStr as integer
        if classOf valInt != Integer do return defaultVal
        return valInt
    ) catch (return defaultVal)
)
-- UI æŒä¹…åŒ– /å®‰å…¨æ•°å€¼è½¬æ¢è¾…åŠ©å‡½æ•°
fn executeSafe str defaultValue = (
    try (execute str) catch (
        try (str as integer) catch defaultValue
    )
)

-- UI æŒä¹…åŒ– /æ™ºèƒ½åˆå§‹åŒ–-..åŠ è½½-..åˆ—è¡¨èƒŒæ™¯ç°åº¦å€¼ï¼ˆé¢œè‰²ï¼‰/UI/åˆå§‹åŒ–é…ç½®
fn setBackgroundColor val = (
    lblBgValue.text = val as string
    Lv_model.BackColor = (dotNetClass "System.Drawing.Color").FromArgb val val val
    setINISetting g_UIConfigPath "Settings" "BgGrayValue" (val as string)
)

-- UI æŒä¹…åŒ– /æ™ºèƒ½åŠ è½½UIé…ç½®
fn loadUIConfig = (
    try (
        
        -- åŠ è½½å‹¾é€‰çŠ¶æ€ï¼ˆå¸¦é»˜è®¤å€¼ï¼‰
        --chkExportToEngine.checked = getINISetting g_UIConfigPath "Checkboxes" "chkExportToEngine" == "true"
        chkXAFOverwrite.checked = getINISetting g_UIConfigPath "Checkboxes" "chkXAFOverwrite" == "true"
        chkAddDateSuffix.checked = getINISetting g_UIConfigPath "Checkboxes" "chkAddDateSuffix" == "true"
        chkAutoFolder.checked = getINISetting g_UIConfigPath "Checkboxes" "chkAutoFolder" == "true"
        chkChangeFont.checked = getINISetting g_UIConfigPath "Checkboxes" "chkChangeFont" == "true"
        chkGridLines.checked = getINISetting g_UIConfigPath "Checkboxes" "chkGridLines" == "true"
        auto_socket.checked = getINISetting g_UIConfigPath "Checkboxes" "auto_socket" == "true"
        auto_makedir_set.checked = getINISetting g_UIConfigPath "Checkboxes" "auto_makedir_set" == "true"
        chk_autoOpenDir.checked = getINISetting g_UIConfigPath "Checkboxes" "chk_autoOpenDir" == "true"
        
        -- åŠ è½½é¢œè‰²
        cpFolder.color = loadColorSettings "FolderColor" (color 245 245 125)
        cpFile.color = loadColorSettings "FileColor" (color 255 255 255)
        
        -- åŠ è½½æ»‘å—å€¼ï¼ˆå¸¦é”™è¯¯å¤„ç†å’ŒèŒƒå›´é™åˆ¶ï¼‰
        local bgValue = executeSafe (getINISetting g_UIConfigPath "Settings" "BgGrayValue") g_defaultBgValue
        bgValue = amax 0 (amin 255 bgValue)  -- å¼ºåˆ¶é™åˆ¶åœ¨0-255
        
        -- æ›´æ–°UIç»„ä»¶
        sldBgColor.value = bgValue
        lblBgValue.text = bgValue as string
        
        -- ç›´æ¥è®¾ç½®èƒŒæ™¯è‰²
        Lv_model.BackColor = (dotNetClass "System.Drawing.Color").FromArgb bgValue bgValue bgValue
        
        format "[LoadUIConfig] BgValue: %\n" bgValue
        ) catch (
        format "[LoadUIConfig Error] %\n" (getCurrentException())
        
        -- æ¢å¤å®‰å…¨é»˜è®¤å€¼
        sldBgColor.value = g_defaultBgValue
        lblBgValue.text = g_defaultBgValue as string
        Lv_model.BackColor = (dotNetClass "System.Drawing.Color").FromArgb g_defaultBgValue g_defaultBgValue g_defaultBgValue
        )
)

-- åœ¨å·¥å…·åˆå§‹åŒ–æ—¶å¢åŠ è·¯å¾„å¥åº·æ£€æŸ¥
fn checkPathHealth path = (
    local retry = 3
    while retry > 0 do (
        if doesDirectoryExist path do return true
        dotNet.invokeMethod (dotNetClass "System.Threading.Thread") "Sleep" 1000
        retry -= 1
    )
    false
)

-- 4. æ–°å¢è¾…åŠ©å‡½æ•°
fn getDisplayName fullPath baseDepth = (
    local pathParts = filterString fullPath "\\"
    local depth = pathParts.count - baseDepth
    (substring fullPath (currentPath.count + 2) -1) -- æ˜¾ç¤ºç›¸å¯¹è·¯å¾„
)

-- å¼ºåŒ–æ–‡ä»¶è·å–é€»è¾‘ 
fn getProcessFiles = (
    local files = #()
    for i = 0 to (Lv_model.Items.Count - 1) where Lv_model.Items.Item[i].Checked do (
        local fPath = Lv_model.Items.Item[i].Tag as String
        if doesFileExist fPath and (getFilenameType fPath) == ".max" do append files fPath
    )
    if files.count == 0 do files = for f in model_files_array where (getFilenameType f) == ".max" and (doesFileExist f) collect f
)

-- BIPæ¨¡å¼é…ç½® / å”¯ä¸€æ–‡ä»¶åç”Ÿæˆå™¨
fn uniqueBipName baseName saveDir = (
    local counter = 1
    while true do (
        local testName = baseName + "_" + (formattedPrint counter format:"03d")
        local targetPath = pathConfig.appendPath saveDir (testName + ".max")
        if not doesFileExist targetPath do return testName
        counter += 1
    )
)

-- BIPæ¨¡å¼é…ç½® / ä¿®æ­£çš„å¯¼å‡ºBIPé€»è¾‘ï¼ˆè°ƒç”¨åŸç”Ÿä¿å­˜å¯¹è¯æ¡†ï¼‰
fn exportBipFile = (
    try (
        local bipRoot = getNodeByName "Bip001" exact:true
        if not isValidNode bipRoot do throw "æœªæ‰¾åˆ°æœ‰æ•ˆçš„Bipedæ ¹éª¨éª¼"
        
        -- è§¦å‘åŸç”Ÿä¿å­˜å¯¹è¯æ¡†
        biped.saveBipFile bipRoot.controller
        
        -- æ•è·ä¿å­˜å¯¹è¯æ¡†
        local mainHWND = windows.getMAXHWND()
        local counter = 0
        local saveDlg = undefined
        while (saveDlg == undefined and counter < 20) do (
            sleep 0.1
            saveDlg = UIAccessor.FindWindow "Save Biped Animation File" ""
            counter += 1
        )
        
        -- è‡ªåŠ¨è®¾ç½®é»˜è®¤æ–‡ä»¶å
        if saveDlg != undefined do (
            UIAccessor.SetWindowText (UIAccessor.GetWindowChildByID saveDlg 0x480) "exported_anim.bip"
            UIAccessor.PressButtonByID saveDlg 0x1 -- ç¡®è®¤ä¿å­˜
        )
    )
    catch (
        messageBox ("å¯¼å‡ºå¤±è´¥:\n" + getCurrentException()) title:"è‡´å‘½é”™è¯¯"
    )
)

-- BIPæ¨¡å¼é…ç½® / ç‹¬ç«‹BIPå¯¼å‡ºè¿›ç¨‹
fn processBipExport fPath = (
    try (
        if not (loadMaxFile fPath quiet:true) do return false
        
        -- è·å–å¯¼å‡ºç±»å‹
        local exportType = case rdo_bipMode.state of (
            1: #bip
            2: #bone
            default: #none
        )
        
        -- ç±»å‹éªŒè¯
        case exportType of (
            #bip: (
                local bipRoots = for obj in objects where classOf obj == Biped_Object collect obj
                if bipRoots.count == 0 do return false
                outDir = pathConfig.appendPath edtExportPath.text "BIP_Exports"
            )
            #bone: (
                local boneNodes = for obj in objects where 
                    (matchPattern obj.name pattern:"*Bone*") or 
                    (classOf obj == Dummy) collect obj
                if boneNodes.count == 0 do return false
                outDir = pathConfig.appendPath edtExportPath.text "Bone_Exports"
            )
        )
        
        -- åˆ›å»ºè¾“å‡ºç›®å½•
        makeDir outDir all:true
        
        -- å¯¼å‡ºé€»è¾‘
        case exportType of (
            #bip: (
                outPath = pathConfig.appendPath outDir (getFilenameFile fPath + ".bip")
                biped.saveBipFile bipRoots[1].controller outPath
            )
            #bone: (
                outPath = pathConfig.appendPath outDir (getFilenameFile fPath + ".xaf")
                exportFile outPath #noPrompt selectedOnly:true using:XAFFormat
            )
        )
        
        format "[æˆåŠŸå¯¼å‡º] %\n" outPath
        true
    )
    catch (
        format "[å¯¼å‡ºå¤±è´¥] % : %\n" fPath (getCurrentException())
        false
    )
)

fn validateExportSettings = (
    -- æ£€æŸ¥è‡³å°‘å‹¾é€‰ä¸€ä¸ªå¯¼å‡ºç±»å‹
    if not chkExportBip.checked and not chkExportBones.checked do (
        messageBox "æœªå‹¾é€‰ä»»ä½•å¯¼å‡ºç±»å‹ï¼" title:"å¯¼å‡ºé…ç½®é”™è¯¯"
        return false
    )
    
    -- æ£€æŸ¥æ¨¡å¼ä¸å‹¾é€‰æ¡†çš„å…¼å®¹æ€§
    if rdo_bipMode.state == 1 and not chkExportBip.checked do (
        messageBox "BIPå¯¼å‡ºæ¨¡å¼éœ€è¦å‹¾é€‰BIPå¯¼å‡ºé¡¹ï¼" title:"æ¨¡å¼ä¸åŒ¹é…"
        return false
    )
    
    true
)

-- å¼ºåŒ–æ–‡ä»¶è·å–é€»è¾‘
fn getBipProcessFiles mode enableCheck = (
    local processFiles = #()
    for i=0 to (Lv_model.Items.Count-1) do (
        local fPath = Lv_model.Items.Item[i].Tag as String
        local isChecked = Lv_model.Items.Item[i].Checked
        local isValid = case mode of (
            1: (getFilenameType fPath == ".max" and doesFileExist fPath)  -- å¯¼å‡ºæ¨¡å¼æ£€æŸ¥MAXæ–‡ä»¶
            2: (getFilenameType fPath == ".bip" and isValidBipFile fPath) -- å¯¼å…¥æ¨¡å¼æ£€æŸ¥BIPæ–‡ä»¶
        )
        
        case enableCheck of (
            true:  (if isChecked and isValid do append processFiles fPath)
            false: (if isValid do append processFiles fPath)
        )
    )
    processFiles
)

----------------------------------------------------------------

-- æ›´æ–°è¿›åº¦æ˜¾ç¤º / ä¼˜åŒ–è¿›åº¦åé¦ˆæœºåˆ¶
fn updateProgressInfo current total success = (
    local progressPercent = (100.0 * current / total) as integer
    lblProgressInfo.text = "è¿›åº¦ï¼š" + (progressPercent as string) + "% | æˆåŠŸï¼š" + (success as string)
    pbProgress.value = current
    windows.processPostedMessages()
)

-- æ‰¹é‡BIPå¯¼å‡ºå¯¼å…¥ / ç»Ÿä¸€å¤„ç†å…¥å£å‡½æ•°ï¼ˆå¤„ç†å‹¾é€‰æˆ–å…¨éƒ¨æ–‡ä»¶ï¼‰
fn processBipFiles mode enableCheck = (
    g_exportAbortFlag = false
    pbProgress.value = 0
    lblProgressInfo.text = "å‡†å¤‡å¼€å§‹..."
    
    -- è·å–éœ€è¦å¤„ç†çš„æ–‡ä»¶åˆ—è¡¨
    local processFiles = getBipProcessFiles mode enableCheck
    if processFiles.count == 0 do (
        messageBox (if enableCheck then "æœªå‹¾é€‰æœ‰æ•ˆæ–‡ä»¶ï¼" else "åˆ—è¡¨ä¸­æ²¡æœ‰æœ‰æ•ˆæ–‡ä»¶ï¼") title:"æ“ä½œä¸­æ­¢" beep:true
        return false
    )
    
    --pbProgress.maximum = processFiles.count
    local successCount = 0
    
    for i=1 to processFiles.count where not g_exportAbortFlag do (
        -- ESCé”®ä¸­æ–­æ£€æµ‹
        if keyboard.escPressed do (
            g_exportAbortFlag = true
            lblProgressInfo.text = "æ“ä½œå·²ä¸­æ–­ï¼"
            windows.processPostedMessages()
            messageBox "BIPå¯¼å…¥è¿›ç¨‹å·²è¢«ç”¨æˆ·ä¸­æ–­ï¼" title:"æç¤º" beep:true
            exit
        )
        
        local fPath = processFiles[i]
        lblProgressInfo.text = "å¤„ç†ä¸­ï¼š" + filenameFromPath fPath + " (" + (i as string) + "/" + processFiles.count as string + ")"+
        ((100.0*i/processFiles.count) as integer) as string + "% | æˆåŠŸï¼š" + successCount as string
        
        try (
            case mode of (
                
                1: (if (processBipExport fPath) do successCount += 1)  -- å¯¼å‡ºæ¨¡å¼
                2: (if (processBipImport fPath) do successCount += 1)  -- å¯¼å…¥æ¨¡å¼
            )
        ) catch (
            format "[å¤„ç†é”™è¯¯] æ–‡ä»¶ï¼š%\né”™è¯¯ï¼š%\n" fPath (getCurrentException())
        )
        
        -- æ›´æ–°è¿›åº¦
        pbProgress.value = i
        lblProgressInfo.text = "è¿›åº¦ï¼š" + ((100.0*i/processFiles.count) as integer) as string + "% | æˆåŠŸï¼š" + successCount as string
        
        windows.processPostedMessages()
        
        -- å†…å­˜ä¼˜åŒ–
        if mod i 5 == 0 do (gc(); freeSceneBitmaps())
    )
    
    -- åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
    AutoExportTool_Pro.refreshFileListView()
    
    -- å®Œæˆå¤„ç†
    lblProgressInfo.text = case mode of (
        1: ("æ‰¹é‡BIPå¯¼å‡ºåˆ—è¡¨å…¨éƒ¨maxæ–‡ä»¶å®Œæˆï¼æˆåŠŸï¼š" + successCount as string + "/" + processFiles.count as string)
        2: ("æ‰¹é‡BIPå¯¼å…¥åˆ—è¡¨å…¨éƒ¨bipæ–‡ä»¶å®Œæˆï¼æˆåŠŸï¼š" + successCount as string + "/" + processFiles.count as string)
    )
    
    -- è‡ªåŠ¨æ‰“å¼€ç›®å½•
    if chk_autoOpenDir.checked and successCount > 0 do (
        ShellLaunch "explorer.exe" (
            case mode of (
                1: (pathConfig.appendPath edtExportPath.text "BIP_Exports")
                2: (pathConfig.appendPath edtExportPath.text "MAX_Imports")
            )
        )
    )
    true
)

----------------------------------------------------------------

-- æ ¸å¿ƒå¤„ç†å‡½æ•° ======================================================
-- ä¸»å¤„ç†å‡½æ•°ï¼ˆä¸¥æ ¼åŒºåˆ†æ¨¡å¼ï¼‰
-- å®‰å…¨è®¿é—®Bipedæ ¹èŠ‚ç‚¹çš„å‡½æ•°
-- å¼ºåŒ– Biped æ ¹èŠ‚ç‚¹æ£€æµ‹ï¼ˆå…¼å®¹ CS éª¨éª¼å’Œç‰ˆæœ¬å·®å¼‚ï¼‰
fn GetWorkingBipRoot = 
(
    try
    (
        -- ä¼˜å…ˆä»é¢æ¿è·å–ï¼ˆå…¼å®¹æ—§ç‰ˆå·¥å…·ï¼‰
        if isProperty rolBsBipedTools #m_workingBipRoot and 
           rolBsBipedTools.m_workingBipRoot != undefined and 
           not isDeleted rolBsBipedTools.m_workingBipRoot then
        (
            return rolBsBipedTools.m_workingBipRoot
        )
    )
    catch()
    
    -- å¼ºåŒ–ç‰ˆéª¨éª¼æ£€æµ‹ï¼ˆå…¼å®¹2019-2024ï¼‰
    local bipRoots = for obj in objects where (classOf obj == Biped_Object) collect obj
    
    if bipRoots.count > 0 then
    (
        -- ç‰ˆæœ¬åˆ†æ”¯å¤„ç†
        if (maxVersion())[1] >= 23000 then  -- 2022+ çš„CSéª¨éª¼éœ€è¦ç‰¹æ®Šå¤„ç†
            return bipRoots[1].controller.rootNode
        else                                -- 2019åŠæ›´æ—©ç‰ˆæœ¬ç›´æ¥è¿”å›æ‰¾åˆ°çš„Bipedæ ¹èŠ‚ç‚¹
            return bipRoots[1]
    )
    
    -- æ—§ç‰ˆæœ¬å¤‡ç”¨æ£€æµ‹ï¼ˆé€šè¿‡é€‰æ‹©è·å–ï¼‰
    if selection.count > 0 and classOf selection[1].baseObject == Biped_Object then
    (
        try(return biped.getRootNode selection[1])catch(return undefined)
    )
    
    undefined
)

-- å¼ºåŒ–ç‰ˆæ ¹èŠ‚ç‚¹éªŒè¯ï¼ˆç»Ÿä¸€æç¤ºä¿¡æ¯ï¼‰
fn BsBipedCheckRoot = 
(
    local rootNode = GetWorkingBipRoot()
    
    if rootNode == undefined do 
    (
        messageBox "æœªæ‰¾åˆ°æœ‰æ•ˆéª¨éª¼ï¼\nè¯·ç¡®è®¤åœºæ™¯ä¸­å­˜åœ¨ Biped/CS ç³»ç»Ÿ" title:"BipedTools"
        return false
    )
    
    if isDeleted rootNode do 
    (
        messageBox "éª¨éª¼æ ¹èŠ‚ç‚¹å·²è¢«åˆ é™¤ï¼\nè¯·é‡æ–°æ‰“å¼€æ–‡ä»¶æˆ–åˆ›å»ºæ–°éª¨éª¼" title:"BipedTools"
        return false
    )
    
    true
)

-- æ–°å¢è¾…åŠ©å‡½æ•° ---------------------------------------------------------
--æ–‡ä»¶ä¿å­˜é€»è¾‘
fn GenerateTargetPath bipPath outputDir = (
    local bipName = getFilenameFile bipPath
    local maxName = bipName + ".max"
    pathConfig.appendPath outputDir maxName
)

fn uniqueFileNameFromTemplate basePath = (
        local counter = 1
        local dir = getFilenamePath basePath
        local fileName = getFilenameFile basePath
        local ext = getFilenameType basePath
        
        while true do (
            local testName = dir + fileName + "_" + (formattedPrint counter format:"03d") + ext
            if not doesFileExist testName do return testName
            counter += 1
        )
    )

fn uniqueFileName baseDir baseName ext = (
    local counter = 1
    while true do (
        local testName = baseDir + "\\" + baseName + "_" + (formattedPrint counter format:"03d") + ext
        if not doesFileExist testName do return testName
        counter += 1
    )
)

-- ç‹¬ç«‹BIPå¯¼å…¥å‡½æ•°ï¼ˆæ— å¯¹è¯æ¡†ç‰ˆæœ¬ï¼‰
fn SilentBipedImport bipPath = (
    if not BsBipedCheckRoot() do return false
    
    undo "å¯¼å…¥BIPåŠ¨ç”»" on (
        try (
            root = GetWorkingBipRoot()
            biped.loadBipFile root.controller bipPath
            true
        ) catch (
            format "[é”™è¯¯] å¯¼å…¥å¤±è´¥ï¼š%\n" (getCurrentException())
            false
        )
    )
    
)
-- å…¼å®¹ç‰ˆBIPå¯¼å…¥å‡½æ•°
fn BsBipedImport = 
(
    if not BsBipedCheckRoot() do return false
    
    local rootNode = GetWorkingBipRoot()
    local bipPath = getOpenFileName \
        caption:"BipedTools - å¯¼å…¥BIPåŠ¨ç”»" \
        filename:(getDir #animations + "\\") \
        types:"BipedåŠ¨ç”»æ–‡ä»¶(*.bip)|*.bip|"
    
    if bipPath != undefined do 
    (
        undo "å¯¼å…¥BIPåŠ¨ç”»" on 
        (
            biped.loadBipFile rootNode.controller bipPath
            messageBox ("BIPåŠ¨ç”»å·²æˆåŠŸåŠ è½½:\n" + bipPath) title:"BipedTools" beep:false
        )
    )
)

-- å…¼å®¹ç‰ˆBIPå¯¼å‡ºå‡½æ•°
fn BsBipedExport = 
(
    if not BsBipedCheckRoot() do return false
    
    local rootNode = GetWorkingBipRoot()
    local defaultName = (getFilenameFile maxFileName) + "_Animation.bip"
    local bipPath = getSaveFileName \
        caption:"BipedTools - å¯¼å‡ºBIPåŠ¨ç”»" \
        filename:(getDir #animations + "\\" + defaultName) \
        types:"BipedåŠ¨ç”»æ–‡ä»¶(*.bip)|*.bip|"
    
    if bipPath != undefined do 
    (
        biped.saveBipFile rootNode.controller bipPath
        messageBox ("BIPåŠ¨ç”»å·²æˆåŠŸä¿å­˜:\n" + bipPath) title:"BipedTools" beep:false
    )
)

--æ‰¹é‡é€‰æ‹©é›†/ä¿å­˜é€‰æ‹©é›†-æ‰¹é‡å¤„ç†åº”ç”¨åˆ°æ–‡ä»¶-ä¿å­˜æ–°æ–‡ä»¶
-- æ–°å¢å‡½æ•°ï¼šä¿å­˜å½“å‰é€‰æ‹©é›†åˆ°XML
-- ä¿®æ”¹åçš„ batchProcessSelSets å‡½æ•°
fn batchProcessSelSets = (
    -- è·å–å¤„ç†æ–‡ä»¶åˆ—è¡¨
    local processFiles = getProcessFiles()
    if processFiles.count == 0 do (
        messageBox "æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„MAXæ–‡ä»¶ï¼" title:"æ“ä½œä¸­æ­¢"
        return undefined
    )

    -- ä¿å­˜é€‰æ‹©é›†åˆ°ä¸´æ—¶æ–‡ä»¶
    local tempXml = getDir #temp + "\\CurrentSelSets.xml"
    if selectionSets.count == 0 do (
        messageBox "å½“å‰åœºæ™¯æ²¡æœ‰é€‰æ‹©é›†ï¼" title:"æ“ä½œä¸­æ­¢"
        return undefined
    )

    -- ä¿å­˜é€‰æ‹©é›†åˆ°ä¸´æ—¶æ–‡ä»¶ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
    local xmlDoc = dotNetObject "System.Xml.XmlDocument"
    local root = xmlDoc.CreateElement "SelectionSets"
    xmlDoc.AppendChild root
    
    for s in selectionSets do (
        local setElem = xmlDoc.CreateElement "Set"
        setElem.SetAttribute "Name" s.name
        for obj in s do (
            local objElem = xmlDoc.CreateElement "Object"
            objElem.InnerText = obj.name
            setElem.AppendChild objElem
        )
        root.AppendChild setElem
    )
    xmlDoc.Save tempXml

    -- å­˜å‚¨é…ç½®å¯¹è¯æ¡†
    local res = queryBox "æ˜¯å¦åˆ›å»ºæ–°æ–‡ä»¶å¤¹ä¿å­˜ä¿®æ”¹åçš„æ–‡ä»¶ï¼Ÿ\n(é€‰æ‹©'å¦'å°†è¦†ç›–åŸå§‹æ–‡ä»¶)" title:"ä¿å­˜é€‰é¡¹"
    local targetFolder = if res then (
        pathConfig.appendPath (getFilenamePath processFiles[1]) "SelsetNew_MAX"
    ) else ""
    if res do makeDir targetFolder all:true

    -- è¿›åº¦æ§åˆ¶
    pbProgress.value = 0
    pbProgress.maximum = processFiles.count
    lblProgressInfo.text = "å‡†å¤‡å¼€å§‹..."
    local successCount = 0

    -- ä¸»å¤„ç†å¾ªç¯ï¼ˆç¡®ä¿è·¯å¾„å®‰å…¨ï¼‰
    for i=1 to processFiles.count where not g_exportAbortFlag do (
        local srcPath = processFiles[i]
        local baseName = getFilenameFile srcPath
        local targetPath = if res then
            pathConfig.appendPath targetFolder (baseName + ".max")
        else
            srcPath

        -- åŠ è½½å‰å¼ºåˆ¶é‡Šæ”¾å†…å­˜
        freeSceneBitmaps()
        gc()

        if loadMaxFile srcPath quiet:true then (
            disableSceneRedraw()
            xmlDoc.Load tempXml
            -- ä¿®æ­£åçš„é€‰æ‹©é›†æ¸…ç†
            for i = (getNumNamedSelSets()) to 1 by -1 do (
                deleteNamedSelSet (getNamedSelSetName i)
            )

            -- é‡å»ºé€‰æ‹©é›†
            local sets = xmlDoc.SelectNodes "//Set"
            for s=0 to sets.Count-1 do (
                local setName = sets.Item[s].GetAttribute "Name"
                local objs = #()
                for o=0 to sets.Item[s].ChildNodes.Count-1 do (
                    local objName = sets.Item[s].ChildNodes.Item[o].InnerText
                    local obj = getNodeByName objName
                    if obj != undefined do append objs obj
                )
                if objs.count > 0 do selectionSets[setName] = objs
            )

            -- ä¿å­˜æ–‡ä»¶
            saveMaxFile targetPath
            successCount += 1

            resetMaxFile #noPrompt
            enableSceneRedraw()
            completeRedraw()
        )

        pbProgress.value = i
        windows.processPostedMessages()
    )

    -- åœ¨å…³é”®å¾ªç¯åå¢åŠ èµ„æºé‡Šæ”¾
    gc light:true
    freeSceneBitmaps()

    -- å®Œæˆå¤„ç†
    lblProgressInfo.text = "å®Œæˆï¼æˆåŠŸå¤„ç† " + successCount as string + " ä¸ªæ–‡ä»¶"
    if res do ShellLaunch "explorer.exe" targetFolder
)

-- ç¡®ä¿æŒ‰é’®äº‹ä»¶ç»‘å®šæ­£ç¡®ç‰ˆæœ¬å‡½æ•° --  false 
--on btn_selsetBatch pressed do (
    --try(
        --batchProcessSelSets() -- ç¡®ä¿è°ƒç”¨çš„æ˜¯å…¨å±€å‡½æ•°ç‰ˆæœ¬
    --)catch(
        --format "[ERROR] æ‰¹å¤„ç†å¤±è´¥ï¼š%\n" (getCurrentException())
        -- å¼ºåˆ¶æ¢å¤åœºæ™¯
        --resetMaxFile #noPrompt
        --enableSceneRedraw()
        --completeRedraw()
    --)
--)
----------------------------------------------------------------
----------------------------------------------------------------

-- lv-åˆ—è¡¨/åˆå§‹åŒ–å‡½æ•°è®¾ç½®é»˜è®¤å­—ä½“ï¼Œæ»‘æ¡éšè—ï¼Œ// æ³¨æ„ï¼ï¼ï¼åˆå§‹lvåˆ—è¡¨---ä¿®æ”¹é»˜è®¤åˆ—è¡¨å‚æ•°åœ¨è¿™é‡Œä¿®æ”¹ï¼ŒåŠ¨æ€åˆ·æ–°éœ€è¦æ”¹å˜åˆ—è¡¨å‚æ•°//åˆ™åœ¨start_Lv_model é‡Œä¿®æ”¹

-- ä¿®æ”¹åˆ—å®½è°ƒæ•´å‡½æ•°ä¸ºå¯é‡ç”¨æ¨¡å¼
fn adjustColumnWidths forceCustom:undefined = (
    if not isKindOf Lv_model dotNetControl do return false
    if classOf Lv_model != dotNetControl do return false
    if Lv_model.Columns.count < 3 do return false
    if forceCustom == undefined do forceCustom = chkChangeFont.checked
    --local scrollbarWidth = 17 -- å‚ç›´æ»šåŠ¨æ¡é¢„ä¼°å®½åº¦ / false 
    --local availableWidth = Lv_model.ClientRectangle.Width - scrollbarWidth / false
    
    try (
        
        Lv_model.SuspendLayout()
        -- å¼ºåˆ¶åº”ç”¨åˆ—å®½é¿å…é—ªçƒ
        Lv_model.Columns.Item[2].Width = if forceCustom then 145 else 125
        Lv_model.ResumeLayout()
        local actualWidth = Lv_model.ClientRectangle.Width
        
        -- åŠ¨æ€åˆ—å®½è®¡ç®—
        case forceCustom of (
            true: ( -- è‡ªå®šä¹‰å¸ƒå±€
            -- è®¡ç®—CKåˆ—å®½ï¼ˆç¬¬ä¸€åˆ—ï¼‰
        local ckMin = actualWidth * 0.1
        local ckWidth = if ckMin < COLUMN_CK_WIDTH then ckMin else COLUMN_CK_WIDTH
        ckWidth = if ckWidth < 20 then 20 else ckWidth
        Lv_model.Columns.Item[0].Width = ckWidth  -- ä¿®æ­£ä¸º[]å’Œ=
        
        -- è®¡ç®—ç±»å‹åˆ—å®½ï¼ˆç¬¬ä¸‰åˆ—ï¼‰
        local typeMin = actualWidth * 0.15
        local typeWidth = if typeMin < COLUMN_TYPE_WIDTH then typeMin else COLUMN_TYPE_WIDTH
        typeWidth = if typeWidth < 20 then 20 else typeWidth
        Lv_model.Columns.Item[2].Width = typeWidth  -- ä¿®æ­£ä¸º[]å’Œ=
        
        -- è®¡ç®—æ–‡ä»¶åˆ—å®½ï¼ˆç¬¬äºŒåˆ—ï¼‰
        local remainingWidth = actualWidth - ckWidth - typeWidth - 5
        Lv_model.Columns.Item[1].Width = if remainingWidth > 50 then remainingWidth else 50  -- ä¿®æ­£ä¸º=
                local fileWidth = actualWidth - ckWidth - typeWidth - 5
            )
            false: ( -- é»˜è®¤å¸ƒå±€
                ckWidth = COLUMN_CK_WIDTH
                typeWidth = COLUMN_TYPE_WIDTH
                fileWidth = COLUMN_FILE_WIDTH
				--fileWidth = LISTVIEW_WIDTH - ckWidth - typeWidth - 20
            )
        )
        
        -- åº”ç”¨åˆ—å®½
        Lv_model.Columns.Item[0].Width = ckWidth
        Lv_model.Columns.Item[1].Width = fileWidth
        Lv_model.Columns.Item[2].Width = typeWidth
            -- å¼ºåˆ¶ç¦ç”¨æ°´å¹³æ»šåŠ¨
        Lv_model.Scrollable = false
        Lv_model.Scrollable = true -- ä»…å‚ç›´æ»šåŠ¨
        Lv_model.ResumeLayout()
        true
    )
    catch (
        format "[ERROR] åˆ—å®½è°ƒæ•´å¤±è´¥: %\n" (getCurrentException())
        false
    )
)

--é»˜è®¤ é€šç”¨ListView / â€‹åˆ—å®šä¹‰ä¸é…ç½® / â€‹â€‹åˆå§‹åŒ– ListViewï¼ˆåˆ—è¡¨è§†å›¾ï¼‰æ•°æ®æ¨¡å‹â€‹â€‹ çš„å‡½æ•°ï¼Œä¸»è¦å¤„ç† â€‹â€‹æ•°æ®åŠ è½½ã€æ ¼å¼è½¬æ¢â€‹â€‹ å’Œ â€‹â€‹UI ç»‘å®š
fn initLvModel = (
    Lv_model.View = (dotNetClass "System.Windows.Forms.View").Details
    Lv_model.LabelEdit = true  -- å¯ç”¨åŸåœ°ç¼–è¾‘åŠŸèƒ½
    Lv_model.CheckBoxes = true
    Lv_model.MultiSelect = true
    
    Lv_model.View = (dotNetClass "System.Windows.Forms.View").Details
    Lv_model.Font = g_defaultFont  -- åˆå§‹åŒ–é»˜è®¤å­—ä½“-01      --- fr æŒ‰é’® æ‰§è¡Œå®ç° å­—ä½“åˆ‡æ¢ï¼ˆchkChangeFont changed state do...å‹¾é€‰æ¡†äº‹ä»¶å¤„ç†ï¼‰
    g_alternateFont = dotNetObject "System.Drawing.Font" "å¾®è½¯é›…é»‘" 8 ((dotNetClass "System.Drawing.FontStyle").Regular)   --fråˆ‡æ¢åŠ¨æ€å­—ä½“-02
    Lv_model.GridLines = false     --éšè—ç½‘æ ¼çº¿
    Lv_model.Scrollable = false     --ä¸‹æ»‘æ¡éšè—

    --g_alternateFont = dotNetObject "System.Drawing.Font" "Segoe UI" 9 ((dotNetClass "System.Drawing.FontStyle").Regular)
    -- ...å…¶ä»–åˆå§‹åŒ–ä»£ç ...
)
--æ–°å¢lvåˆ—è¡¨æ— ç¼è¡”æ¥æ‹¼è£… / è‡ªå®šä¹‰å•è¡Œlistview
fn initlvHeader = (
    lvHeader.View = (dotNetClass "System.Windows.Forms.View").Details
    lvHeader.HeaderStyle = (dotNetClass "System.Windows.Forms.ColumnHeaderStyle").None      --éšè—åˆ—å¤´
    lvHeader.FullRowSelect = true
    lvHeader.MultiSelect = false
    lvHeader.GridLines = false
    lvHeader.Scrollable = false
    -- åŠ¨æ€åˆ—å®½åŸºäºå¤é€‰æ¡†çŠ¶æ€
    local typeWidth = if chkChangeFont.checked then 145 else 125
    -- è°ƒæ•´åˆ—å¸ƒå±€ï¼šCK/Icon |  æ–‡ä»¶  | ç±»å‹
    lvHeader.Columns.Clear()
    lvHeader.Columns.Add "æ¨¡å¼" 150
    lvHeader.Columns.Add "æ–‡ä»¶" 170  
    lvHeader.Columns.Add "ç±»å‹" typeWidth  -- åŠ¨æ€å®½åº¦
    lvHeader.Columns.Item[0].TextAlign = (dotNetClass "System.Windows.Forms.HorizontalAlignment").Left
    lvHeader.Columns.Item[1].TextAlign = (dotNetClass "System.Windows.Forms.HorizontalAlignment").Center  -- å±…ä¸­
    lvHeader.Columns.Item[2].TextAlign = (dotNetClass "System.Windows.Forms.HorizontalAlignment").Right
    
    -- è§†è§‰æ ·å¼
    lvHeader.BackColor = (dotNetClass "System.Drawing.Color").FromArgb 70 70 70
    lvHeader.ForeColor = (dotNetClass "System.Drawing.Color").FromArgb 0 255 255 -- 255 105 180 ç³–ç²‰ / 248 248 255  çç™½/0 150 255  èµ›åšè“
    lvHeader.Font = dotNetObject "System.Drawing.Font" "å¾®è½¯é›…é»‘" 9 ((dotNetClass "System.Drawing.FontStyle").Bold)
    
    -- åˆå§‹åŒ–æ•°æ®
    try (
    li = dotNetObject "System.Windows.Forms.ListViewItem" "CK/Ico"
    li.SubItems.Add("â¬ğŸ“æ–‡ä»¶å¤¹/æ–‡ä»¶ğŸ“„")  
    li.SubItems.Add(" ç±»å‹/Typ")
    lvHeader.Items.Add li
) catch (
    format "åˆå§‹åŒ–é”™è¯¯ï¼š%\n" (getCurrentException())
)
    -- ç¦ç”¨äº¤äº’
    --lvHeader.Enabled = false              --     æœ‰æ•ˆ ä½† åº•è‰² æ˜¾ç¤ºé”™è¯¯ / false 
    --lvHeader.HideSelection = true
)

-- lv-åˆ—è¡¨/ç»Ÿä¸€çš„çŠ¶æ€æ›´æ–°å‡½æ•°/è‡ªå®šä¹‰çŠ¶æ€æ /å•è¡Œlistview
fn initModeStatus = (
    ModeStatus.View = (dotNetClass "System.Windows.Forms.View").Details
    ModeStatus.HeaderStyle = (dotNetClass "System.Windows.Forms.ColumnHeaderStyle").None    --éšè—åˆ—å¤´
    ModeStatus.FullRowSelect = true
    ModeStatus.MultiSelect = false
    ModeStatus.GridLines = false
    ModeStatus.Scrollable = false
    
    -- è°ƒæ•´åˆ—å¸ƒå±€ï¼šæ¨¡å¼çŠ¶æ€ | å½“å‰è·¯å¾„ | æ–‡ä»¶è®¡æ•°
    ModeStatus.Columns.Clear()
    ModeStatus.Columns.Add "æ¨¡å¼" 180
    ModeStatus.Columns.Add "å½“å‰è·¯å¾„" 120  -- æ–°å¢è·¯å¾„åˆ—
    ModeStatus.Columns.Add "è®¡æ•°" 135
    ModeStatus.Columns.Item[0].TextAlign = (dotNetClass "System.Windows.Forms.HorizontalAlignment").Left
    ModeStatus.Columns.Item[1].TextAlign = (dotNetClass "HorizontalAlignment").Center  -- å±…ä¸­
	ModeStatus.Columns.Item[2].TextAlign = (dotNetClass "System.Windows.Forms.HorizontalAlignment").Right
    -- è§†è§‰æ ·å¼
    ModeStatus.BackColor = (dotNetClass "System.Drawing.Color").FromArgb 70 70 70
    ModeStatus.ForeColor = (dotNetClass "System.Drawing.Color").FromArgb 0 255 0 -- 255 105 180 ç³–ç²‰ / 248 248 255  çç™½/0 150 255  èµ›åšè“
    ModeStatus.Font = dotNetObject "System.Drawing.Font" "å¾®è½¯é›…é»‘" 9 ((dotNetClass "System.Drawing.FontStyle").Bold)
    
    -- å¼ºåˆ¶åˆ›å»ºåˆå§‹é¡¹ï¼ˆå¸¦å¼‚å¸¸å¤„ç†ï¼‰
    try (
        if ModeStatus.Items.Count == 0 do (
            local li = dotNetObject "System.Windows.Forms.ListViewItem" "FBXæ¨¡å¼-Auto | Action:å¾…å‘½"
            li.SubItems.Add("")
            li.SubItems.Add("æ–‡ä»¶ï¼š0")
            ModeStatus.Items.Add li
        )
    ) catch (
        format "[åˆå§‹é¡¹åˆ›å»ºé”™è¯¯] %" (getCurrentException())
    )
)

-- å¢å¼ºçŠ¶æ€æ›´æ–°å‡½æ•°/lv-åˆ—è¡¨/ç¨³å®šçŠ¶æ€æ æ˜¾ç¤ºå‡½æ•°
fn updateModeStatus = (
    try (
        if not (isKindOf ModeStatus dotNetControl) do return false
        if ModeStatus.IsDisposed do return false
        
        -- æ„å»ºæ ¸å¿ƒçŠ¶æ€æ–‡æœ¬
        local fbxMode = #("Auto","Skin","Bake")[rdo_exportMode.state]
        local actionText = " | Act:" + g_lastAction
        
        -- å¼ºåˆ¶åˆ›å»ºçŠ¶æ€é¡¹ï¼ˆé˜²å´©æºƒï¼‰
        if ModeStatus.Items.Count == 0 do (
            local li = dotNetObject "System.Windows.Forms.ListViewItem" ""
            li.SubItems.Add("")
            li.SubItems.Add("")
            ModeStatus.Items.Add li
        )
        
        -- æ›´æ–°ç¬¬ä¸€åˆ—ï¼ˆåŠ¨æ€æŒ‰é’®çŠ¶æ€ï¼‰
        local item = ModeStatus.Items.Item[0]
        item.Text = "FBX:" + fbxMode + actionText
        
        -- ä¿æŒåŸæœ‰è·¯å¾„ä¿¡æ¯æ˜¾ç¤º
        local validPath = doesDirectoryExist edtExportPath.text
        item.SubItems.Item[1].Text = if validPath then filenameFromPath edtExportPath.text else "æœ€è¿‘æ–‡ä»¶"
        
        -- ä¿æŒæ–‡ä»¶è®¡æ•°é€»è¾‘
        local dirCount = if validPath then (getDirectories (edtExportPath.text + "\\*")).count else 0
        item.SubItems.Item[2].Text = "æ–‡ä»¶ï¼š" + (amax 0 (model_files_array.count - dirCount)) as string
        
        ModeStatus.Refresh()
        true
    )
    catch (
        format "[çŠ¶æ€æ›´æ–°å¤±è´¥] %\n" (getCurrentException())
        false
    )
)

-- è¾…åŠ©å‡½æ•°ï¼šéªŒè¯.NETå¯¹è±¡
fn isvalidobj obj = (
    try (
        return not (
            obj == undefined or 
            obj.IsDisposed or 
            obj.Equals(undefined) or 
            not (dotNet.isNetObject obj)
        ) -- è¡¥å…¨ç¼ºå¤±çš„é—­åˆæ‹¬å·
    ) catch (
        return false
    )
)

-- çŠ¶æ€æ›´æ–°ç¤ºä¾‹
--fn updateStatus text = (
    --ModeStatus.Items.Item[0].Text = text
    --ModeStatus.Refresh()
--)
----------------------------------------------------------------
----------------------------------------------------------------
-- å…¨å±€å‡½æ•°ï¼šå¼ºåˆ¶æ¸…ç©ºæœ€è¿‘æ–‡ä»¶è®°å½•
fn clearRecentFilesCompletely = (
    local xmlPath = (getDir #maxData) + "\\RecentDocuments.xml"
    try (
        -- åˆ›å»ºç©ºçš„XMLç»“æ„è¦†ç›–åŸæ–‡ä»¶
        local xDoc = dotNetObject "System.Xml.XmlDocument"
        local root = xDoc.CreateElement("RecentDocuments")
        xDoc.AppendChild(root)
        xDoc.Save(xmlPath)
        
        -- é‡ç½®å†…å­˜è®°å½•
        g_recentFiles = #()
        true
    ) catch (
        format "[æ¸…ç©ºé”™è¯¯] %\n" (getCurrentException())
        false
    )
)

-- å…¨å±€å‡½æ•°ï¼šç«‹å³ä¿®æ”¹æœ€è¿‘æ–‡ä»¶æ˜¾ç¤ºæ•°é‡
fn setMaxRecentFileCountImmediately count = (
    -- 1. ä¿®æ”¹INIæ–‡ä»¶ï¼ˆæ ¸å¿ƒè®¾ç½®ï¼‰
    local iniFile = (getDir #maxData) + "\\3dsmax.ini"
    setINISetting iniFile "General" "FileMRUListCount" (count as string)
    
    -- 2. ä½¿ç”¨æ­£ç¡®çš„æ³¨å†Œè¡¨è®¾ç½®æ–¹æ³•
    local success = false
    try (
        -- åˆ†è§£æ³¨å†Œè¡¨è·¯å¾„
        local rootKey = "HKEY_CURRENT_USER"
        local subPath = "Software\\Autodesk\\3dsMax\\" + (maxVersion() as string) + "\\Preference"
        local valueName = "FileMRUListCount"
        
        -- ä½¿ç”¨æ­£ç¡®çš„4å‚æ•°æ ¼å¼
        setINISetting rootKey subPath valueName (count as string)
        success = true
        format "[æ³¨å†Œè¡¨è®¾ç½®æˆåŠŸ] %\\%\\% = %\n" rootKey subPath valueName count
    ) catch (
        format "[æ³¨å†Œè¡¨é”™è¯¯] %\n" (getCurrentException())
    )
    
    -- 3. åˆ·æ–°Maxç•Œé¢
    try (
        actionMan.executeAction 0 "55230"  -- 2022+åˆ·æ–°UIå‘½ä»¤
        actionMan.executeAction 0 "40021"  -- é€šç”¨åˆ·æ–°å‘½ä»¤
    ) catch ()
    
    success
)

-- ä»RecentDocuments.xmlåŠ è½½æœ€è¿‘æ–‡ä»¶ / ç¨³å®šæ ¸å¿ƒåŠŸèƒ½å®ç° /  true /ï¼ˆå…¼å®¹æ‰€æœ‰Maxç‰ˆæœ¬ï¼‰
fn loadRecentFilesFromXML = (
    g_recentFiles = #()
    local xmlPath = pathConfig.normalizePath ((getDir #maxData) + "\\RecentDocuments.xml")
    
    if doesFileExist xmlPath do (
        try (
            local xDoc = dotNetObject "System.Xml.XmlDocument"
            xDoc.Load xmlPath
            local entries = xDoc.SelectNodes "//MaxApp.RecentDocument"
            
            /* å€’åºåŠ è½½ç¡®ä¿æœ€æ–°åœ¨å‰ */
            for i = (entries.Count-1) to 0 by -1 do (
                local pathNode = entries.Item[i].SelectSingleNode "FilePath"
                if pathNode != undefined do (
                    local filePath = pathConfig.normalizePath pathNode.InnerText
                    local exists = doesFileExist filePath
                    append g_recentFiles #(filePath, exists)
                )
            )
        )
        catch (
            format "[XMLåŠ è½½é”™è¯¯] %\n" (getCurrentException())
        )
        --ä¿æŒåŸå§‹æ’åºï¼ˆä¸‹é¢å•è¡Œä»£ç -å®é™…/å®ç°æ–‡ä»¶æ’åºæ•ˆæœï¼šæœ€è¿‘çš„åœ¨æœ€ä¸Šé¢ï¼‰-- ç›®å‰ç¬¦åˆ æ–‡ä»¶ æ’åºæ„Ÿå®˜ -- è‹¥ æ˜¾ç¤º æ’åºä¸æ­£å¸¸ åˆ™ éœ€ å»é™¤ å³ï¿½ï¿½
        g_recentFiles = for i = g_recentFiles.count to 1 by -1 collect g_recentFiles[i]
    )
    g_recentFiles
)

-- å¼ºåŒ–ç‰ˆå§¿åŠ¿å¤åˆ¶å‡½æ•°ï¼ˆä¿®å¤Bipedæ§åˆ¶å™¨è®¿é—®ï¼‰
fn copyPosture = (
    global g_postureCache = #()
    
    -- è·å–Bipedä¸»æ¥å£å‡½æ•°
    fn getBipedMaster obj = (
        if (maxVersion())[1] >= 24000 then (
            try(Interface13.GetBipDriver12Interface obj.TMController)catch(undefined)
        ) else (  -- ä¿®å¤æ­¤å¤„ç¼ºå°‘çš„å³æ‹¬å·
            try(Interface13.GetBipMaster12Interface obj.TMController)catch(undefined)
        )
    )  -- è¡¥å…¨getBipedMasterå‡½æ•°ç»“æŸæ‹¬å·
    
    for obj in objects where (classOf obj == BoneGeometry or classOf obj == Biped_Object or classOf obj == Point) do (
        local isRootBiped = false
        local bipData = undefined
        local isPoint = (classOf obj == Point)
        
        -- ä½¿ç”¨CPToolsçš„çŸ©é˜µè·å–æ–¹å¼
        local tm = matrix3 1
        if classOf obj == Biped_Object do (
            try (
                local master = getBipedMaster obj
                if master != undefined do (
                    isRootBiped = (master.GetRootNode() == obj)
                    local id = 0, link = 0
                    master.GetIdLink obj &id &link
                    tm = master.GetBipedTM currentTime id link
                )
            )
            catch()
        )
        
        append g_postureCache #(
            obj.name,
            (if classOf obj == Biped_Object then tm else obj.transform), -- ä½¿ç”¨ç²¾å‡†çŸ©é˜µ
            bipData,
            if obj.parent != undefined then obj.parent.name else "",
            classOf obj == BoneGeometry,
            isPoint,
            (if classOf obj == Biped_Object then getBipedMaster obj else undefined) -- å­˜å‚¨Bipedä¸»æ¥å£
        )
    )
    format "[å§¿åŠ¿å¤‡ä»½] å·²è®°å½• % ä¸ªéª¨éª¼çŠ¶æ€\n" g_postureCache.count
)  -- è¡¥å…¨copyPostureå‡½æ•°ç»“æŸæ‹¬å·

-- æ™ºèƒ½å§¿åŠ¿ç²˜è´´å‡½æ•°ï¼ˆæ•´åˆCPToolséª¨éª¼å¤„ç†ï¼‰
fn pastePosture enableAutoKey = (
    if g_postureCache == undefined do return false
    
    local originalAutoKey = autoKeyMode
    autoKeyMode = enableAutoKey
    local startTime = animationRange.start
    
    -- é˜¶æ®µ0ï¼šåˆå§‹åŒ–Bipedç³»ç»Ÿ
    disableSceneRedraw()
    progressStart "åˆå§‹åŒ–Bipedç³»ç»Ÿ..."
    try (
        for entry in g_postureCache where entry[7] != undefined do (
            entry[7].StartSettingBipedKeys() -- å¯åŠ¨å¿«é€Ÿè®¾ç½®æ¨¡å¼
        )
    )
    catch (format "[åˆå§‹åŒ–é”™è¯¯] %\n" (getCurrentException()))
    enableSceneRedraw()
    progressEnd()

    -- é˜¶æ®µ1ï¼šåº”ç”¨å˜æ¢çŸ©é˜µ
    disableSceneRedraw()
    progressStart "åº”ç”¨ç²¾å‡†çŸ©é˜µ..."
    try (
        for entry in g_postureCache do (
            local targetObj = getNodeByName entry[1]
            if not isValidNode targetObj do continue
            
            try (
                case of (
                    (entry[5]): ( -- å¸¸è§„éª¨éª¼
                        targetObj.transform = entry[2]
                        if enableAutoKey do addNewKey targetObj.transform.controller startTime
                    )
                    
                    (entry[6]): ( -- Pointè¾…åŠ©
                        targetObj.transform = entry[2]
                        if enableAutoKey do addNewKey targetObj.transform.controller startTime
                    )
                    
                    (entry[7] != undefined): ( -- Bipedéª¨éª¼
                        local master = entry[7]
                        local id = 0, link = 0
                        master.GetIdLink targetObj &id &link
                        
                        -- ä½¿ç”¨CPToolsçš„SetBipedTMæ–¹æ³•
                        master.SetBipedTM startTime entry[2] id link
                        if enableAutoKey do (
                            master.AddKey startTime
                            biped.update targetObj #all
                        )
                    )
                )
                format "[æˆåŠŸ] % % æ›´æ–°\n" (classOf targetObj) targetObj.name
            )
            catch (format "[åº”ç”¨é”™è¯¯] % : %\n" targetObj.name (getCurrentException()))
        )
    )
    catch (format "[çŸ©é˜µåº”ç”¨é”™è¯¯] %\n" (getCurrentException()))
    enableSceneRedraw()
    progressEnd()

    -- é˜¶æ®µ2ï¼šå…³é—­Bipedå¿«é€Ÿæ¨¡å¼
    disableSceneRedraw()
    progressStart "å®ŒæˆBipedæ“ä½œ..."
    try (
        for entry in g_postureCache where entry[7] != undefined do (
            entry[7].StopSettingBipedKeys() -- å…³é—­å¿«é€Ÿè®¾ç½®æ¨¡å¼
            biped.update entry[7].GetRootNode() #all
        )
    )
    catch (format "[å…³é—­é”™è¯¯] %\n" (getCurrentException()))
    enableSceneRedraw()
    progressEnd()

    autoKeyMode = originalAutoKey
    true
)

/* ä½¿ç”¨ç¤ºä¾‹ï¼š
with redraw off (
    copyPosture() -- å¤‡ä»½å§¿åŠ¿
    
    -- å¯¼å…¥FBXåæ‰§è¡Œ
    pastePosture false  -- åŸºç¡€å§¿åŠ¿
    pastePosture true   -- åŠ¨ç”»å…³é”®å¸§
    
    -- æœ€ç»ˆæ›´æ–°
    for master in biped.getBipedRoots() do (
        biped.createAllLayers master
        maxOps.CollapseNode master off
    )
)
format "[å®Œæˆ] å§¿åŠ¿åº”ç”¨æˆåŠŸï¼\n"
*/

-- ä¿®æ­£åçš„æ–‡ä»¶åŠ è½½å‡½æ•° / true
fn loadFileSafe fPath = (
    if not doesFileExist fPath do return false
    
    try (
        if maxFilePath != "" and needsSave do (
            if not (queryBox "åœºæ™¯æœªä¿å­˜ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ" title:"è­¦å‘Š") do return false
        )
        
        loadMaxFile fPath useFileUnits:true quiet:true
   
    ) catch (
        format "åŠ è½½å¤±è´¥ï¼š%\n" (getCurrentException())
        false
    )
)

-- Lvåˆ—è¡¨åˆ·æ–°å‡½æ•°ï¼ˆå¿…é¡»å£°æ˜åœ¨rolloutå†…éƒ¨ï¼‰/ï¼ˆç¨³å®šçš„åˆ·æ–°å‡½æ•°ï¼‰æ ¸å¿ƒåˆ—è¡¨åˆ·æ–°å‡½æ•° ï¼

    fn refreshFileListView forceRefresh:false = (
        -- ç¡®ä¿æœªæˆªæ–­åˆ—è¡¨
        local itemsToShow = model_files_array  -- ç›´æ¥ä½¿ç”¨å®Œæ•´æ•°ç»„
        -- è°ƒæ•´åˆ—å®½è°ƒæ•´é¡ºåºåˆ°BeginUpdateä¹‹å‰
        --adjustColumnWidths forceCustom:g_forceCustomLayout 
        -- åœ¨BeginUpdateå‰æ›´æ–°åˆ—å®½
        lvHeader.Columns.Item[2].Width = if chkChangeFont.checked then 145 else 125
    
        lvHeader.Refresh()
        
        Lv_model.BeginUpdate()
        --Lv_model.Scrollable = false  -- æ¯æ¬¡åˆ·æ–°æ—¶å¼ºåˆ¶ç¦ç”¨
        --Lv_model.Scrollable = true
        Lv_model.Items.Clear()
        model_files_array = #()
        -- æ·»åŠ æ•°æ®æ—¶è®¾ç½®å¯¹é½æ–¹å¼
        for i=1 to model_files_array.count do (
            local li = dotNetObject "System.Windows.Forms.ListViewItem" ""
            
            -- CKåˆ—å†…å®¹å±…ä¸­
            li.Text = "âœ“" -- ç¤ºä¾‹å›¾æ ‡
            li.TextAlign = (dotNetClass "System.Windows.Forms.HorizontalAlignment").Center
            
            -- æ–‡ä»¶åˆ—å·¦å¯¹é½ï¼ˆé»˜è®¤ï¼‰
            li.SubItems.Add(filenameFromPath model_files_array[i])
            
            -- ç±»å‹åˆ—å±…ä¸­
            local typeItem = li.SubItems.Add(getFileType model_files_array[i])
            typeItem.TextAlign = (dotNetClass "System.Windows.Forms.HorizontalAlignment").Center
        )
        local currentPath = pathConfig.normalizePath edtExportPath.text -- ç¬¬ä¸€å±‚æ ‡å‡†åŒ–
        local currentPath = edtExportPath.text
        local pathValid = false
        try (
            pathValid = doesDirectoryExist currentPath
            if not pathValid and matchPattern currentPath pattern:"\\\\*" do (
                dotNetClass "System.Threading.Thread").Sleep(1000)  -- ç›´æ¥è°ƒç”¨é™æ€æ–¹æ³•
                --dotNet.invokeMethod (dotNetClass "System.Threading.Thread") "Sleep" #(1000)
                pathValid = doesDirectoryExist currentPath
            
        ) catch (pathValid = false)
        
        if not pathValid  do (
            Lv_model.EndUpdate()
            lblCount.text = "è·¯å¾„ä¸å¯ç”¨ï¼"
            messageBox ("è·¯å¾„ä¸å¯è®¿é—®ï¼š\n" + currentPath) title:"é”™è¯¯" beep:false
            return false
        )
        -- å¼ºåˆ¶å»é™¤å½“å‰è·¯å¾„æœ«å°¾åæ–œæ 
        if currentPath != "" and currentPath[currentPath.count] == "\\" do (
            currentPath = substring currentPath 1 (currentPath.count - 1)
        )
        if not doesDirectoryExist currentPath do return #()
        
        -- è·å–ç›®å½•å’Œæ–‡ä»¶ï¼ˆè‡ªç„¶æ’åºï¼‰
        local data = g_fileManager.getFilesAndDirs currentPath (
            case rdoFileFilter.state of (
                1: "*.max"                   -- Maxåœºæ™¯
                2: "*.fbx"                   -- FBXèµ„æº
                3: "*.ms*"                   -- ç²¾ç¡®åŒ¹é…æ‰€æœ‰è„šæœ¬ç±»å‹(Maxè„šæœ¬/åŠ å¯†è„šæœ¬/å®è„šæœ¬)
                4: "*.bip"                   -- Bipedæ•°æ®
                5: "*.mzp"                   -- å®è„šæœ¬
                6: "*.xaf"                    -- é™„ä»¶æ•°æ®
                default: "*"                   -- é»˜è®¤å…¨æ˜¾ç¤º
            )
        )
        
        -- åˆ†ç¦»ç›®å½•å’Œæ–‡ä»¶è®¡æ•°
        local dirCount = data[1].count
        local fileCount = data[2].count
        
        local dirs = data[1]
        local files = data[2]
        local fileCount = files.count -- æ–°å¢æ–‡ä»¶è®¡æ•°
        local baseDepth = (filterString currentPath "\\").count
        -- è‡ªç„¶æ’åº
        qsort dirs g_fileManager.pseudoNaturalSort
        qsort files g_fileManager.pseudoNaturalSort
    
        -- æ·»åŠ ç›®å½•é¡¹ / true
        for d in data[1] do (
            local normDir = pathConfig.normalizePath d
            -- å¼ºåˆ¶å»é™¤æœ«å°¾åæ–œæ 
            if normDir != "" and normDir[normDir.count] == "\\" do (
                normDir = substring normDir 1 (normDir.count - 1)
            )
        
        -- æå–çº¯æ–‡ä»¶å¤¹åç§° / true ï¼ˆé»˜è®¤é€šç”¨ï¼‰
        local folderName = filenameFromPath normDir
        li = dotNetObject "System.Windows.Forms.ListViewItem" "ğŸ“‚"
        li.UseItemStyleForSubItems = false
        
        -- ä¸»åˆ—å›¾æ ‡é¢œè‰²ï¼ˆå›ºå®šå€¼ï¼‰
        li.ForeColor = (dotNetClass "System.Drawing.Color").FromArgb 245 245 125 -- å›ºå®šæµ…é»„è‰²
        
        -- æ–‡ä»¶ååˆ—ï¼ˆè·Ÿéšæ–‡ä»¶å¤¹é¢œè‰²é…ç½®ï¼‰
        local subName = li.SubItems.Add(folderName)
        subName.ForeColor = g_ColorConfig.folderNameColor  -- ä½¿ç”¨é…ç½®é¢œè‰²
        
        -- ç±»å‹åˆ—ï¼ˆåŒæ­¥æ–‡ä»¶åé¢œè‰²ï¼‰
        local subType = li.SubItems.Add("æ–‡ä»¶å¤¹")
        subType.ForeColor = g_ColorConfig.folderNameColor  -- ä¸æ–‡ä»¶ååŒè‰²
        
        li.Tag = d
        Lv_model.Items.Add(li)
        append model_files_array ("[DIR]"+d) -- ç›®å½•æ ‡è®°
    )
    
    -- æ·»åŠ ç›®å½•é¡¹ / true (æ–‡ä»¶é¡¹ä¿æŒç¨³å®šé€»è¾‘)
    for f in data[2] do (
        local exists = doesFileExist f
        
        li = dotNetObject "System.Windows.Forms.ListViewItem" (if exists then "ğŸ“„" else "âœ˜")
        li.UseItemStyleForSubItems = false
        
        -- ä¸»åˆ—å›¾æ ‡é¢œè‰²ï¼ˆå›ºå®šç™½è‰²ï¼‰
        li.ForeColor = (dotNetClass "System.Drawing.Color").White
        
        -- æ–‡ä»¶ååˆ—ï¼ˆè·Ÿéšæ–‡ä»¶é¢œè‰²é…ç½®ï¼‰
        local subName = li.SubItems.Add(filenameFromPath f)
        subName.ForeColor = if exists then g_ColorConfig.fileNameColor else (dotNetClass "System.Drawing.Color").Red
        
        -- ç±»å‹åˆ—ï¼ˆåŒæ­¥æ–‡ä»¶åé¢œè‰²ï¼‰
        local typeInfo = try(getFileType f)catch("æ— æ•ˆæ–‡ä»¶")
        local subType = li.SubItems.Add(if exists then typeInfo else "å¤±æ•ˆæ–‡ä»¶")
        subType.ForeColor = if exists then g_ColorConfig.fileNameColor else (dotNetClass "System.Drawing.Color").Red
        
        li.Tag = f
        Lv_model.Items.Add(li)
        append model_files_array f   --  ä»…æ·»åŠ æ–‡ä»¶è·¯å¾„
        
        -- åœ¨åˆ›å»ºåˆ—è¡¨é¡¹åæ·»åŠ ç‰¹æ®Šæ ‡è®°
        local isMergeFile = (findString (toLower (getFilenameFile f)) "merge") != undefined or 
                           (findString (toLower (getFilenameFile f)) "socket") != undefined or
                           (findString (getFilenameFile f) "æŒ‚ç‚¹") != undefined
        
        if isMergeFile do (
            li.ForeColor = (dotNetClass "System.Drawing.Color").FromArgb 255 200 0  -- æ©™è‰²æ ‡è®°åˆå¹¶æ–‡ä»¶
            li.Text = "ğŸ”—"  -- é“¾æ¥å›¾æ ‡
        )
        
        -- åœ¨åˆ›å»ºåˆ—è¡¨é¡¹åæ·»åŠ ç‰¹æ®Šæ ‡è®°ï¼ˆåˆ†æ®µæ–‡ä»¶ï¼‰
        local fileName = toLower (getFilenameFile f)
        local isSegmentFile = (findString fileName "start") != undefined or 
                             (findString fileName "loop") != undefined or 
                             (findString fileName "end") != undefined

        if isSegmentFile do (
            li.ForeColor = (dotNetClass "System.Drawing.Color").FromArgb 216 191 216  -- æ ‡è®°åˆ†æ®µæ–‡ä»¶é¢œè‰²
            li.Text = "ğŸ”„"  -- å¾ªç¯å›¾æ ‡
        )
        --append g_model_files_array f
    )
        
    -- è°ƒæ•´åˆ—å®½//å¤±æ•ˆ-false/é»˜è®¤åˆ—è¡¨width/ä¸åœ¨è¿™è°ƒæ•´ï¼ï¼ï¼//åœ¨å…¨å±€å‡½æ•°é‡Œè°ƒæ•´å³å¯ / false 
        --if Lv_model.Columns.Count >= 3 do (                
            --Lv_model.Columns.Item[0].Width = 50
            --Lv_model.Columns.Item[1].Width = 310
            --Lv_model.Columns.Item[2].Width = 100
        --)
        
        -- æ–‡ä»¶è®¡æ•°éƒ¨åˆ†
        local fileCount = 0
        for i=0 to (Lv_model.Items.Count-1) do (
        if Lv_model.Items.Item[i].SubItems.Item[2].Text != "æ–‡ä»¶å¤¹" do fileCount += 1)
        lblCount.text = "æ–‡ä»¶ï¼š" + (fileCount as string)
        
        --lblCount.text = "æ–‡ä»¶ï¼š" + (model_files_array.count) as string -- æ›´æ–°è®¡æ•°åˆ—è¡¨æ˜¾ç¤ºçš„æ‰€æœ‰/items / false / å¤‡ç”¨
        
         -- æ–°å¢ï¼šè®¡ç®—å¹¶æ›´æ–°æ–‡ä»¶è®¡æ•°
         local dirCount = (getDirectories (edtExportPath.text + "\\*")).count
         lblCount.text = "æ–‡ä»¶ï¼š" + (model_files_array.count - dirCount) as string
         
         -- æ›´æ–°æ¨¡å¼çŠ¶æ€ä¸­çš„è·¯å¾„ä¿¡æ¯
         local currentFolder = if ddlLikedPaths.selection > 0 then 
        g_likedFolders[ddlLikedPaths.selection].name else 
        filenameFromPath currentPath
        
        -- å¼ºåˆ¶çŠ¶æ€æ æ›´æ–°
        updateModeStatus()
        if ModeStatus.Items.Count > 0 do (
            try (
                local item = ModeStatus.Items.Item[0]
                item.SubItems[2].Text = lblCount.text
                ModeStatus.Refresh()
            ) catch ()
        )
        Lv_model.Scrollable = (Lv_model.Items.Count * 20 > Lv_model.Height) -- æ ¹æ®é¡¹æ•°åŠ¨æ€å¯ç”¨
        -- å¼ºåˆ¶è®¾ç½®æ»šåŠ¨èŒƒå›´
        Lv_model.VirtualListSize = model_files_array.count
        Lv_model.EndUpdate()
    
        -- åœ¨åˆ·æ–°å®Œæˆåæ·»åŠ ï¼š
        if g_forceCustomLayout do (
            adjustColumnWidths forceCustom:true
            Lv_model.Font = g_alternateFont
        )
        
        -- ç¡®ä¿é»˜è®¤çŠ¶æ€
        if not g_forceCustomLayout do (
            adjustColumnWidths forceCustom:false
            Lv_model.Font = g_defaultFont
        )
    -- æ–°å¢ï¼šç»Ÿä¸€æ»šåŠ¨æ¡æ§åˆ¶
    Lv_model.Scrollable = false
    --adjustColumnWidths forceCustom:g_forceCustomLayout -- å…³é”®ï¼šå…ˆè°ƒæ•´åˆ—å®½ / false 
    Lv_model.Scrollable = true
    
    -- ç‰¹æ®Šå¤„ç†æœ€è¿‘æ–‡ä»¶æ¨¡å¼
    --if g_showRecentFiles do (
        --Lv_model.Columns.Item[1].Width -= 20 -- æ–‡ä»¶ååˆ—å‹ç¼©é˜²æ­¢æº¢å‡º
        --Lv_model.Scrollable = false
        --Lv_model.Scrollable = true -- ä¿æŒå‚ç›´æ»šåŠ¨
    --)
        -- å¼ºåˆ¶é‡ç»˜
        Lv_model.Refresh()
        updateModeStatus()
        --adjustColumnWidths ()
        windows.processPostedMessages() -- å…³é”®ï¼ç¡®ä¿UIåˆ·æ–°
    )

----------------------------------------------------------------
--è‡ªåŠ¨ä¿å­˜ç›‘æ§-å‡½æ•°
fn initAutoSaveWatcher = (
    try (
        g_autoSaveWatcher.Path = g_autoSavePath
        g_autoSaveWatcher.Filter = "*.max"
        g_autoSaveWatcher.NotifyFilter = (dotNetClass "System.IO.NotifyFilters").FileName
        g_autoSaveWatcher.EnableRaisingEvents = true
        
        -- ä¿®æ­£å‚æ•°ä¼ é€’æ–¹å¼ä¸ºæ•°ç»„
        dotnet.addEventHandler g_autoSaveWatcher "Created" (fn s e = (
            dotNet.invokeMethod (dotNetClass "System.Threading.Thread") "Sleep" #(1000)
            if doesFileExist e.FullPath and (getFilenameType e.FullPath) == ".max" do (
                additem_lv Lv_model e.FullPath
            )
        ))
    ) catch (
        format "[ç›‘æ§åˆå§‹åŒ–é”™è¯¯] %\n" (getCurrentException())
    )
)

-- åœ¨ç›‘æ§äº‹ä»¶ä¸­å¢åŠ é‡è¯•æœºåˆ¶/ä¼˜åŒ–é€‰é¡¹--å¾…éªŒè¯-false
--dotNet.addEventHandler g_autoSaveWatcher "Created" (fn s e = (
    --local retryCount = 0
    --while retryCount < 3 do (
        --try (
            --if doesFileExist e.FullPath do (
                --additem_lv Lv_model e.FullPath
                --exit
            --)
        --) catch (
           --retryCount += 1
            --dotNet.invokeMethod (dotnetclass "System.Threading.Thread") "Sleep" 500
        --)
    --)
--))

-- å¼ºåŒ–åŠ¨ç”»æ£€æµ‹-å‡½æ•°
fn export_mod_fn mod_state = (
    --
    case mod_state of (
        1: ( -- Autoæ¨¡å¼ï¼ˆæ™ºèƒ½åˆ¤æ–­ï¼‰
            FbxExporterSetParam "ResetExport"
            FbxExporterSetParam "SmoothingGroups" true
            FbxExporterSetParam "SmoothMeshExport" true
            
            FbxExporterSetParam "Cameras" false
            FbxExporterSetParam "Lights" false
            FbxExporterSetParam "EmbedTextures" false
            FbxExporterSetParam "ShowWarnings" false
        )
        2: ( -- Skinæ¨¡å‹æ¨¡å¼
            FbxExporterSetParam "ResetExport"
            FbxExporterSetParam "SmoothingGroups" true
            FbxExporterSetParam "SmoothMeshExport" true
            FbxExporterSetParam "Animation" false
            FbxExporterSetParam "EmbedTextures" false
            FbxExporterSetParam "Cameras" false
            FbxExporterSetParam "Lights" false
            FbxExporterSetParam "Skin" true -- æ˜¾å¼å¯ç”¨è’™çš®
            FbxExporterSetParam "ShowWarnings" false
        )
        3: ( -- BakeåŠ¨ç”»æ¨¡å¼
            FbxExporterSetParam "ResetExport"
            FbxExporterSetParam "SmoothingGroups" false
            FbxExporterSetParam "SmoothMeshExport" false
            
            FbxExporterSetParam "Animation" true
            FbxExporterSetParam "BakeAnimation" true
            FbxExporterSetParam "BakeResampleAnimation" true
            FbxExporterSetParam "FilterKeyReducer" true
            
            FbxExporterSetParam "EmbedTextures" false
            FbxExporterSetParam "Cameras" false
            FbxExporterSetParam "Lights" false
            FbxExporterSetParam "ShowWarnings" false
        )
    )
        
)

-- é€‰æ‹©é›†è¿‡æ»¤å‡½æ•° / æœªéªŒè¯ / false / å¤‡ç”¨
fn filterSetsByMode sets = (
    case rdo_exportMode.state of (
        2: ( -- Skinæ¨¡å¼è¿‡æ»¤
            local skinSets = for s in sets where matchPattern s pattern:"*skin*" collect s
            if skinSets.count == 0 do (
                messageBox "æœªæ‰¾åˆ°åŒ…å«'skin'çš„é€‰æ‹©é›†ï¼" title:"æ¨¡å¼ä¸åŒ¹é…"
                throw "å¯¼å‡ºä¸­æ­¢"
            )
            skinSets -- å…³é”®ï¼šè¿”å›å•ä¸€æ•°ç»„
        )
        
        default: sets -- Autoæ¨¡å¼ä¸è¿‡æ»¤
 
    )
) 

-- æ—¥æœŸæ—¶é—´åˆ·æ–°å‡½æ•° =================================================
fn fnRefreshDate = (
    local arrTime = getLocalTime()  -- è·å–æœ¬åœ°æ—¶é—´æ•°ç»„
    
    -- æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ -------------------------------------------------
    local formattedDate = formattedPrint arrTime[1] format:"04d" + "/" +  -- å¹´
                          formattedPrint arrTime[2] format:"02d" + "/" +  -- æœˆ
                          formattedPrint arrTime[4] format:"02d"         -- æ—¥
    --å…¨æ˜¾ç¤ºï¼ˆæ—¶åˆ†ï¼‰
    local formattedTime = formattedPrint arrTime[5] format:"02d" + ":" +  -- æ—¶
                          formattedPrint arrTime[6] format:"02d"          -- åˆ†
                         
    --å…¨æ˜¾ç¤ºï¼ˆæ—¶åˆ†ç§’ï¼‰
	--local formattedTime = formattedPrint arrTime[5] format:"02d" + ":" +  -- æ—¶
                          --formattedPrint arrTime[6] format:"02d" + ":" +  -- åˆ†
                          --formattedPrint arrTime[7] format:"02d"         -- ç§’
	-- è®¡ç®—æ˜ŸæœŸ ------------------------------------------------------
    local dayWeekID = mod arrTime[3] 7  -- æ˜ŸæœŸç´¢å¼• (0=æ—¥,1=ä¸€...6=å…­)
    
    -- æ„å»ºæ˜¾ç¤ºå­—ç¬¦ä¸² -------------------------------------------------
    lblDateTime.text = formattedDate + "  æ˜ŸæœŸ" + arrDayWeek[dayWeekID + 1] + "  " + formattedTime  --ï¼ˆå®æ—¶ç§’æ˜¾ç¤ºï¼‰
)

-- è®°å¿†çª—å£ä½ç½®é…ç½®å‡½æ•°ï¼ˆpos-remenber)
fn savePositionToINI pos = (
        local iniPath = (getDir #scripts) + "\\AutoExportTool_Pro.ini"
        try (
            setIniSetting iniPath "Settings" "LastPos" (pos as string)
        ) catch (
            format "[é”™è¯¯] æ— æ³•ä¿å­˜çª—å£ä½ç½®åˆ°INIæ–‡ä»¶ï¼š%\n" (getCurrentException())
            messageBox "æ— æ³•ä¿å­˜è®¾ç½®ï¼Œè¯·æ£€æŸ¥è„šæœ¬ç›®å½•æƒé™ï¼" title:"è­¦å‘Š"
        )
    )


-- å®æ—¶æ£€æµ‹é€‰æ‹©é›†çŠ¶æ€å‡½æ•°
fn refreshSceneSetsCache = (
    g_sceneSetsCache = #()
    try (
        g_sceneSetsCache = for i=1 to (getNumNamedSelSets()) collect (getNamedSelSetName i)
    ) catch (
        format "[é”™è¯¯] é€‰æ‹©é›†åˆ·æ–°å¤±è´¥ï¼š%\n" (getCurrentException())
    )
)

-- æ£€æŸ¥åŸºç¡€åœºæ™¯çŠ¶æ€--å‡½æ•°
fn isValidScene = (
    try (
        local valid = true
        valid = valid and (maxFileName != undefined)  -- åœºæ™¯æ–‡ä»¶åæœ‰æ•ˆæ€§
        valid = valid and (objects.count > 0)         -- è‡³å°‘å­˜åœ¨ä¸€ä¸ªå¯¹è±¡
        valid = valid and (not isDeleted rootNode)    -- æ ¹èŠ‚ç‚¹æœ‰æ•ˆæ€§
        valid
    ) catch (
        false
    )
)    
    
-- ä¿®æ”¹CheckForSaveå‡½æ•°ï¼Œç¡®ä¿å§‹ç»ˆè¿”å›å¸ƒå°”å€¼ / æœåŠ¡äº åŒå‡»æ‰“å¼€ 
fn CheckForSave = (
    try (
        -- ç¡®ä¿needsSaveè½¬æ¢ä¸ºå¸ƒå°”å€¼
        local needsSaveState = (needsSave as BooleanClass)
        if needsSaveState then (
            local res = queryBox "å½“å‰åœºæ™¯æœªä¿å­˜ï¼Œæ˜¯å¦ä¿å­˜æ›´æ”¹ï¼Ÿ" title:"ä¿å­˜ç¡®è®¤"
            return (res == true) -- æ˜ç¡®è¿”å›å¸ƒå°”å€¼
        ) else (
            return true -- æ— éœ€ä¿å­˜æ—¶ç›´æ¥è¿”å›true
        )
    ) catch (
        format "[OpenSuccess] MouseDoubleClick--åŒå‡»æ‰“å¼€æ–‡ä»¶æˆåŠŸï¼ï¼ï¼\n" (getCurrentException())
        return true -- å¼‚å¸¸æ—¶é»˜è®¤å…è®¸ç»§ç»­æ“ä½œ
    )
)
    
-- å®šä¹‰é€šç”¨æ–‡ä»¶æ‰“å¼€å‡½æ•° - æœåŠ¡äºåŒå‡»æ‰“å¼€æ–‡ä»¶/ï¼ˆæ³¨æ„è‹¥æ­¤ç±»ä»£ç æ‰§è¡Œä¸­å¼•ç”¨åˆ°å…¶ä»–å‡½æ•°ï¼Œåˆ™ éœ€ æ’åœ¨å¼•ç”¨åˆ°çš„å‡½æ•°çš„åé¢å³-ä»£ç è¡Œä¸‹æ–¹ï¼ï¼ï¼fn CheckForSave = (... æ­¤å‡½æ•°çš„åé¢ä»»æ„ä½ç½®ï¼
fn openFileWithDefaultApp filePath = (
    if (CheckForSave()) do (
        g_lastAction = "åŒå‡»-æ‰“å¼€æ–‡ä»¶"
        updateModeStatus()
        try (
            shellLaunch filePath ""
            
            -- å¦‚æœæ˜¯MAXæ–‡ä»¶ï¼Œé«˜äº®æ˜¾ç¤º
            if (toLower (getFilenameType filePath)) == ".max" do (
                -- ç¨ç­‰ç‰‡åˆ»è®©æ–‡ä»¶åŠ è½½å®Œæˆ
                dotNet.invokeMethod (dotNetClass "System.Threading.Thread") "Sleep" 500
                highlightCurrentFile()
            )
            
            format "å·²æ‰“å¼€æ–‡ä»¶ï¼š%\n" filePath
        ) catch (
            format "[æ‰“å¼€é”™è¯¯] æ–‡ä»¶ï¼š%\né”™è¯¯ï¼š%\n" filePath (getCurrentException())
        )
    )
)

--lvåˆ—è¡¨-ä¸»è¦æ–°å¢åºå·å¯å‹¾é€‰/æ‹“å±•æ’ä»¶åŠ è½½ç¼“å­˜ï¼›
fn initPluginSystem = (
        
    -- åˆå§‹åŒ–åˆ—è¡¨
    Lv_model.View = (dotNetClass "System.Windows.Forms.View").Details
    Lv_model.CheckBoxes = true  
    Lv_model.MultiSelect = true  
 )
     
-- åŠ¨æ€å¸ƒå±€è°ƒæ•´å‡½æ•° -- new try
fn updateButtonLayout = (
    -- è®¡ç®—æ–‡æœ¬å®é™…éœ€è¦çš„åƒç´ å®½åº¦
    local textPadding = 20 -- å·¦å³ç•™ç™½
    btn_aotu_model.width = (getTextExtent btn_aotu_model.text)[1] + textPadding
    btn_exp_M_fbx.width = (getTextExtent btn_exp_M_fbx.text)[1] + textPadding
    
    -- å¼ºåˆ¶åˆ·æ–°å¸ƒå±€
    AutoExportTool_Pro.width = 500  --  roulout--å°ºå¯¸ wide å¤±æ•ˆï¼Œä»¥æ­¤å¼ºåˆ¶å°ºå¯¸ä¸ºä¸»å®½ï¼ŒæŒ‰éœ€å¯åˆ ï¼Œå¯¹åº” updateButtonLayout()
    redrawViews()           -- true åˆ·æ–°åˆ—è¡¨ 
    ---refreshFileListView()
)
    
   
----------------------------------------------------------------
    
-- åˆ·æ–°åœºæ™¯é€‰æ‹©é›†--å‡½æ•°
fn GetSetFormScene = (
    sele_set_list = #()
    local set_array = getNumNamedSelSets()
    for i=1 to set_array do (
        append sele_set_list (getNamedSelSetName i)
    )
    selec_set.items = sele_set_list
)
    
    ----------------------------------------------------------------
    
-- åˆ—è¡¨-æ¡†æ¶-å‡½æ•°1
fn setup_list lv_body =
(
    lv_body.view = (dotnetclass "system.windows.forms.view").details
    lv_body.fullrowselect = True
    lv_body.gridlines = True
    lv_body.hideselection = false
    lv_body.borderstyle = lv_body.borderstyle.fixedsingle
    lv_body.headerstyle = lv_body.headerstyle.nonclickable
    lv_body.backcolor = lv_body.backcolor.fromargb 225 225 225
    lv_body.allowdrop = True
)
    
-- åˆ—è¡¨-æ¡†æ¶-å‡½æ•°2
fn newlist_columns lv_body str_array size_arry =
(
    for i=1 to str_array.count do
    (
        lv_body.columns.add str_array[i] size_arry[i]
    )
)
    
-- åˆ—è¡¨åˆå§‹åŒ–å¼ºåŒ–ï¼ˆåˆ—å®½è‡ªé€‚åº”ï¼‰
fn start_Lv_model = (
    Lv_model.MultiSelect = true -- å¯ç”¨å¤šé€‰
    Lv_model.HideSelection = false -- ä¿æŒé€‰ä¸­å¯è§
    -- åŸºç¡€è®¾ç½®
    Lv_model.View = (dotNetClass "System.Windows.Forms.View").Details
    Lv_model.HeaderStyle = (dotNetClass "System.Windows.Forms.ColumnHeaderStyle").None
    Lv_model.FullRowSelect = true
    Lv_model.Scrollable = false  -- åˆå§‹ç¦ç”¨æ»šåŠ¨æ¡
    Lv_model.MultiSelect = true -- å¯ç”¨å¤šé€‰/æ–°å¢/æ·»åŠ å¤šé€‰æ”¯æŒ
    Lv_model.HideSelection = false -- ä¿æŒé€‰ä¸­å¯è§/æ–°å¢/æ·»åŠ å¤šé€‰æ”¯æŒ
    Lv_model.BorderStyle = (dotNetClass "System.Windows.Forms.BorderStyle").FixedSingle
    -- æ·»åŠ æ»šåŠ¨äº‹ä»¶å¤„ç†
    Lv_model.Scrollable = (Lv_model.Items.Count * 20 > Lv_model.Height) -- æ ¹æ®é¡¹æ•°åŠ¨æ€å¯ç”¨
    -- åˆ›å»ºåˆ—å¤´å¹¶è®¾ç½®å¯¹é½
    Lv_model.Columns.Clear()
    
    -- CK/ICONåˆ—
    local colCK = Lv_model.Columns.Add "CK/ICON" COLUMN_CK_WIDTH
    colCK.TextAlign = (dotNetClass "System.Windows.Forms.HorizontalAlignment").Center
    
    -- æ–‡ä»¶åˆ—ï¼ˆè‡ªé€‚åº”å®½åº¦ï¼‰
    local colFile = Lv_model.Columns.Add "æ–‡ä»¶/Name" (LISTVIEW_WIDTH - COLUMN_CK_WIDTH - COLUMN_TYPE_WIDTH - 5) -- ç•™å‡ºæ»šåŠ¨æ¡ç©ºé—´
    
    -- ç±»å‹åˆ—
    local colType = Lv_model.Columns.Add "ç±»å‹/Type" COLUMN_TYPE_WIDTH
    colType.TextAlign = (dotNetClass "System.Windows.Forms.HorizontalAlignment").Center
    
    -- è®¾ç½®æ ‡é¢˜å­—ä½“
    
    --Lv_model.Font = dotNetObject "System.Drawing.Font" "å¾®è½¯é›…é»‘" 8 ((dotNetClass "System.Drawing.FontStyle").Bold)

    --Lv_model.Font = dotNetObject "System.Drawing.Font" "å®‹ä½“" 9 ((dotNetClass "System.Drawing.FontStyle").Regular)

    --Lv_model.Font = dotNetObject "System.Drawing.Font" "é»‘ä½“" 10 ((dotNetClass "System.Drawing.FontStyle").Italic)
    
    Lv_model.Sorting = (dotNetClass "System.Windows.Forms.SortOrder").None
    
    -- è®¾ç½®å…¨å±€èƒŒæ™¯è‰² --------------------------
    --Lv_model.BackColor = (dotNetClass "System.Drawing.Color").FromArgb 180 180 180       -- èƒŒæ™¯é¢œè‰²-true
    Lv_model.ForeColor = (dotNetClass "System.Drawing.Color").FromArgb 255 255 255          -- é»˜è®¤æ–‡å­—é¢œè‰² - å¤‡ç”¨-false
    --Lv_model.ForeColor = (dotNetClass "System.Drawing.Color").Blue                         -- true ç”Ÿæ•ˆ
    Lv_model.allowDrop = true
    updateModeStatus()
)

--é«˜äº® / é¢œè‰²å‚è€ƒ 
--ç”µå…‰è“--RGB:color( 0 149 255 )
--éœ“è™¹ç´«--RGB:color( 255 0 255 )
--è§å…‰ç»¿--RGB:color( 50 255 50 )
--å®çŸ³çº¢--RGB:color( 220 20 60 )
--é•­å°„é“¶--RGB:color( 192 192 192 )
--æ¿€å…‰ç»¿--RGB:color( 0 255 0 ) // çº¯ç»¿ï¼Œè§†è§‰æäº®
--ç‚«å…‰æ©™--RGB:color( 255 80 0 ) // çº¢æ©™ç«ç„°è‰²
--æå…‰é’--RGB:color( 0 255 255 ) // è“ç»¿åŒé€šé“æ‹‰æ»¡
--éœ“è™¹ç²‰--RGB:color( 255 0 127 ) // è§å…‰ç²‰åˆºçœ¼æ•ˆæœ
--ç«ç„°çº¢--RGB:color( 255 0 0 ) // çº¯çº¢åŸºå‡†è‰²
--é•­å°„é‡‘--RGB:color( 255 215 0 ) // é‡‘å±å…‰æ³½é«˜äº®é»„
--è§å…‰æŸ é»„--RGB:color( 200 255 0 ) // ç»¿é»„æ··åˆè§å…‰
--ç”µå…‰ç´«--RGB:color( 180 0 255 ) // è“ç´«é€šé“æè‡´å¯¹æ¯”
--èµ›åšè“--RGB:color( 0 150 255 ) // æ¯”ç”µå…‰è“æ›´å†·å†½
--ä¿¡å·é»„--RGB:color( 255 255 30 ) // è­¦ç¤ºç¯çº§åˆ«é«˜äº®

--æ³¡ç³–ç²‰--RGB:color( 255 105 180 ) ï¼›æ¨±èŠ±ç²‰-- RGB:color ( 255 182 193 ) ï¼› -- å¤å¤è“ RGB:color( 135 206 250 )ï¼›å©´å„¿è“ RGB:color( 135 206 235 )ï¼›
	--é“¶ç° RGB:color( 192 192 192) ï¼› --è–°è¡£è‰ç´« RGB:color( 216 191 216 )ï¼› -- èµ›åšè“ RGB:color( 0 184 255 )ï¼›
	---- ç´«æ™¶è‰²RGB:color( 160 0 255 )  (RGBï¼›-- éœ“è™¹ç²‰ (RGB:(color( 255 95 155 )ï¼›-- äº®é»„ RGB:color( 255 255 0) 

--è–„è·ç»¿--RGB:color( 62 180 137 )
--æ·±æµ·è“--RGB:color( 0 105 148 )
--å¥¶æ²¹æ©™--RGB:color( 255 179 102 )
--è–°è¡£è‰--RGB:color( 181 126 220 )
--ç¥ç€é‡‘--RGB:color( 255 176 59 )

--å†°å·ç°--RGB:color( 112 128 144 )
--æ¨±æ¡ƒçº¢--RGB:color( 222 49 99 )
--é¦™æ§Ÿè‰²--RGB:color( 242 210 161 )
--å­”é›€è“--RGB:color( 0 117 113 )
--å·§å…‹åŠ›æ£•--RGB:color( 123 63 0 )

--æš–è‰²
--è½æ—¥æ©˜--RGB:color( 255 95 31 )
--ç«ç‘°é‡‘--RGB:color( 183 110 121 )
--ç„¦ç³–æ£•--RGB:color( 175 110 75 )
--çŠç‘šç²‰--RGB:color( 255 114 118 )
--è§å…‰é»„--RGB:color( 204 255 0 )

--å†·è‰²
--æ¾çŸ³ç»¿--RGB:color( 64 224 208 )
--é›¾éœ¾è“--RGB:color( 109 155 195 )
--æ©„æ¦„ç»¿--RGB:color( 128 128 0 )
--å†°å·è“--RGB:color( 176 224 230 )
--æš—å¤œç´«--RGB:color( 102 0 153 )

--ä¸­æ€§
--çŸ³æ¿ç°--RGB:color( 94 94 94 )
--äºšéº»ç±³--RGB:color( 250 240 230 )
--ç‚­é»‘è‰²--RGB:color( 28 28 28 )
--æ°´æ³¥ç°--RGB:color( 168 172 173 )
--çç ç™½--RGB:color( 248 248 255 )

-- åˆ é™¤é€‰ä¸­çš„æ–‡ä»¶/æ–‡ä»¶å¤¹å‡½æ•°/true/ç¨³å®š / ä¼˜åŠ¿ï¼šç»Ÿä¸€çš„åˆ é™¤é€»è¾‘ï¼š

--æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ä½¿ç”¨ç›¸ä¼¼çš„åˆ é™¤æµç¨‹ / æœåŠ¡å™¨è·¯å¾„ç»Ÿä¸€ä½¿ç”¨DOSå‘½ä»¤

--æœ¬åœ°è·¯å¾„ä½¿ç”¨åŸç”Ÿæ–¹æ³•
fn deleteSelectedFiles = (
    try (
        local selItems = AutoExportTool_Pro.Lv_model.SelectedItems
        if selItems.Count == 0 do return undefined
        
        -- æ„å»ºæ–‡ä»¶åˆ—è¡¨å­—ç¬¦ä¸²
        local fileList = ""
        for i=0 to selItems.Count-1 do (
            local path = selItems.Item[i].Tag as String
            fileList += path + "\n"
        )
        
        -- ç¡®è®¤å¯¹è¯æ¡†
        local msg = "ç¡®å®šæ°¸ä¹…åˆ é™¤ä»¥ä¸‹é¡¹ç›®ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼\n\n" + fileList
        if not (queryBox msg title:"å±é™©æ“ä½œ" beep:true) do return false
        
        -- åˆ é™¤æ‰€æœ‰é€‰ä¸­çš„é¡¹ç›®
        local deletedItems = #()
        local failedItems = #()
        
        for i=selItems.Count-1 to 0 by -1 do (
            local path = selItems.Item[i].Tag as String
            local isNetworkPath = matchPattern path pattern:"\\\\*"
            local success = false
            local isDir = doesDirectoryExist path
            local successCount = 0
            local failCount = 0
            try (
                if isDir then (
                    -- åˆ é™¤æ–‡ä»¶å¤¹
                    if isNetworkPath then (
                        -- æœåŠ¡å™¨è·¯å¾„ä½¿ç”¨DOSå‘½ä»¤
                        local cmd = "cmd /c rmdir /s /q \"" + path + "\""
                        hiddenDOSCommand cmd
                    ) else (
                        -- æœ¬åœ°è·¯å¾„ä½¿ç”¨.NETæ–¹æ³•
                        local dir = dotNetClass "System.IO.Directory"
                        dir.Delete path true
                    )
                ) else (
                    -- åˆ é™¤æ–‡ä»¶
                    if isNetworkPath then (
                        -- æœåŠ¡å™¨è·¯å¾„ä½¿ç”¨DOSå‘½ä»¤
                        local cmd = "cmd /c del /f /q \"" + path + "\""
                        hiddenDOSCommand cmd
                    ) else (
                        deleteFile path
                    )
                )
                
                -- éªŒè¯åˆ é™¤
                if (isDir and not doesDirectoryExist path) or (not isDir and not doesFileExist path) then (
                    success = true
                    g_lastAction = "â€‹â€‹å³é”®-åˆ é™¤" + (if isDir then "æ–‡ä»¶å¤¹" else "æ–‡ä»¶")
                    updateModeStatus()
                )
            ) catch (
                success = false
            )
            
            -- è®°å½•ç»“æœ
            if success then (
                append deletedItems path
            ) else (
                append failedItems path
            )
        )
        
        -- åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
        AutoExportTool_Pro.refreshFileListView()
        -- æ˜¾ç¤ºæ“ä½œç»“æœ
        local resultMsg = ""
        --local resultMsg = g_lastAction
        if deletedItems.count > 0 then (
        g_lastAction = "å·²åˆ é™¤ " + (deletedItems.count as string) + " ä¸ªé¡¹ç›®\n"
        updateModeStatus()
    )
        if failedItems.count > 0 then (
            resultMsg += "åˆ é™¤å¤±è´¥ " + (failedItems.count as string) + " ä¸ªé¡¹ç›®:\n"
            for i=1 to (amin 5 failedItems.count) do (  -- æœ€å¤šæ˜¾ç¤º5ä¸ªå¤±è´¥é¡¹
                resultMsg += failedItems[i] + "\n"
            )
            if failedItems.count > 5 do resultMsg += "......\n"
        )
        
        if resultMsg != "" do messageBox resultMsg title:"åˆ é™¤ç»“æœ"
        updateModeStatus() 
    ) catch (
        format "[åˆ é™¤é”™è¯¯] %\n" (getCurrentException())
        messageBox ("åˆ é™¤è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: " + (getCurrentException())) title:"é”™è¯¯"
    )
)

--åŒé‡åˆ é™¤å°è¯• / é¦–å…ˆå°è¯•ä½¿ç”¨DOSå‘½ä»¤å¼ºåˆ¶åˆ é™¤ / å¦‚æœDOSå‘½ä»¤å¤±è´¥ï¼Œå†å°è¯•ä½¿ç”¨MAXScriptçš„deleteFileæ–¹æ³• / æ¯æ¬¡å°è¯•åéªŒè¯æ–‡ä»¶æ˜¯å¦ç¡®å®è¢«åˆ é™¤
--æœ¬åœ°åˆ é™¤å·²ç»å®ç°ä¸”ç¨³å®š/æœåŠ¡å™¨åˆ™æœ‰å‡ ç‡ä¸ç¨³å®š - è‹¥ åˆ é™¤æ— æ•ˆ åˆ™ éœ€ ç­‰å¾…æœåŠ¡å™¨ç½‘ç»œæ¢å¤ ç›¸å¯¹ç¨³å®šå å†æ¬¡ æ“ä½œå°è¯•ï¼ï¼ï¼é—®é¢˜ä¸å¤§..
-- å¸¦é‡è¯•æœºåˆ¶çš„æ–‡ä»¶åˆ é™¤å‡½æ•°/æœªéªŒè¯/å¤‡ç”¨ ï¼ˆå½“æœåŠ¡å™¨åœ°å€ä¸ç¨³å®šåˆ™åˆ é™¤ä¸æˆåŠŸï¼Œåˆ—è¡¨åˆ·æ–°æ–‡ä»¶/æ–‡ä»¶å¤¹è¿˜å­˜åœ¨ï¼Œæ–°å¢çš„ä¸€ä¸ªé‡åˆ æœºåˆ¶ï¼Œå½“æ£€æµ‹åˆ° not success  åˆ™ è¿›è¡Œé‡è¯• ï¼‰æœ¬åœ°åˆ é™¤å·²ç»å®ç°ä¸”ç¨³å®š
fn deleteFileWithRetry path maxRetries:3 = (
    local retryCount = 0
    local success = false
    local isNetworkPath = matchPattern path pattern:"\\\\*"
    
    while retryCount < maxRetries and not success do (
        try (
            if isNetworkPath then (
                -- æœåŠ¡å™¨è·¯å¾„ä½¿ç”¨DOSå‘½ä»¤
                local cmd = "cmd /c del /f /q \"" + path + "\""
                hiddenDOSCommand cmd
                -- æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢«åˆ é™¤
                if not doesFileExist path then (
                    success = true
                )
            ) else (
                -- æœ¬åœ°è·¯å¾„ä½¿ç”¨MAXScriptæ–¹æ³•
                deleteFile path
                if not doesFileExist path then success = true
            )
        ) catch (
            success = false
        )
        
        if not success do (
            sleep 0.5  -- ç­‰å¾…0.5ç§’å†é‡è¯•
            retryCount += 1
        )
    )
    
    success
)

-- ä¿®å¤åçš„æ–‡ä»¶/æ–‡ä»¶å¤¹å±æ€§æŸ¥çœ‹å‡½æ•°
fn showItemProperties path = (
    try (
        if not (doesFileExist path or doesDirectoryExist path) do (
            messageBox "è·¯å¾„ä¸å­˜åœ¨: " + path title:"é”™è¯¯"
            return false
        )
        
        if Lv_model.SelectedItems.Count == 0 do return undefined
        local selItem = Lv_model.SelectedItems.Item[0]
        local fPath = selItem.Tag as String
        -- è·å–åŸºæœ¬ä¿¡æ¯
        local size = 0
        local modDate = "æœªçŸ¥"
        if doesFileExist path then (
            size = getFileSize path
            modDate = getFileModDate path
        )
        else if doesDirectoryExist path then (
            modDate = getFileModDate path
            -- è®¡ç®—æ–‡ä»¶å¤¹å¤§å°
            local totalSize = 0
            local files = getFiles (path + "\\*.*")
            for f in files do totalSize += getFileSize f
            size = totalSize
        )
        
        -- è½¬æ¢æ–‡ä»¶å¤§å°æ ¼å¼
        local sizeStr
        case of (
            (size > 1024*1024*1024): sizeStr = (size/(1024*1024*1024)) as string + " GB"
            (size > 1024*1024): sizeStr = (size/(1024*1024)) as string + " MB"
            (size > 1024): sizeStr = (size/1024) as string + " KB"
            default: sizeStr = size as string + " å­—èŠ‚"
        )
        
        -- åˆ›å»ºå±æ€§å­—ç¬¦ä¸²
        local msg = "è·¯å¾„:ğŸŒ» " + path + "\n" + \
                   "ç±»å‹:ğŸ“© " + (if doesDirectoryExist path then "æ–‡ä»¶å¤¹" else "æ–‡ä»¶") + "\n" + \
                   "å¤§å°: " + sizeStr + "\n" + \
                   "ä¿®æ”¹æ—¶é—´: " + modDate
        
        -- æ˜¾ç¤ºæ¶ˆæ¯æ¡†
        messageBox msg title:"å±æ€§"
    ) catch (
        format "[å±æ€§é”™è¯¯] %\n" (getCurrentException())
        messageBox ("âš ï¸ä¸æ”¯æŒæ–‡ä»¶å¤¹å±æ€§è·å–: " + (getCurrentException())) title:"é”™è¯¯"
    )
)

-- è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
fn formatSize size = (
    case of (
        (size > 1024*1024*1024): (size/(1024*1024*1024.0)) as string + " GB"
        (size > 1024*1024): (size/(1024*1024.0)) as string + " MB"
        (size > 1024): (size/1024.0) as string + " KB"
        default: size as string + " å­—èŠ‚"
    )
)

-- åˆ›å»ºç¼–è¾‘æ¡†å‡½æ•°
fn createEditTextBox item = (
    try (
        -- è·å–é¡¹ç›®ä½ç½®å’Œå¤§å°ï¼ˆåªé’ˆå¯¹æ–‡ä»¶/æ–‡ä»¶å¤¹åç§°åˆ—ï¼‰
        local rect = item.SubItems.Item[1].Bounds
        
        -- åˆ›å»ºç¼–è¾‘æ¡†
        g_editTextBox = dotNetObject "System.Windows.Forms.TextBox"
        g_editTextBox.Bounds = rect
        g_editTextBox.Text = item.SubItems.Item[1].Text
        g_editTextBox.BorderStyle = (dotNetClass "System.Windows.Forms.BorderStyle").FixedSingle
        g_editTextBox.Font = Lv_model.Font
              -- ç¡®å®šæ˜¯æ–‡ä»¶è¿˜æ˜¯æ–‡ä»¶å¤¹
              local oldPath = item.Tag as String
              g_editingIsFile = not (doesDirectoryExist oldPath)
              
              -- ä¼˜åŒ–æ–‡ä»¶åæ˜¾ç¤º
              if g_editingIsFile then (
                  -- æ–‡ä»¶ï¼šåªæ˜¾ç¤ºæ–‡ä»¶åéƒ¨åˆ†ï¼ˆä¸å¸¦æ‰©å±•åï¼‰
                  g_editTextBox.Text = getFilenameFile item.SubItems.Item[1].Text
              ) else (
                  -- æ–‡ä»¶å¤¹ï¼šæ˜¾ç¤ºå®Œæ•´åç§°
                  g_editTextBox.Text = item.SubItems.Item[1].Text
              )
        -- æ·»åŠ ç¼–è¾‘æ¡†åˆ°ListView
        Lv_model.Controls.Add g_editTextBox
        g_editTextBox.Focus()
        g_editTextBox.SelectAll()
        
        -- ä¿å­˜å½“å‰ç¼–è¾‘é¡¹
        g_editingItem = item
    )
    catch (
        format "[åˆ›å»ºç¼–è¾‘æ¡†é”™è¯¯] %\n" (getCurrentException())
    )
)

-- å®Œæˆç¼–è¾‘å‡½æ•°
fn finishEditing = (
    try (
        if g_editTextBox != undefined and g_editingItem != undefined do (
            local newName = g_editTextBox.Text
            local oldPath = g_editingItem.Tag as String
            local isFolder = doesDirectoryExist oldPath
            
            -- æ„å»ºæ–°è·¯å¾„
            local newPath = ""
            if isFolder then (
                local parentDir = getFilenamePath oldPath
                newPath = pathConfig.appendPath parentDir newName
            ) else (
                local dir = getFilenamePath oldPath
                local ext = getFilenameType oldPath
                newPath = dir + newName + ext
            )
            
            -- æ‰§è¡Œé‡å‘½å
            if isFolder then (
                -- ä½¿ç”¨DOSå‘½ä»¤é‡å‘½åæ–‡ä»¶å¤¹
                local cmd = "cmd /c ren \"" + oldPath + "\" \"" + newName + "\""
                hiddenDOSCommand cmd
            ) else (
                -- æ–‡ä»¶é‡å‘½å
                renameFile oldPath newPath
            )
            
            -- æ›´æ–°åˆ—è¡¨é¡¹
            g_editingItem.SubItems.Item[1].Text = if isFolder then newName else (newName + ext)
            g_editingItem.Tag = newPath
            g_lastAction = "é‡å‘½åæˆåŠŸ"
            updateModeStatus()
            
            -- æ¸…ç†ç¼–è¾‘çŠ¶æ€
            Lv_model.Controls.Remove g_editTextBox
            g_editTextBox.Dispose()
            g_editTextBox = undefined
            g_editingItem = undefined
        )
    )
    catch (
        format "[é‡å‘½åé”™è¯¯] %\n" (getCurrentException())
        cancelEditing()
    )
)

-- å–æ¶ˆç¼–è¾‘å‡½æ•°
fn cancelEditing = (
    try (
        if g_editTextBox != undefined do (
            Lv_model.Controls.Remove g_editTextBox
            g_editTextBox.Dispose()
            g_editTextBox = undefined
            g_editingItem = undefined
            g_lastAction = "é‡å‘½åå–æ¶ˆ"
            updateModeStatus()
        )
    )
    catch (
        format "[å–æ¶ˆç¼–è¾‘é”™è¯¯] %\n" (getCurrentException())
    )
)

-- é‡å‘½åå‡½æ•°ï¼ˆå¯åŠ¨ç¼–è¾‘ï¼‰
fn renameSelectedItem = (
    try (
        local selItems = AutoExportTool_Pro.Lv_model.SelectedItems
        if selItems.Count != 1 do (
            messageBox "è¯·é€‰æ‹©å•ä¸ªé¡¹ç›®è¿›è¡Œé‡å‘½å" title:"æç¤º"
            return false
        )
        
        local item = selItems.Item[0]
        createEditTextBox item
    ) 
    catch (
        format "[é‡å‘½åé”™è¯¯] %\n" (getCurrentException())
    )
)

-- æ–°å¢/åˆ—è¡¨-å‰ªåˆ‡åŠŸèƒ½ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
fn cutSelectedItems = (
    try (
        g_clipboard = #()
        g_clipboardType = "cut"
        local selItems = AutoExportTool_Pro.Lv_model.SelectedItems
        
        -- æ”¯æŒå¤šé€‰
        for i=0 to selItems.Count-1 do (
            local path = selItems.Item[i].Tag as String
            append g_clipboard path
        )
        
        if g_clipboard.count > 0 do (
            g_lastAction = "å·²å‰ªåˆ‡ " + (g_clipboard.count as string) + " ä¸ªé¡¹ç›®"
            updateModeStatus()
        )
    ) catch (
        format "[å‰ªåˆ‡é”™è¯¯] %\n" (getCurrentException())
    )
)

-- æ–°å¢/åˆ—è¡¨-å¤åˆ¶åŠŸèƒ½ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
fn copySelectedItems = (
    try (
        g_clipboard = #()
        g_clipboardType = "copy"
        local selItems = AutoExportTool_Pro.Lv_model.SelectedItems
        
        -- æ”¯æŒå¤šé€‰
        for i=0 to selItems.Count-1 do (
            local path = selItems.Item[i].Tag as String
            append g_clipboard path
        )
        
        if g_clipboard.count > 0 do (
            g_lastAction = "å·²å¤åˆ¶ " + (g_clipboard.count as string) + " ä¸ªé¡¹ç›®"
            updateModeStatus()
        )
    ) catch (
        format "[å¤åˆ¶é”™è¯¯] %\n" (getCurrentException())
    )
)

-- æ–°å¢/åˆ—è¡¨-ç²˜è´´åŠŸèƒ½ï¼ˆä¿®å¤æ–‡ä»¶å¤¹å‰ªåˆ‡ï¼‰
fn pasteItems = (
    try (
        -- æ£€æŸ¥å‰ªè´´æ¿æ˜¯å¦ä¸ºç©º
        if g_clipboard.count == 0 do (
            messageBox "å‰ªè´´æ¿ä¸ºç©º" title:"æç¤º"
            return false
        )
        
        -- ç¡®å®šç›®æ ‡è·¯å¾„
        local targetPath = ""
        local selItems = AutoExportTool_Pro.Lv_model.SelectedItems
        
        -- å¦‚æœé€‰ä¸­äº†å•ä¸ªæ–‡ä»¶å¤¹
        if selItems.Count == 1 and doesDirectoryExist (selItems.Item[0].Tag as String) then (
            targetPath = selItems.Item[0].Tag as String
        ) 
        -- å¦‚æœå½“å‰åˆ—è¡¨è·¯å¾„æœ‰æ•ˆ
        else if g_currentPath != undefined and doesDirectoryExist g_currentPath then (
            targetPath = g_currentPath
        )
        -- å¦‚æœéƒ½æ²¡æœ‰ï¼Œä½¿ç”¨å¯¼å‡ºè·¯å¾„ä½œä¸ºåå¤‡
        else if AutoExportTool_Pro.edtExportPath.text != "" then (
            targetPath = AutoExportTool_Pro.edtExportPath.text
        )
        else (
            messageBox "æ— æ³•ç¡®å®šç›®æ ‡ä½ç½®ï¼Œè¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶å¤¹æˆ–è®¾ç½®å¯¼å‡ºè·¯å¾„" title:"é”™è¯¯"
            return false
        )
        
        -- ç¡®ä¿ç›®æ ‡è·¯å¾„å­˜åœ¨
        if not doesDirectoryExist targetPath do (
            makeDir targetPath all:true
        )
        
        local successCount = 0
        local failCount = 0
        local movedItems = #()  -- è®°å½•æˆåŠŸç§»åŠ¨çš„é¡¹ç›®
        
        for path in g_clipboard do (
            try (
                -- ç¡®ä¿æºè·¯å¾„æœ‰æ•ˆ
                if not (doesFileExist path or doesDirectoryExist path) do (
                    format "[ç²˜è´´è­¦å‘Š] æºè·¯å¾„ä¸å­˜åœ¨: %\n" path
                    failCount += 1
                    continue
                )
                
                local fileName = filenameFromPath path
                local newPath = targetPath + "\\" + fileName
                
                -- å¤„ç†æ–‡ä»¶å¤¹
                  if doesDirectoryExist path then (
                    if g_clipboardType == "copy" then (
                        -- å¤åˆ¶æ–‡ä»¶å¤¹
                        local cmd = "cmd /c xcopy /E /I /Y \"" + path + "\" \"" + newPath + "\""
                        hiddenDOSCommand cmd
                        if doesDirectoryExist newPath do successCount += 1
                    ) else (
                        -- ç§»åŠ¨æ–‡ä»¶å¤¹
                        local cmd = "cmd /c move /Y \"" + path + "\" \"" + newPath + "\""
                        hiddenDOSCommand cmd
                        if doesDirectoryExist newPath do successCount += 1
                    )
                    
                    if g_clipboardType == "cut" then (
                        -- å¤åˆ¶æ–‡ä»¶å¤¹
                        local cmd = "cmd /c xcopy /E /I /Y \"" + path + "\" \"" + newPath + "\""
                        hiddenDOSCommand cmd
                        if doesDirectoryExist newPath do successCount += 1
                    ) else (
                        -- ç§»åŠ¨æ–‡ä»¶å¤¹
                        local cmd = "cmd /c move /Y \"" + path + "\" \"" + newPath + "\""
                        hiddenDOSCommand cmd
                        if doesDirectoryExist newPath do successCount += 1
                    )
                        
                        -- æ£€æŸ¥æ˜¯å¦ç§»åŠ¨æˆåŠŸ
                        if doesDirectoryExist newPath and not doesDirectoryExist path then (
                            successCount += 1
                            append movedItems path  -- è®°å½•å·²ç§»åŠ¨çš„é¡¹ç›®
                        ) else (
                            failCount += 1
                    )
                )
                
                -- å¤„ç†æ–‡ä»¶
                else if doesFileExist path then (
                    if g_clipboardType == "copy" then (
                        -- å¤åˆ¶æ–‡ä»¶
                        local result = copyFile path newPath
                        if result and doesFileExist newPath then (
                            successCount += 1
                        ) else (
                            failCount += 1
                        )
                    ) else (
                        -- ç§»åŠ¨æ–‡ä»¶
                        local result = renameFile path newPath
                        if result and doesFileExist newPath and not doesFileExist path then (
                            successCount += 1
                            append movedItems path  -- è®°å½•å·²ç§»åŠ¨çš„é¡¹ç›®
                        ) else (
                            failCount += 1
                        )
                    )
                )
            ) catch (
                failCount += 1
                format "[ç²˜è´´é”™è¯¯] é¡¹ç›®: % é”™è¯¯: %\n" path (getCurrentException())
            )
        )
        
        -- å¦‚æœæ˜¯å‰ªåˆ‡æ“ä½œï¼Œåªç§»é™¤æˆåŠŸç§»åŠ¨çš„é¡¹ç›®
        if g_clipboardType == "cut" then (
            for movedItem in movedItems do (
                local index = findItem g_clipboard movedItem
                if index > 0 do deleteItem g_clipboard index
            )
            
            -- å¦‚æœæ‰€æœ‰é¡¹ç›®éƒ½å·²ç§»åŠ¨ï¼Œæ¸…ç©ºå‰ªè´´æ¿ç±»å‹
            if g_clipboard.count == 0 then (
                g_clipboardType = ""
            )
        )
        
        -- åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
        AutoExportTool_Pro.refreshFileListView()
        
        g_lastAction = "å·²ç²˜è´´ " + (successCount as string) + " ä¸ªé¡¹ç›® (" + (failCount as string) + " å¤±è´¥)"
        updateModeStatus()
        
        return true
    )
    catch (
        format "[ç²˜è´´é”™è¯¯] %\n" (getCurrentException())
        messageBox ("ç²˜è´´å¤±è´¥: " + (getCurrentException())) title:"é”™è¯¯"
        return false
    )
)



fn ensurePluginDir = (
    local pluginDir = getDir #scripts
    if not doesDirectoryExist pluginDir do (
        makeDir pluginDir all:true
    )
    pluginDir
)

--å¤‡ä»½ä¸»æ’ä»¶ ms .. ç®€åŒ– / ä¿®å¤ 8.18

fn createBackup = (
    try (
        if doesFileExist g_pluginPath do (
            -- ç¡®ä¿ç›®å½•å­˜åœ¨
            makeDir (getFilenamePath g_backupPluginPath) all:true
            
            -- åˆ é™¤æ—§å¤‡ä»½
            if doesFileExist g_backupPluginPath do (
                try (deleteFile g_backupPluginPath) 
                catch (format "[å¤‡ä»½æ¸…ç†é”™è¯¯] %\n" (getCurrentException()))
            )
            
            -- åˆ›å»ºå¤‡ä»½
            try (
                copyFile g_pluginPath g_backupPluginPath
                format "[å¤‡ä»½æˆåŠŸ] æ’ä»¶å·²å¤‡ä»½åˆ°: %\n" g_backupPluginPath
            ) 
            catch (
                format "[å¤‡ä»½å¤±è´¥] %\n" (getCurrentException())
            )
        )
    ) 
    catch (
        format "[å¤‡ä»½é”™è¯¯] %\n" (getCurrentException())
    )
)

-- å·¥å…·æ æ·»åŠ  max ui // macroScript(å¤–éƒ¨èœå•å®å·¥å…·æ ) / true
fn addToolbarToMax = (
    -- åˆ›å»ºå¤‡ä»½
    createBackup()
    
    -- ç¡®ä¿å®è„šæœ¬åœ¨å¤–éƒ¨å®šä¹‰
    macroScript VideoTutorialAction 
    category:"AutoExportTool" 
    buttonText:"ğŸ¬ è§†é¢‘æ•™ç¨‹ | Video Tutorial"
    (
        openHelpLink "https://space.bilibili.com/327573825"
    )

    macroScript DocumentationAction 
    category:"AutoExportTool" 
    buttonText:"ğŸ“š å¸®åŠ©æ–‡æ¡£ | Documentation"
    (
        openHelpLink "https://ladyicefox.github.io/autoexporttool-docs/"
    )

    macroScript IssuesAction 
    category:"AutoExportTool" 
    buttonText:"ğŸ› é—®é¢˜å»ºè®® | Report Issues"
    (
        openHelpLink "https://github.com/ladyicefox/autoexporttool-docs/issues"
    )

    -- æ–°å¢ï¼šæ£€æŸ¥æ›´æ–°å®è„šæœ¬
    macroScript checkForUpdatesAction 
    category:"AutoExportTool" 
    buttonText:"ğŸ”„ æ£€æŸ¥æ›´æ–° | Check Updates"
    (
        try (
            checkForUpdates ()
            
        ) catch (
            format "[æ£€æŸ¥æ›´æ–°é”™è¯¯] %\n" (getCurrentException())
        )
    )

    -- æ–°å¢ï¼šé‡ç½®çª—å£ä½ç½®å®è„šæœ¬
    macroScript ResetWindowPosAction 
    category:"AutoExportTool" 
    buttonText:"ğŸ”„ é‡ç½®çª—å£ä½ç½® | Reset Window Position"
    (
        try (
            -- å¦‚æœæ’ä»¶çª—å£å·²ç»æ‰“å¼€ï¼Œåˆ™é‡ç½®å…¶ä½ç½®
            if isDialogVisible AutoExportTool_Pro do (
                -- è·å–å±å¹•å°ºå¯¸
                local screenWidth = sysInfo.desktopSize[1]
                local screenHeight = sysInfo.desktopSize[2]
                
                -- è®¡ç®—ä¸­å¤®ä½ç½®
                local dialogWidth = AutoExportTool_Pro.width
                local dialogHeight = AutoExportTool_Pro.height
                local centerX = (screenWidth - dialogWidth) / 2
                local centerY = (screenHeight - dialogHeight) / 2
                
                -- è®¾ç½®å¯¹è¯æ¡†ä½ç½®
                setDialogPos AutoExportTool_Pro [centerX, centerY]
                
                -- æ›´æ–°å…¨å±€å˜é‡å’ŒINIæ–‡ä»¶
                g_lastDialogPos = [centerX, centerY]
                setINISetting g_WindowPosPath "Window" "Position" (g_lastDialogPos as string)
                
                --messageBox "çª—å£ä½ç½®å·²é‡ç½®åˆ°å±å¹•ä¸­å¤®ï¼" title:"é‡ç½®çª—å£ä½ç½®"
            )
        ) catch (
            format "[é‡ç½®çª—å£ä½ç½®é”™è¯¯] %\n" (getCurrentException())
        )
    )

    -- å¼€å¯è‡ªåŠ¨æ£€æµ‹æ›´æ–°çš„å®è„šæœ¬
    macroScript AutoUpdateEnableAction
    category:"AutoExportTool"
    buttonText:"âœ¨ å¼€å¯è‡ªåŠ¨æ£€æµ‹ | Auto-Update On"
    (
        on execute do (
            g_autoCheckUpdate = true
            setINISetting g_UIConfigPath "Settings" "AutoCheckUpdate" "true"
            messageBox "è‡ªåŠ¨æ£€æµ‹æ›´æ–°å·²å¼€å¯" title:"è®¾ç½®å·²æ›´æ–°"
        )
    )
    
    -- å…³é—­è‡ªåŠ¨æ£€æµ‹æ›´æ–°çš„å®è„šæœ¬
    macroScript AutoUpdateDisableAction
    category:"AutoExportTool"
    buttonText:"âŒ å…³é—­è‡ªåŠ¨æ£€æµ‹ | Auto-Update Off"
    (
        on execute do (
            g_autoCheckUpdate = false
            setINISetting g_UIConfigPath "Settings" "AutoCheckUpdate" "false"
            messageBox "è‡ªåŠ¨æ£€æµ‹æ›´æ–°å·²å…³é—­" title:"è®¾ç½®å·²æ›´æ–°"
        )
    )
    
    macroScript AutoStartEnableAction 
        category:"AutoExportTool" 
        buttonText:"âœ¨ å¼€å¯ âš®â€‹ Open"
    (
        try (
            if not g_autoStartEnabled do (
                toggleAutoStart()
                messageBox "AutoExportTool è‡ªå¯ - å·²æ‰“å¼€" title:"âœ¨ æˆåŠŸ"
            )
        ) catch (
            format "[è‡ªå¯å¼€å¯é”™è¯¯] %\n" (getCurrentException())
        )
    )
    
    macroScript AutoStartDisableAction 
        category:"AutoExportTool" 
        buttonText:"âŒ å…³é—­ âš­â€‹ Close"
    (
        try (
            if g_autoStartEnabled do (
                toggleAutoStart()
                messageBox "AutoExportTool è‡ªå¯ - å·²è§£é™¤" title:"âœ¨ æˆåŠŸ"
            )
        ) catch (
            format "[è‡ªå¯å…³é—­é”™è¯¯] %\n" (getCurrentException())
        )
    )

    macroScript OpenToolAction 
    category:"AutoExportTool" 
    buttonText:"ğŸ§° AutoExportTool"
    (
        try (
            fn findPluginFile = (
                -- 1. é¦–å…ˆå°è¯•åŸå§‹è·¯å¾„
                if doesFileExist g_pluginPath do return g_pluginPath
                
                -- 2. å°è¯•å¤‡ä»½è·¯å¾„
                if doesFileExist g_backupPluginPath do return g_backupPluginPath
                
                -- 3. åœ¨è„šæœ¬ç›®å½•ä¸­æœç´¢
                local scriptDir = getDir #scripts
                local files = getFiles (scriptDir + "\\AutoExportTool_Pro*.ms")
                if files.count > 0 do return files[1]
                
                -- 4. åœ¨å¤‡ä»½ç›®å½•ä¸­æœç´¢
                local backupDir = scriptDir + "\\AutoExportTool_Backup\\"
                if doesDirectoryExist backupDir do (
                    local backupFiles = getFiles (backupDir + "\\AutoExportTool_Pro*.ms")
                    if backupFiles.count > 0 do return backupFiles[1]
                )
                
                undefined
            )
            
            local pluginPath = findPluginFile()
            if pluginPath == undefined do (
                messageBox "æ‰¾ä¸åˆ°AutoExportToolæ’ä»¶æ–‡ä»¶!" title:"é”™è¯¯"
                return false
            )
            
            -- åŠ è½½æ’ä»¶
            fileIn pluginPath
            
            -- åˆ›å»ºå¯¹è¯æ¡†ï¼ˆå¦‚æœå°šæœªæ˜¾ç¤ºï¼‰
            if not (isDialogVisible AutoExportTool_Pro) do (
                createDialog AutoExportTool_Pro
            )
        ) 
        catch (
            format "[å·¥å…·æ é”™è¯¯] %\n" (getCurrentException())
            messageBox ("æ‰“å¼€æ’ä»¶å¤±è´¥: " + (getCurrentException())) title:"é”™è¯¯"
        )
    )
    
    macroScript BilibiliAction 
        category:"AutoExportTool" 
        buttonText:"ğŸ“º Bilibili | ğŸ”— B/Link"
    (
        openHelpLink "https://space.bilibili.com/327573825"
    )
    
    macroScript QQSpaceAction 
        category:"AutoExportTool" 
        buttonText:"ğŸ§ Qzone | ğŸ”— Q-Link"
    (
        openHelpLink "https://user.qzone.qq.com/240811498"
    )
    
    macroScript RemoveToolbarAction 
        category:"AutoExportTool" 
        buttonText:"ğŸ’£ å¸è½½å·¥å…·æ  â€‹â€‹âš¬â€‹â§ Uninstall"
    (
        try (
            removeToolbarFromMax()
        ) catch (
            format "[å·¥å…·æ ç§»é™¤é”™è¯¯] %\n" (getCurrentException())
        )
    )
    
    macroScript CloseToolAction 
        category:"AutoExportTool"
        buttonText:"âŒ å…³é—­æ’ä»¶ â§ CloseTool "
    (
        try (
            if isDialogVisible AutoExportTool_Pro do (
                destroyDialog AutoExportTool_Pro
            )
        ) catch ()
    )
    
    -- æ›´æ–°å·¥å…·æ çŠ¶æ€
    g_toolbarAdded = true
    setINISetting g_UIConfigPath "Settings" "ToolbarAdded" "true"
    
    try (
        local mainMenu = menuMan.getMainMenuBar()
        local subMenu = menuMan.findMenu "AutoExportTool"
        
        -- ç§»é™¤æ—§èœå•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if subMenu != undefined do (
            menuMan.unRegisterMenu subMenu
            menuMan.updateMenuBar()
        )
        
        -- åˆ›å»ºæ–°èœå•
        subMenu = menuMan.createMenu "AutoExportTool"
        
        -- æ·»åŠ ä¸»åŠŸèƒ½é¡¹
        local openToolItem = menuMan.createActionItem "OpenToolAction" "AutoExportTool"
        openToolItem.setTitle "ğŸ§°â€‹AutoExportTool"
        subMenu.addItem openToolItem -1
        
        -- æ·»åŠ åˆ°ä¸»èœå•æ 
        local mainItem = menuMan.createSubMenuItem "ğŸ§°â€‹AutoExportTool" subMenu
        mainMenu.addItem mainItem (mainMenu.numItems() + 1)
        
        -- æ·»åŠ åˆ†éš”ç¬¦
        local separator = menuMan.createSeparatorItem()
        subMenu.addItem separator -1
        
        -- åˆ›å»ºè‡ªå¯å­èœå•
        local autoStartSubMenu = menuMan.createMenu "è‡ªå¯è®¾ç½®"
        
        -- åˆ›å»ºè‡ªå¯åŠ¨ä½œé¡¹
        local enableAutoStartItem = menuMan.createActionItem "AutoStartEnableAction" "AutoExportTool"
        enableAutoStartItem.setTitle "âœ¨ å¼€å¯ âš®â€‹ Open"
        
        local disableAutoStartItem = menuMan.createActionItem "AutoStartDisableAction" "AutoExportTool"
        disableAutoStartItem.setTitle "âŒ å…³é—­ âš­â€‹ Close"
        
        -- å°†è‡ªå¯åŠ¨ä½œé¡¹æ·»åŠ åˆ°è‡ªå¯å­èœå•
        autoStartSubMenu.addItem enableAutoStartItem -1
        autoStartSubMenu.addItem disableAutoStartItem -1
        
        -- å°†è‡ªå¯å­èœå•æ·»åŠ åˆ°ä¸»èœå•
        local autoStartMenuItem = menuMan.createSubMenuItem "ğŸ—¿ è‡ªå¯è®¾ç½® | AutoStart" autoStartSubMenu
        subMenu.addItem autoStartMenuItem -1
        
        -- æ·»åŠ åˆ†éš”ç¬¦
        local separator1 = menuMan.createSeparatorItem()
        subMenu.addItem separator1 -1
        
        -- åˆ›å»ºç‰ˆæœ¬æ›´æ–°å­èœå•
        local updateSubMenu = menuMan.createMenu "ç‰ˆæœ¬æ›´æ–°"
        
        -- åˆ›å»ºç«‹å³æ£€æŸ¥æ›´æ–°åŠ¨ä½œé¡¹
        local checkNowItem = menuMan.createActionItem "checkForUpdatesAction" "AutoExportTool"
        checkNowItem.setTitle "ğŸ”„ æ£€æŸ¥æ›´æ–° | Check Updates"
        updateSubMenu.addItem checkNowItem -1
        
        -- æ·»åŠ åˆ†éš”ç¬¦
        local updateSeparator = menuMan.createSeparatorItem()
        updateSubMenu.addItem updateSeparator -1
        
        -- åˆ›å»ºå¼€å¯è‡ªåŠ¨æ£€æµ‹åŠ¨ä½œé¡¹
        local enableAutoUpdateItem = menuMan.createActionItem "AutoUpdateEnableAction" "AutoExportTool"
        enableAutoUpdateItem.setTitle "âœ¨ å¼€å¯è‡ªåŠ¨æ£€æµ‹ | Auto-Update On"
        
        -- åˆ›å»ºå…³é—­è‡ªåŠ¨æ£€æµ‹åŠ¨ä½œé¡¹
        local disableAutoUpdateItem = menuMan.createActionItem "AutoUpdateDisableAction" "AutoExportTool"
        disableAutoUpdateItem.setTitle "âŒ å…³é—­è‡ªåŠ¨æ£€æµ‹ | Auto-Update Off"
        
        -- å°†è‡ªåŠ¨æ£€æµ‹åŠ¨ä½œé¡¹æ·»åŠ åˆ°ç‰ˆæœ¬æ›´æ–°å­èœå•
        updateSubMenu.addItem enableAutoUpdateItem -1
        updateSubMenu.addItem disableAutoUpdateItem -1
        
        -- å°†ç‰ˆæœ¬æ›´æ–°å­èœå•æ·»åŠ åˆ°ä¸»èœå•
        local updateMenuItem = menuMan.createSubMenuItem "ğŸ”„ ç‰ˆæœ¬æ›´æ–° | Check Updates" updateSubMenu
        subMenu.addItem updateMenuItem -1
        
        -- æ·»åŠ åˆ†éš”ç¬¦
        local separator2 = menuMan.createSeparatorItem()
        subMenu.addItem separator2 -1
        
        -- åˆ›å»ºå¸®åŠ©å­èœå•
        local helpSubMenu = menuMan.createMenu "â“ å¸®åŠ© | Help"
        
        -- æ·»åŠ è§†é¢‘æ•™ç¨‹é¡¹
        local videoTutorialItem = menuMan.createActionItem "VideoTutorialAction" "AutoExportTool"
        videoTutorialItem.setTitle "ğŸ¬ è§†é¢‘æ•™ç¨‹ | Video Tutorial"
        helpSubMenu.addItem videoTutorialItem -1
        
        -- æ·»åŠ å¸®åŠ©æ–‡æ¡£é¡¹
        local docsItem = menuMan.createActionItem "DocumentationAction" "AutoExportTool"
        docsItem.setTitle "ğŸ“š å¸®åŠ©æ–‡æ¡£ | Documentation"
        helpSubMenu.addItem docsItem -1

        -- æ·»åŠ é—®é¢˜å»ºè®®é¡¹
        local issuesItem = menuMan.createActionItem "IssuesAction" "AutoExportTool"
        issuesItem.setTitle "ğŸ› é—®é¢˜å»ºè®® | Report Issues"
        helpSubMenu.addItem issuesItem -1
        
        -- æ·»åŠ åˆ†éš”çº¿
        local separatorNew = menuMan.createSeparatorItem()
        helpSubMenu.addItem separatorNew -1
        
        -- æ·»åŠ Bç«™é“¾æ¥é¡¹
        local bilibiliItem = menuMan.createActionItem "BilibiliAction" "AutoExportTool"
        bilibiliItem.setTitle "ğŸ“º Bilibili | ğŸ”— B/Link "
        helpSubMenu.addItem bilibiliItem -1
        
        -- æ·»åŠ QQç©ºé—´é“¾æ¥é¡¹
        local qqSpaceItem = menuMan.createActionItem "QQSpaceAction" "AutoExportTool"
        qqSpaceItem.setTitle "ğŸ§ Qzone | ğŸ”— Q-Link"
        helpSubMenu.addItem qqSpaceItem -1
        
        -- æ·»åŠ åˆ†éš”ç¬¦
        local separator3 = menuMan.createSeparatorItem()
        helpSubMenu.addItem separator3 -1
        
        -- æ·»åŠ å·¥å…·æ ç®¡ç†é¡¹
        local removeToolbarItem = menuMan.createActionItem "RemoveToolbarAction" "AutoExportTool"
        removeToolbarItem.setTitle "ğŸ’£ å¸è½½å·¥å…·æ  â€‹â€‹âš¬â€‹â§ Uninstall"
        helpSubMenu.addItem removeToolbarItem -1
        
        -- æ·»åŠ åˆ†éš”ç¬¦
        local separator4 = menuMan.createSeparatorItem()
        helpSubMenu.addItem separator4 -1
        
        -- æ·»åŠ é‡ç½®çª—å£ä½ç½®é¡¹
        local resetWindowPosItem = menuMan.createActionItem "ResetWindowPosAction" "AutoExportTool"
        resetWindowPosItem.setTitle "ğŸ”„ é‡ç½®çª—å£ä½ç½® | Reset Window Position"
        helpSubMenu.addItem resetWindowPosItem -1
    
        -- æ·»åŠ åˆ†éš”çº¿
        local separatorReset = menuMan.createSeparatorItem()
        helpSubMenu.addItem separatorReset -1
        
        -- æ·»åŠ å…³é—­æ’ä»¶/å·¥å…·é¡¹
        local closeToolItem = menuMan.createActionItem "CloseToolAction" "AutoExportTool"
        closeToolItem.setTitle "âŒ å…³é—­æ’ä»¶ â§ CloseTool"
        helpSubMenu.addItem closeToolItem -1
        
        -- å°†å¸®åŠ©å­èœå•æ·»åŠ åˆ°ä¸»èœå•
        local helpMenuItem = menuMan.createSubMenuItem "â“ å¸®åŠ© | Help" helpSubMenu
        subMenu.addItem helpMenuItem -1
        
        -- æ›´æ–°èœå•æ 
        menuMan.updateMenuBar()
        
        g_toolbarAdded = true
        setINISetting g_UIConfigPath "Settings" "ToolbarAdded" "true"
        
        g_lastAction = "å·¥å…·æ å·²æ·»åŠ åˆ°3ds Maxèœå•"
        updateModeStatus()
        messageBox "âœ¨ å·¥å…·æ å·²æˆåŠŸæ·»åŠ åˆ°3ds Maxèœå•æ " title:"æˆåŠŸ"
        
    ) catch (
        format "[å·¥å…·æ æ·»åŠ é”™è¯¯] %\n" (getCurrentException())
        messageBox ("æ·»åŠ å·¥å…·æ å¤±è´¥: " + (getCurrentException())) title:"é”™è¯¯"
    )
)


--æ’ä»¶å¤‡ä»½ / æ¢å¤ åŠŸèƒ½ - æ¢å¤æ€§æ£€æŸ¥
fn checkAndRecoverPlugin = (
    -- å¦‚æœä¸»æ’ä»¶ä¸¢å¤±ä½†å¤‡ä»½å­˜åœ¨
    if not doesFileExist g_pluginPath and doesFileExist g_backupPluginPath do (
        try (
            -- ä»å¤‡ä»½æ¢å¤
            makeDir (getFilenamePath g_backupPluginPath) all:true
            copyFile g_backupPluginPath g_pluginPath
            format "[æ¢å¤] æ’ä»¶å·²ä»å¤‡ä»½æ¢å¤: %\n" g_pluginPath
        ) catch (
            format "[æ¢å¤é”™è¯¯] %\n" (getCurrentException())
        )
    )
    
    -- å¦‚æœå¤‡ä»½è¿‡æ—¶ï¼ˆä¸»æ’ä»¶æ›´æ–°æ—¥æœŸæ›´æ™šï¼‰
    if doesFileExist g_pluginPath and doesFileExist g_backupPluginPath and \
       (getFileModDate g_pluginPath) > (getFileModDate g_backupPluginPath) do (
        try (
            -- æ›´æ–°å¤‡ä»½
            makeDir (getFilenamePath g_backupPluginPath) all:true
            copyFile g_pluginPath g_backupPluginPath
            format "[å¤‡ä»½æ›´æ–°] æ’ä»¶å¤‡ä»½å·²æ›´æ–°\n"
        ) catch (
            format "[å¤‡ä»½æ›´æ–°é”™è¯¯] %\n" (getCurrentException())
        )
    )
)

-- é¦–æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨æ·»åŠ å·¥å…·æ /åœ¨INIæ–‡ä»¶ä¸­è®°å½•å·²æ·»åŠ çŠ¶æ€/é¿å…é‡å¤æ·»åŠ ï¼‰/ æ³¨æ„ å¼•ç”¨ addToolbarToMax() è¡Œåˆ—å…ˆåä½ç½®ï¼ï¼ï¼
fn autoAddToolbarOnFirstRun = (
    -- æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡å·¥å…·æ 
    local alreadyAdded = getINISetting g_UIConfigPath "Settings" "ToolbarAdded"
    if alreadyAdded != "true" then (
        addToolbarToMax()
        setINISetting g_UIConfigPath "Settings" "ToolbarAdded" "true"
    )
)

-- å³é”®èœå•äº‹ä»¶å¤„ç† / true
fn setupContextMenu = (
    -- å³é”®èœå•æ˜¾ç¤ºäº‹ä»¶
    dotNet.addEventHandler g_contextMenu "Opening" (fn sender args = (
        try (
            -- æ¸…é™¤ç°æœ‰èœå•é¡¹
            g_contextMenu.Items.Clear()
            
            -- è·å–é€‰ä¸­çš„é¡¹ç›®
            local selItems = AutoExportTool_Pro.Lv_model.SelectedItems
            
            -- æ£€æŸ¥æ˜¯å¦ç‚¹å‡»åœ¨ç©ºä½™å¤„ (æ²¡æœ‰é€‰ä¸­ä»»ä½•é¡¹ç›®)
            local isClickOnEmpty = (selItems.Count == 0)
            
            -- å¦‚æœæ˜¯ç‚¹å‡»åœ¨ç©ºä½™å¤„ï¼Œæ˜¾ç¤ºç²˜è´´èœå•
            if isClickOnEmpty then (
                -- ç²˜è´´èœå•ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
                local pasteItem = g_contextMenu.Items.Add("ğŸ“‹ ç²˜è´´")
                dotNet.addEventHandler pasteItem "Click" (fn s e = pasteItems())
                
                return true
            )
            
            
            -- æ£€æŸ¥æ˜¯å¦å¤šé€‰ï¼ˆ2ä¸ªæˆ–æ›´å¤šé¡¹ç›®ï¼‰
            local isMultiSelect = (selItems.Count > 1)
            
            -- å¦‚æœæ˜¯å¤šé€‰ï¼Œæ˜¾ç¤ºæ‰¹é‡æ“ä½œèœå•
            if isMultiSelect then (
                -- æ·»åŠ å‰ªåˆ‡èœå•
                local cutItem = g_contextMenu.Items.Add("âœ„ å‰ªåˆ‡")
                dotNet.addEventHandler cutItem "Click" (fn s e = cutSelectedItems())
                
                -- æ·»åŠ å¤åˆ¶èœå•
                local copyItem = g_contextMenu.Items.Add("â§‰ å¤åˆ¶")
                dotNet.addEventHandler copyItem "Click" (fn s e = copySelectedItems())
                
                -- æ·»åŠ åˆ†éš”çº¿
                g_contextMenu.Items.Add((dotNetObject "System.Windows.Forms.ToolStripSeparator"))
                
                -- æ·»åŠ åˆ é™¤èœå•
                local deleteItem = g_contextMenu.Items.Add("âŒ åˆ é™¤")
                dotNet.addEventHandler deleteItem "Click" (fn s e = deleteSelectedFiles())
                
                return true
            )
            
            -- å•é€‰æƒ…å†µä¸‹çš„å¤„ç†
            local firstItem = selItems.Item[0]
            local path = firstItem.Tag as String
            local isFolder = doesDirectoryExist path
            
            -- æ ¹æ®ç±»å‹æ·»åŠ ä¸åŒçš„èœå•é¡¹
            if isFolder then (
                -- æ–‡ä»¶å¤¹çš„èœå•é¡¹
                local openFolderItem = g_contextMenu.Items.Add("ğŸ“‚â†’æ‰“å¼€æ–‡ä»¶å¤¹")
                dotNet.addEventHandler openFolderItem "Click" (fn s e = (
                    for i=0 to AutoExportTool_Pro.Lv_model.SelectedItems.Count-1 do (
                        local itemPath = AutoExportTool_Pro.Lv_model.SelectedItems.Item[i].Tag as String
                        if doesDirectoryExist itemPath then (
                            shellLaunch "explorer.exe" ("\"" + itemPath + "\"")
                            g_lastAction = "â€‹â€‹å³é”®-æ‰“å¼€æ–‡ä»¶å¤¹"
                            updateModeStatus()
                        )
                    )
                ))
                
                -- æ·»åŠ åˆ†éš”çº¿
                g_contextMenu.Items.Add((dotNetObject "System.Windows.Forms.ToolStripSeparator"))
                
                -- æ–°å¢ï¼šç²˜è´´åŠŸèƒ½
                local pasteItem = g_contextMenu.Items.Add("â€‹â—â€‹ ç²˜è´´")
                dotNet.addEventHandler pasteItem "Click" (fn s e = pasteItems())
                
                -- æ·»åŠ åˆ†éš”çº¿
                g_contextMenu.Items.Add((dotNetObject "System.Windows.Forms.ToolStripSeparator"))
        
                -- æ–°å¢ï¼šå‰ªåˆ‡åŠŸèƒ½
                local cutItem = g_contextMenu.Items.Add("âœ„â€‹ å‰ªåˆ‡")
                dotNet.addEventHandler cutItem "Click" (fn s e = cutSelectedItems())
                
                -- æ–°å¢ï¼šå¤åˆ¶åŠŸèƒ½
                local copyItem = g_contextMenu.Items.Add("â§‰ å¤åˆ¶")
                dotNet.addEventHandler copyItem "Click" (fn s e = copySelectedItems())
                
                -- æ·»åŠ åˆ†éš”çº¿
                g_contextMenu.Items.Add((dotNetObject "System.Windows.Forms.ToolStripSeparator"))
                
                -- æ·»åŠ é€šç”¨åˆ é™¤èœå•é¡¹
                local deleteItem = g_contextMenu.Items.Add("âŒ åˆ é™¤")
                dotNet.addEventHandler deleteItem "Click" (fn s e = deleteSelectedFiles())
            
                -- æ·»åŠ åˆ†éš”çº¿
                g_contextMenu.Items.Add((dotNetObject "System.Windows.Forms.ToolStripSeparator"))
              
                -- æ·»åŠ é‡å‘½åèœå•
                local renameItem = g_contextMenu.Items.Add("âœï¸ é‡å‘½å")
                dotNet.addEventHandler renameItem "Click" (fn s e = renameSelectedItem())
                
                -- æ·»åŠ åˆ†éš”çº¿
                g_contextMenu.Items.Add((dotNetObject "System.Windows.Forms.ToolStripSeparator"))
                
                local propertiesItem = g_contextMenu.Items.Add("ğŸ“Œ å±æ€§")
                dotNet.addEventHandler propertiesItem "Click" (fn s e = (
                    for i=0 to AutoExportTool_Pro.Lv_model.SelectedItems.Count-1 do (
                        local itemPath = AutoExportTool_Pro.Lv_model.SelectedItems.Item[i].Tag as String
                        showItemProperties itemPath
                        g_lastAction = "â€‹â€‹å³é”®-å±æ€§"
                        updateModeStatus()
                    )
                ))
            )
            else (
                -- æ–‡ä»¶çš„èœå•é¡¹
                local fileType = toLower (getFilenameType path)
                -- æ·»åŠ é€šç”¨æ‰“å¼€é€‰é¡¹ - ä½†BIP å’Œ xaf æ–‡ä»¶é™¤å¤– / æ’é™¤ç‰¹å®šç±»å‹
                if fileType != ".bip" and fileType != ".xaf" do (
                    local openItem = g_contextMenu.Items.Add("ğŸ“‹â†’é»˜è®¤æ–¹å¼æ‰“å¼€")
                    dotNet.addEventHandler openItem "Click" (fn s e = (
                        for i=0 to AutoExportTool_Pro.Lv_model.SelectedItems.Count-1 do (
                            local itemPath = AutoExportTool_Pro.Lv_model.SelectedItems.Item[i].Tag as String
                            if doesFileExist itemPath then (
                                shellLaunch itemPath ""
                                g_lastAction = "â€‹â€‹å³é”®-æ‰“å¼€æ–‡ä»¶"
                                updateModeStatus()
                            )
                        )
                    ))
                )
                
                -- æ·»åŠ åˆ†éš”çº¿ï¼ˆä½¿ç”¨é€šç”¨æ’é™¤é€»è¾‘ï¼‰ // ä¿®æ”¹åœ¨è¿™é‡Œ
                local excludedTypes = #(".max", ".fbx", ".ms",".mse",".mcr",".mzp")
                if (findItem excludedTypes fileType) != 0 do (
                    g_contextMenu.Items.Add((dotNetObject "System.Windows.Forms.ToolStripSeparator"))
                )
                
                
                -- ç±»å‹ç‰¹å®šèœå•é¡¹
                case fileType of (
                    
                    ".max": (
                        g_lastAction = "â€‹â€‹å³é”®-å½“å‰æ‰“å¼€"
                        updateModeStatus()
                        -- åªæ˜¾ç¤ºç‰¹å®šäºbipçš„èœå•é¡¹
                        
                        local maxItem = g_contextMenu.Items.Add("ğŸ”œâ†’å½“å‰åœºæ™¯æ‰“å¼€")
                        dotNet.addEventHandler maxItem "Click" (fn s e = (
                            for i=0 to AutoExportTool_Pro.Lv_model.SelectedItems.Count-1 do (
                                local path = AutoExportTool_Pro.Lv_model.SelectedItems.Item[i].Tag as String
                                resetMaxFile #noPrompt
                                loadMaxFile Path useFileUnits:true quiet:true
                        -- æ‰“å¼€max åŒæ—¶åˆ·æ–° é€‰æ‹©é›† / true 
                                GetSetFormScene() 
                                messageBox ("MAXæ‰“å¼€æˆåŠŸ: " + path) title:"æ“ä½œæˆåŠŸ"
                            )
                        ))
                    )
                    
                    ".bip": (
                        g_lastAction = "â€‹â€‹å³é”®-å¯¼å…¥BIP"
                        updateModeStatus()
                        -- åªæ˜¾ç¤ºç‰¹å®šäºbipçš„èœå•é¡¹
                        local bipItem = g_contextMenu.Items.Add("ğŸ”¤â†’å¯¼å…¥BIP")
                        dotNet.addEventHandler bipItem "Click" (fn s e = (
                            for i=0 to AutoExportTool_Pro.Lv_model.SelectedItems.Count-1 do (
                                local path = AutoExportTool_Pro.Lv_model.SelectedItems.Item[i].Tag as String
                                SilentBipedImport path
                                messageBox ("BIPå¯¼å…¥æˆåŠŸ: " + path) title:"æ“ä½œæˆåŠŸ"
                            )
                        ))
                    )
                    
                    ".ms": (
                        g_lastAction = "â€‹â€‹å³é”®-è¿è¡Œè„šæœ¬"
                        updateModeStatus()
                        -- åªæ˜¾ç¤ºç‰¹å®šäºmsçš„èœå•é¡¹
                        local runItem = g_contextMenu.Items.Add("ğŸ”¤â†’è¿è¡Œè„šæœ¬")
                        dotNet.addEventHandler runItem "Click" (fn s e = (
                            for i=0 to AutoExportTool_Pro.Lv_model.SelectedItems.Count-1 do (
                                local path = AutoExportTool_Pro.Lv_model.SelectedItems.Item[i].Tag as String
                                fileIn path
                            )
                        ))
                    )
                    
                    ".mse": (
                        g_lastAction = "â€‹â€‹å³é”®-è¿è¡ŒåŠ å¯†è„šæœ¬"
                        updateModeStatus()
                        -- åªæ˜¾ç¤ºç‰¹å®šäºmseçš„èœå•é¡¹
                        local runItem = g_contextMenu.Items.Add("ğŸ”¤â†’è¿è¡ŒåŠ å¯†è„šæœ¬")
                        dotNet.addEventHandler runItem "Click" (fn s e = (
                            for i=0 to AutoExportTool_Pro.Lv_model.SelectedItems.Count-1 do (
                                local path = AutoExportTool_Pro.Lv_model.SelectedItems.Item[i].Tag as String
                                fileIn path
                            )
                        ))
                    )
                    
                    ".mzp": (
                        g_lastAction = "â€‹â€‹å³é”®-è¿è¡Œå®è„šæœ¬"
                        updateModeStatus()
                        -- åªæ˜¾ç¤ºç‰¹å®šäºmzpçš„èœå•é¡¹
                        local runItem = g_contextMenu.Items.Add("ğŸ”¤â†’è¿è¡Œå®è„šæœ¬")
                        dotNet.addEventHandler runItem "Click" (fn s e = (
                            for i=0 to AutoExportTool_Pro.Lv_model.SelectedItems.Count-1 do (
                                local path = AutoExportTool_Pro.Lv_model.SelectedItems.Item[i].Tag as String
                                fileIn path
                            )
                        ))
                    )
                    
                    ".mcr": (
                        g_lastAction = "â€‹â€‹å³é”®-è¿è¡Œå®è„šæœ¬"
                        updateModeStatus()
                        -- åªæ˜¾ç¤ºç‰¹å®šäºmcrçš„èœå•é¡¹
                        local runItem = g_contextMenu.Items.Add("ğŸ”¤â†’è¿è¡Œå®è„šæœ¬")
                        dotNet.addEventHandler runItem "Click" (fn s e = (
                            for i=0 to AutoExportTool_Pro.Lv_model.SelectedItems.Count-1 do (
                                local path = AutoExportTool_Pro.Lv_model.SelectedItems.Item[i].Tag as String
                                fileIn path
                            )
                        ))
                    )
                    
                    ".xaf": (
                        g_lastAction = "â€‹â€‹å³é”®-å¯¼å…¥XAF"
                        updateModeStatus()
                        -- åªæ˜¾ç¤ºç‰¹å®šäºxafçš„èœå•é¡¹
                        local xafItem = g_contextMenu.Items.Add("ğŸ”¤â†’å¯¼å…¥XAF")
                        dotNet.addEventHandler xafItem "Click" (fn s e = (
                            for i=0 to AutoExportTool_Pro.Lv_model.SelectedItems.Count-1 do (
                                local path = AutoExportTool_Pro.Lv_model.SelectedItems.Item[i].Tag as String
                                importXafAnimation path
                                messageBox ("xafå¯¼å…¥æˆåŠŸ: " + path) title:"æ“ä½œæˆåŠŸ"
                            )
                        ))
                    )
                    
                    ".fbx": (
                        g_lastAction = "â€‹â€‹å³é”®-ç”¨FBXæŸ¥çœ‹å™¨æ‰“å¼€"
                        updateModeStatus()
                        -- åªæ˜¾ç¤ºç‰¹å®šäºfbxçš„èœå•é¡¹
                        local fbxItem = g_contextMenu.Items.Add("ç”¨FBXæŸ¥çœ‹å™¨æ‰“å¼€")
                        dotNet.addEventHandler fbxItem "Click" (fn s e = (
                            local viewerPath = getDir #scripts + "\\FBXViewer.exe"
                            if doesFileExist viewerPath then (
                                for i=0 to AutoExportTool_Pro.Lv_model.SelectedItems.Count-1 do (
                                    local path = AutoExportTool_Pro.Lv_model.SelectedItems.Item[i].Tag as String
                                    ShellLaunch viewerPath ("\"" + path + "\"")
                                )
                            ) else (
                                messageBox "FBXæŸ¥çœ‹å™¨æœªæ‰¾åˆ°ï¼Œè¯·å°†FBXViewer.exeæ”¾å…¥è„šæœ¬ç›®å½•ï¼" title:"é”™è¯¯"
                            )
                        ))
                        
                        -- æ·»åŠ åˆ†éš”çº¿
                        g_contextMenu.Items.Add((dotNetObject "System.Windows.Forms.ToolStripSeparator"))
                        
                        -- æ·»åŠ "å¯¼å…¥åœºæ™¯"èœå•é¡¹
                        local importSceneItem = g_contextMenu.Items.Add("ğŸ”¤â†’å¯¼å…¥åœºæ™¯")
                        dotNet.addEventHandler importSceneItem "Click" (fn s e = (
                            local selectedItems = AutoExportTool_Pro.Lv_model.SelectedItems
                            if selectedItems.Count == 0 do return false
                            
                            -- åªå¯¼å…¥ç¬¬ä¸€ä¸ªé€‰ä¸­çš„FBXæ–‡ä»¶
                            local fbxPath = selectedItems.Item[0].Tag as String
                            
                            -- ç¡®è®¤æ“ä½œ
                            local msg = "ç¡®å®šè¦æ¸…ç©ºå½“å‰åœºæ™¯å¹¶å¯¼å…¥FBXæ–‡ä»¶å—ï¼Ÿ\n" + fbxPath
                            if not (queryBox msg title:"å¯¼å…¥FBXåœºæ™¯" beep:false) do return false
                            
                            try (
                                -- æ¸…ç©ºåœºæ™¯
                                resetMaxFile #noPrompt  
                                
                                -- è®¾ç½®FBXå¯¼å…¥å‚æ•°ä¸ºé»˜è®¤å€¼
                                FBXImporterSetParam "Mode" #create        -- åˆ›å»ºæ–°åœºæ™¯
                                FBXImporterSetParam "Animations" true     -- å¯¼å…¥åŠ¨ç”»
                                FBXImporterSetParam "Cameras" true        -- å¯¼å…¥æ‘„åƒæœº
                                FBXImporterSetParam "Lights" true         -- å¯¼å…¥ç¯å…‰
                                FBXImporterSetParam "AxisConversion" true -- åº”ç”¨è½´è½¬æ¢
                                FBXImporterSetParam "Rescale" true        -- è‡ªåŠ¨ç¼©æ”¾
                                
                                -- å¯¼å…¥FBXæ–‡ä»¶
                                importFile fbxPath #noPrompt using:FBXIMP
                                
                                g_lastAction = "FBXå¯¼å…¥åœºæ™¯"
                                updateModeStatus()
                                messageBox "FBXæ–‡ä»¶å·²æˆåŠŸå¯¼å…¥åœºæ™¯" title:"æ“ä½œæˆåŠŸ"
                                
                            ) catch (
                                format "[FBXå¯¼å…¥é”™è¯¯] %\n" (getCurrentException())
                                messageBox ("FBXå¯¼å…¥å¤±è´¥: " + (getCurrentException())) title:"é”™è¯¯"
                            )
                        ))
                    )
                )  -- ç»“æŸcaseè¯­å¥
                
                   -- æ·»åŠ åˆ†éš”çº¿
                g_contextMenu.Items.Add((dotNetObject "System.Windows.Forms.ToolStripSeparator"))
                
                -- æ–°å¢ï¼šç²˜è´´åŠŸèƒ½
                local pasteItem = g_contextMenu.Items.Add("â€‹â—â€‹ ç²˜è´´")
                dotNet.addEventHandler pasteItem "Click" (fn s e = pasteItems())
                
                -- æ·»åŠ åˆ†éš”çº¿
                g_contextMenu.Items.Add((dotNetObject "System.Windows.Forms.ToolStripSeparator"))
        
                -- æ–°å¢ï¼šå‰ªåˆ‡åŠŸèƒ½
                local cutItem = g_contextMenu.Items.Add("âœ„ â€‹å‰ªåˆ‡")
                dotNet.addEventHandler cutItem "Click" (fn s e = cutSelectedItems())
                
                -- æ–°å¢ï¼šå¤åˆ¶åŠŸèƒ½
                local copyItem = g_contextMenu.Items.Add("â§‰ å¤åˆ¶")
                dotNet.addEventHandler copyItem "Click" (fn s e = copySelectedItems())
                
                -- æ·»åŠ åˆ†éš”çº¿
                g_contextMenu.Items.Add((dotNetObject "System.Windows.Forms.ToolStripSeparator"))
                
                -- æ·»åŠ é€šç”¨åˆ é™¤èœå•é¡¹
                local deleteItem = g_contextMenu.Items.Add("âŒ åˆ é™¤")
                dotNet.addEventHandler deleteItem "Click" (fn s e = deleteSelectedFiles())
            
                -- æ·»åŠ åˆ†éš”çº¿
                g_contextMenu.Items.Add((dotNetObject "System.Windows.Forms.ToolStripSeparator"))
                
                -- æ·»åŠ é‡å‘½åèœå•
                local renameItem = g_contextMenu.Items.Add("âœï¸ é‡å‘½å")
                dotNet.addEventHandler renameItem "Click" (fn s e = renameSelectedItem())
                
                -- æ·»åŠ åˆ†éš”çº¿
                g_contextMenu.Items.Add((dotNetObject "System.Windows.Forms.ToolStripSeparator"))
                
                -- æ·»åŠ é€šç”¨å±æ€§èœå•é¡¹
                local propertiesItem = g_contextMenu.Items.Add("ğŸ“Œ å±æ€§")
                dotNet.addEventHandler propertiesItem "Click" (fn s e = (
                    for i=0 to AutoExportTool_Pro.Lv_model.SelectedItems.Count-1 do (
                        local itemPath = AutoExportTool_Pro.Lv_model.SelectedItems.Item[i].Tag as String
                        showItemProperties itemPath
                        g_lastAction = "â€‹â€‹å³é”®-å±æ€§"
                        updateModeStatus()
                    )
                ))
            )  -- ç»“æŸelseå—ï¼ˆæ–‡ä»¶å¤„ç†ï¼‰
            
            true -- æ˜¾ç¤ºèœå•
        ) catch (
            format "[èœå•é”™è¯¯] %\n" (getCurrentException())
            false -- ä¸æ˜¾ç¤ºèœå•
        )
    ))  -- ç»“æŸOpeningäº‹ä»¶å¤„ç†å‡½æ•°
    --g_contextMenu.Show (mouse.screenPos[1]) (mouse.screenPos[2])
    -- ç»‘å®šå³é”®èœå•åˆ°åˆ—è¡¨
    AutoExportTool_Pro.Lv_model.ContextMenuStrip = g_contextMenu
)  -- ç»“æŸsetupContextMenuå‡½æ•°

-- åœ¨åˆ—è¡¨ç©ºä½™å¤„å³é”®å‘¼å‡ºèœå•
fn createEmptyAreaContextMenu = (
    -- åˆ›å»ºä¸´æ—¶èœå•
    local tempMenu = dotNetObject "System.Windows.Forms.ContextMenuStrip"
    
    -- ç²˜è´´èœå•
    local pasteItem = tempMenu.Items.Add("ç²˜è´´")
    dotNet.addEventHandler pasteItem "Click" (fn s e = pasteItems())
    
    -- æ˜¾ç¤ºèœå•
    tempMenu.Show (mouse.screenPos[1]) (mouse.screenPos[2])
)

-- åˆ—è¡¨ç©ºä½™å¤„å³é”®å¤„ç†ï¼ˆä½¿ç”¨å‘½åå‡½æ•°ï¼‰
fn onListViewRightClick s e = (
    try (
        if e.Button == e.Button.Right then (
            local hitTest = Lv_model.HitTest e.X e.Y
            
            -- å¦‚æœç‚¹å‡»åœ¨ç©ºä½™å¤„ï¼ˆæ²¡æœ‰é¡¹ç›®ï¼‰
            if hitTest.Item == undefined then (
                -- åˆ›å»ºä¸´æ—¶èœå•
                local tempMenu = dotNetObject "System.Windows.Forms.ContextMenuStrip"
                
                -- ç²˜è´´èœå•
                local pasteItem = tempMenu.Items.Add("ç²˜è´´")
                dotNet.addEventHandler pasteItem "Click" (fn s e = pasteItems())
                
                -- æ˜¾ç¤ºèœå•
                tempMenu.Show (mouse.screenPos[1]) (mouse.screenPos[2])
            )
        )
    )
    catch (
        format "[å³é”®èœå•é”™è¯¯] %\n" (getCurrentException())
    )
-- ç»‘å®šå³é”®äº‹ä»¶
dotNet.addEventHandler Lv_model "MouseClick" onListViewRightClick
)

-- å¢å¼ºæ»šåŠ¨çŠ¶æ€æ£€æµ‹å‡½æ•°
fn updateScrollState = 
(
    try 
    (
        -- åŠ¨æ€è®¡ç®—åˆ—å®½ï¼ˆå…³é”®ä¿®æ”¹ï¼‰
        --local totalWidth = Lv_model.ClientRectangle.Width
        Lv_model.Columns.Item[1].Width = totalWidth - COLUMN_CK_WIDTH - COLUMN_TYPE_WIDTH - 5 -- 25ä¸ºæ»šåŠ¨æ¡é¢„ç•™å®½åº¦
        
        -- å‚ç›´æ»šåŠ¨æ¡è‡ªåŠ¨æ˜¾ç¤º
        local itemHeight = Lv_model.GetItemRect(0).Height
        local visibleItems = (Lv_model.ClientRectangle.Height / itemHeight) as integer
        Lv_model.Scrollable = (Lv_model.Items.Count > visibleItems)
        --Lv_model.Refresh()
		
	)
    catch 
    (
        try(Lv_model.Scrollable = true)catch()
    )
    chkChangeFont.checked = true  -- è¦†ç›–INIé…ç½®ï¼Œå¼ºåˆ¶å‹¾é€‰
    g_forceCustomLayout = true    -- åŒæ­¥å…¨å±€çŠ¶æ€
    adjustColumnWidths forceCustom:true -- ç«‹å³åº”ç”¨åˆ—å®½e
    Lv_model.Font = g_alternateFont     -- å¼ºåˆ¶åº”ç”¨å­—ä½“

	)

-- ä¿®æ”¹åçš„ additem_lv å‡½æ•°
fn additem_lv lv_body file_node isDrag:false = (
    if doesFileExist file_node or doesDirectoryExist file_node do (
        try (
            lv_body.BeginUpdate()
            local isDir = (getFilenameType file_node) == "" -- ä¿®å¤ç±»å‹åˆ¤æ–­
            local li = dotNetObject "System.Windows.Forms.ListViewItem" (if isDir then "ğŸ“‚" else "ğŸ“„")
            
            -- æ˜¾ç¤ºåŸå§‹æ–‡ä»¶åï¼ˆä¿ç•™ç‚¹å·ï¼‰
            li.subitems.add (filenameFromPath file_node)
            
            -- å¼ºåˆ¶è®¾ç½®ç±»å‹ï¼ˆå…³é”®ä¿®å¤ï¼‰
            li.subitems.add (if isDir then "æ–‡ä»¶å¤¹" else getFileType file_node)
            
            li.Tag = file_node
            lv_body.Items.Add(li)
            append model_files_array file_node
            lv_body.EndUpdate()
            
            -- ç«‹å³æ›´æ–°è®¡æ•°å’ŒçŠ¶æ€
            lblCount.text = "æ–‡ä»¶ï¼š" + (model_files_array.count - (getDirectories (edtExportPath.text + "\\*")).count) as string
            updateModeStatus()
        ) catch (
            format "æ·»åŠ æ–‡ä»¶åˆ°åˆ—è¡¨å¤±è´¥ï¼š%\n" (getCurrentException())
        )
    )
)


----------------------------------------------------------------
    
    -- ===================== æ–°å¢åŠŸèƒ½æ¨¡å— ===========================

    ----------------------------------------------------------------
    
-- ç¡®ä¿è¿›åº¦æ›´æ–°å‡½æ•°æ­£ç¡®è°ƒç”¨
fn updateProgress index total success fail = (
    try (
        local progressPercent = (100.0 * index / total) as integer
        pbProgress.value = progressPercent
        lblProgressInfo.text = "è¿›åº¦ï¼š" + progressPercent as string + "% | æˆåŠŸï¼š" + success as string + " | å¤±è´¥ï¼š" + fail as string
        pbProgress.refresh()
        --windows.processPostedMessages() -- å¼ºåˆ¶ç•Œé¢æ›´æ–°
        if mod index 5 == 0 do (  -- æ¯5ä¸ªæ–‡ä»¶æ›´æ–°ä¸€æ¬¡ç•Œé¢
        --lblProgressInfo.text = "è¿›åº¦ï¼š" + ((100.0*index/total) as integer) as string + "%"
        pbProgress.value = index
        windows.processPostedMessages()  -- æ§åˆ¶åˆ·æ–°é¢‘ç‡
        )
    ) catch (
        format "[è¿›åº¦æ›´æ–°é”™è¯¯] %\n" (getCurrentException())
    )
)
    
    
-- åœ¨å‡½æ•°å®šä¹‰åŒºåŸŸæ·»åŠ ç¼ºå¤±çš„ updateExportPath å‡½æ•° ================
    -- ä¿®æ”¹è·¯å¾„æ›´æ–°å‡½æ•°ï¼Œå“åº”è‡ªåŠ¨ç”Ÿæˆå¤é€‰æ¡†å˜åŒ–
fn updateExportPath forceAuto:false = (
    if chkAutoFolder.checked or forceAuto then (
        basePath = if maxFilePath != "" then maxFilePath else getDir #scene
        edtExportPath.text = pathConfig.appendPath basePath "FBX"
    ) else (
        if edtExportPath.text == "" do edtExportPath.text = getDir #scene
    )
    if not doesFileExist edtExportPath.text do makeDir edtExportPath.text all:true
)
    
   -- æŒ‚ç‚¹å½’é›¶å‡½æ•° - åœ¨å¯¼å‡ºå‰å¤„ç†æ‰€æœ‰åŒ…å«"Socket"çš„å¯¹è±¡
fn resetSocketTransforms = (
    local socketNodes = for obj in objects where (
        (classOf obj == Dummy or classOf obj == Point) and 
        matchPattern obj.name pattern:"*Socket*"
    ) collect obj
    
    local originalStates = #()
    
    for node in socketNodes do (
        -- ä¿å­˜åŸå§‹çŠ¶æ€
        local state = #(
            node.parent,
            node.transform,
            node.rotation.controller
        )
        append originalStates #(node, state)
        
        -- æ–­å¼€ä¸çˆ¶å¯¹è±¡çš„é“¾æ¥
        node.parent = undefined
        
        -- é‡ç½®ä½ç½®å’Œæ—‹è½¬
        node.pos = [0,0,0]
        
        -- ç¡®ä¿ä½¿ç”¨Euler XYZæ—‹è½¬æ§åˆ¶å™¨
        if classOf node.rotation.controller != Euler_XYZ do (
            node.rotation.controller = Euler_XYZ()
        )
        
        -- è®¾ç½®æ—‹è½¬ (X:90, Y:0, Z:0)
        node.rotation.controller.x_rotation = 90
        node.rotation.controller.y_rotation = 0
        node.rotation.controller.z_rotation = 0
        
        format "[æŒ‚ç‚¹å½’é›¶] å·²å¤„ç†: %\n" node.name
    )
    
    return originalStates
)

   -- æ¢å¤æŒ‚ç‚¹åŸå§‹çŠ¶æ€ / å¯¼å‡º ä½†  ä¸å½±å“  MAX æ–‡ä»¶ ï¼ˆå¤šä½™çš„æ“ä½œï¼ŒæŒ‚ç‚¹å½’é›¶å‹¾é€‰åçš„å¯¼å‡ºè¿›ç¨‹å…¶å®å¹¶æœªä½œä¿å­˜maxæ–‡ä»¶çš„åŠ¨ä½œï¼Œåº”è¯¥å±äºæ²‰æ·€ä»£ç ..å®é™…ä¸Šæœ‰äº›å¤šä½™ï¼‰
fn restoreSocketTransforms originalStates = (
    for stateData in originalStates do (
        local node = stateData[1]
        local state = stateData[2]
        
        if isValidObj node do (
            -- æ¢å¤çˆ¶å¯¹è±¡é“¾æ¥
            node.parent = state[1]
            
            -- æ¢å¤åŸå§‹å˜æ¢
            node.transform = state[2]
            
            -- æ¢å¤åŸå§‹æ—‹è½¬æ§åˆ¶å™¨
            node.rotation.controller = state[3]
        )
    )
) 

-- å¯¼å‡ºåç§°çš„ç²¾å‡†è°ƒè¯• /  å¯¼å‡ºå‡½æ•° åŠŸèƒ½ true
fn sanitizeFileName name = (
    -- æ›¿æ¢ç©ºæ ¼ä¸ºå•ä¸‹åˆ’çº¿
    local cleanName = substituteString name " " "_"
    -- æ›¿æ¢ç‰¹æ®Šå­—ç¬¦ä¸ºå•ä¸‹åˆ’çº¿
    --cleanName = substituteString cleanName "@" "_"
    cleanName = substituteString cleanName "-" "_"
    cleanName = substituteString cleanName ":" "_"
    
    -- å¤„ç†è¿ç»­ä¸‹åˆ’çº¿é—®é¢˜
    while (findString cleanName "__") != undefined do (
        cleanName = substituteString cleanName "__" "_"
    )
    
    -- ç§»é™¤å¼€å¤´å’Œç»“å°¾çš„ä¸‹åˆ’çº¿
    if cleanName[1] == "_" do cleanName = substring cleanName 2 -1
    if cleanName[cleanName.count] == "_" do cleanName = substring cleanName 1 (cleanName.count-1)
    
    cleanName
)

-- ä¿®æ”¹åçš„ export_file å‡½æ•°ï¼ˆç§»é™¤å±€éƒ¨ export_segment å®šä¹‰ï¼‰
-- ä¿®æ”¹åçš„å¯¼å‡ºå‡½æ•°ï¼ˆæ·»åŠ é€‰æ‹©é›†æœ‰æ•ˆæ€§æ£€æŸ¥ï¼‰
fn export_file fPath objSet targetPath = (
    export_mod_fn rdo_exportMode.state
    
    if not (isValidScene()) do (
        format "[é”™è¯¯] å½“å‰åœºæ™¯æ— æ•ˆæˆ–æœªåŠ è½½\n"
        return false
    )
    
    -- ä½¿ç”¨ä¼ å…¥çš„targetPath
    exportDir = targetPath
    makeDir exportDir all:true
    
    -- æŒ‰é€‰æ‹©é›†åˆ›å»ºå­ç›®å½•
    if auto_makedir_set.checked do (
        exportDir = pathConfig.appendPath exportDir objSet
        makeDir exportDir all:true
    )

    -- ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶å
    local baseName = if (maxFileName != "") then (
        getFilenameFile maxFileName
    ) else (
        getFilenameFile fPath
    )
    
    local safeName = sanitizeFileName baseName
    
    -- æœ€ç»ˆè¾“å‡ºè·¯å¾„
    local outName = exportDir + "\\" + safeName + ".fbx"
    
    try (
        exportFile outName #noPrompt selectedOnly:true using:FBXEXP
        format "[æˆåŠŸå¯¼å‡ºï¼] %\n" outName
        true
    ) catch (
        format "[å¯¼å‡ºå¤±è´¥ï¼ï¼ï¼] %\n" outName
        false
    )
)

-- æ ¹æ®é€‰æ‹©é›†åç§°é€‰ä¸­å¯¹è±¡ï¼Œå¹¶å¤„ç†æŒ‚ç‚¹å½’é›¶
fn selectExportobject selste_items = (
    clearSelection()
    local temp_good = false
    local nss = selectionSets[selste_items]

    if nss != undefined do (
        -- æ˜¾ç¤ºéšè—å¯¹è±¡
        for i=1 to nss.count do (
            nss[i].isHidden = false
        )
        
        select nss  -- é€‰ä¸­é€‰æ‹©é›†å†…å¯¹è±¡
        max hide inv  -- éšè—æœªé€‰ä¸­å¯¹è±¡
        temp_good = true
    )
    true
    temp_good
)

-- å¼ºåŒ–æ–‡ä»¶åŠ è½½å‡½æ•°ï¼ˆå¢åŠ ç©ºæŒ‡é’ˆä¿æŠ¤ï¼‰;æ˜ç¡®æ•è·ç‰ˆæœ¬å…¼å®¹æ€§å’Œæ–‡ä»¶æŸå;load_file å‡½æ•°ï¼ˆç§»é™¤å¼ºåˆ¶åˆ†æ®µæ•°æ®æ£€æŸ¥ï¼‰
fn load_file fpath = (
    local temp_good = false
        if (getFilenameType fpath) == ".max" and doesFileExist fpath do (
            try (
                -- ä½¿ç”¨æ­£ç¡®çš„ç‰ˆæœ¬è·å–å‡½æ•°
                local fileVersion = getFileVersion fpath
                if fileVersion != undefined and fileVersion[1] > (maxVersion())[1] do (
                    format "[è­¦å‘Š] æ–‡ä»¶ % ç‰ˆæœ¬(%)é«˜äºå½“å‰3ds Maxç‰ˆæœ¬(%)\n" fpath fileVersion maxVersion()
                )
                
                resetMaxFile #noPrompt
                loadMaxFile fpath useFileUnits:true quiet:true
                temp_good = true
                
                -- åŠ è½½åå¼ºåˆ¶åˆ·æ–°åœºæ™¯æ•°æ®
                refreshSceneSetsCache()
            ) catch (
                format "[ä¸¥é‡é”™è¯¯] æ–‡ä»¶åŠ è½½å¤±è´¥ï¼š% (åŸå› ï¼š%)\n" fpath (getCurrentException())
                temp_good = false
            )
        )
        temp_good
    )

-- åˆ é™¤æ‰€æœ‰å¯¹è±¡çš„åŠ¨ç”»å…³é”®å¸§
fn delete_all_key = (
    for obj in objects do (
        deleteKeys obj.transform.controller #allKeys
    )
)

-- æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨å¹¶æ›´æ–°UI
fn reset_model_files f_array btn_txt = (
    if f_array.count > 0 do (
        deleteItem f_array 1
        local filestext = ""
        for i in f_array do (filestext += i + "\r\n")
        btn_txt.text = filestext
    )
)

-- ç”ŸæˆFBXæ–‡ä»¶åï¼ˆç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼‰
fn GetFbxNameFormMax TempName = (
    local NameCutPos = 0
    for i = TempName.count to 1 by -1 do (
        if TempName[i] == "-" do (
            NameCutPos = i
            exit
        )
    )
    if NameCutPos > 0 then (
        substring TempName 1 (NameCutPos - 1)
    ) else (
        TempName
    )
)
   
-- å³é”®èœå•å¤„ç†å‡½æ•°--è§¦å‘maxé»˜è®¤å¼¹çª—-false--Esc=true
fn AutoExportTool_Pro_leftClickHandler = (
    g_showRecentFiles = false  -- æ–°å¢æ¨¡å¼é‡ç½®
    if queryBox "æ˜¯å¦ç«‹å³ç»ˆæ­¢å¯¼å‡ºè¿›ç¨‹ï¼Ÿ" title:"ç»ˆæ­¢ç¡®è®¤" beep:false do (
        g_exportAbortFlag = true -- è®¾ç½®ä¸­æ–­æ ‡å¿—
    )
) 

-- æŒ‰é’®åŠ¨æ€ç¬¦å·æµ‹è¯•-åŠ¨æ€æ›´æ–°è¡¨æƒ…-å®šä¹‰å‡½æ•°
fn updateEmoji state = (
    g_showRecentFiles = false  -- æ–°å¢æ¨¡å¼é‡ç½®
    case state of (
        #normal: lbl_01.text = emojiLib[1] + " YQiu_AutoExportTool"
        #hover: lbl_01.text = emojiLib[2] + " YQiu_AutoExportTool"
        #clicked: lbl_01.text = emojiLib[3] + " YQiu_AutoExportTool"
    )
)

-- æ–‡ä»¶å½’æ¡£/ - ç‹¬ç«‹æ¯”è¾ƒå‡½æ•°ï¼šæŒ‰æ–‡ä»¶ä¿®æ”¹æ—¶é—´é™åºæ’åº--æ²‰æ·€å‡½æ•°ï¼ˆå¤‡ç”¨ï¼‰
fn compareFiles a b = (
    local dateA = getFileModDate a  -- è·å–æ–‡ä»¶Aä¿®æ”¹æ—¶é—´
    local dateB = getFileModDate b  -- è·å–æ–‡ä»¶Bä¿®æ”¹æ—¶é—´
    dateA > dateB  -- è¿”å›trueè¡¨ç¤ºAæ’åœ¨Bå‰ï¼ˆä»æ–°åˆ°æ—§ï¼‰
)

--å¸¸ç”¨è·¯å¾„ç›¸å…³è¾…åŠ© æ–‡ä»¶è·¯å¾„è‡ªåŠ¨ç²˜è´´ / btnBrowsePath é¼ æ ‡å³é”® å®ç° å¤åˆ¶ TEXT = æ–‡ä»¶ç›®å½•åœ°å€ åˆ° å¸¸ç”¨è·¯å¾„ç®¡ç† ROULLOUT çš„ ç›®å½•è·¯å¾„  
-- ===== å¸¸ç”¨ç›®å½•/å®‰å…¨å‰ªè´´æ¿æ“ä½œå‡½æ•° =====
-- åœ¨å¤åˆ¶å‰å¤„ç†ç‰¹æ®Šå­—ç¬¦
fn sanitizePathForCmd txt = (
    local sanitized = txt
    
    -- å¤„ç†ç©ºæ ¼
    if findString txt " " != undefined do (
        sanitized = "\"" + txt + "\""
    )
    
    -- å¤„ç†ç‰¹æ®Šç¬¦å·
    sanitized = substituteString sanitized "&" "^&"
    sanitized = substituteString sanitized "<" "^<"
    sanitized = substituteString sanitized ">" "^>"
    sanitized = substituteString sanitized "|" "^|"
    
    sanitized
)

--å¸¸ç”¨ç›®å½•/ä¼˜åŒ–çš„å‰ªè´´æ¿å‡½æ•°ï¼ˆåŒ…å«ç‰ˆæœ¬æ£€æµ‹ï¼‰
fn setClipboardText txt = (
    -- ç»Ÿä¸€å¤„ç†ç‰¹æ®Šå­—ç¬¦
    local safeTxt = substituteString txt "\"" "\\\""
    
    -- MAX 2014åŠæ›´æ—©ç‰ˆæœ¬ä½¿ç”¨CMDæ–¹æ³•
    if (maxVersion())[1] < 17000 do (
        try (
            local shell = createOLEObject "WScript.Shell"
            shell.Exec("cmd /c echo " + safeTxt + " | clip")
            return true
        )
        catch (return false)
    )
    
    try (
        -- é«˜ç‰ˆæœ¬ä¼˜å…ˆä½¿ç”¨.NETæ–¹æ³•
        (dotNetClass "System.Windows.Forms.Clipboard").SetText(safeTxt)
        return true
    )
    catch (
        try (
            -- COMåå¤‡æ–¹æ³•
            local shell = createOLEObject "WScript.Shell"
            shell.Exec("cmd /c echo " + safeTxt + " | clip")
            return true
        )
        catch (
            format "[é”™è¯¯] å‰ªè´´æ¿å†™å…¥å¤±è´¥: %\n" (getCurrentException())
            return false
        )
    )
)

-- æ‰¹é‡åˆå¹¶æŒ‚ç‚¹æ–‡ä»¶//æŸ¥æ‰¾å¯¹åº”çš„CSéª¨éª¼ / æ”¹è¿›çš„éª¨éª¼æŸ¥æ‰¾å‡½æ•°
fn findCorrespondingBone socketName = (
    local boneName = ""
    local targetBone = undefined
    
    -- ä»Socketåç§°æå–éª¨éª¼åç§°ï¼ˆæ›´ç²¾ç¡®çš„åŒ¹é…é€»è¾‘ï¼‰
    case of (
        (matchPattern socketName pattern:"*_Socket"): 
            boneName = substituteString socketName "_Socket" ""
        (matchPattern socketName pattern:"*Socket"): 
            boneName = substituteString socketName "Socket" ""
        (matchPattern socketName pattern:"*æŒ‚ç‚¹*"): 
            boneName = substituteString socketName "æŒ‚ç‚¹" ""
        default: boneName = socketName
    )
    
    -- æ¸…ç†åç§°ä¸­çš„å¤šä½™ä¸‹åˆ’çº¿å’Œç©ºæ ¼
    boneName = trimRight (trimLeft boneName)
    boneName = substituteString boneName "__" "_"
    
    -- ä¼˜å…ˆæŸ¥æ‰¾Bipedéª¨éª¼ï¼ˆBIPED OBJECTç±»å‹ï¼‰
    local bipedBones = for obj in objects where (classOf obj == Biped_Object) collect obj
    
    -- 1. ç²¾ç¡®åŒ¹é…æŸ¥æ‰¾ï¼ˆè€ƒè™‘CSéª¨éª¼å‘½åè§„èŒƒï¼‰
    for bone in bipedBones do (
        local cleanBoneName = bone.name
        -- ç§»é™¤Bipå‰ç¼€è¿›è¡ŒåŒ¹é…
        if matchPattern cleanBoneName pattern:"Bip001 *" do (
            cleanBoneName = substituteString cleanBoneName "Bip001 " ""
        )
        
        if bone.name == boneName or cleanBoneName == boneName do (
            targetBone = bone
            exit
        )
    )
    
    -- 2. æ™ºèƒ½éƒ¨åˆ†åŒ¹é…ï¼ˆå¤„ç†å¸¸è§çš„CSéª¨éª¼å‘½åå˜ä½“ï¼‰
    if targetBone == undefined do (
        -- å¤„ç†å¤´éƒ¨ç›¸å…³éª¨éª¼
        if matchPattern boneName pattern:"*Head*" then (
            targetBone = getNodeByName "Bip001 Head"
            if targetBone == undefined do targetBone = getNodeByName "Head"
        )
        -- å¤„ç†è„ŠæŸ±ç›¸å…³éª¨éª¼
        else if matchPattern boneName pattern:"*Spine*" then (
            targetBone = getNodeByName "Bip001 Spine"
            if targetBone == undefined do targetBone = getNodeByName "Bip001 Spine1"
            if targetBone == undefined do targetBone = getNodeByName "Bip001 Spine2"
            if targetBone == undefined do targetBone = getNodeByName "Spine"
        )
        -- å¤„ç†éª¨ç›†
        else if matchPattern boneName pattern:"*Pelvis*" then (
            targetBone = getNodeByName "Bip001 Pelvis"
            if targetBone == undefined do targetBone = getNodeByName "Pelvis"
        )
        -- å¤„ç†å››è‚¢
        else if matchPattern boneName pattern:"*Arm*" then (
            if findString boneName "L" != undefined or findString boneName "Left" != undefined then (
                targetBone = getNodeByName "Bip001 L Arm"
                if targetBone == undefined do targetBone = getNodeByName "Bip001 L Forearm"
            )
            else (
                targetBone = getNodeByName "Bip001 R Arm"
                if targetBone == undefined do targetBone = getNodeByName "Bip001 R Forearm"
            )
        )
        else if matchPattern boneName pattern:"*Leg*" then (
            if findString boneName "L" != undefined or findString boneName "Left" != undefined then (
                targetBone = getNodeByName "Bip001 L Leg"
                if targetBone == undefined do targetBone = getNodeByName "Bip001 L Calf"
            )
            else (
                targetBone = getNodeByName "Bip001 R Leg"
                if targetBone == undefined do targetBone = getNodeByName "Bip001 R Calf"
            )
        )
    )
    
    -- 3. æœ€åå°è¯•åç§°åŒ…å«åŒ¹é…
    if targetBone == undefined do (
        for bone in bipedBones do (
            if findString bone.name boneName != undefined do (
                targetBone = bone
                exit
            )
        )
    )
    
    -- è¾“å‡ºè°ƒè¯•ä¿¡æ¯
    if targetBone != undefined then (
        format "[éª¨éª¼åŒ¹é…] % -> %\n" socketName targetBone.name
    ) else (
        format "[è­¦å‘Š] æœªæ‰¾åˆ° % çš„å¯¹åº”éª¨éª¼\n" socketName
    )
    
    targetBone
)

-- æ‰¹é‡åˆå¹¶æŒ‚ç‚¹æ–‡ä»¶//å¯¹é½æŒ‚ç‚¹åˆ°éª¨éª¼/æ”¹è¿›çš„å¯¹é½æŒ‚ç‚¹åˆ°éª¨éª¼å‡½æ•°
fn alignSocketToBone socketNode targetBone = (
    if not (isValidNode socketNode and isValidNode targetBone) do return undefined
    
    try (
        -- æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯ç›®æ ‡éª¨éª¼çš„å­çº§
        if socketNode.parent == targetBone do (
            format "[ä¿¡æ¯] % å·²ç»æ˜¯ % çš„å­çº§ï¼Œè·³è¿‡å¯¹é½\n" socketNode.name targetBone.name
            return #(socketNode, targetBone, socketNode.transform, socketNode.parent)
        )
        
        -- ä¿å­˜åŸå§‹å˜æ¢ä¿¡æ¯
        local originalTransform = socketNode.transform
        local originalParent = socketNode.parent
        
        -- ä½¿ç”¨å¿«æ·é“¾æ¥æ’ä»¶çš„å¯¹é½é€»è¾‘
        -- 1. å…ˆæ–­å¼€å½“å‰çˆ¶çº§å…³ç³»
        socketNode.parent = undefined
        
        -- 2. å¯¹é½åˆ°ç›®æ ‡éª¨éª¼çš„ä¸–ç•Œå˜æ¢
        socketNode.transform = targetBone.transform
        
        -- 3. é“¾æ¥åˆ°ç›®æ ‡éª¨éª¼
        socketNode.parent = targetBone
        
        -- 4. é‡ç½®å±€éƒ¨å˜æ¢ï¼ˆä½¿å…¶ç›¸å¯¹äºçˆ¶éª¨éª¼çš„å˜æ¢ä¸º0ï¼‰
        in coordsys local (
            socketNode.pos = [0,0,0]
            socketNode.rotation = (quat 0 0 0 1)
        )
        
        format "[å¯¹é½æˆåŠŸ] % -> %\n" socketNode.name targetBone.name
        
        -- è¿”å›å¯¹é½ä¿¡æ¯
        #(socketNode, targetBone, originalTransform, originalParent)
    )
    catch (
        format "[å¯¹é½é”™è¯¯] % -> %: %\n" socketNode.name targetBone.name (getCurrentException())
        
        -- å°è¯•å¤‡ç”¨æ–¹æ³•ï¼šç›´æ¥ä½¿ç”¨çˆ¶çº§é“¾æ¥è€Œä¸å˜æ¢
        try (
            socketNode.parent = targetBone
            format "[å¤‡ç”¨å¯¹é½] ä½¿ç”¨ç®€å•çˆ¶çº§é“¾æ¥: % -> %\n" socketNode.name targetBone.name
            #(socketNode, targetBone, originalTransform, originalParent)
        )
        catch (
            format "[ä¸¥é‡é”™è¯¯] å®Œå…¨æ— æ³•å¯¹é½: %\n" (getCurrentException())
            undefined
        )
    )
)

-- æ‰¹é‡åˆå¹¶æŒ‚ç‚¹æ–‡ä»¶//æ¢å¤æŒ‚ç‚¹åŸå§‹çŠ¶æ€
fn restoreSocketAlignment alignmentInfo = (
    if alignmentInfo == undefined do return false
    
    try (
        local socketNode = alignmentInfo[1]
        local originalTransform = alignmentInfo[3]
        local originalParent = alignmentInfo[4]
        
        if isValidNode socketNode do (
            -- æ¢å¤çˆ¶çº§å…³ç³»
            socketNode.parent = originalParent
            
            -- æ¢å¤å˜æ¢
            socketNode.transform = originalTransform
        )
        
        true
    )
    catch (
        format "[æ¢å¤é”™è¯¯] %: %\n" alignmentInfo[1].name (getCurrentException())
        false
    )
)
-- æ‰¹é‡åˆå¹¶æŒ‚ç‚¹æ–‡ä»¶//è‡ªåŠ¨å¤„ç†åˆå¹¶é€‰æ‹©é›†å¼¹çª—
fn handleSelectionSetDialogs = (
    try (
        -- æŸ¥æ‰¾å¹¶è‡ªåŠ¨å¤„ç†é€‰æ‹©é›†åˆå¹¶å¼¹çª—
        local maxHWND = windows.getMAXHWND()
        local dialog = undefined
        local counter = 0
        
        -- ç­‰å¾…å¼¹çª—å‡ºç°ï¼ˆæœ€å¤šç­‰å¾…2ç§’ï¼‰
        while dialog == undefined and counter < 20 do (
            sleep 0.1
            dialog = UIAccessor.FindWindowEx maxHWND 0 "#32770" "é‡å‘½ååˆå¹¶æè´¨"
            if dialog == undefined do (
                dialog = UIAccessor.FindWindowEx maxHWND 0 "#32770" "åˆå¹¶"
            )
            counter += 1
        )
        
        -- å¦‚æœæ‰¾åˆ°å¼¹çª—ï¼Œè‡ªåŠ¨ç‚¹å‡»"æ˜¯"æˆ–"åˆå¹¶"
        if dialog != undefined do (
            local yesButton = UIAccessor.FindWindowEx dialog 0 "Button" "æ˜¯(&Y)"
            if yesButton == undefined do yesButton = UIAccessor.FindWindowEx dialog 0 "Button" "åˆå¹¶(&M)"
            
            if yesButton != undefined do (
                UIAccessor.PressButton yesButton
                format "[è‡ªåŠ¨å¤„ç†] å·²å¤„ç†åˆå¹¶å¼¹çª—\n"
            )
        )
    )
    catch (
        format "[å¼¹çª—å¤„ç†é”™è¯¯] %\n" (getCurrentException())
    )
)
-- æ‰¹é‡åˆå¹¶æŒ‚ç‚¹æ–‡ä»¶//åˆå¹¶æ–‡ä»¶å¹¶å¤„ç†æŒ‚ç‚¹
fn mergeAndProcessSockets targetFile mergeFile = (
    if not (doesFileExist targetFile and doesFileExist mergeFile) do return false
    
    local success = false
    local alignmentInfos = #()
    
    -- å¯ç”¨é™é»˜æ¨¡å¼
    setSilentMode true
    
    try (
        -- åŠ è½½ç›®æ ‡æ–‡ä»¶
        if not (loadMaxFile targetFile quiet:true) do (
            format "[é”™è¯¯] æ— æ³•åŠ è½½æ–‡ä»¶: %\n" targetFile
            return false
        )
        
        -- è·å–å½“å‰åœºæ™¯ä¸­çš„éª¨éª¼
        local sceneBones = for obj in objects where (classOf obj == BoneGeometry or classOf obj == Biped_Object) collect obj
        
        -- åˆå¹¶æ–‡ä»¶ï¼ˆä½¿ç”¨é™é»˜æ¨¡å¼ï¼‰
        local mergeResult = false
        try (
            mergeResult = mergeMaxFile mergeFile #autoRenameDups #useMergedMtlDups #neverReparent quiet:true
        )
        catch (
            -- å¦‚æœåˆå¹¶å¤±è´¥ï¼Œå°è¯•å¤„ç†å¼¹çª—åé‡è¯•
            handleSelectionSetDialogs()
            sleep 0.5
            try (
                mergeResult = mergeMaxFile mergeFile #autoRenameDups #useMergedMtlDups #neverReparent quiet:true
            )
            catch (
                format "[åˆå¹¶é”™è¯¯] æ— æ³•åˆå¹¶æ–‡ä»¶: %\n" (getCurrentException())
                return false
            )
        )
        
        if not mergeResult do (
            format "[é”™è¯¯] åˆå¹¶æ–‡ä»¶å¤±è´¥: %\n" mergeFile
            return false
        )
        
        -- æŸ¥æ‰¾å¹¶å¤„ç†æ‰€æœ‰æŒ‚ç‚¹
        local socketNodes = for obj in objects where (
            (classOf obj == Dummy or classOf obj == Point) and 
            (matchPattern obj.name pattern:"*Socket*" or matchPattern obj.name pattern:"*socket*" or
             matchPattern obj.name pattern:"*æŒ‚ç‚¹*")
        ) collect obj
        
        format "[æŒ‚ç‚¹æ£€æµ‹] æ‰¾åˆ° % ä¸ªæŒ‚ç‚¹\n" socketNodes.count
        
        -- å¤„ç†æ¯ä¸ªæŒ‚ç‚¹
        for socket in socketNodes do (
            local targetBone = findCorrespondingBone socket.name
            
            if targetBone != undefined then (
                format "[æŒ‚ç‚¹å¯¹é½] % -> %\n" socket.name targetBone.name
                local alignmentInfo = alignSocketToBone socket targetBone
                if alignmentInfo != undefined do append alignmentInfos alignmentInfo
            )
            else (
                format "[è­¦å‘Š] æœªæ‰¾åˆ° % çš„å¯¹åº”éª¨éª¼\n" socket.name
            )
        )
        
        -- ä¿å­˜æ–‡ä»¶
        saveMaxFile targetFile quiet:true
        success = true
        format "[æˆåŠŸ] å¤„ç†å®Œæˆ: %\n" targetFile
        
    )
    catch (
        format "[åˆå¹¶é”™è¯¯] %: %\n" targetFile (getCurrentException())
        success = false
    )
    
    -- æ¢å¤æ­£å¸¸æ¨¡å¼
    setSilentMode false
    
    -- æ¢å¤åœºæ™¯
    resetMaxFile #noPrompt
    
    success
)

-- æ‰¹é‡åˆå¹¶æŒ‚ç‚¹æ–‡ä»¶//è·å–åˆå¹¶æ–‡ä»¶
fn getMergeFileFromList = (
    for i = 0 to (Lv_model.Items.Count - 1) do (
        local item = Lv_model.Items.Item[i]
        local path = item.Tag as String
        
        if doesFileExist path and (
            matchPattern (filenameFromPath path) pattern:"*merge*" or 
            matchPattern (filenameFromPath path) pattern:"*Merge*" or
            matchPattern (getFilenameFile path) pattern:"*æŒ‚ç‚¹*" or
            matchPattern (getFilenameFile path) pattern:"*socket*"
        ) then (
            return path
        )
    )
    
    undefined
)

-- æ‰¹é‡åˆå¹¶æŒ‚ç‚¹æ–‡ä»¶//ä¸»å¤„ç†å‡½æ•°ï¼šæ‰¹é‡åˆå¹¶æŒ‚ç‚¹æ–‡ä»¶
fn batchMergeSocketFiles = (
    -- æ£€æŸ¥æ˜¯å¦æœ‰åˆå¹¶æ–‡ä»¶
    g_mergeFilePath = getMergeFileFromList()
    
    if g_mergeFilePath == undefined do (
        messageBox "æœªæ‰¾åˆ°åˆå¹¶æ–‡ä»¶ï¼\nè¯·ç¡®ä¿åˆ—è¡¨ä¸­æœ‰åŒ…å«\"merge\"ã€\"Merge\"æˆ–\"æŒ‚ç‚¹\"å­—æ ·çš„æ–‡ä»¶" title:"é”™è¯¯"
        return false
    )
    
    -- ç¡®è®¤å¯¹è¯æ¡†
    local msg = "å³å°†å¼€å§‹æ‰¹é‡åˆå¹¶æŒ‚ç‚¹æ–‡ä»¶ï¼\n\n"
    msg += "åˆå¹¶æ–‡ä»¶: " + filenameFromPath g_mergeFilePath + "\n"
    msg += "è­¦å‘Š: æ­¤æ“ä½œå°†ç›´æ¥ä¿®æ”¹åŸæ–‡ä»¶ï¼Œè¯·ç¡®ä¿å·²å¤‡ä»½ï¼\n"
    msg += "æ˜¯å¦ç»§ç»­ï¼Ÿ"
    
    if not (queryBox msg title:"å±é™©æ“ä½œ" beep:true) do return false
    
    -- è·å–å¤„ç†æ–‡ä»¶åˆ—è¡¨
    local processFiles = #()
    
    for i = 0 to (Lv_model.Items.Count - 1) do (
        local item = Lv_model.Items.Item[i]
        local path = item.Tag as String
        
        -- è·³è¿‡åˆå¹¶æ–‡ä»¶æœ¬èº«å’Œæ–‡ä»¶å¤¹
        if path != g_mergeFilePath and not (matchPattern path pattern:"[DIR]*") and 
           doesFileExist path and (getFilenameType path) == ".max" do (
            append processFiles path
        )
    )
    
    if processFiles.count == 0 do (
        messageBox "æ²¡æœ‰æ‰¾åˆ°éœ€è¦å¤„ç†çš„MAXæ–‡ä»¶ï¼" title:"æ“ä½œä¸­æ­¢"
        return false
    )
    
    -- åˆå§‹åŒ–è¿›åº¦
    g_exportAbortFlag = false
    pbProgress.value = 0
    pbProgress.maximum = processFiles.count
    lblProgressInfo.text = "å‡†å¤‡å¼€å§‹åˆå¹¶æŒ‚ç‚¹æ–‡ä»¶..."
    
    local successCount = 0
    local failCount = 0
    
    -- ä¸»å¤„ç†å¾ªç¯
    for i = 1 to processFiles.count where not g_exportAbortFlag do (
        if keyboard.escPressed do (
            g_exportAbortFlag = true
            lblProgressInfo.text = "ç”¨æˆ·ä¸­æ–­æ“ä½œï¼"
            exit
        )
        
        local targetFile = processFiles[i]
        lblProgressInfo.text = "å¤„ç†ä¸­: " + filenameFromPath targetFile + " (" + i as string + "/" + processFiles.count as string + ")"
        
        -- å¤„ç†æ–‡ä»¶
        if mergeAndProcessSockets targetFile g_mergeFilePath then (
            successCount += 1
            format "[æˆåŠŸ] %\n" targetFile
        )
        else (
            failCount += 1
            format "[å¤±è´¥] %\n" targetFile
        )
        
        -- æ›´æ–°è¿›åº¦
        pbProgress.value = i
        windows.processPostedMessages()
        
        -- å†…å­˜ä¼˜åŒ–
        if mod i 5 == 0 do (gc(); freeSceneBitmaps())
    )
    
    -- å®Œæˆå¤„ç†
    local resultMsg = "æ‰¹é‡åˆå¹¶å®Œæˆï¼\n\n"
    resultMsg += "æˆåŠŸ: " + successCount as string + " ä¸ªæ–‡ä»¶\n"
    resultMsg += "å¤±è´¥: " + failCount as string + " ä¸ªæ–‡ä»¶\n"
    resultMsg += "åˆå¹¶æ–‡ä»¶: " + filenameFromPath g_mergeFilePath
    
    lblProgressInfo.text = "æ‰¹é‡åˆå¹¶*æŒ‚ç‚¹*æ–‡ä»¶å®Œæˆï¼æˆåŠŸ: " + successCount as string + " / å¤±è´¥: " + failCount as string
    messageBox resultMsg title:"å®Œæˆ"
    
    true
)

-- æ‰¹é‡åŒæ­¥é€‰æ‹©é›†å‡½æ•° / åŒæ­¥æ›´æ–°åˆ—è¡¨æ–‡ä»¶çš„é€‰æ‹©é›† 
fn batchSyncSelectionSets = (
    -- æ¸…ç©ºç›‘å¬å™¨ä¿¡æ¯
    clearListener()
    g_exportAbortFlag = false
    pbProgress.value = 0
    lblProgressInfo.text = "å‡†å¤‡å¼€å§‹åŒæ­¥é€‰æ‹©é›†..."
    
    -- ä¿å­˜å½“å‰åœºæ™¯ä¿¡æ¯ï¼ˆé€‰æ‹©é›†æ¨¡æ¿æ–‡ä»¶ï¼‰
    local templateFile = maxFilePath + maxFileName
    local templateFileName = maxFileName
    
    -- æ£€æŸ¥å½“å‰åœºæ™¯æ˜¯å¦æœ‰é€‰æ‹©é›†
    if (getNumNamedSelSets()) == 0 do (
        messageBox "å½“å‰åœºæ™¯æ²¡æœ‰é€‰æ‹©é›†ï¼" title:"æ“ä½œä¸­æ­¢"
        return false
    )
    
    -- è·å–å¤„ç†æ–‡ä»¶åˆ—è¡¨ï¼ˆä»…MAXæ–‡ä»¶ï¼‰
    local processFiles = #()
    for i = 0 to (Lv_model.Items.Count - 1) do (
        local item = Lv_model.Items.Item[i]
        local path = item.Tag as String
        
        -- è·³è¿‡æ–‡ä»¶å¤¹å’ŒéMAXæ–‡ä»¶
        if not (matchPattern path pattern:"[DIR]*") and 
           doesFileExist path and 
           (toLower (getFilenameType path)) == ".max" do (
            append processFiles path
        )
    )
    
    if processFiles.count == 0 do (
        messageBox "æ²¡æœ‰æ‰¾åˆ°éœ€è¦å¤„ç†çš„MAXæ–‡ä»¶ï¼" title:"æ“ä½œä¸­æ­¢"
        return false
    )
    
    -- ä¿å­˜å½“å‰é€‰æ‹©é›†åˆ°ä¸´æ—¶XML
    local tempXmlPath = (getDir #temp) + "\\TempSelectionSets.xml"
    local saveSuccess = false
    
    try (
        -- ä½¿ç”¨ç°æœ‰çš„ä¿å­˜å‡½æ•°
        local dotNetXmlDoc = dotNetObject "System.xml.xmlDocument"
        local rootElement = dotNetXmlDoc.createElement "SelectionSet_Tools"
        dotNetXmlDoc.appendChild rootElement

        for s in selectionSets do (
            local setElement = dotNetXmlDoc.createElement "SelectionSet"
            setElement.SetAttribute "SetName" s.name
            rootElement.appendChild setElement

            for o in s do (
                local objElement = dotNetXmlDoc.createElement "ObjectName"
                objElement.InnerText = o.name
                setElement.appendChild objElement
            )
        )
        dotNetXmlDoc.save tempXmlPath
        saveSuccess = true
    )
    catch (
        format "[é€‰æ‹©é›†ä¿å­˜é”™è¯¯] %\n" (getCurrentException())
        saveSuccess = false
    )
    
    if not saveSuccess do (
        messageBox "æ— æ³•ä¿å­˜å½“å‰é€‰æ‹©é›†ï¼" title:"é”™è¯¯"
        return false
    )
    
    -- ç¡®è®¤å¯¹è¯æ¡†
    local msg = "å³å°†å¼€å§‹æ‰¹é‡åŒæ­¥é€‰æ‹©é›†ï¼\n\n"
    msg += "å°†å½±å“ " + (processFiles.count as string) + " ä¸ªMAXæ–‡ä»¶\n"
    msg += "è­¦å‘Š: æ­¤æ“ä½œå°†ä¿®æ”¹åŸæ–‡ä»¶ï¼Œè¯·ç¡®ä¿å·²å¤‡ä»½ï¼\n"
    msg += "æ˜¯å¦ç»§ç»­ï¼Ÿ"
    
    if not (queryBox msg title:"æ‰¹é‡åŒæ­¥é€‰æ‹©é›†" beep:true) do (
        deleteFile tempXmlPath  -- æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        return false
    )
    
    -- è®¾ç½®è¿›åº¦
    pbProgress.maximum = processFiles.count
    local successCount = 0
    local failCount = 0
    local errorFiles = #()  -- è®°å½•å‡ºé”™çš„æ–‡ä»¶
    
    -- å­˜å‚¨é€‰æ‹©é›†ä¿¡æ¯ç”¨äºæœ€åæ˜¾ç¤º
    local selectionSetNames = #()
    for s in selectionSets do append selectionSetNames s.name
    
    -- ä¸»å¤„ç†å¾ªç¯ - ä½¿ç”¨ä»£ç 1çš„ç¨³å®šé€»è¾‘
    for i = 1 to processFiles.count where not g_exportAbortFlag do (
        -- ESCé”®æ£€æµ‹
        if keyboard.escPressed do (
            g_exportAbortFlag = true
            format "[ç”¨æˆ·ä¸­æ–­] å¯¼å‡ºè¿›ç¨‹å·²è¢«æ‰‹åŠ¨ç»ˆæ­¢\n"
            lblProgressInfo.text = "ç”¨æˆ·ä¸­æ–­æ“ä½œï¼"
            windows.processPostedMessages()
            messageBox "åŒæ­¥æ›´æ–°é€‰æ‹©é›†è¿›ç¨‹å·²è¢«ç”¨æˆ·ä¸­æ–­ï¼" title:"æç¤º"
            exit
        )
        
        local targetFile = processFiles[i]
        lblProgressInfo.text = "é€‰æ‹©é›†/åŒæ­¥ä¸­: " + filenameFromPath targetFile + " (" + i as string + "/" + processFiles.count as string + ")"
        
        try (
            -- ä¿å­˜å½“å‰åœºæ™¯çŠ¶æ€ï¼ˆå¦‚æœæ˜¯å·²æ‰“å¼€çš„åœºæ™¯ï¼‰
            local wasDirty = needsSave
            local currentFile = maxFilePath + maxFileName
            
            -- åŠ è½½ç›®æ ‡æ–‡ä»¶
            if loadMaxFile targetFile quiet:true then (
                -- æ¸…é™¤ç°æœ‰é€‰æ‹©é›†
                local numSets = getNumNamedSelSets()
                for j = numSets to 1 by -1 do (
                    try (
                        deleteNamedSelSet (getNamedSelSetName j)
                    )
                    catch (
                        format "[æ¸…ç†é€‰æ‹©é›†] ç§»é™¤: %\n" (getNamedSelSetName j)
                    )
                )
                
                -- åŠ è½½é€‰æ‹©é›†
                local dotNetXmlDoc = dotNetObject "System.xml.xmlDocument"
                dotNetXmlDoc.Load tempXmlPath
                local rootElement = dotNetXmlDoc.DocumentElement
                
                if rootElement.name == "SelectionSet_Tools" then (
                    local nodesSelSet = rootElement.ChildNodes
                    
                    for k = 0 to nodesSelSet.count - 1 do (
                        local elemSelSet = nodesSelSet.Item[k]
                        local setName = (elemSelSet.Attributes.GetNamedItem "SetName").value
                        
                        local objNodes = elemSelSet.ChildNodes
                        local objNames = #()
                        
                        for m = 0 to objNodes.count - 1 do (
                            local objElement = objNodes.Item[m]
                            append objNames objElement.InnerText
                        )
               
                        -- åˆ›å»ºé€‰æ‹©é›†ï¼ˆåªåŒ…å«åœºæ™¯ä¸­å­˜åœ¨çš„å¯¹è±¡ï¼‰
                        local validObjects = #()
                        for objName in objNames do (
                            local obj = getNodeByName objName
                            if obj != undefined and not isDeleted obj do append validObjects obj
                        )
                        
                        if validObjects.count > 0 do (
                            try (
                                selectionSets[setName] = validObjects
                            )
                            catch (
                                format "[è­¦å‘Š] æ— æ³•åˆ›å»ºé€‰æ‹©é›†: %\n" setName
                            )
                        )
                    )
                    
                    -- ä¿å­˜æ–‡ä»¶
                    try (
                        saveMaxFile targetFile
                        successCount += 1
                        format "[æˆåŠŸ] å·²åŒæ­¥: %\n" targetFile
                    )
                    catch (
                        format "[ä¿å­˜é”™è¯¯] æ— æ³•ä¿å­˜: %\n" targetFile
                        append errorFiles #(targetFile, "ä¿å­˜å¤±è´¥")
                        failCount += 1
                    )
                )
                else (
                    format "[é”™è¯¯] æ— æ•ˆçš„XMLæ ¼å¼: %\n" targetFile
                    append errorFiles #(targetFile, "XMLæ ¼å¼æ— æ•ˆ")
                    failCount += 1
                )
                
                -- é‡ç½®åœºæ™¯ï¼Œæ¢å¤åŸå§‹æ–‡ä»¶
                resetMaxFile #noPrompt
                
                -- å¦‚æœä¹‹å‰æœ‰æ‰“å¼€çš„æ–‡ä»¶ï¼Œé‡æ–°æ‰“å¼€å®ƒ
                if currentFile != "" and doesFileExist currentFile and wasDirty do (
                    loadMaxFile currentFile quiet:true
                )
            )
            else (
                format "[é”™è¯¯] æ— æ³•åŠ è½½æ–‡ä»¶: %\n" targetFile
                append errorFiles #(targetFile, "æ–‡ä»¶æ— æ³•åŠ è½½")
                failCount += 1
            )
        )
        catch (
            local errMsg = getCurrentException()
            append errorFiles #(targetFile, errMsg)
            failCount += 1
            
            -- å°è¯•æ¢å¤åœºæ™¯
            try (
                resetMaxFile #noPrompt
                if (maxFilePath + maxFileName) != "" do (
                    loadMaxFile (maxFilePath + maxFileName) quiet:true
                )
            )
            catch ()
        )
        
        -- æ›´æ–°è¿›åº¦
        pbProgress.value = i
        windows.processPostedMessages()
        
        -- å†…å­˜ä¼˜åŒ–
        if mod i 5 == 0 do (
            gc()
            freeSceneBitmaps()
        )
    )
    
    -- æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    try (deleteFile tempXmlPath) catch ()
    
    -- å®Œæˆå¤„ç†ï¼Œæ˜¾ç¤ºè¯¦ç»†ç»“æœ 
    local resultMsg = "æ‰¹é‡åŒæ­¥é€‰æ‹©é›†å®Œæˆï¼\n\n"
    resultMsg += "å¤„ç†æˆåŠŸ: " + successCount as string + " ä¸ªæ–‡ä»¶\n"
    
    -- æ·»åŠ é€‰æ‹©é›†ä¿¡æ¯åˆ°ç»“æœæ¶ˆæ¯
    if selectionSetNames.count > 0 do (
        resultMsg += "\nåŒæ­¥çš„é€‰æ‹©é›†:\n"
        for setName in selectionSetNames do (
            resultMsg += "  â€¢ " + setName + "\n"
        )
    )
    
    -- é‡æ–°æ‰“å¼€é€‰æ‹©é›†æ¨¡æ¿æ–‡ä»¶
    if templateFile != "" and doesFileExist templateFile do (
        try (
            resetMaxFile #noPrompt
            loadMaxFile templateFile quiet:true
            resultMsg += "\n\nå·²é‡æ–°æ‰“å¼€é€‰æ‹©é›†æ¨¡æ¿æ–‡ä»¶: " + templateFileName
            format "[å®Œæˆ] å·²é‡æ–°æ‰“å¼€é€‰æ‹©é›†æ¨¡æ¿æ–‡ä»¶: %\n" templateFileName
        )
        catch (
            resultMsg += "\n\nè­¦å‘Š: æ— æ³•é‡æ–°æ‰“å¼€é€‰æ‹©é›†æ¨¡æ¿æ–‡ä»¶: " + templateFileName
            format "[è­¦å‘Š] æ— æ³•é‡æ–°æ‰“å¼€é€‰æ‹©é›†æ¨¡æ¿æ–‡ä»¶: %\n" templateFileName
        )
    )
    
    lblProgressInfo.text = "é€‰æ‹©é›†åŒæ­¥å®Œæˆï¼å¤„ç†æˆåŠŸ: " + successCount as string + " ä¸ªæ–‡ä»¶"
    messageBox resultMsg title:"æ›´æ–°å®Œæˆ"

    -- åˆ·æ–°å½“å‰åœºæ™¯çš„é€‰æ‹©é›†æ˜¾ç¤º
    try (
        if (maxFilePath + maxFileName) != "" do (
            GetSetFormScene()
        )
    ) 
    catch ()
    
    true
)

--åˆå¹¶åˆ†æ®µåŠ¨ç”»
fn mergeSegmentAnimations = (
    g_exportAbortFlag = false
    lblProgressInfo.text = "å‡†å¤‡å¼€å§‹åˆå¹¶åˆ†æ®µåŠ¨ç”»..."
    
    -- è·å–å‹¾é€‰çš„æ–‡ä»¶
    local selectedFiles = #()
    for i = 0 to (Lv_model.Items.Count - 1) do (
        if Lv_model.Items.Item[i].Checked do (
            local path = Lv_model.Items.Item[i].Tag as String
            if not matchPattern path pattern:"*[DIR]*" and (getFilenameType path) == ".max" and doesFileExist path do (
                append selectedFiles path
            )
        )
    )
    
    if selectedFiles.count < 2 do (
        messageBox "è¯·è‡³å°‘å‹¾é€‰2ä¸ªåˆ†æ®µMAXæ–‡ä»¶è¿›è¡Œåˆå¹¶ï¼" title:"æ“ä½œä¸­æ­¢"
        return false
    )
    
    -- æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    local fileList = ""
    for f in selectedFiles do (
        fileList += filenameFromPath f + "\n"
    )
    
    local msg = "ç¡®å®šè¦å°†ä»¥ä¸‹åˆ†æ®µæ–‡ä»¶åˆå¹¶å—ï¼Ÿ\n\n" + fileList + "\næ­¤æ“ä½œå¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚"
    if not (queryBox msg title:"ç¡®è®¤åˆå¹¶" beep:true) do (
        return false
    )
    
    -- åˆ†ææ–‡ä»¶åï¼Œç¡®å®šåŠ¨ç”»é¡ºåº
    local animationSegments = #()
    for f in selectedFiles do (
        local fileName = getFilenameFile f
        local segmentType = "middle" -- é»˜è®¤ä¸­é—´æ®µ
        
        case of (
            (findString (toLower fileName) "start" != undefined): segmentType = "start"
            (findString (toLower fileName) "loop" != undefined): segmentType = "loop"
            (findString (toLower fileName) "end" != undefined): segmentType = "end"
        )
        
        append animationSegments #(f, fileName, segmentType)
    )
    
    -- æŒ‰ç±»å‹æ’åº: start -> loop -> end -> middle
    fn segmentSort a b = (
        local typeOrder = #("start", "loop", "end", "middle")
        local aIndex = findItem typeOrder a[3]
        local bIndex = findItem typeOrder b[3]
        
        if aIndex < bIndex then -1
        else if aIndex > bIndex then 1
        else 0
    )
    
    qsort animationSegments segmentSort
    
    -- åˆ›å»ºè¾“å‡ºç›®å½•
    local baseName = getFilenameFile animationSegments[1][1]
    baseName = substituteString baseName "_start" ""
    baseName = substituteString baseName "_loop" ""
    baseName = substituteString baseName "_end" ""
    baseName = substituteString baseName "start" ""
    baseName = substituteString baseName "loop" ""
    baseName = substituteString baseName "end" ""
    
    local timeStamp = localTime as string
    timeStamp = substituteString timeStamp "/" "-"
    timeStamp = substituteString timeStamp ":" "-"
    local outputDir = pathConfig.appendPath (getDir #scene) ("Merged_" + baseName + "_" + timeStamp)
    local bipDir = pathConfig.appendPath outputDir "BIP"
    local xafDir = pathConfig.appendPath outputDir "XAF"
    makeDir outputDir all:true
    makeDir bipDir all:true
    makeDir xafDir all:true
    
    -- è¿›åº¦è®¾ç½® - ä¿®å¤: ä½¿ç”¨æ­£ç¡®çš„.NETå±æ€§
    local totalSteps = animationSegments.count * 3 + 2 -- 3æ­¥æ“ä½œ: å¯¼å‡ºBIP, å¯¼å‡ºXAF, åˆå¹¶ + ä¿å­˜å’Œæ¸…ç†
    pbProgress.Minimum = 0
    pbProgress.Maximum = totalSteps
    pbProgress.Value = 0
    
    local currentProgress = 0
    local successCount = 0
    
    -- æŠ¥å‘Šæ•°æ®
    local reportData = "====== åˆ†æ®µåŠ¨ç”»åˆå¹¶æŠ¥å‘Š ======\n"
    reportData += "ç”Ÿæˆæ—¶é—´: " + localTime as string + "\n"
    reportData += "åŸºç¡€æ¨¡æ¿: " + baseName + "\n"
    reportData += "åˆå¹¶æ–‡ä»¶æ•°: " + animationSegments.count as string + "\n\n"
    
    -- ç¬¬ä¸€æ­¥: å¯¼å‡ºå„åˆ†æ®µçš„BIPå’ŒXAF
    local bipFiles = #()
    local xafFiles = #()
    local animationRanges = #()
    
    for i = 1 to animationSegments.count where not g_exportAbortFlag do (
        local segment = animationSegments[i]
        local filePath = segment[1]
        local fileName = segment[2]
        
        lblProgressInfo.text = "å¤„ç†åˆ†æ®µ: " + fileName
        
        -- åŠ è½½æ–‡ä»¶
        if loadMaxFile filePath quiet:true do (
            -- è·å–åŠ¨ç”»èŒƒå›´
            local animStart = animationRange.start
            local animEnd = animationRange.end
            
            -- ä¿®å¤: ä½¿ç”¨å¸§æ•°è®¡ç®—åŠ¨ç”»é•¿åº¦
            local animLength = (animEnd.frame - animStart.frame) as integer
            append animationRanges #(animStart, animEnd, animLength)
            
            -- å¯¼å‡ºBIP
            local bipRoots = for obj in objects where classOf obj == Biped_Object collect obj
            if bipRoots.count > 0 do (
                local bipPath = pathConfig.appendPath bipDir (fileName + ".bip")
                try (
                    biped.saveBipFile bipRoots[1].controller bipPath
                    append bipFiles #(bipPath, animStart, animEnd, animLength)
                    reportData += "BIPå¯¼å‡ºæˆåŠŸ: " + bipPath + "\n"
                ) catch (
                    reportData += "BIPå¯¼å‡ºå¤±è´¥: " + bipPath + " - " + (getCurrentException()) + "\n"
                )
            )
            
            currentProgress += 1
            -- ä¿®å¤: ç¡®ä¿è¿›åº¦å€¼ä¸è¶…è¿‡æœ€å¤§å€¼
            pbProgress.Value = amin currentProgress totalSteps
            
            -- å¯¼å‡ºXAF (é™„ä»¶éª¨éª¼)
            try (
                local xafPath = pathConfig.appendPath xafDir (fileName + ".xaf")
                if exportAttachmentBones filePath xafDir do (
                    append xafFiles #(xafPath, animStart, animEnd, animLength)
                    reportData += "XAFå¯¼å‡ºæˆåŠŸ: " + xafPath + "\n"
                )
            ) catch (
                reportData += "XAFå¯¼å‡ºå¤±è´¥: " + (getCurrentException()) + "\n"
            )
            
            currentProgress += 1
            -- ä¿®å¤: ç¡®ä¿è¿›åº¦å€¼ä¸è¶…è¿‡æœ€å¤§å€¼
            pbProgress.Value = amin currentProgress totalSteps
            
            resetMaxFile #noPrompt
            successCount += 1
        )
        
        currentProgress += 1
        -- ä¿®å¤: ç¡®ä¿è¿›åº¦å€¼ä¸è¶…è¿‡æœ€å¤§å€¼
        pbProgress.Value = amin currentProgress totalSteps
        windows.processPostedMessages()
    )
    
    -- ç¬¬äºŒæ­¥: æ‰“å¼€ç¬¬ä¸€ä¸ªåˆ†æ®µæ–‡ä»¶ä½œä¸ºæ¨¡æ¿
    lblProgressInfo.text = "æ‰“å¼€æ¨¡æ¿æ–‡ä»¶..."
    windows.processPostedMessages()
    
    local templatePath = animationSegments[1][1]
    if not (loadMaxFile templatePath quiet:true) do (
        messageBox "æ— æ³•æ‰“å¼€æ¨¡æ¿æ–‡ä»¶ï¼" title:"é”™è¯¯"
        return false
    )
    
    -- æ¸…ç©ºå½“å‰åœºæ™¯çš„åŠ¨ç”»
    lblProgressInfo.text = "æ¸…ç©ºæ¨¡æ¿æ–‡ä»¶åŠ¨ç”»..."
    windows.processPostedMessages()
    
    -- æ¸…ç©ºBipedåŠ¨ç”»
    local bipRoots = for obj in objects where classOf obj == Biped_Object collect obj
    if bipRoots.count > 0 do (
        local bipRoot = bipRoots[1]
        try (
            -- åˆ é™¤æ‰€æœ‰Bipedå…³é”®å¸§
            biped.deleteKeys bipRoot.controller #allKeys
            reportData += "å·²æ¸…ç©ºBipedåŠ¨ç”»\n"
        ) catch (
            reportData += "æ¸…ç©ºBipedåŠ¨ç”»å¤±è´¥: " + (getCurrentException()) + "\n"
        )
    )
    
    -- æ¸…ç©ºéª¨éª¼å’Œè™šæ‹Ÿä½“åŠ¨ç”»
    local boneNodes = for obj in objects where (
        classOf obj == BoneGeometry or 
        classOf obj == Dummy or 
        classOf obj == Point
    ) collect obj
    
    for bone in boneNodes do (
        try (
            deleteKeys bone.controller #allKeys
        ) catch ()
    )
    reportData += "å·²æ¸…ç©ºéª¨éª¼åŠ¨ç”»\n"
    
    currentProgress += 1
    -- ä¿®å¤: ç¡®ä¿è¿›åº¦å€¼ä¸è¶…è¿‡æœ€å¤§å€¼
    pbProgress.Value = amin currentProgress totalSteps
    
    -- ç¬¬ä¸‰æ­¥: åˆå¹¶åŠ¨ç”»åˆ°å½“å‰åœºæ™¯
    lblProgressInfo.text = "åˆå¹¶åŠ¨ç”»åˆ°æ¨¡æ¿..."
    windows.processPostedMessages()
    
    -- æŸ¥æ‰¾Bipedæ ¹èŠ‚ç‚¹
    local bipRoot = undefined
    local bipRoots = for obj in objects where classOf obj == Biped_Object collect obj
    if bipRoots.count > 0 do bipRoot = bipRoots[1]
    
    -- è®¡ç®—æ€»æ—¶é—´èŒƒå›´
    local totalLength = 0
    for range in animationRanges do (
        totalLength += range[3]
    )
    
    -- è®¾ç½®åŠ¨ç”»èŒƒå›´
    animationRange = interval 0f (totalLength as time)
    
    -- åˆå¹¶BIPåŠ¨ç”» - ä¿®å¤: ä½¿ç”¨æ­£ç¡®çš„æ—¶é—´è®¾ç½®æ–¹æ³•
    local currentFrame = 0
    
    for i = 1 to bipFiles.count do (
        local bipInfo = bipFiles[i]
        local bipPath = bipInfo[1]
        local segLength = bipInfo[4]
        
        if doesFileExist bipPath and bipRoot != undefined do (
            try (
                -- ä¿®å¤: ä½¿ç”¨æ­£ç¡®çš„æ—¶é—´è®¾ç½®æ–¹æ³•
                at time (currentFrame as time)
                (
                    -- åŠ è½½BIPæ–‡ä»¶åˆ°å¯¹åº”æ—¶é—´èŒƒå›´
                    biped.loadBipFile bipRoot.controller bipPath append:true
                    reportData += "BIPåˆå¹¶æˆåŠŸ: " + bipPath + " -> " + (currentFrame as string) + "å¸§\n"
                    
                    -- åˆ·æ–°Bipedæ˜¾ç¤º
                    biped.update bipRoot #all
                )
            ) catch (
                reportData += "BIPåˆå¹¶å¤±è´¥: " + bipPath + " - " + (getCurrentException()) + "\n"
            )
        )
        
        currentFrame += segLength
    )
    
    -- åˆå¹¶XAFåŠ¨ç”» (å¦‚æœæœ‰)
    if xafFiles.count > 0 do (
        lblProgressInfo.text = "åˆå¹¶é™„ä»¶åŠ¨ç”»..."
        windows.processPostedMessages()
        
        -- æ”¶é›†åœºæ™¯ä¸­çš„éª¨éª¼å’Œè™šæ‹Ÿä½“
        local boneNodes = for obj in objects where (
            classOf obj == BoneGeometry or 
            classOf obj == Dummy or 
            classOf obj == Point
        ) collect obj
        
        currentFrame = 0
        
        for i = 1 to xafFiles.count do (
            local xafInfo = xafFiles[i]
            local xafPath = xafInfo[1]
            local segLength = xafInfo[4]
            
            if doesFileExist xafPath and boneNodes.count > 0 do (
                try (
                    -- ä¿®å¤: ä½¿ç”¨æ­£ç¡®çš„æ—¶é—´è®¾ç½®æ–¹æ³•
                    at time (currentFrame as time)
                    (
                        -- åŠ è½½XAFæ–‡ä»¶
                        LoadSaveAnimation.loadAnimation xafPath boneNodes relative:false insert:false
                        reportData += "XAFåˆå¹¶æˆåŠŸ: " + xafPath + "\n"
                    )
                ) catch (
                    reportData += "XAFåˆå¹¶å¤±è´¥: " + xafPath + " - " + (getCurrentException()) + "\n"
                )
            )
            
            currentFrame += segLength
        )
    )
    
    currentProgress += 1
    -- ä¿®å¤: ç¡®ä¿è¿›åº¦å€¼ä¸è¶…è¿‡æœ€å¤§å€¼
    pbProgress.Value = amin currentProgress totalSteps
    
    -- ç¬¬å››æ­¥: ä¿å­˜åˆå¹¶åçš„åœºæ™¯
    lblProgressInfo.text = "ä¿å­˜åˆå¹¶æ–‡ä»¶..."
    windows.processPostedMessages()
    
    -- ä¿®å¤: ç¡®ä¿æ–‡ä»¶åæ­£ç¡®å»é™¤åˆ†æ®µæ ‡è¯†
    local finalBaseName = baseName
    if matchPattern finalBaseName pattern:"*_Merged" do (
        finalBaseName = substituteString finalBaseName "_Merged" ""
    )
    
    local mergedMaxPath = pathConfig.appendPath outputDir (finalBaseName + "_Merged.max")
    try (
        saveMaxFile mergedMaxPath
        reportData += "\nåˆå¹¶åœºæ™¯ä¿å­˜æˆåŠŸ: " + mergedMaxPath + "\n"
        
        -- éªŒè¯ä¿å­˜çš„æ–‡ä»¶
        if doesFileExist mergedMaxPath then (
            local fileSize = getFileSize mergedMaxPath
            reportData += "æ–‡ä»¶å¤§å°: " + (fileSize as string) + " å­—èŠ‚\n"
        )
    ) catch (
        reportData += "åœºæ™¯ä¿å­˜å¤±è´¥: " + (getCurrentException()) + "\n"
    )
    
    currentProgress += 1
    -- ä¿®å¤: ç¡®ä¿è¿›åº¦å€¼ä¸è¶…è¿‡æœ€å¤§å€¼
    pbProgress.Value = amin currentProgress totalSteps
    
    -- ä¿å­˜æŠ¥å‘Š
    local reportPath = pathConfig.appendPath outputDir "Merge_Report.txt"
    try (
        local reportFile = createFile reportPath
        format "%" reportData to:reportFile
        close reportFile
    ) catch ()
    
    -- å®Œæˆå¤„ç†
    lblProgressInfo.text = "åˆ†æ®µåŠ¨ç”»åˆå¹¶å®Œæˆï¼æˆåŠŸå¤„ç† " + successCount as string + " ä¸ªæ–‡ä»¶"
    
    if chk_autoOpenDir.checked do (
        ShellLaunch "explorer.exe" outputDir
    )
    
    -- æ˜¾ç¤ºæŠ¥å‘Š
    messageBox ("åˆå¹¶å®Œæˆï¼\n\nå·²å¤„ç†: " + successCount as string + " ä¸ªæ–‡ä»¶\nè¾“å‡ºç›®å½•: " + outputDir) title:"åˆ†æ®µåŠ¨ç”»åˆå¹¶"
    
    true
)


-- åœ¨ rollout çš„ on äº‹ä»¶åŒºåŸŸæ·»åŠ æŒ‰é’®äº‹ä»¶
on btnBatchExportXAFChecked pressed do
(
    batchExportXAFChecked()
)

-- åœ¨AutoExportTool_Pro rolloutä¸­æ·»åŠ XAF-ç¼–è¾‘/æŒ‰é’®äº‹ä»¶å¤„ç†
on btnBatchExportXAF pressed do (
    g_lastAction = "æ‰¹é‡å¯¼å‡ºXAF"
    updateModeStatus()
    batchExportXAF()
)

on btnBatchImportXAF pressed do (
    g_lastAction = "æ‰¹é‡å¯¼å…¥XAF"
    updateModeStatus()
    batchImportXAF()
)

on btnOpenXAFEditor pressed do (
    try (
        createDialog rolXAFEditor modal:false
        g_lastAction = "æ‰“å¼€XAFç¼–è¾‘å™¨"
        updateModeStatus()
    )
    catch (
        format "[XAFç¼–è¾‘å™¨æ‰“å¼€é”™è¯¯] %\n" (getCurrentException())
        messageBox ("æ— æ³•æ‰“å¼€XAFç¼–è¾‘å™¨:\n" + (getCurrentException())) title:"é”™è¯¯"
    )
)

-- åœ¨BIPç»„æŒ‰é’®äº‹ä»¶ä¸­æ·»åŠ è°ƒç”¨
on btnMergeSegments pressed do (
    g_lastAction = "åˆå¹¶åˆ†æ®µåŠ¨ç”»"
    updateModeStatus()
    mergeSegmentAnimations()
)
-- ===================== äº‹ä»¶å¤„ç† =====================
on btnBatchSyncSelSets pressed do (
    g_lastAction = "âˆ¥åŒæ­¥-é€‰æ‹©é›†â€‹"
    updateModeStatus()
    batchSyncSelectionSets()
)

-- åˆå¹¶æŒ‰é’®äº‹ä»¶å¤„ç†
on btnBatchMerge pressed do (
    g_lastAction = "â§ºåˆå¹¶-æŒ‚ç‚¹"
    updateModeStatus()
    batchMergeSocketFiles()
)

-- æ”¹åå·¥å…·çš„å‘¼å‡º
on btnRenameTool pressed do (try(destroyDialog RenameToolRollout)catch(); createDialog RenameToolRollout)

-- false / å¤‡ç”¨ / ï¼ˆ æœªéªŒè¯ ï¼‰
on btnCharacterMapping pressed do
(
    g_lastAction = "ç®¡ç†-è§’è‰²æ˜ å°„"
    updateModeStatus()
    createdialog  rolCharacterMapping pos:mouse.screenpos
)

-- false / å¤‡ç”¨ / -- false / å¤‡ç”¨ / ï¼ˆ æ‰¹é‡å¯¼å‡º-è™½ç„¶å·²éªŒè¯ï¼ŒUIé‡å¤-filepathä½ç½®å ä½å¤šä½™ï¼Œç›®å‰åªä¿ç•™ä¸€ä¸ªå¿…è¦çš„ä¿å­˜è·¯å¾„ï¼‰
on btnBrowseEngine pressed do
(
    local initDir = if g_engineProjectPath != "" then g_engineProjectPath else "C:\\"
    local dir = getSavePath caption:"é€‰æ‹©å¼•æ“é¡¹ç›®ç›®å½•" initialDir:initDir
    if dir != undefined do (
        edtEnginePath.text = pathConfig.normalizePath dir
        g_engineProjectPath = edtEnginePath.text
    )
)

--  false / å¤‡ç”¨æ–¹æ¡ˆ ï¼Œå¤‡ç”¨æ–¹æ¡ˆ ï¼Œéœ€è¦å…¨å±€è°ƒè¯• ç›®å‰ åª æ”¯æŒ æ‰¹é‡å¯¼å‡ºäº‹ä»¶æŒ‰é’® / å·² æ³¨é”€ ï¼ˆæ„Ÿè§‰UI å¸ƒå±€ å¤šä½™ ï¼Œä¿å­˜è·¯å¾„ä¹Ÿèƒ½æ”¯æŒå…¶ä»–è·¯å¾„ï¼Œåªæ˜¯ç¼ºå°‘è§’è‰²æ–‡ä»¶å¤¹çš„æ˜ å°„ï¼Œç›®å‰åŠŸèƒ½æ»¡è¶³åŸºç¡€çš„æ‰¹é‡å¯¼å‡ºï¼‰
on chkExportToEngine changed state do
(
    g_exportToEngine = state
    edtExportPath.enabled = not state
    btnBrowsePath.enabled = not state
    btnOpenExportPath.enabled = not state
    
    if state then (
        lblProgressInfo.text = "å¯¼å‡ºç›®æ ‡: å¼•æ“é¡¹ç›®"
    ) else (
        lblProgressInfo.text = "å¯¼å‡ºç›®æ ‡: æœ¬åœ°è·¯å¾„"
    )
)

-- åº”è¯¥æ˜¯ ç‚¹å‡» å…¶ä»– ç»‘å®š ç‚¹å‡»  äº‹ä»¶ - äº‹ä»¶ç¡®è®¤ / ç»“æŸ ç¼–è¾‘çŠ¶æ€ 
on Lv_model MouseClick e do (
    try(
        --if g_editTextBox = 0  and e.Button == e.Button.Left then 
    --dotNet.addEventHandler e.Button.Left "Click" (fn s e = 
       --createEditTextBox item 
       --finishEditing()
    --)
        -- å¦‚æœæ­£åœ¨ç¼–è¾‘ï¼Œç‚¹å‡»å…¶ä»–åœ°æ–¹å®Œæˆç¼–è¾‘
        if g_editTextBox != undefined and e.Button == e.Button.Left do (
            
            finishEditing()
        )
    ) 
    catch (
        format "[ç‚¹å‡»äº‹ä»¶é”™è¯¯] %\n" (getCurrentException())
    )
)

-- å³é”®èœå•æ‰©å±•ï¼ˆåœ¨ç©ºä½™åŒºåŸŸï¼‰
on AutoExportTool_Pro rbuttonup pos do (
    -- åˆ›å»ºå³é”®èœå•
    local contextMenu = dotNetObject "System.Windows.Forms.ContextMenuStrip"
    
    -- æ£€æµ‹æ›´æ–°èœå•é¡¹ï¼ˆæ”¾åœ¨æœ€å‰é¢ï¼‰
    local updateText = if g_updateAvailable then "ğŸ”„ æ£€æµ‹æ›´æ–° NEWâ— |ã€CheckUpdateã€‘" else "ğŸ”„ æ£€æµ‹æ›´æ–° |ã€CheckUpdateã€‘"
    local updateItem = contextMenu.Items.Add(updateText)
    updateItem.Image = (dotNetClass "System.Drawing.SystemIcons").WinLogo.ToBitmap()
    dotNet.addEventHandler updateItem "Click" (fn s e = 
        checkForUpdates()
    )
    
    -- è‡ªåŠ¨æ›´æ–°è®¾ç½®èœå•é¡¹
local autoUpdateItem = contextMenu.Items.Add("âš™ï¸ è‡ªåŠ¨æ£€æŸ¥æ›´æ–°")
autoUpdateItem.Checked = g_autoCheckUpdate
dotNet.addEventHandler autoUpdateItem "Click" (fn s e = (
    g_autoCheckUpdate = not g_autoCheckUpdate
    setINISetting g_UIConfigPath "Settings" "AutoCheckUpdate" (g_autoCheckUpdate as string)
    try (destroyDialog AutoExportTool_Pro) catch()
        fileIn (getSourceFileName())
        createDialog AutoExportTool_Pro
    ))
    -- ä¸å°è¯•æ›´æ–°å½“å‰èœå•é¡¹çŠ¶æ€ï¼Œä¸‹æ¬¡æ‰“å¼€èœå•æ—¶ä¼šæ­£ç¡®æ˜¾ç¤º
    -- ä¸è¦è¿”å›ä»»ä½•å€¼
    -- åˆ†éš”çº¿
    contextMenu.Items.Add((dotNetObject "System.Windows.Forms.ToolStripSeparator"))
    
    -- å¸®åŠ©èœå•
    local helpItem = contextMenu.Items.Add("å¸®åŠ© |ã€Helpã€‘")
    helpItem.Image = (dotNetClass "System.Drawing.SystemIcons").Question.ToBitmap()
    
    -- å¸®åŠ©å­èœå•
    local helpSubMenu = dotNetObject "System.Windows.Forms.ContextMenuStrip"
    
    local videoTutorialItem = helpSubMenu.Items.Add("è§†é¢‘æ•™ç¨‹")
    dotNet.addEventHandler videoTutorialItem "Click" (fn s e = 
        openHelpLink "https://space.bilibili.com/327573825"
    )
    
    local helpDocItem = helpSubMenu.Items.Add("å¸®åŠ©æ–‡æ¡£")
    dotNet.addEventHandler helpDocItem "Click" (fn s e = 
        openHelpLink "https://ladyicefox.github.io/autoexporttool-docs/"
    )
    
    local issueItem = helpSubMenu.Items.Add("é—®é¢˜å»ºè®®")
    dotNet.addEventHandler issueItem "Click" (fn s e = 
        openHelpLink "https://github.com/ladyicefox/autoexporttool-docs/issues"
    )
    
    helpSubMenu.Items.Add((dotNetObject "System.Windows.Forms.ToolStripSeparator"))
    
    local bilibiliItem = helpSubMenu.Items.Add("ğŸ“ºBilibili")
    dotNet.addEventHandler bilibiliItem "Click" (fn s e = 
        openHelpLink "https://space.bilibili.com/327573825"
    )
    
    local qqItem = helpSubMenu.Items.Add("ğŸ§Qzone")
    dotNet.addEventHandler qqItem "Click" (fn s e = 
        openHelpLink "https://user.qzone.qq.com/240811498"
    )
    
    helpItem.DropDown = helpSubMenu
    
    -- åˆ†éš”çº¿
    contextMenu.Items.Add((dotNetObject "System.Windows.Forms.ToolStripSeparator"))
    
  -- æ·»åŠ è‡ªå¯èœå•é¡¹ï¼ˆå¸¦çŠ¶æ€æ ‡è®°ï¼‰
  local autoStartItem = contextMenu.Items.Add("â„µ æ˜¯å¦éš3dMaxè‡ªå¯ |ã€Auto-SWMAXã€‘")
  autoStartItem.Checked = g_autoStartEnabled
  dotNet.addEventHandler autoStartItem "Click" (fn s e = (
      toggleAutoStart()
      
  ))

    -- åˆ†éš”çº¿
    --contextMenu.Items.Add((dotNetObject "System.Windows.Forms.ToolStripSeparator"))
 
    -- æ·»åŠ å·¥å…·æ èœå•ï¼ˆå¸¦çŠ¶æ€æ ‡è®°ï¼‰
    local toolbarText = if g_toolbarAdded then "ğ“€€ å·¥å…·æ å·²æ·»åŠ  |ã€Auto-STBMaxã€‘" else "ğ“€€ å·¥å…·æ å·²å¸è½½ |ã€Auto-Unistalledã€‘"
    local toolbarItem = contextMenu.Items.Add(toolbarText)
    toolbarItem.Checked = g_toolbarAdded

    -- æ·»åŠ çŠ¶æ€å›¾æ ‡
    if g_toolbarAdded then (
        toolbarItem.Image = (dotNetClass "System.Drawing.SystemIcons").Shield.ToBitmap()
    ) else (
        toolbarItem.Image = (dotNetClass "System.Drawing.SystemIcons").Warning.ToBitmap()
    )

    -- å·¥å…·æ ç‚¹å‡»å¤„ç†å‡½æ•°
    fn toolbarClickHandler sender e = (
        if g_toolbarAdded then (
            removeToolbarFromMax()
            sender.Text = "ğ“€€ å·¥å…·æ å·²å¸è½½ |ã€Auto-Unistalledã€‘"
        ) else (
            addToolbarToMax()
            sender.Text = "ğ“€€ å·¥å…·æ å·²æ·»åŠ  |ã€Auto-STBMaxã€‘"
            
            -- å¦‚æœå·¥å…·æ æ·»åŠ æˆåŠŸï¼Œè‡ªåŠ¨å¼€å¯è‡ªå¯åŠ¨
            if g_toolbarAdded and not g_autoStartEnabled then (
                toggleAutoStart()
                
                -- æ›´æ–°è‡ªå¯åŠ¨èœå•é¡¹çŠ¶æ€ï¼ˆä½¿ç”¨éå†æŸ¥æ‰¾ï¼‰
                for i = 0 to (sender.Owner.Items.Count - 1) do (
                    local item = sender.Owner.Items.Item[i]
                    if item.Text == "â„µ æ˜¯å¦éš3dMaxè‡ªå¯ |ã€Auto-SWMAXã€‘" then (
                        item.Checked = true
                        exit
                    )
                )
            )
        )
        
        -- æ›´æ–°å‹¾é€‰çŠ¶æ€å’Œå›¾æ ‡
        sender.Checked = g_toolbarAdded
        if g_toolbarAdded then (
            sender.Image = (dotNetClass "System.Drawing.SystemIcons").Shield.ToBitmap()
        ) else (
            sender.Image = (dotNetClass "System.Drawing.SystemIcons").Warning.ToBitmap()
        )
    )
    
    -- æ·»åŠ äº‹ä»¶å¤„ç†
    dotNet.addEventHandler toolbarItem "Click" toolbarClickHandler

    -- åˆ†éš”çº¿
    contextMenu.Items.Add((dotNetObject "System.Windows.Forms.ToolStripSeparator"))
    
    -- æ·»åŠ é‡å¯æ’ä»¶é¡¹
    local restartItem = contextMenu.Items.Add("ğŸ”„â€‹â€‹â€‹â€‹ é‡å¯æ’ä»¶ |ã€Auto-RSToolã€‘")
    restartItem.Image = (dotNetClass "System.Drawing.SystemIcons").Information.ToBitmap()
    dotNet.addEventHandler restartItem "Click" (fn s e = (
        try (destroyDialog AutoExportTool_Pro) catch()
        fileIn (getSourceFileName())
        createDialog AutoExportTool_Pro
    ))
    
    
    -- åˆ†éš”ç¬¦
    contextMenu.Items.Add((dotNetObject "System.Windows.Forms.ToolStripSeparator"))
    
    
    -- å…³é—­èœå•
    local closeItem = contextMenu.Items.Add("ğŸ“› å…³é—­å·¥å…· |ã€CloseToolã€‘")
    closeItem.Image = (dotNetClass "System.Drawing.SystemIcons").Error.ToBitmap()
    dotNet.addEventHandler closeItem "Click" (fn s e = 
        try (destroyDialog AutoExportTool_Pro) catch()
    )
    -- åˆ†éš”ç¬¦
    contextMenu.Items.Add((dotNetObject "System.Windows.Forms.ToolStripSeparator"))
        
    -- å…³äºèœå•é¡¹
    local aboutItem = contextMenu.Items.Add("â„¹ï¸ å…³äº")
    aboutItem.Image = (dotNetClass "System.Drawing.SystemIcons").Information.ToBitmap()
    dotNet.addEventHandler aboutItem "Click" (fn s e = 
        messageBox ("AutoExportTool Pro\nç‰ˆæœ¬: v" + g_currentVersion + "\nä½œè€…: å¶ç§‹") title:"å…³äº"
    )
    
    -- æ˜¾ç¤ºèœå•
    contextMenu.Show (mouse.screenPos[1]) (mouse.screenPos[2])
)

-- ç‰ˆæœ¬ç®¡ç†æŒ‰é’®äº‹ä»¶/maxç‰ˆæœ¬ç®¡ç†/äº‹ä»¶ / false / å¤‡ç”¨
--on btnVersionManager pressed do (
    --try(destroyDialog rolVersionManager)catch()
    --createDialog rolVersionManager pos:mouse.screenpos style:#(#style_titlebar, #style_border, #style_sysmenu, #style_minimizebox)
--)

-- ============================çª—å£æ‹–åŠ¨åŠŸèƒ½==================================

         -- ====== çº¯ MaxScript æ‹–åŠ¨å®ç° / å®‰å…¨çš„äº‹ä»¶å¤„ç† ====== 

on lblDragArea mousedown pos do
        (
            try (
                dragging = true
                dragStartPos = mouse.screenPos
                windowStartPos = getDialogPos AutoExportTool_Pro
            ) catch (
                dragging = false
            )
        )
        
on lblDragArea mousemove pos do
        (
            if dragging do
            (
                try (
                    -- å®‰å…¨è·å–é¼ æ ‡ä½ç½®
                    local currentPos = [0,0]
                    if classof mouse == Point2 then currentPos = mouse.screenPos
                    
                    -- å®‰å…¨è®¡ç®—æ–°ä½ç½®
                    local delta = currentPos - dragStartPos
                    local newPos = windowStartPos + delta
                    
                    -- å®‰å…¨è®¾ç½®çª—å£ä½ç½®
                    if isValidPos newPos do
                    (
                        setDialogPos AutoExportTool_Pro newPos
                    )
                ) catch (
                    dragging = false
                )
            )
        )
        
on lblDragArea mouseup pos do
        (
            dragging = false
        )
        
-- è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥ä½ç½®æ˜¯å¦æœ‰æ•ˆ
fn isValidPos pos =
(
    try (
        return classof pos == Point2 and pos.x > -10000 and pos.y > -10000 and pos.x < 10000 and pos.y < 10000
    ) catch (
        return false
    )
)
 
-- ====== çº¯ DotNet æ‹–åŠ¨å®ç°  ====== ï¼ˆ åŠŸèƒ½éªŒè¯å®ç° / true ,æœ‰ç¼ºé™·,ä¸»å±æ‹–åŠ¨é—®é¢˜ä¸å¤§ï¼›åˆ†å±ä¸å®æ—¶ï¼Œæœ‰ä¹±åŠ¨ç°è±¡ / å¯ä¼˜åŒ–  )
on lblTitle MouseDown arg do
    (
        
        g_dragging = true
        g_dragStartPos = mouse.screenPos
        
)

on lblTitle MouseMove arg do
    (
        if g_dragging and arg.button == arg.button.left then
        (
            local currentPos = mouse.screenPos
            local delta = currentPos - g_dragStartPos
            setDialogPos AutoExportTool_Pro (getDialogPos AutoExportTool_Pro + delta)
            g_dragStartPos = currentPos
        )
    )
    
on lblTitle MouseUp arg do
    (
        g_dragging = false
    )
    

-- ==========================================================================
-- å…³é—­æ’ä»¶ / ä¸»æ’ä»¶æ ‡é¢˜æŠ¬å¤´ add + å…³é—­æ’ä»¶æŒ‰é’® / true ( æ— è¾¹æ¡†æ¨¡å¼ åŠ ä¸ª å…³é—­ æ¨¡æ‹Ÿä¸€ä¸‹å…³é—­ï¼Œå¯ç‚¹å‡» å…³é—­..)
on btnClose pressed do 
 (
     destroyDialog AutoExportTool_Pro
 )

 -- ==========================================================================

 -- é‡å¯æ’ä»¶/æŒ‰é’®ç‚¹å‡»äº‹ä»¶
on btnRestartPlugin pressed do (
    g_lastAction = "â€‹â€‹â»â€‹æ’ä»¶-é‡å¯"
    updateModeStatus()
    restartPlugin()
)
-- æŒ‰é’®äº‹ä»¶å¤„ç†- æ–°å¢ç‹¬ç«‹åˆ·æ–°åˆ—è¡¨
on btnRefreshList pressed do (
    g_lastAction = "â†»åˆ—è¡¨-åˆ·æ–°"
    updateModeStatus()
    local currentPath = edtExportPath.text -- ä¿æŒå½“å‰è·¯å¾„ä¸å˜
    if doesDirectoryExist currentPath do (
        edtExportPath.text = currentPath -- æ˜¾å¼é‡ç½®ç¡®ä¿è·¯å¾„ä¸€è‡´
        refreshFileListView forceRefresh:true
        format "[åˆ·æ–°] è·¯å¾„ï¼š%\n" currentPath
    )
)
-- æŒ‰é’®äº‹ä»¶å¤„ç†ï¼ˆå®Œæ•´ä¿®å¤ç‰ˆï¼‰// äº‹ä»¶ / false (å¤±æ•ˆ/æœªå®ç°)
on btnCleanRecent pressed do (  -- å·¦é”®å¤„ç†
    if queryBox "æ˜¯å¦è®¾ç½®æœ€è¿‘æ–‡ä»¶æ˜¾ç¤ºæ•°é‡ä¸º10ä¸ªï¼Ÿ\n(ç«‹å³ç”Ÿæ•ˆ)" title:"è®¾ç½®" beep:false do (
        if setMaxRecentFileCountImmediately 10 do (
            messageBox "æœ€è¿‘æ–‡ä»¶æ˜¾ç¤ºæ•°é‡å·²è®¾ç½®ä¸º10ä¸ª" title:"æ“ä½œæˆåŠŸ"
        )
    )
)
--æœ€è¿‘æ–‡ä»¶ æ¸…ç† é‡ç½®è®°å½•æ–‡æ¡£ / äº‹ä»¶ / å®æµ‹ max 2022 ç”Ÿæ•ˆ - false(éƒ¨åˆ†ç‰ˆæœ¬ä¸æ”¯æŒ æ¯”å¦‚ MAX 2019ï¼ï¼ï¼) 
on btnCleanRecent rightclick do (  -- å³é”®å¤„ç†
    if keyboard.controlPressed then (  -- Ctrl+å³é”®ï¼šåˆ·æ–°åˆ—è¡¨
        refreshFileListView forceRefresh:true
    ) else (  -- æ™®é€šå³é”®ï¼šæ¸…ç©ºè®°å½•
        if queryBox "æ˜¯å¦å½»åº•æ¸…ç©ºæ‰€æœ‰æœ€è¿‘æ–‡ä»¶è®°å½•ï¼Ÿ\n(åŒ…æ‹¬å†…å­˜å’Œæ–‡ä»¶å­˜å‚¨)" title:"å±é™©æ“ä½œ" beep:true do (
            if clearRecentFilesCompletely() do (
                Lv_model.Items.Clear()
                lblCount.text = "æ–‡ä»¶ï¼š0"
                messageBox "æœ€è¿‘æ–‡ä»¶è®°å½•å·²å½»åº•æ¸…ç©ºï¼" title:"å®Œæˆ"
            )
        )
    )
)

--æ–°å¢æ—‹è½¬æ¨¡å¼å¼€å…³å’Œæ’é™¤å‰ç¼€è¾“å…¥æ¡†/ç›¸å…³äº‹ä»¶
on chk_useRotation changed state do (
    g_useCustomRotation = state
    rdo_rotation.visible = state
)
--æ–°å¢ XAF å¯¼å‡º æ•°æ®å±æ€§ tcb / euler--/å‹¾é€‰/äº‹ä»¶
on rdo_rotation changed state do (
    g_rotationMode = if state == 1 then #tcb else #euler
)
-- æ–°å¢ XAF / ç›¸å…³/äº‹ä»¶
on edt_excludePrefix entered text do (
    g_excludePrefix = text
)

--æ–°å¢æ–‡ä»¶å½’æ¡£æŒ‰é’®ï¼ˆåŠŸèƒ½ï¼šæŒ‰æ–‡ä»¶åå’Œæ—¶é—´ç­›é€‰æœ€æ–°ç‰ˆæœ¬æ–‡ä»¶ï¼Œè‡ªåŠ¨å½’æ¡£ï¼‰/äº‹ä»¶
on btnArchive pressed do (
    g_lastAction = "æ–‡ä»¶-å½’æ¡£"
    updateModeStatus()
    
    try (
        -- 1. åˆ›å»ºå½’æ¡£ç›®å½•
        local currentPath = pathConfig.normalizePath edtExportPath.text
        local timeArray = getLocalTime()  -- è·å–å½“å‰æ—¶é—´
        local dateStamp = formattedPrint timeArray[1] format:"04d" +  
                          formattedPrint timeArray[2] format:"02d" +   
                          formattedPrint timeArray[4] format:"02d"      
        local archiveDirName = "æ–‡ä»¶å½’æ¡£_" + dateStamp                  
        local archiveDir = pathConfig.appendPath currentPath archiveDirName
        
        -- æ£€æŸ¥å¹¶åˆ é™¤å·²å­˜åœ¨çš„å½“å¤©å½’æ¡£æ–‡ä»¶å¤¹
        if doesDirectoryExist archiveDir do (
            try (
                -- ä½¿ç”¨DOSå‘½ä»¤å¼ºåˆ¶åˆ é™¤æ–‡ä»¶å¤¹åŠå…¶å†…å®¹
                local cmd = "cmd /c rmdir /s /q \"" + archiveDir + "\""
                hiddenDOSCommand cmd
                format "[å½’æ¡£] åˆ é™¤å·²å­˜åœ¨çš„å½’æ¡£ç›®å½•: %\n" archiveDir
            )
            catch (
                format "[å½’æ¡£é”™è¯¯] æ— æ³•åˆ é™¤ç°æœ‰ç›®å½•: %\n" (getCurrentException())
                messageBox "æ— æ³•åˆ é™¤ç°æœ‰å½’æ¡£ç›®å½•ï¼Œè¯·æ‰‹åŠ¨åˆ é™¤åé‡è¯•" title:"é”™è¯¯"
                return false
            )
        )
        
        -- åˆ›å»ºæ–°çš„å½’æ¡£ç›®å½•
        makeDir archiveDir all:true
        format "[å½’æ¡£] åˆ›å»ºæ–°å½’æ¡£ç›®å½•: %\n" archiveDir
        
        lblProgressInfo.text = "æ­£åœ¨åˆ†ææ–‡ä»¶ç‰ˆæœ¬..."
        windows.processPostedMessages()
        
        -- 2. æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹
        local fileGroups = #()
        
        -- æ–‡ä»¶åè§£æå‡½æ•°
        fn parseVersion fName = (
            local parts = filterString fName "_"
            if parts.count > 1 and (matchPattern parts[parts.count] pattern:"v??") then (
                local verPart = parts[parts.count]
                local numStr = substring verPart 2 -1
                
                -- æ„å»ºåŸºç¡€åç§°
                local baseParts = for i=1 to parts.count-1 collect parts[i]
                local baseName = ""
                for p in baseParts do baseName += p + (if p != baseParts[baseParts.count] then "_" else "")
                baseName = trimRight baseName "_ "
                
                -- éªŒè¯æ•°å­—æœ‰æ•ˆæ€§
                if numStr as integer != undefined then (
                    return #(baseName, numStr as integer)
                )
            )
            #(fName, 0) -- æ— ç‰ˆæœ¬ä¿¡æ¯è¿”å›0
        )
        
        -- åˆ†ç»„å¤„ç†é€»è¾‘
        for f in model_files_array where (getFilenameType f == ".max") do (
            local fName = getFilenameFile f
            local parsed = parseVersion fName
            local found = false
            
            -- æŸ¥æ‰¾æˆ–åˆ›å»ºåˆ†ç»„
            for group in fileGroups where group.baseName == parsed[1] do (
                found = true
                if parsed[2] > group.maxNumber then (
                    group.maxNumber = parsed[2]
                    group.latestFile = f
                )
                if parsed[2] == 0 do group.originalFile = f
                exit
            )
            
            if not found do (
                local newGroup = FileGroup \
                    baseName:parsed[1] \
                    originalFile:(if parsed[2]==0 then f else undefined) \
                    latestFile:(if parsed[2]>0 then f else undefined) \
                    maxNumber:parsed[2]
                append fileGroups newGroup
            )
        )
        
        -- 2.5 æ–°å¢æ—¥æœŸåç¼€å¤„ç†å‡½æ•°
        fn addDateSuffix baseName = (
            -- ç§»é™¤æ—§æ—¥æœŸåç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if matchPattern baseName pattern:"*-??-?-?" do (
                local parts = filterString baseName "-"
                if parts.count >= 3 and \
                   isKindOf (parts[parts.count-2] as integer) Number and \
                   isKindOf (parts[parts.count-1] as integer) Number and \
                   isKindOf (parts[parts.count] as integer) Number do (
                    baseName = ""
                    for i=1 to (parts.count-3) do (
                        baseName += parts[i]
                        if i < (parts.count-3) do baseName += "-"
                    )
                )
            )
            
            -- æ·»åŠ æ–°æ—¥æœŸåç¼€
            local t = getLocalTime()  -- åœ¨å‡½æ•°å†…éƒ¨è·å–æ—¶é—´
            baseName += "-" + (formattedPrint (t[1]-2000) format:"02d") + "-" + \
                         (formattedPrint t[2] format:"02d") + "-" + \
                         (formattedPrint t[4] format:"02d")
            return baseName
        )
        
        -- 3. å®‰å…¨å¤åˆ¶æ–‡ä»¶ï¼ˆæ·»åŠ æ—¥æœŸåç¼€å¤„ç†ï¼‰
        local copyCount = 0
        local failedCount = 0
        
        for group in fileGroups do (
            -- å¤åˆ¶åŸå§‹æ–‡ä»¶
            if group.originalFile != undefined and doesFileExist group.originalFile do (
                local baseName = getFilenameFile group.originalFile
                local ext = getFilenameType group.originalFile
                
                -- æ·»åŠ æ—¥æœŸåç¼€ï¼ˆå¦‚æœå‹¾é€‰ï¼‰
                if chkAddDateSuffix.checked do baseName = addDateSuffix baseName
                
                local target = archiveDir + "\\" + baseName + ext
                if copyFile group.originalFile target then (
                    copyCount += 1
                ) else (
                    failedCount += 1
                    format "[å½’æ¡£é”™è¯¯] æ— æ³•å¤åˆ¶æ–‡ä»¶: % -> %\n" group.originalFile target
                )
            )
            
            -- å¤åˆ¶æœ€æ–°ç‰ˆæœ¬
            if group.latestFile != undefined and doesFileExist group.latestFile do (
                local baseName = getFilenameFile group.latestFile
                local ext = getFilenameType group.latestFile
                
                -- æ·»åŠ æ—¥æœŸåç¼€ï¼ˆå¦‚æœå‹¾é€‰ï¼‰
                if chkAddDateSuffix.checked do baseName = addDateSuffix baseName
                
                local target = archiveDir + "\\" + baseName + ext
                if copyFile group.latestFile target then (
                    copyCount += 1
                ) else (
                    failedCount += 1
                    format "[å½’æ¡£é”™è¯¯] æ— æ³•å¤åˆ¶æ–‡ä»¶: % -> %\n" group.latestFile target
                )
            )
        )
        
        -- 4. å¤„ç†éç‰ˆæœ¬æ–‡ä»¶ï¼ˆæ·»åŠ æ—¥æœŸåç¼€å¤„ç†ï¼‰
        for f in model_files_array where (getFilenameType f == ".max") do (
            local isVersioned = false
            for group in fileGroups do (
                if findItem #(group.originalFile, group.latestFile) f > 0 do (
                    isVersioned = true
                    exit
                )
            )
            if not isVersioned and doesFileExist f do (
                local baseName = getFilenameFile f
                local ext = getFilenameType f
                
                -- æ·»åŠ æ—¥æœŸåç¼€ï¼ˆå¦‚æœå‹¾é€‰ï¼‰
                if chkAddDateSuffix.checked do baseName = addDateSuffix baseName
                
                local target = archiveDir + "\\" + baseName + ext
                if copyFile f target then (
                    copyCount += 1
                ) else (
                    failedCount += 1
                    format "[å½’æ¡£é”™è¯¯] æ— æ³•å¤åˆ¶æ–‡ä»¶: % -> %\n" f target
                )
            )
        )
        
        -- åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
        AutoExportTool_Pro.refreshFileListView()
        
        -- å®Œæˆåé¦ˆ
        ShellLaunch "explorer.exe" archiveDir
        
        local resultMsg = "æ–‡ä»¶å½’æ¡£å®Œæˆï¼æˆåŠŸå¤åˆ¶: " + copyCount as string + " ä¸ªæ–‡ä»¶"
        if failedCount > 0 do resultMsg += "ï¼Œå¤±è´¥: " + failedCount as string + " ä¸ªæ–‡ä»¶"
        
        lblProgressInfo.text = resultMsg
        
        if failedCount == 0 then (
            messageBox (resultMsg + "\nä½ç½®: " + archiveDir) title:"æ“ä½œå®Œæˆ" beep:false
        ) else (
            messageBox (resultMsg + "\nè¯·æ£€æŸ¥æ–‡ä»¶æƒé™æˆ–ç£ç›˜ç©ºé—´") title:"æ“ä½œå®Œæˆ(éƒ¨åˆ†å¤±è´¥)" beep:true
        )
        
    ) catch (
        format "[å½’æ¡£é”™è¯¯] %\n" (getCurrentException())
        messageBox ("å½’æ¡£è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: " + (getCurrentException())) title:"é”™è¯¯" beep:true
    )
)

--åŠŸèƒ½ï¼šæ‰‹åŠ¨æ¸…ç†åœºæ™¯å†—ä½™èµ„æºï¼Œé‡Šæ”¾å†…å­˜
on btnGC pressed do (
    g_lastAction = "æ¸…ç†-åœºæ™¯ï¼ï¼ï¼"
    updateModeStatus()
    -- æ‰§è¡Œå…¨é¢æ¸…ç†
    disableSceneRedraw()
    gc()          -- åƒåœ¾å›æ”¶
    freeSceneBitmaps()  -- é‡Šæ”¾è´´å›¾å†…å­˜
    enableSceneRedraw()
    completeRedraw()
    lblProgressInfo.text = "å½“å‰åœºæ™¯æ¸…ç†å®Œæˆï¼ï¼ï¼" 
    messageBox "åœºæ™¯èµ„æºå·²æ¸…ç†ï¼" title:"GCå®Œæˆ" beep:false
)

--lv-åˆ—è¡¨/æ¢å¤åˆå§‹CP-é¢œè‰²/æ˜¾ç¤ºæ§åˆ¶
on btnResetColor pressed do (
    g_lastAction = "ï¿½ï¿½å§‹CP-é¢œè‰²"
    updateModeStatus()
    cpFolder.color = color 245 245 125
    cpFile.color = color 255 255 255
    
    --Lv_model.Font = dotNetObject "System.Drawing.Font" "å¾®è½¯é›…é»‘" 8 ((dotNetClass "System.Drawing.FontStyle").Bold)
)
----------------------------------------------------------------
--on cpGridLine changed newColor do (
    --g_gridLineColor = (dotNetClass "System.Drawing.Color").FromArgb newColor.r newColor.g newColor.b
--)
----------------------------------------------------------------
--lv-åˆ—è¡¨/ç½‘æ ¼çº¿/æ˜¾ç¤ºæ§åˆ¶
on chkGridLines changed state do (
    g_lastAction = "ç½‘æ ¼çº¿/æ˜¾ç¤º"
    updateModeStatus()
    Lv_model.GridLines = state
	--Lv_model.Font = dotNetObject "System.Drawing.Font" "å®‹ä½“" 10 ((dotNetClass "System.Drawing.FontStyle").Regular)
    Lv_model.Refresh()
    --saveUIConfig() -- å®æ—¶ä¿å­˜çŠ¶æ€
)

-- lv-åˆ—è¡¨//å‹¾é€‰æ¡†äº‹ä»¶å¤„ç†-ä¿®æ”¹å­—ä½“åˆ‡æ¢äº‹ä»¶
on chkChangeFont changed state do (
    g_lastAction = "åˆ‡æ¢-å­—ä½“!!!"
    updateModeStatus()
    Lv_model.Font = if state then g_alternateFont else g_defaultFont   
	g_forceCustomLayout = state -- æ›´æ–°å…¨å±€çŠ¶æ€
    -- æ›´æ–°lvHeaderåˆ—å®½
    local targetTypeWidth = if state then 145 else 125
    lvHeader.Columns.Item[2].Width = targetTypeWidth  -- ç¬¬ä¸‰åˆ—å®½åº¦
    
    lvHeader.Columns.Item[2].Width = if state then 145 else 125  -- ç¬¬ä¸‰åˆ—
    
    lvHeader.Refresh()
	
	adjustColumnWidths forceCustom:state -- ç«‹å³åº”ç”¨æ–°å¸ƒå±€
)

-- åœ¨ edtPathDir çš„ entered äº‹ä»¶ä¸­æ·»åŠ 
on edtPathDir entered txt do (
    
    updateModeStatus()  -- ç»Ÿä¸€è°ƒç”¨çŠ¶æ€æ›´æ–°

    if not doesDirectoryExist txt do (
        messageBox "è·¯å¾„æ— æ•ˆæˆ–ä¸å¯è®¿é—®ï¼" title:"è¾“å…¥é”™è¯¯"
        edtPathDir.text = getDir #scene
    )
)
--æ¢å¤é»˜è®¤è·¯å¾„
on btnResetPath pressed do (
	g_lastAction = "è·¯å¾„-æ¢å¤"
    updateModeStatus()  -- ç»Ÿä¸€è°ƒç”¨çŠ¶æ€æ›´æ–°
    local currentDir = maxFilePath
 
    -- å»é™¤è·¯å¾„æœ«å°¾çš„åæ–œæ ï¼ˆå¦‚æœå­˜åœ¨ï¿½ï¿½
    if currentDir != "" and currentDir[currentDir.count] == "\\" do (
        currentDir = substring currentDir 1 (currentDir.count - 1)
    )
    edtExportPath.text = getDir #scene
    edtExportPath.text = currentDir
    refreshFileListView()
g_showRecentFiles = false
)

-- ä¿®æ”¹æ–‡ä»¶è®¡æ•°æ ‡ç­¾çš„æ›´æ–°é€»è¾‘ï¼ˆåŒå‘åŒæ­¥ï¼‰
on lblCount text changed newText do (
    try (
        if ModeStatus.Items.Count > 0 do (
            local item = ModeStatus.Items.Item[0]
            item.SubItems[2].Text = newText
            ModeStatus.Refresh()
        )
    ) catch (
        format "[çŠ¶æ€åŒæ­¥é”™è¯¯] %\n" (getCurrentException())
    )
)

-- åœ¨æ¨¡å¼åˆ‡æ¢äº‹ä»¶ä¸­æ›´æ–°
on rdo_exportMode changed state do (
    g_lastAction = "åˆ‡æ¢-å¯¼å‡ºæ¨¡å¼"
    updateModeStatus()  -- ç»Ÿä¸€è°ƒç”¨çŠ¶æ€æ›´æ–°
)

-- æ»‘æ¡å€¼æ”¹å˜äº‹ä»¶
on sldBgColor changed val do (
    g_lastAction = "ç°åº¦å€¼-è°ƒæ•´"
    updateModeStatus()
    -- å®æ—¶æ˜¾ç¤ºå½“å‰å€¼
    format "[Slider Changed] Value: %\n" val
    lblBgValue.text = val as string
    Lv_model.BackColor = (dotNetClass "System.Drawing.Color").FromArgb val val val
    saveUIConfig()  -- ç«‹å³ä¿å­˜
)

-- BIPæ¨¡å¼åˆ‡æ¢äº‹ä»¶2 ==================================================
on rdo_bipMode changed state do (
    
    updateModeStatus()  -- ç»Ÿä¸€è°ƒç”¨çŠ¶æ€æ›´æ–°
    
    -- BIPç›¸å…³é€»è¾‘2
    g_bipProcessMode = state
    -- ä»…åŒæ­¥æ–‡ä»¶ç±»å‹è¿‡æ»¤ï¼Œä¸ä¿®æ”¹è·¯å¾„
    case state of (
        1: ( -- å¯¼å‡ºæ¨¡å¼æ˜¾ç¤ºMAXæ–‡ä»¶
            rdoFileFilter.state = 1  -- å¯¹åº”MAXå•é€‰æŒ‰é’®
            currentFilter = "*.max"
            --return undefined -- é˜»æ­¢åç»­åˆ·æ–°
        )
        2: ( -- å¯¼å…¥æ¨¡å¼æ˜¾ç¤ºBIPæ–‡ä»¶
            rdoFileFilter.state = 4  -- å‡è®¾BIPæ˜¯ç¬¬å››ä¸ªå•é€‰æŒ‰é’®
            currentFilter = "*.bip"
            --return undefined -- é˜»æ­¢åç»­åˆ·æ–°
        )
        
    )
    --Lv_model.Items.Clear()
    --model_files_array = #()
    
    if not g_showRecentFiles do (
    -- å¼ºåˆ¶åˆ·æ–°åˆ—è¡¨
    refreshFileListView forceRefresh:true
    format "[Bip-æ¨¡å¼åˆ‡æ¢] è¿‡æ»¤ç±»å‹ï¼š%\n" currentFilter
)
   if g_showRecentFiles do (
    return undefined )-- é˜»æ­¢åç»­åˆ·æ–°///ä¸ä½œåˆ·æ–°//refreshFileListView forceRefresh:true//-æœ€è¿‘æ‰“å¼€æ–‡ä»¶æ¨¡å¼ä¸‹-åˆ·æ–°ä¼šåˆ—è¡¨åˆ·æ–°å¼‚å¸¸
)

-- é¢œè‰²åº”ç”¨äº‹ä»¶
on btnApplyColor pressed do (
    g_lastAction = "åº”ç”¨é¢œè‰²-cp"
    updateModeStatus()
    try (
        -- [1/4] ä¿å­˜å½“å‰é¢œè‰²é…ç½®
        g_ColorConfig.folderNameColor = (dotNetClass "System.Drawing.Color").FromArgb cpFolder.color.r cpFolder.color.g cpFolder.color.b
        g_ColorConfig.fileNameColor = (dotNetClass "System.Drawing.Color").FromArgb cpFile.color.r cpFile.color.g cpFile.color.b
        
        -- [2/4] æ¨¡å¼çŠ¶æ€ä¿æŒ
        local isRecentMode = g_showRecentFiles

-- å¦‚æœå½“å‰ä¸ºæœ€è¿‘æ¨¡å¼ï¼Œåˆ‡æ¢åˆ°æ ‡å‡†æ¨¡å¼å¹¶åˆå§‹åŒ–åˆ—è¡¨

        if isRecentMode do (
             --start_Lv_model()
             g_showRecentFiles = true 
             --Lv_model.GridLines = false
             -- [3/4] ç‰©ç†æŒ‰é’®æ¨¡æ‹Ÿ
            if classOf btnRecentFiles == RolloutClass do (
                -- è§†è§‰åé¦ˆ
                btnRecentFiles.states.pressed = true
                redrawViews()
                sleep 0.1
                
                -- å®é™…æ‰§è¡Œ
                btnRecentFiles.states.pressed = false
                btnRecentFiles.pressed()
            )
        )
        
        /* æ™ºèƒ½åˆ·æ–°é€»è¾‘
        - è‹¥ä»æœ€è¿‘æ¨¡å¼åˆ‡æ¢è¿‡æ¥ï¼šç”¨æ ‡å‡†æ¨¡å¼åˆ·æ–°
        - è‹¥åŸæœ¬å°±æ˜¯æ ‡å‡†æ¨¡å¼ï¼šæ­£å¸¸åˆ·æ–°
        - åœ¨æœ€è¿‘æ¨¡å¼ä¸ä¸»åŠ¨åˆ·æ–°ï¼ˆé€šè¿‡æ¡ä»¶é¿å…ï¼‰
    */
    if not isRecentMode do (
        refreshFileListView forceRefresh:true  -- æ ‡å‡†æ¨¡å¼å¼ºåˆ¶åˆ·æ–°
    )
    
    -- ç‰¹æ®Šå¤„ç†ï¼šè‹¥åŸä¸ºæœ€è¿‘æ¨¡å¼ï¼Œåˆ·æ–°åæ¢å¤çŠ¶æ€
    if isRecentMode do (
        g_showRecentFiles = true  -- æ¢å¤æœ€è¿‘æ¨¡å¼æ ‡è®°
            -- æ›´æ–°é¢œè‰²é…ç½®ï¼ˆæ— è®ºå½“å‰æ¨¡å¼ï¼‰

        --refreshFileListView forceRefresh:false  -- è½¯åˆ·æ–°ä¿æŒç•Œé¢å…ƒç´   -  false 
    )
        
        Lv_model.Refresh()
    	updateModeStatus() -- æ–°å¢
	    windows.processPostedMessages() -- å…³é”®
	) catch (
        format "[ä¸¥é‡é”™è¯¯] é¢œè‰²åº”ç”¨å¤±è´¥: %\n" (getCurrentException())
    )
)

-- æ–°å¢äº‹ä»¶å¤„ç†ï¼šè¿”å›ä¸Šä¸€å±‚ç›®å½•
on btnParentPath pressed do (
    g_lastAction = "â†©æ–‡ä»¶è¿”å›"
    updateModeStatus()
    local currentPath = edtExportPath.text
    if currentPath == "" do (
        edtExportPath.text = getDir #scene
        refreshFileListView()
        return undefined
        updateModeStatus() -- æ–°å¢
        sleep 0.05 -- 50mså»¶è¿Ÿç¡®ä¿æ“ä½œå®Œæˆ
    )
    
    -- æ–°å¢è·¯å¾„å­˜åœ¨æ€§éªŒè¯
    if not doesDirectoryExist currentPath do (
        --messageBox "è·¯å¾„ä¸å­˜åœ¨ï¼Œå·²é‡ç½®ä¸ºé»˜è®¤ç›®å½•ï¼" title:"è·¯å¾„é”™è¯¯"
        edtExportPath.text = getDir #scene
        refreshFileListView()
        
		updateModeStatus() -- æ–°å¢
	    windows.processPostedMessages() -- å…³é”®
		return undefined
    )
    
    -- è·å–çˆ¶ç›®å½•å¹¶æ£€æŸ¥æ˜¯å¦ä¸ºæ ¹ç›®å½•
    local parentPath = pathConfig.normalizePath (pathConfig.removePathLeaf currentPath)
    
    -- è‹¥å½“å‰è·¯å¾„æ˜¯æ ¹ç›®å½•ï¼Œåˆ™è·³è½¬åˆ°å¾ªç¯è·¯å¾„
    if parentPath == currentPath do (
        if doesDirectoryExist g_cyclePath do (
            edtExportPath.text = g_cyclePath
            refreshFileListView()
            return undefined
        )
        -- è‹¥å¾ªç¯è·¯å¾„æ— æ•ˆåˆ™é‡ç½®ä¸ºåœºæ™¯ç›®å½•
        edtExportPath.text = getDir #scene
        refreshFileListView()
        return undefined
    )
    
    -- æ›´æ–°å¾ªç¯è·¯å¾„ä¸ºå½“å‰è·¯å¾„
    g_cyclePath = currentPath
    
    -- æ­£å¸¸è¿”å›ä¸Šä¸€å±‚
    edtExportPath.text = parentPath
    chkAutoFolder.checked = false
    g_showRecentFiles = false
    refreshFileListView()
    format "[è·¯å¾„æ›´æ–°] åˆ‡æ¢åˆ°çˆ¶ç›®å½•ï¼š%\n" parentPath
) 
    
-- æ–°å¢æŒ‰é’®1ï¼šä¸€é”®æ·»åŠ æ‰€æœ‰é€‰æ‹©é›†ï¼ˆå¸¦åœºæ™¯æ£€æŸ¥ï¼‰

-- ä¿®æ”¹ btnRecentFiles çš„ pressed äº‹ä»¶å¤„ç†

on btnRecentFiles pressed do (
    g_lastAction = "â†©ï¸æœ€è¿‘æ‰“å¼€"
    updateModeStatus()
    g_showRecentFiles = true
    rdoFileFilter.state = 1
    local validFiles = loadRecentFilesFromXML()
    
    model_files_array = #()
    Lv_model.Items.Clear()
    
    Lv_model.BeginUpdate()
    local existCount = 0
    for entry in validFiles do (
        local fPath = entry[1]
        local exists = entry[2]
        
        append model_files_array fPath
        
        li = dotNetObject "System.Windows.Forms.ListViewItem" ""
        li.UseItemStyleForSubItems = false
        
        -- å›¾æ ‡åˆ—
        li.Text = if exists then "ğŸ“„" else "âœ˜"
        li.ForeColor = (dotNetClass "System.Drawing.Color").White  -- å›¾æ ‡å§‹ç»ˆç™½è‰²
        
        -- æ–‡ä»¶ååˆ—
        local subName = li.SubItems.Add(filenameFromPath fPath)
        subName.ForeColor = if exists then g_ColorConfig.fileNameColor else (dotNetClass "System.Drawing.Color").Red
        
        -- ç±»å‹åˆ—
        local typeColor = if exists then g_ColorConfig.fileNameColor else (dotNetClass "System.Drawing.Color").Red
        local typeInfo = if exists then (getFileType fPath) else "<<å¤±æ•ˆæ–‡ä»¶>>"
        local subType = li.SubItems.Add(typeInfo)
        subType.ForeColor = typeColor
        
        li.Tag = fPath
        Lv_model.Items.Add(li)
        
        if exists do existCount += 1
    )
    Lv_model.EndUpdate()
    -- æ–°å¢ï¼šæœ€è¿‘æ–‡ä»¶æ¨¡å¼ç‰¹æ®Šå¤„ç†
    Lv_model.Scrollable = false
    Lv_model.Scrollable = true -- ä»…å‚ç›´
    -- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    lblCount.text = "æ–‡ä»¶ï¼š" + (validFiles.count - (validFiles.count - existCount)) as string + "/" + validFiles.count as string
    edtExportPath.text = "æœ€è¿‘æ–‡ä»¶ï¼ˆæœ‰æ•ˆï¼š" + existCount as string + " å¤±æ•ˆï¼š" + (validFiles.count - existCount) as string + "ï¼‰"
    Lv_model.Refresh()
    updateModeStatus()
    -- æ–°å¢ï¼šç‰¹æ®Šåˆ—å®½è®¡ç®—
    -- æ–°å¢ï¼šè‡ªåŠ¨ä¿å­˜æ¨¡å¼ç‰¹æ®Šå¤„ç†
    
    if chkChangeFont.checked do (
        if g_showRecentFiles do (
            local safeWidth = Lv_model.ClientRectangle.Width - 17 -- æ‰£é™¤å‚ç›´æ»šåŠ¨æ¡
            Lv_model.Columns.Item[1].Width = safeWidth - 105 -- æ–‡ä»¶ååˆ—åŠ¨æ€è®¡ç®—
            
            -- å¼ºåˆ¶ç¦ç”¨æ°´å¹³æ»šåŠ¨
            Lv_model.Scrollable = false
            Lv_model.Scrollable = true -- ä»…å‚ç›´æ»šåŠ¨
            return undefined -- è·³è¿‡å¸¸è§„è®¡ç®—
            )
    adjustColumnWidths forceCustom:chkChangeFont.checked -- æºå¸¦å­—ä½“çŠ¶æ€
    adjustColumnWidths()
    )
)

--on btnRecentFiles pressed do (
    --g_showRecentFiles = true
    --local validFiles = loadRecentFilesFromXML()
    
    --model_files_array = #()  -- æ¸…ç©ºæ•°æ®æº
    --Lv_model.Items.Clear()   -- ç›´æ¥æ¸…é™¤åˆ—è¡¨é¡¹
    
    --local existCount = 0  -- ç‹¬ç«‹æœ‰æ•ˆè®¡æ•°å™¨
    --for entry in validFiles do (
        --local fPath = entry[1]
        --local exists = entry[2]
        
        --append model_files_array fPath  -- ä¿æŒåŸå§‹æ•°æ®å®Œæ•´
        
        -- åˆ›å»ºåˆ—è¡¨é¡¹ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
        --li = dotNetObject "System.Windows.Forms.ListViewItem" ""
        --li.Text = if exists then "ğŸ“„" else "âœ˜"
        --li.SubItems.Add(filenameFromPath fPath)
        --li.SubItems.Add((if exists then "æœ€è¿‘æ–‡ä»¶ - " else "å¤±æ•ˆæ–‡ä»¶ - ") + getFileType fPath)
        --li.ForeColor = if exists then g_ColorConfig.fileNameColor else (dotNetClass "System.Drawing.Color").Red
        --Lv_model.Items.Add(li)
        
        --if exists do existCount += 1
    --)
    
    -- ä¿®æ”¹ç‚¹ï¼šç›´æ¥è®¾ç½®è®¡æ•°ï¼Œä¸ä¾èµ–updateModeStatus
    --lblCount.text = "æ–‡ä»¶ï¼š" + existCount as string
    --edtExportPath.text = "æœ€è¿‘æ‰“å¼€ï¼ˆæœ‰æ•ˆæ–‡ä»¶ï¼š" + existCount as string + "ï¼‰"
    
    -- æ‰‹åŠ¨è§¦å‘çŠ¶æ€æ æ›´æ–°
    --updateModeStatus()
--)
-- ä¿®æ­£æ§ä»¶äº‹ä»¶ç»‘å®š
on rdoFileFilter changed state do (
    g_lastAction = "File-ç­›é€‰.."
    updateModeStatus()
    if g_showRecentFiles do (
        --messageBox "æœ€è¿‘æ‰“å¼€æ¨¡å¼ä¸‹ä¸å¯åˆ‡æ¢æ–‡ä»¶ç±»å‹!" title:"æç¤º"
        rdoFileFilter.state = 1
        return undefined
    )
    refreshFileListView()
	updateModeStatus() -- æ–°å¢
	windows.processPostedMessages() -- å…³é”®ï¼
)

-- ä¿å­˜è·¯å¾„TEXT æ›´æ”¹ / è§¦å‘åˆ—è¡¨åˆ·æ–°
on edtExportPath entered txt do refreshFileListView()

-- è‡ªåŠ¨è®°å¿†ä¸Šæ¬¡ä½¿ç”¨çš„è·¯å¾„
on edtExportPath changed text do (
    setINISetting g_ConfigPath "Paths" "LastExportPath" text
)

-- ä¿®å¤æ’ä»¶ç›®å½•åºå·æ˜¾ç¤ºé—®é¢˜ å·¦é”® ä¸» MAX æ’ä»¶ä½ç½® //åœ¨æŒ‰é’®äº‹ä»¶å¤„ç†éƒ¨åˆ†æ·»åŠ å³é”®åŠŸèƒ½ - 8.18
on btnPluginDir pressed do (
    g_lastAction = "ğŸ“¦æ’ä»¶ç›®å½•"
    updateModeStatus()
    g_showRecentFiles = false  -- æ–°å¢æ¨¡å¼é‡ç½®
    local scriptDir = pathConfig.appendPath (getDir #maxroot) "scripts"
    edtExportPath.text = scriptDir
    rdoFileFilter.state = 3 -- åˆ‡æ¢åˆ°MSç±»å‹
    Lv_model.Scrollable = false -- 
    Lv_model.Scrollable = true -- å…è®¸å‚ç›´æ»šåŠ¨
    -- æŒ‚èµ·å¸ƒå±€é˜²æ­¢é—ªçƒ --
    Lv_model.SuspendLayout()
    -- æ¢å¤å¸ƒå±€å¹¶åˆ·æ–° --
    Lv_model.ResumeLayout()
    refreshFileListView() -- ç›´æ¥è°ƒç”¨åˆ·æ–°
	-- æ»šåŠ¨æ¡æ§åˆ¶ --
    Lv_model.Scrollable = (Lv_model.Items.Count * 20 > Lv_model.Height)  -- åŠ¨æ€å‚ç›´æ»šåŠ¨
    -- æœ€ç»ˆå¸ƒå±€éªŒè¯ --
    Lv_model.PerformLayout()
    -- çŠ¶æ€åŒæ­¥ --
    updateModeStatus() -- æ–°å¢
	windows.processPostedMessages() -- å…³é”®ï¼

)

--å³é”® - å¯¼èˆªåˆ°å¤‡ä»½ç›®å½• / 8.18
on btnPluginDir rightclick do ( 
    g_lastAction = "ğŸ“¦å¤‡ä»½ç›®å½•"
    updateModeStatus()
    g_showRecentFiles = false  -- æ–°å¢æ¨¡å¼é‡ç½®
    
    -- è·å–æ­£ç¡®çš„å¤‡ä»½ç›®å½•ï¼ˆå»æ‰æ–‡ä»¶åéƒ¨åˆ†ï¼‰
    local backupDir = g_backupPluginPath1
    --local backupDir = getFilenamePath g_backupPluginPath1
    -- ç¡®ä¿å¤‡ä»½ç›®å½•å­˜åœ¨
    makeDir backupDir all:true
    
    -- è®¾ç½®è·¯å¾„å¹¶åˆ·æ–°
    edtExportPath.text = backupDir
    rdoFileFilter.state = 7 -- MSç±»å‹
    refreshFileListView() 
    
    -- æ›´æ–°çŠ¶æ€
    updateModeStatus()
    windows.processPostedMessages()
)

--æ–°å¢æŒ‰é’®äº‹ä»¶-ç‚¹å‡»åˆ·æ–°è‡ªåŠ¨ä¿å­˜æ–‡ä»¶
on btnAutoSave pressed do (
    g_lastAction = "ğŸ’¾è‡ªåŠ¨ä¿å­˜"
    updateModeStatus()
    g_showRecentFiles = false  -- æ–°å¢æ¨¡å¼é‡ç½®
    -- è®¾ç½®è·¯å¾„æ˜¾ç¤ºä¸ºè‡ªåŠ¨ä¿å­˜ç›®å½•
    edtExportPath.text = g_autoSavePath
    
    -- æ¸…ç©ºå½“å‰åˆ—è¡¨
    Lv_model.Items.Clear()
    model_files_array = #()
    rdoFileFilter.state = 1 -- åˆ‡æ¢åˆ°MAXç±»å‹
    -- æŒ‚èµ·å¸ƒå±€é˜²æ­¢é—ªçƒ --
    Lv_model.SuspendLayout()
    -- è·å–è‡ªåŠ¨ä¿å­˜ç›®å½•ä¸‹çš„æ‰€æœ‰.maxæ–‡ä»¶
    --local autoSaveFiles = getFiles (pathConfig.appendPath g_autoSavePath "*.max")
    -- æ¢å¤å¸ƒå±€å¹¶åˆ·æ–° --
    Lv_model.ResumeLayout()
    refreshFileListView() -- ç›´æ¥è°ƒç”¨åˆ·æ–°å‡½æ•°
	-- æ»šåŠ¨æ¡æ§åˆ¶ --
    Lv_model.Scrollable = (Lv_model.Items.Count * 20 > Lv_model.Height)  -- åŠ¨æ€å‚ç›´æ»šåŠ¨
    -- æœ€ç»ˆå¸ƒå±€éªŒè¯ --
    Lv_model.PerformLayout()
    -- çŠ¶æ€åŒæ­¥ --
    updateModeStatus() -- æ–°å¢
	windows.processPostedMessages() -- å…³é”®ï¼

)

-- æ–°å¢æŒ‰é’®äº‹ä»¶--é€‰æ‹©é›†ç®¡ç†
on btnSelSetManager pressed do (
    try(createdialog rolSelSetTools pos:[mouse.screenpos.x+50,mouse.screenpos.y])catch()
)

-- äº‹ä»¶å¤„ç†
--æŒ‰é’®åŠ¨æ€ç¬¦å·æµ‹è¯•--åŠ¨æ€æ›´æ–°è¡¨æƒ…- ç»‘å®šäº‹ä»¶
on lbl_01 mouseOver do updateEmoji #hover
on lbl_01 mouseOut do updateEmoji #normal
on lbl_01 clicked do updateEmoji #clicked

--...
on ddlLikedFolder selected id do (
    g_lastAction = "å¸¸ç”¨-Selete.."
    updateModeStatus()
    g_showRecentFiles = false
    if iniLikedFolder[id] != undefined do (
        strDir = iniLikedFolder[id].dir
        fnRefreshList strDir type:arrFileType[rdoFileType.state]
    )
)

-- å³å‡»åˆ é™¤é¡¹
on ddlLikedFolder rightclick do (
    if ddlLikedFolder.selection > 0 and ddlLikedFolder.items.count > 0 do (
        deleteItem iniLikedFolder ddlLikedFolder.selection
        fnRefLikedFolderItems()  -- åˆ·æ–°ä¸‹æ‹‰åˆ—è¡¨
        stSetConfigAll.fnSetConfigBsOpenTools()
    )
)
  
--å¸¸ç”¨ç›®å½•-Main / ä¼˜åŒ–pos,é‡è¯•ï¼Œæ“ä½œæ„Ÿå®˜
on btnManagePaths pressed do (
    g_lastAction = "ç®¡ç†-å¸¸ç”¨ç›®å½•"
    updateModeStatus()
    
    -- åˆ·æ–°ä¸‹æ‹‰åˆ—è¡¨
    ddlLikedPaths.items = for f in g_likedFolders collect f.name
    
    -- è®¡ç®—å¯¹è¯æ¡†ä½ç½®ï¼ˆç¡®ä¿åœ¨å±å¹•å†…ï¼‰
    local dialogPos = mouse.screenPos - [150, 75]
    dialogPos.x = amax 0 (amin dialogPos.x (sysInfo.desktopSize.x - 300))
    dialogPos.y = amax 0 (amin dialogPos.y (sysInfo.desktopSize.y - 130))
    -- step1:å…³é—­å·²å­˜åœ¨çš„å¯¹è¯æ¡†ï¼ˆé˜²æ­¢é‡å¤/é€šè¿‡æ­¥éª¤æ¶ˆé™¤-è·¯å¾„ç®¡ç†ç•Œé¢é®æŒ¡ï¼‰
    try (destroydialog rolPathManager) catch ()
    -- step2:åˆ›å»ºå¯¹è¯æ¡† (æœ€ç»ˆå§‹ç»ˆæ‰“å¼€ å¸¸ç”¨ç›®å½•)
    createDialog rolPathManager width:300 height:130 pos:dialogPos
    
    -- è®¾ç½®å¯¹è¯æ¡†æ‰“å¼€æ ‡è®°
    g_pathManagerDialogOpen = true
)

--å¸¸ç”¨ç›®å½•-å³é”®åˆ é™¤äº‹ä»¶
-- ä¿®æ”¹åçš„ç®¡ç†ç›®å½•å³é”®äº‹ä»¶ï¼ˆCtrl+å³é”®æ¸…ç©ºæ‰€æœ‰è·¯å¾„/å•é¡¹åˆ é™¤+å³é”®ï¼‰
on btnManagePaths rightclick do (
    g_lastAction = "Dlt-Path"
    updateModeStatus()
    try 
    (
        -- æ–°å¢ï¼šæ£€æµ‹Ctrlé”®æ˜¯å¦æŒ‰ä¸‹
        if keyboard.controlPressed then 
        (
            -- ç¡®è®¤æ¸…ç©ºæ“ä½œ
            if queryBox "ç¡®å®šæ¸…ç©ºæ‰€æœ‰å¸¸ç”¨è·¯å¾„å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼" title:"âš ï¸ è­¦å‘Š" beep:true then 
            (
                g_likedFolders = #() -- æ¸…ç©ºè·¯å¾„æ•°ç»„
                saveConfig()          -- ä¿å­˜ç©ºé…ç½®
                ddlLikedPaths.items = #() -- æ¸…ç©ºä¸‹æ‹‰åˆ—è¡¨
                messageBox "æ‰€æœ‰å¸¸ç”¨è·¯å¾„å·²æ¸…ç©ºï¼" title:"æ“ä½œå®Œæˆ"
            )
        )
        else 
        (
            -- åŸæœ‰é€»è¾‘ï¼šåˆ é™¤é€‰ä¸­è·¯å¾„
            local selIndex = ddlLikedPaths.selection
            format "[åˆ é™¤æ“ä½œ] å°è¯•åˆ é™¤ç´¢å¼•ï¼š%\n" selIndex
            if selIndex > 0 and selIndex <= g_likedFolders.count do 
            (
                local target = g_likedFolders[selIndex]
                if queryBox ("ç¡®å®šåˆ é™¤è·¯å¾„ï¼š\n[" + target.name + "]\n" + target.dir + "?") then 
                (
                    deleteItem g_likedFolders selIndex
                    if saveConfig() then 
                    (
                        format "[åˆ é™¤æˆåŠŸ] å·²åˆ é™¤è·¯å¾„ï¼š%\n" target.name
                        ddlLikedPaths.items = for f in g_likedFolders collect f.name
                        ddlLikedPaths.selection = min selIndex g_likedFolders.count
                    )
                )
            )
        )
    ) 
    catch 
    (
        format "[æ“ä½œé”™è¯¯] %\n" (getCurrentException())
    )
)

--å†…å­˜ä¼˜åŒ–å¤„ç† / new
on rolPathManager close do (
    -- æ¸…ç†å…¨å±€ä¸´æ—¶å˜é‡
    if (globalVars.get #g_tempPathForManager) != undefined do (
        globalVars.remove #g_tempPathForManager
    )
    
    -- å¼ºåˆ¶åƒåœ¾å›æ”¶
    gc light:true
)

-- (å¸¸ç”¨è·¯å¾„-listbox/åŒ¹é…)-é€‰ä¸­åˆ·æ–°åˆ—è¡¨
on ddlLikedPaths selected idx do (
    g_lastAction = "å¸¸ç”¨-Selete.."
    updateModeStatus()
    g_showRecentFiles = false
    if idx > 0 and idx <= g_likedFolders.count do (
        edtExportPath.text = g_likedFolders[idx].dir
        rdoFileFilter.state = 1 -- åˆ‡æ¢åˆ°maxç±»å‹
        model_files_array = #()
        Lv_model.items.clear()
        local maxFiles = getFiles (pathConfig.appendPath edtExportPath.text "*.max")
        for f in maxFiles do additem_lv Lv_model f
        
        refreshFileListView forceRefresh:true -- å¼ºåˆ¶å®Œå…¨åˆ·æ–°
        updateModeStatus() -- æ–°å¢
        windows.processPostedMessages() -- å…³é”®ï¼
    )
)

-- æ–°å¢æŒ‰é’®1ï¼šæ·»åŠ å…¨éƒ¨é€‰æ‹©é›† / å¯¼å‡ºé€‰æ‹©é›†é…ç½®
on btn_add_all pressed do (
    g_lastAction = "å…¨é€‰-é€‰æ‹©é›†"
    updateModeStatus()
    -- æ£€æŸ¥åœºæ™¯æ˜¯å¦æœªä¿å­˜
    if maxFileName == "" do (
        messageBox "åœºæ™¯æœªä¿å­˜ï¼Œè¯·å…ˆä¿å­˜åœºæ™¯ï¼" title:"æ“ä½œä¸­æ­¢" beep:false
        return undefined
    )
    
    -- æ£€æŸ¥åœºæ™¯æ˜¯å¦ä¸ºç©º
    if objects.count == 0 do (
        messageBox "åœºæ™¯ä¸ºç©ºï¼Œè¯·æ·»åŠ å¯¹è±¡ï¼" title:"æ“ä½œä¸­æ­¢" beep:false
        return undefined
    )
    
    -- æ£€æŸ¥æ˜¯å¦å­˜åœ¨é€‰æ‹©é›†
    local setCount = getNumNamedSelSets()
    if setCount == 0 do (
        messageBox "å½“å‰åœºæ™¯æ²¡æœ‰é€‰æ‹©é›†ï¼" title:"æ“ä½œä¸­æ­¢" beep:false
        return undefined
    )
    
    -- æ­£å¸¸æ‰§è¡Œé€»è¾‘
    export_setsets = #()
    for i = 1 to setCount do (
        append export_setsets (getNamedSelSetName i)
    )
    
    -- æ›´æ–°æ˜¾ç¤ºï¼ˆä¼˜åŒ–å­—ç¬¦ä¸²æ‹¼æ¥ï¼‰
    local temp_string = ""
    for i = 1 to export_setsets.count do (
        temp_string += export_setsets[i]
        if i < export_setsets.count do temp_string += " , "
    )
    set_names.text = temp_string
    
    if export_setsets.count > 1 do (
        auto_makedir_set.checked = true
    )
    --messageBox "æˆåŠŸæ·»åŠ æ‰€æœ‰é€‰æ‹©é›†ï¼" title:"æ“ä½œå®Œæˆ" beep:false
)

-- æ–°å¢æŒ‰é’®2ï¼šä¸€é”®æ¸…ç©ºé€‰æ‹©é›† 
on btn_clear_all pressed do (
    g_lastAction = "æ¸…ç©º-é€‰æ‹©é›†"
    updateModeStatus()
    export_setsets = #()
    set_names.text = ""
    auto_makedir_set.checked = false -- å¼ºåˆ¶å–æ¶ˆå‹¾é€‰åˆ†ç›®å½•å¤é€‰æ¡†
    --messageBox "å·²æ¸…é™¤æ‰€æœ‰é€‰æ‹©é›†ï¼" title:"æ“ä½œå®Œæˆ" beep:false
)

-- å¢å¼ºåŒå‡»äº‹ä»¶å¤„ç†ï¼Œæ·»åŠ è·¯å¾„å­˜åœ¨æ€§æ£€æŸ¥-- true -- (åŠŸèƒ½å®ç°)
on Lv_model MouseDoubleClick sender args do (
    g_lastAction = "åŒå‡»-æ‰“å¼€.."
    updateModeStatus()
    try (
        
        try (
            -- è·å–é€‰ä¸­æ–‡ä»¶è·¯å¾„
            selectedItem = Lv_model.SelectedItems.Item[0]
            selectedPath = selectedItem.Tag as String
            
            -- æ ¹æ®Maxç‰ˆæœ¬è®¾ç½®å•ä½å‚æ•°
            maxVersionValue = (maxVersion())[1]
            if maxVersionValue >= 23000 then (  -- 2021+ ç‰ˆæœ¬
                FBXImporterSetParam "ConvertUnit" #cm  -- æ˜¾å¼å•ä½ç¬¦å·
            ) else (  -- 2019åŠæ›´æ—§ç‰ˆæœ¬
                FBXImporterSetParam "ConvertUnit" true -- æ—§ç‰ˆå¸ƒå°”å€¼
            )
            
            -- æ‰§è¡Œæ–‡ä»¶å¯¼å…¥
            FBXImporterSetParam "ConvertUnit" (getConvertUnitParam())
            importFile selectedPath #noPrompt using:FBXIMP
        )
        catch (
            format "MouseDoubleClick--åŒå‡»æ‰“å¼€æ–‡ä»¶æˆåŠŸï¼ï¼ï¼" (getCurrentException())
        )
        
        --format "[ä¸¥é‡é”™è¯¯] æ–‡ä»¶æ‰“å¼€å¤±è´¥ï¼š%\n" (getCurrentException())
        -- 1. æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­é¡¹
        if (Lv_model.SelectedItems == undefined) or (Lv_model.SelectedItems.Count == 0) do (
            format "æœªé€‰ä¸­ä»»ä½•æ–‡ä»¶é¡¹\n"
            return undefined
        )
        
        -- 2. è·å–é€‰ä¸­é¡¹å¹¶éªŒè¯æœ‰æ•ˆæ€§
        local item = Lv_model.SelectedItems.Item[0]
        if item == undefined do (
            format "é”™è¯¯ï¼šé€‰ä¸­çš„åˆ—è¡¨é¡¹æ— æ•ˆ\n"
            return undefined
        )
        
        -- 3. æå–æ–‡ä»¶è·¯å¾„å¹¶éªŒè¯æ ¼å¼
        local filePath = item.Tag as String
        if filePath == undefined or filePath == "" do (
            format "é”™è¯¯ï¼šæ–‡ä»¶è·¯å¾„ä¸ºç©ºæˆ–æœªå®šä¹‰\n"
            return undefined
        )
        -- 4. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”ä¸º.maxç±»å‹
        if not (doesFileExist filePath) do (
            format "é”™è¯¯ï¼šæ–‡ä»¶ä¸å­˜åœ¨ - %\n" filePath
            return undefined
        )
        --if (getFilenameType filePath) != ".max" do (
            --format "é”™è¯¯ï¼šæ–‡ä»¶ç±»å‹ä¸æ˜¯.max - %\n" filePath
            --return undefined
        --)
        -- 5. æ£€æŸ¥åœºæ™¯ä¿å­˜çŠ¶æ€ï¼ˆç¡®ä¿è¿”å›å¸ƒå°”å€¼ï¼‰
        local shouldProceed = CheckForSave()
        if classOf shouldProceed != BooleanClass do (
            format "é”™è¯¯ï¼šä¿å­˜æ£€æŸ¥è¿”å›éå¸ƒå°”å€¼ - %\n" (classOf shouldProceed)
            return undefined
        )
        
       -- [1] è·å–é€‰ä¸­é¡¹ -----------------------------------------------------------------
       if Lv_model.SelectedItems.Count == 0 do return undefined
       local item = Lv_model.SelectedItems.Item[0]
       if item == undefined do return undefined
       
       -- 2. ä¸¥æ ¼ç±»å‹è½¬æ¢è·¯å¾„
       local filePath = pathConfig.normalizePath (item.Tag as String)
       local fileType = toLower (getFilenameType filePath)
       local path = ""
       try (
           -- å¼ºåˆ¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶æ ‡å‡†åŒ–è·¯å¾„
           path = pathConfig.normalizePath (item.Tag as String)
       ) catch (
           format "[é”™è¯¯] è·¯å¾„è½¬æ¢å¤±è´¥ï¼š%\n" (getCurrentException())
           return undefined
       )
       
       -- 3. è·¨ç‰ˆæœ¬æ–‡ä»¶å¤¹æ£€æµ‹é€»è¾‘
       local isFolder = false
       if (maxVersion())[1] >= 23000 then ( -- 2022+ ä½¿ç”¨ç°ä»£API
           isFolder = doesDirectoryExist path
       ) else ( -- 2019 å…¼å®¹æ¨¡å¼
           isFolder = (getFilenameType path) == "" or (doesDirectoryExist path)
       )
      
       
    -- å¤„ç†æ–‡ä»¶å¤¹å¯¼èˆª
    if isFolder do (
        -- è·¯å¾„æ ‡å‡†åŒ–å¤„ç†
        -- ç‰ˆæœ¬å…¼å®¹è·¯å¾„è®¾ç½®
            edtExportPath.text = if (maxVersion())[1] >= 23000 then (
                pathConfig.appendPath path ""
            ) else (
                path
            )
        
    -- æ™ºèƒ½è®¾ç½®æ–‡ä»¶ç­›é€‰ç±»å‹
    local newState = autoDetectFilterType path
    if newState != rdoFileFilter.state do (
        rdoFileFilter.state = newState
        format "[æ™ºèƒ½åˆ‡æ¢] æ£€æµ‹åˆ°ç‰¹å¾æ–‡ä»¶å¤¹ï¼š% â†’ ç±»å‹%\n" folderName newState
    )
    
    -- å®‰å…¨åˆ·æ–°åˆ—è¡¨
    try (
        refreshFileListView forceRefresh:true
    ) catch (
        format "[é”™è¯¯] åˆ·æ–°å¤±è´¥ï¼š%\n" (getCurrentException())
        model_files_array = #()
        Lv_model.Items.Clear()
    )
    
    return undefined
)
    -- å¼ºåŒ–ç±»å‹åˆ¤æ–­é€»è¾‘ï¼ˆåŒæ—¶æ£€æŸ¥ç±»å‹æ å’Œæ–‡ä»¶ç³»ç»Ÿï¼‰
    if (item.SubItems.Item[2].Text == "æ–‡ä»¶å¤¹") or (doesDirectoryExist path) do (
        edtExportPath.text = path
        refreshFileListView()
        return undefined
    )
        
     -- é…ç½®FBXå¯¼å…¥å‚æ•°
        FBXImporterSetParam "Animation" true        -- å¯¼å…¥åŠ¨ç”»
        FBXImporterSetParam "ResetScene" true        -- é‡ç½®åœºæ™¯
        FBXImporterSetParam "Skin" true               -- å¯¼å…¥è’™çš®
        FBXImporterSetParam "Cameras" false            -- ç¦æ­¢ç›¸æœºå¯¼å…¥
        FBXImporterSetParam "Lights" false               -- ç¦æ­¢ç¯å…‰å¯¼å…¥
        --FBXImporterSetParam "ConvertUnit" #centimeters  -- å•ä½è½¬æ¢  é™¤max 2019 ////å…¶ä»–max ç‰ˆæœ¬ åŒå‡»ä¼šæŠ¥é”™(å•ä½è½¬æ¢æ··æ·†ï¼‰ï¼Œå¿…é¡»æ³¨é”€æ‰...!!!  å·² ä¿®å¤ï¼Œmax 2019,2022 OK .
        FBXImporterSetParam "AxisConversion" true    -- è‡ªåŠ¨è½´è½¬æ¢
     -- åªå¤„ç†å·¦é”®åŒå‡» / è§„é¿ è¯¯æ“ä½œ å³é”® åŒå‡» / æå‡ åŒå‡»åˆ—è¡¨æ–‡ä»¶ æ‰“å¼€æ–‡ä»¶çš„æ“ä½œç²¾å‡†æ€§ / false
     
     case (toLower (getFilenameType filePath)) of (
        --å¤§éƒ¨åˆ†æ–‡ä»¶æ ¼å¼ / åŒå‡» å¯é»˜è®¤æ‰“å¼€
        ".png": ( openFileWithDefaultApp filePath )  -- PNGå›¾åƒ
        ".jpg": ( openFileWithDefaultApp filePath )  -- JPEGå›¾åƒ
        ".jpeg": ( openFileWithDefaultApp filePath ) -- JPEGå›¾åƒ
        ".txt": ( openFileWithDefaultApp filePath )  -- æ–‡æœ¬æ–‡ä»¶
        ".doc": ( openFileWithDefaultApp filePath )  -- Wordæ–‡æ¡£
        ".docx": ( openFileWithDefaultApp filePath ) -- Wordæ–‡æ¡£
        ".xls": ( openFileWithDefaultApp filePath )  -- Excelè¡¨æ ¼
        ".xlsx": ( openFileWithDefaultApp filePath ) -- Excelè¡¨æ ¼
        ".pdf": ( openFileWithDefaultApp filePath )  -- PDFæ–‡æ¡£
        ".zip": ( openFileWithDefaultApp filePath )  -- ZIPå‹ç¼©åŒ…
        ".rar": ( openFileWithDefaultApp filePath )  -- RARå‹ç¼©åŒ…
        ".7z": ( openFileWithDefaultApp filePath )   -- 7-Zipå‹ç¼©åŒ…
        ".ini": ( openFileWithDefaultApp filePath )  -- é…ç½®æ–‡ä»¶
        ".json": ( openFileWithDefaultApp filePath ) -- JSONæ–‡ä»¶
        ".xml": ( openFileWithDefaultApp filePath )  -- XMLæ–‡ä»¶
        
        ".bip": (
                if (CheckForSave()) do ( 
           
                g_lastAction = "åŒå‡»-å¯¼å…¥.."
                updateModeStatus()
                if Lv_model.SelectedItems.Count == 0 do return false
                local item = Lv_model.SelectedItems.Item[0]
                local bipPath = item.Tag as String
                
                if (toLower (getFilenameType bipPath)) != ".bip" do return false
                
                if SilentBipedImport bipPath do (
                    messageBox ("BIPå·²å¯¼å…¥ï¼š\n" + bipPath) title:"æˆåŠŸ" beep:false
                    )
                )
            )
        ".ms": (  -- è„šæœ¬æ–‡ä»¶ï¼ˆä¸é‡ç½®åœºæ™¯ï¼‰
                if (CheckForSave()) do (
                    g_lastAction = "åŒå‡»-è¿è¡Œ.."
                    updateModeStatus()
                    -- å®‰å…¨æ‰§è¡Œè„šæœ¬ä¸é‡ç½®åœºæ™¯
                    try (
                        fileIn filePath  -- ç›´æ¥æ‰§è¡Œè„šæœ¬
                        format "å·²æ‰§è¡Œè„šæœ¬ï¼š%\n" filePath
                    ) catch (
                        format "[è„šæœ¬é”™è¯¯] æ–‡ä»¶ï¼š%\né”™è¯¯ï¼š%\n" filePath (getCurrentException())
                    )
                )
            )
            
        ".mse": (  -- åŠ å¯†è„šæœ¬ï¼ˆä¸é‡ç½®åœºæ™¯ï¼‰
                if (CheckForSave()) do (
                    g_lastAction = "åŒå‡»-è¿è¡Œ.."
                    updateModeStatus()
                    -- å®‰å…¨æ‰§è¡ŒåŠ å¯†è„šæœ¬
                    try (
                        fileIn filePath  -- ç›´æ¥æ‰§è¡ŒåŠ å¯†è„šæœ¬
                        format "å·²æ‰§è¡ŒåŠ å¯†è„šæœ¬ï¼š%\n" filePath
                    ) catch (
                        format "[åŠ å¯†è„šæœ¬é”™è¯¯] æ–‡ä»¶ï¼š%\né”™è¯¯ï¼š%\n" filePath (getCurrentException())
                    )
                )
            )
            
        ".mzp": (  -- è„šæœ¬æ–‡ä»¶ï¼ˆä¸é‡ç½®åœºæ™¯ï¼‰
                if (CheckForSave()) do (
                    g_lastAction = "åŒå‡»-è¿è¡Œ.."
                    updateModeStatus()
                    -- å®‰å…¨æ‰§è¡Œè„šæœ¬ä¸é‡ç½®åœºæ™¯
                    try (
                        fileIn filePath  -- ç›´æ¥æ‰§è¡Œè„šæœ¬
                        format "å·²æ‰§è¡Œè„šæœ¬ï¼š%\n" filePath
                    ) catch (
                        format "[è„šæœ¬é”™è¯¯] æ–‡ä»¶ï¼š%\né”™è¯¯ï¼š%\n" filePath (getCurrentException())
                    )
                )
            )
			
        ".mcr": (  -- è„šæœ¬æ–‡ä»¶ï¼ˆä¸é‡ç½®åœºæ™¯ï¼‰
                if (CheckForSave()) do (
                    g_lastAction = "åŒå‡»-è¿è¡Œ.."
                    updateModeStatus()
                    -- å®‰å…¨æ‰§è¡Œè„šæœ¬ä¸é‡ç½®åœºæ™¯
                    try (
                        fileIn filePath  -- ç›´æ¥æ‰§è¡Œè„šæœ¬
                        format "å·²æ‰§è¡Œè„šæœ¬ï¼š%\n" filePath
                    ) catch (
                        format "[è„šæœ¬é”™è¯¯] æ–‡ä»¶ï¼š%\né”™è¯¯ï¼š%\n" filePath (getCurrentException())
                    )
                )
            )
			
        ".max": (  -- MAXåœºæ™¯æ–‡ä»¶
                if (CheckForSave()) do (
                    resetMaxFile #noPrompt
                    loadMaxFile filePath useFileUnits:true quiet:true
                    -- æ‰“å¼€max åŒæ—¶åˆ·æ–° é€‰æ‹©é›†
                    GetSetFormScene() 
                    
                    -- ç›´æ¥è°ƒç”¨é«˜äº®å‡½æ•°ï¼Œä¸éœ€è¦å»¶è¿Ÿ
                    highlightCurrentFile()
                    
                    format "åœºæ™¯å·²é‡ç½®å¹¶åŠ è½½ï¼š%\n" filePath
                )
            )
            -- å…¶ä»–æ–‡ä»¶ç±»å‹å¤„ç†ï¼ˆä¿æŒä¸å˜ï¼‰
            default: (openFileWithDefaultApp filePath)
            
        ".xaf": (
                if (CheckForSave()) do (
                    g_lastAction = "åŒå‡»-å¯¼å…¥.."
                    updateModeStatus()
                    local xafPath = item.Tag as String
                    if importXafAnimation path do (
                        messageBox ("xafå·²å¯¼å…¥ï¼š\n" + xafPath) title:"æˆåŠŸ" beep:false
                    )
                )
            )
            
            
        ".fbx": (
                
                if (CheckForSave()) do (
                    
                try(     
                    
                -- å¯¼å…¥å‰å‡†å¤‡/æ ¸å¿ƒåŒå‡»å¯¼å…¥æŸ¥çœ‹
                with redraw off (
                    format "[å®Œæˆ] FBXå¯¼å…¥åŠå§¿åŠ¿ä¿®æ­£æˆåŠŸï¼" (getCurrentException())  
                    --åŒå‡»åˆ—è¡¨FBXæ–‡ä»¶åŠŸèƒ½å¤‡æ³¨ï¼šï¼ˆ
                    -- å‰ææ˜¯ä¿è¯ å¯¼å…¥å‰---å½“å‰æ‰“å¼€çš„ max æ–‡ä»¶ åˆå§‹ pose ä¸º æ ‡å‡†çš„é»˜è®¤åˆå§‹POSE,ç›®å‰åŠŸèƒ½æš‚æ—¶åªæ˜¯æ”¯æŒ å¯¼å…¥æŸ¥çœ‹ä¸ºä¸»ï¼Œå¿«æ·æ£€æŸ¥ï¼š//FBX å¯¼å‡º æ˜¯å¦éƒ½å¯¼å‡ºæˆåŠŸäº† ï¼ï¼Ÿ...
                    -- é€»è¾‘æ˜¯å¤åˆ¶å½“å‰æ‰“å¼€çš„æ–‡ä»¶çš„ç¬¬0å¸§ä½œä¸ºåˆå§‹pose , å¯¼å…¥ FBX å‰ è¿›è¡Œå¼ºåˆ¶å¤åˆ¶ ï¼Œå¯¼å…¥FBX å å† åœ¨ ç¬¬ 0 å¸§ è¿›è¡Œç²˜è´´ pose ï¼ˆåŒ…æ‹¬cs,è™šæ‹Ÿä½“å¦‚ B0NE ,DUMMY ç­‰...)
                   
                    --æ¸…ç©ºç›‘å¬å™¨ä¿¡æ¯ï¼‰
                    clearlistener()
                    -- å¢å¼ºç‰ˆç¦ç”¨è§†å›¾åˆ·æ–°
                     disableSceneRedraw()
                     suspendEditing() -- æŒ‚èµ·ç¼–è¾‘æ“ä½œï¼ˆMax 2022+ æ–°å¢APIï¼‰
                    -- å¤‡ä»½å§¿åŠ¿æ—¶å¼ºåˆ¶ä½¿ç”¨ä¸–ç•Œåæ ‡ç³»
                    in coordSys world copyPosture()
                    
                    -- é…ç½®FBXå¯¼å…¥å‚æ•°
                    FBXImporterSetParam "ResetScene" true
                    FBXImporterSetParam "ConvertUnit" (getConvertUnitParam())  -- æ­£ç¡®è°ƒç”¨å…¨å±€å‡½æ•°
                                    
                    -- æ‰§è¡Œå¯¼å…¥ï¼ˆæ·»åŠ ç‰ˆæœ¬å…¼å®¹å‚æ•°ï¼‰
                                    
                    if (maxVersion())[1] >= 21000 then (
                                        
                        importFile filePath #noPrompt using:FBXIMP  -- æ–°ç‰ˆå¿…é¡»æŒ‡å®šusingå‚æ•°
                                    
                    ) else (
                                        
                        importFile filePath #noPrompt  -- æ—§ç‰ˆæ— éœ€using
                                    
                    )
                    
                    -- å»¶è¿Ÿæ¢å¤UIï¼ˆMax 2022+ ä¼˜åŒ–ï¼‰
                    resumeEditing() -- æ¢å¤ç¼–è¾‘æ“ä½œ
                    enableSceneRedraw()
                    completeRedraw()           
                
                    -- åˆ†é˜¶æ®µåº”ç”¨å§¿åŠ¿
                    pastePosture false  -- åº”ç”¨åŸºç¡€å§¿åŠ¿
                    pastePosture true   -- ä¿®æ­£åŠ¨ç”»å±‚çŠ¶æ€
                )
                
                -- æœ€ç»ˆBipedç³»ç»Ÿæ›´æ–°
                for master in biped.getBipedRoots() do (
                    -- å¢åŠ ç©ºæŒ‡é’ˆä¿æŠ¤
                    if isValidNode master do (
                    biped.update master #all
                    maxOps.CollapseNode master off
                )
            )
                format "[å®Œæˆ] FBXå¯¼å…¥åŠå§¿åŠ¿ä¿®æ­£æˆåŠŸï¼\n"
                 
                                )catch (
                                         format "[å®Œæˆ] FBXå¯¼å…¥åŠå§¿åŠ¿ä¿®æ­£æˆåŠŸï¼" (getCurrentException())
                                        )
                    )
                            )
                            default: (
                                openFileWithDefaultApp filePath
                            )
                        )
            )catch ( format "[å…¨å±€é”™è¯¯] åŒå‡»æ“ä½œå¤±è´¥ï¼š%\n" (getCurrentException()) 
                      )
        -- åœ¨å¯¼å…¥å®Œæˆåå¼ºåˆ¶å›æ”¶å†…å­˜
        gc light:true
        freeSceneBitmaps()
        
        )
    
--format "[ä¸¥é‡é”™è¯¯] æµç¨‹ä¸­æ–­ï¼š%\n" (getCurrentException())             

--[[ åˆ—è¡¨äº¤äº’å¢å¼º2 ]]--ç›´æ¥ç‚¹å‡»æ‰§è¡Œåˆ é™¤--new--true
on btn_removeSelected pressed do (
    g_lastAction = "åˆ é™¤-é€‰ä¸­é¡¹.."
    updateModeStatus()
    
    try (
        -- å®‰å…¨é”å®šç•Œé¢
        Lv_model.BeginUpdate()
        
        -- è·å–è¦åˆ é™¤çš„é¡¹ï¼šä¼˜å…ˆä½¿ç”¨å‹¾é€‰é¡¹ï¼Œå¦‚æœæ²¡æœ‰å‹¾é€‰é¡¹åˆ™ä½¿ç”¨é€‰ä¸­çš„é¡¹
        local indicesToRemove = #()
        
        -- æ£€æŸ¥æ˜¯å¦æœ‰å‹¾é€‰é¡¹
        local hasCheckedItems = false
        for i = 0 to (Lv_model.Items.Count-1) do (
            if Lv_model.Items.Item[i].Checked do (
                hasCheckedItems = true
                exit
            )
        )
        
        -- æ ¹æ®æ˜¯å¦æœ‰å‹¾é€‰é¡¹å†³å®šåˆ é™¤ç­–ç•¥
        if hasCheckedItems then (
            -- åˆ é™¤æ‰€æœ‰å‹¾é€‰é¡¹
            for i = (Lv_model.Items.Count-1) to 0 by -1 where Lv_model.Items.Item[i].Checked do (
                append indicesToRemove i
            )
        ) else (
            -- åˆ é™¤æ‰€æœ‰é€‰ä¸­çš„é¡¹
            for i = (Lv_model.Items.Count-1) to 0 by -1 where Lv_model.Items.Item[i].Selected do (
                append indicesToRemove i
            )
        )
        
        if indicesToRemove.count == 0 do (
            messageBox "è¯·å…ˆå‹¾é€‰æˆ–é€‰æ‹©è¦åˆ é™¤çš„é¡¹ç›®ï¼" title:"æç¤º"
            Lv_model.EndUpdate()
            return undefined
        )
        
        -- å¯¹ç´¢å¼•è¿›è¡Œæ’åºï¼ˆä»å¤§åˆ°å°ï¼‰
        sort indicesToRemove
        indicesToRemove = for i in indicesToRemove collect i  -- ç¡®ä¿æ˜¯æ•°ç»„
        
        -- ä»åå‘å‰åˆ é™¤ï¼ˆé¿å…ç´¢å¼•å˜åŒ–é—®é¢˜ï¼‰
        for i = indicesToRemove.count to 1 by -1 do (
            local idx = indicesToRemove[i]
            if idx >= 0 and idx < Lv_model.Items.Count do (
                try (
                    -- ç§»é™¤åˆ—è¡¨é¡¹
                    Lv_model.Items.RemoveAt idx
                    
                    -- åŒæ­¥æ•°æ®æ•°ç»„
                    if idx+1 <= model_files_array.count do (
                        deleteItem model_files_array (idx+1)
                    )
                )
                catch (
                    format "[åˆ é™¤è·³è¿‡] ç´¢å¼• % å¼‚å¸¸ï¼š%\n" idx (getCurrentException())
                )
            )
        )
        
        -- æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        local dirCount = (getDirectories (edtExportPath.text + "\\*")).count
        local fileCount = model_files_array.count - dirCount
        lblCount.text = "æ–‡ä»¶ï¼š" + (fileCount as string)
        
        -- æ›´æ–°æ¨¡å¼çŠ¶æ€
        updateModeStatus()
        
        -- æ˜¾ç¤ºæ“ä½œç»“æœ
        g_lastAction = "å·²åˆ é™¤ " + (indicesToRemove.count as string) + " ä¸ªé¡¹ç›®"
        updateModeStatus()
        
    )
    catch (
        format "[åˆ é™¤é”™è¯¯] ä¸»æµç¨‹å¼‚å¸¸ï¼š%\n" (getCurrentException())
        try (
            messageBox "åˆ é™¤æ“ä½œå¼‚å¸¸ï¼Œå»ºè®®åˆ·æ–°åˆ—è¡¨ï¼" title:"é”™è¯¯" beep:true
        ) catch ()
    )
    
    -- ç¡®ä¿ç•Œé¢è§£é”
    try (Lv_model.EndUpdate()) catch ()
    try (Lv_model.Refresh()) catch ()
    
    -- å†…å­˜æ¸…ç†
    gc light:true
)

-- æ–°å¢é‡ç½®åœºæ™¯åŠŸèƒ½
on btn_resetScene pressed do (
    g_lastAction = "é‡ç½®-åœºæ™¯"
    updateModeStatus()
    try (
        resetMaxFile #noPrompt
        format "åœºæ™¯å·²é‡ç½®\n"
    ) catch (
        format "é‡ç½®å¤±è´¥ï¼š%\n" (getCurrentException())
    )
)

-- å¼ºåŒ–ç‰ˆè‡ªåŠ¨è¯†åˆ«åŠŸèƒ½
on btn_autoRead pressed do (
    g_lastAction = "âŒ›è¯»å–-å½“å‰"
    updateModeStatus()
    g_showRecentFiles = false -- æ–°å¢æ¨¡å¼é‡ç½®
    
    -- è·å–å½“å‰Maxæ–‡ä»¶çš„ç›®å½•è·¯å¾„ï¼ˆåŒ…å«æœ«å°¾åæ–œæ ï¼‰
    local currentDir = maxFilePath
    rdoFileFilter.state = 1 -- åˆ‡æ¢åˆ°MAXç±»å‹
    
    -- å»é™¤è·¯å¾„æœ«å°¾çš„åæ–œæ ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if currentDir != "" and currentDir[currentDir.count] == "\\" do (
        currentDir = substring currentDir 1 (currentDir.count - 1)
    )
    
    -- å¤„ç†æœªä¿å­˜åœºæ™¯çš„æƒ…å†µ
    if currentDir == "" then (
        messageBox "å½“å‰åœºæ™¯æœªä¿å­˜ï¼Œè¯·å…ˆä¿å­˜æ–‡ä»¶ï¼" title:"æç¤º" beep:false
        return undefined
    )
    
    -- æ›´æ–°å¯¼å‡ºè·¯å¾„å’Œåˆ—è¡¨
    chkAutoFolder.checked = false
    edtExportPath.text = currentDir  -- æ­¤æ—¶è·¯å¾„å·²æ— æœ«å°¾åæ–œæ 
    model_files_array = #()
    Lv_model.Items.Clear()
    
    -- ä½¿ç”¨å®‰å…¨è·¯å¾„æ‹¼æ¥åŠ è½½.maxæ–‡ä»¶
    local maxFiles = getFiles (pathConfig.appendPath currentDir "*.max")
    for f in maxFiles do additem_lv Lv_model f
    
    -- åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
    refreshFileListView()
    
    -- ä½¿ç”¨å…¨å±€å‡½æ•°é«˜äº®å½“å‰æ–‡ä»¶
    highlightCurrentFile()
    
    updateModeStatus() 
    windows.processPostedMessages() -- å…³é”®ï¼
    format "å·²åŠ è½½ç›®å½•ï¼š%\n" currentDir
)

-- å¯¼å‡ºæˆ–è€…ä¿å­˜è·¯å¾„ åœ°å€ å˜æ›´ åˆ·æ–° åˆ—è¡¨ 
on edtExportPath changed text do (
    if chkAutoFolder.checked do (
        model_files_array = #()
        Lv_model.items.clear()
        local maxFiles = getFiles (pathConfig.appendPath text "*.max")
        for f in maxFiles do additem_lv Lv_model f
    )
)

-- åªæ˜¾ç¤º æ–‡ä»¶ ï¼ˆ æ¯”å¦‚ ä¸éœ€è¦æ–‡ä»¶å¤¹çš„æ˜¾ç¤ºï¼Œåˆ™åœ¨å¯¼å‡ºå‰ï¼Œæ·»åŠ ä¸€éè¿™ä¸ª æ·»åŠ MAX æ“ä½œ åˆ™åˆ—è¡¨åªæ˜¾ç¤º MAX æ–‡ä»¶ ï¼Œè§„é¿ æ‰¹é‡å¯¼å‡º è¿›ç¨‹ å¼€å§‹å ï¼Œæé«˜ å¯¼å‡º ç›®æ ‡ å‡†å¤‡å·¥ä½œçš„ å¯æ“ä½œæ€§ï¼è§„é¿ æ‰¹é‡å¯¼å‡º ä¼šè‡ªåŠ¨è¯†åˆ« æœ‰MAX æ–‡ä»¶çš„ æ–‡ä»¶å¤¹å’Œæ–‡ä»¶ï¼‰
on btnBrowseFolder pressed do (
    g_lastAction = "æ·»åŠ -MAXæ–‡ä»¶"
    updateModeStatus()
    g_showRecentFiles = false  -- é‡ç½®æ ‡è®°
        local selectedDir = getSavePath caption:"é€‰æ‹©åŒ…å«MAXæ–‡ä»¶çš„ç›®å½•" initialDir:edtExportPath.text
        if selectedDir != undefined do (
            -- æ¸…é™¤æ—§æ•°æ®
            model_files_array = #()
            Lv_model.items.clear()
            
            -- åŠ è½½æ–°æ–‡ä»¶
            local maxFiles = getFiles (selectedDir + "\\*.max")
            for f in maxFiles do (
                additem_lv Lv_model f
            )
            edtExportPath.text = selectedDir
        )
    )
   
    -- è‡ªåŠ¨ç”Ÿæˆå¤é€‰æ¡†äº‹ä»¶
on chkAutoFolder changed state do (
    if state then updateExportPath forceAuto:true
    else edtExportPath.text = pathConfig.removePathLeaf edtExportPath.text
)
   -- æ–°å¢"å®šä½FBX"æŒ‰é’®
on btn_resetFBXPath pressed do (
    g_lastAction = "å®šä½-FBX"
    updateModeStatus()
    updateExportPath forceAuto:true
)                                
    
-- æµè§ˆè·¯å¾„æŒ‰é’®åŠŸèƒ½--new
on btnBrowsePath pressed do (
    g_lastAction = "set-å¯¼å‡ºè·¯å¾„"
    updateModeStatus()
    newPath = getSavePath caption:"é€‰æ‹©å¯¼å‡ºç›®å½•" initialDir:edtExportPath.text
    if newPath != undefined do (
        edtExportPath.text = newPath
        chkAutoFolder.checked = false  -- æ–°å¢ï¼šå–æ¶ˆè‡ªåŠ¨ç”Ÿæˆç›®å½•å‹¾é€‰
        g_lastExportPath = newPath  -- æ›´æ–°æœ€åè·¯å¾„è®°å½•
        -- åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
        AutoExportTool_Pro.refreshFileListView()
    )
)

--- ===== åœ¨ btnBrowsePath æ§ä»¶æ·»åŠ å³é”®åŠŸèƒ½ =====
-- ===== åœ¨æŒ‰é’®äº‹ä»¶ä¸­è°ƒç”¨ =====
-- åœ¨ btnBrowsePath rightclick äº‹ä»¶ä¸­ä¿®æ”¹ä¸ºï¼š
on btnBrowsePath rightclick do (
    
    g_lastAction = "copy-path"
    updateModeStatus()
    
    if edtExportPath.text != "" do (
        -- ä½¿ç”¨å®‰å…¨è·¯å¾„å¤„ç†
        local pathToCopy = pathConfig.normalizePath edtExportPath.text
        
        -- å¤åˆ¶åˆ°å‰ªè´´æ¿
        if (setClipboardText pathToCopy) then (
            -- è®¾ç½®å…¨å±€ä¸´æ—¶è·¯å¾„
            g_tempPathForManager = pathToCopy
            
            -- å…³é—­å·²å­˜åœ¨çš„å¯¹è¯æ¡†ï¼ˆé˜²æ­¢é‡å¤ï¼‰
            try (destroydialog rolPathManager) catch ()
            
            -- è®¡ç®—å¯¹è¯æ¡†ä½ç½®ï¼ˆç¡®ä¿åœ¨å±å¹•å†…ï¼‰
            local dialogPos = mouse.screenPos - [150, 75]
            dialogPos.x = amax 0 (amin dialogPos.x (sysInfo.desktopSize.x - 300))
            dialogPos.y = amax 0 (amin dialogPos.y (sysInfo.desktopSize.y - 130))
            
            -- ç«‹å³æ‰“å¼€ç®¡ç†å™¨ï¼ˆå¸¦ä½ç½®å‚æ•°ï¼‰
            createDialog rolPathManager width:300 height:130 pos:dialogPos
            
            -- è®¾ç½®å¯¹è¯æ¡†æ‰“å¼€æ ‡è®°
            g_pathManagerDialogOpen = true
            
            -- ç›´æ¥å°è¯•å¡«å……è·¯å¾„ï¼ˆä¸å†éœ€è¦å¾ªç¯ï¼‰
            try (
                rolPathManager.edtPathDir.text = g_tempPathForManager
                setFocus rolPathManager.edtPathName
            )
            catch (
                format "[è·¯å¾„ç®¡ç†] è‡ªåŠ¨å¡«å……å¤±è´¥: %\n" (getCurrentException())
            )
        )
        else (
            messageBox "å‰ªè´´æ¿å†™å…¥å¤±è´¥ï¼" title:"é”™è¯¯" beep:true
        )
    )
)

-- æ‰“å¼€è·¯å¾„æŒ‰é’®åŠŸèƒ½--new/up
on btnOpenExportPath pressed do (
    g_lastAction = "æ‰“å¼€å½“å‰è·¯å¾„1"
    updateModeStatus()
    if doesFileExist edtExportPath.text do (
        ShellLaunch "explorer.exe" ("file:///" + edtExportPath.text)  -- å…¼å®¹è·¯å¾„æ ¼å¼1
    )
if g_showRecentFiles do (
    messageBox "oi!è¿™ä¸–ä¸Šä»€ä¹ˆâ€˜æœâ€™éƒ½æœ‰ï¼Œå°±æ˜¯æ²¡æœ‰â€˜å¦‚æœâ€™" title:"é­”å¹»çš„ç°å®â€‹â€‹/æœ€è¿‘æ‰“å¼€æ–‡ä»¶æ¨¡å¼ï¼ï¼" beep:false
)
--g_showRecentFiles = false
)
    -- æ‰“å¼€è·¯å¾„æŒ‰é’®åŠŸèƒ½--new/down
on btnOpenExportPath1 pressed do (
    g_lastAction = "æ‰“å¼€å½“å‰è·¯å¾„2"
    updateModeStatus()
    if doesFileExist edtExportPath.text do (
        ShellLaunch "explorer.exe" ("file:///" + edtExportPath.text)  -- å…¼å®¹è·¯å¾„æ ¼å¼2
    )
    if g_showRecentFiles do (
        messageBox "æˆ‘éµä»äº†å†…å¿ƒçš„æ³•åˆ™ï¼Œè€Œä¸æ˜¯ä¸–ä¿—çš„è§„åˆ™" title:"å¬ä»å†…å¿ƒçš„å£°éŸ³â€‹/æœ€è¿‘æ‰“å¼€æ–‡ä»¶æ¨¡å¼ï¼ï¼ï¼" beep:false
    )
    --g_showRecentFiles = false
)
----------------------------------------------------------------
    --åˆ·æ–°åœºæ™¯é€‰æ‹©é›†
on btn_reset pressed do (
    g_lastAction = " åˆ·æ–°-é€‰æ‹©é›†"
    updateModeStatus()
    GetSetFormScene())
    --æ›´æ–°åˆ°å¯¼å‡ºé€‰æ‹©é›†åç§° æ·»åŠ 
on btn_add_set pressed do (
    g_lastAction = " æ·»åŠ -é€‰æ‹©é›†"
    updateModeStatus()
    -- æ£€æŸ¥é€‰æ‹©é›†æ˜¯å¦æœ‰æ•ˆ
    if selec_set.items.count == 0 do (
        messageBox "è¯·å…ˆåˆ›å»ºæˆ–åˆ·æ–°é€‰æ‹©é›†ï¼" title:"é€‰æ‹©é›†ä¸ºç©º" beep:false
        return undefined
    )
    
    local selName = selec_set.selected
    if selName == undefined or selName == "" do (
        messageBox "æœªé€‰æ‹©æœ‰æ•ˆé€‰æ‹©é›†åç§°ï¼" title:"æ— æ•ˆé€‰æ‹©" beep:false
        return undefined
    )
    
    -- æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåé€‰æ‹©é›†
    local temp_index = findItem export_setsets selName
    if temp_index == 0 do (
        append export_setsets selName
        
        -- å®‰å…¨æ„å»ºæ˜¾ç¤ºå­—ç¬¦ä¸²ï¼ˆè¿‡æ»¤æ— æ•ˆé¡¹ï¼‰
        local temp_string = ""
        for i in export_setsets where (i != undefined and i != "") do (
            temp_string += i + " , "
        )
        temp_string = trimRight temp_string " , "  -- åˆ é™¤æœ«å°¾é€—å·
        
        set_names.text = temp_string
    )
    if export_setsets.count > 1 do (
        auto_makedir_set.checked = true
    )
)
    
-- ä¿®æ”¹åçš„å¯¼å‡ºé…ç½®--é€‰æ‹©é›†--åˆ é™¤æŒ‰é’®é€»è¾‘1ï¼ˆæ— ç¡®è®¤ç›´æ¥åˆ é™¤ï¼‰
on btn_del_set pressed do (
    g_lastAction = " ç§»é™¤-é€‰æ‹©é›†"
    updateModeStatus()
    if export_setsets.count > 0 then
    (
        deleteItem export_setsets export_setsets.count
        
        -- æ„å»ºæ˜¾ç¤ºå­—ç¬¦ä¸²
        local temp_string = ""
        for i = 1 to export_setsets.count do 
        (
            temp_string += export_setsets[i]
            if i < export_setsets.count do temp_string += " , "
        )
        set_names.text = temp_string
    )
    else
    (
        --messageBox "æ²¡æœ‰å¯åˆ é™¤çš„é€‰æ‹©é›†ï¼" title:"æç¤º" beep:false
    )
)
    
--æ‹–æ”¾äº‹ä»¶ç»“æŸ
on Lv_model DragOver sender args do
(
    if args.Data.GetDataPresent (dotNetClass "System.Windows.Forms.DataFormats").FileDrop then
    (
        args.Effect = args.Effect.Copy
    )
    else
    (
        args.Effect = args.Effect.None
    )
)

--æ‹–æ”¾äº‹ä»¶å¼€å§‹
on Lv_model DragDrop sender args do
(
    local dropData = args.Data.GetData (dotNetClass "System.Windows.Forms.DataFormats").FileDrop
    if dropData == undefined do return false
    
    for path in dropData do
    (
        if doesFileExist path then 
        (
            -- æ·»åŠ æ–‡ä»¶
            append model_files_array path
            -- åˆ›å»ºåˆ—è¡¨é¡¹å¹¶æ·»åŠ åˆ°Lv_model
            -- ... (ç±»ä¼¼ä¸Šé¢refreshå‡½æ•°ä¸­çš„æ–‡ä»¶æ·»åŠ é€»è¾‘)
        )
        else if doesDirectoryExist path then 
        (
            -- æ·»åŠ æ–‡ä»¶å¤¹ï¼ˆä½¿ç”¨ç‰¹æ®Šæ ‡è®°ï¼‰
            append model_files_array ("[DIR]"+path)
            -- åˆ›å»ºåˆ—è¡¨é¡¹å¹¶æ·»åŠ åˆ°Lv_model
            -- ... (ç±»ä¼¼ä¸Šé¢refreshå‡½æ•°ä¸­çš„æ–‡ä»¶å¤¹æ·»åŠ é€»è¾‘)
        )
    )
    
    -- åˆ·æ–°åˆ—è¡¨è§†å›¾
    refreshFileListView()
)

-- ä¿®æ”¹æ‹–æ”¾äº‹ä»¶ï¼Œä¿ç•™åŸæœ‰åŠŸèƒ½
on Lv_model DragDrop sender EventArgs do (
        g_showRecentFiles = false
        local data = EventArgs.data.GetFileDropList()
        local validExts = #(".max", ".fbx", ".ms", ".mse", ".bip", ".mzp", ".mcr")
        
        -- æ–°å¢ï¼šæ‹–æ”¾å‰ç¦ç”¨è‡ªåŠ¨å¸ƒå±€
        Lv_model.BeginUpdate()
        
        for k = 0 to data.count-1 do 
        (
            local fPath = pathConfig.normalizePath data.item[k]
            if findItem validExts (toLower(getFilenameType fPath)) > 0 do
            (
                additem_lv Lv_model fPath isDrag:true
                -- æ¯æ¬¡æ·»åŠ åç«‹å³æ›´æ–°å¸ƒå±€ï¼ˆå…³é”®ä¿®å¤ï¼‰
                Lv_model.EndUpdate()
                Lv_model.BeginUpdate()
                updateScrollState() 
            )
        )
        
        -- æ¢å¤å¸ƒå±€æ§åˆ¶
        Lv_model.EndUpdate()
        updateScrollState()
    )
    ----------------------------------------------------------------
    -- ä»…æ¸…ç©ºåˆ—è¡¨æ˜¾ç¤ºçš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ / å¹¶é çœŸå® åˆ é™¤
    on btn_model_close pressed do (
        g_lastAction = "â€‹âœ–â€‹æ¸…ç©º-åˆ—è¡¨"
        updateModeStatus()
        model_files_array = #()
        Lv_model.Items.Clear()
        lblCount.text = "æ–‡ä»¶ï¼š0"
        -- ä¿ç•™å½“å‰è·¯å¾„ä¸é‡ç½®
        format "[æ¸…ç©º] åˆ—è¡¨å·²æ¸…ç©ºï¼Œå½“å‰è·¯å¾„ä¿æŒï¼š%\n" edtExportPath.text
    )
    --edtExportPath.text = pathConfig.normalizePath (getDir #scene) -- é‡ç½®é»˜è®¤è·¯å¾„ - false

-- æ‰¹é‡BIPå¯¼å…¥æ‰§è¡Œäº‹ä»¶ ===========================================
----------------------------------------------------------------
--ä¸€é”®æ¢çš®/XAFå¯¼å‡ºå¯¼å…¥å±æ€§äº‹ä»¶ - è€ƒè™‘åˆ° UI æ’ç‰ˆ å·²æ»¡ / false - ä½œæ²‰æ·€ä»£ç å¤„ç†/å¤‡ç”¨
--xaf ç›¸å…³ é™„ä»¶ å¯¼å‡º å‚æ•° 1 / äº‹ä»¶
on chk_useRotation changed state do (
    g_useCustomRotation = state
    rdo_rotation.visible = state
)

--xaf ç›¸å…³ é™„ä»¶ å¯¼å‡º å‚æ•° 2 / äº‹ä»¶
on rdo_rotation changed state do (
    g_rotationMode = if state == 1 then #tcb else #euler
)

-- æ–‡ä»¶å½’æ¡£ / åç¼€ç›¸å…³ / false æ²‰æ·€ä»£ç 
on edt_excludePrefix entered text do (
    g_excludePrefix = text
)

-- ä¿®æ”¹æŒ‰é’®äº‹ä»¶ç»‘å®šï¼ˆç§»é™¤éª¨éª¼é€‰æ‹©éªŒè¯ï¼‰- æ ¸å¿ƒ/æ‰¹é‡å¤„ç†æ–‡ä»¶ä¸€é”®æ¢çš®ï¼ˆå¯¼å…¥BIP,XAF=é™„ä»¶ï¼Œè½¬å­˜æˆæ–°MAX) è‡ªåŠ¨åˆ›å»ºçš„æŒ‡å®šæ–‡ä»¶å¤¹-//SkinReplace_Output
on btnBatchSkinReplace pressed do (
    try (
        g_lastAction = "ğŸ­ä¸€é”®æ¢çš®"
        updateModeStatus()  -- å…ˆæ›´æ–°çŠ¶æ€å†æ‰§è¡Œæ“ä½œ
        
        disableSceneRedraw()
        
        if queryBox "ç¡®å®šå¼€å§‹æ‰¹é‡æ¢çš®å—ï¼Ÿ\næ–°æ–‡ä»¶å°†ä¿å­˜åˆ° SkinReplace_Output ç›®å½•" title:"ç¡®è®¤æ“ä½œ" do (
        processSkinReplacement()
        )
    )
    catch (
        format "[æ¢çš®é”™è¯¯] %\n" (getCurrentException())
        g_lastAction = "æ“ä½œå¤±è´¥ï¼"
        updateModeStatus()

    )
    enableSceneRedraw()
    completeRedraw()
    --cleanupBipedNodes()
)

-- æ‰¹é‡ï¼ˆè¯†åˆ«åˆ—è¡¨å…¨éƒ¨BIP-æ•°æ®æ–‡ä»¶ï¼Œå¯¼å…¥å½“å‰æ‰“å¼€çš„ MAX æ–‡ä»¶ï¼Œè½¬å­˜æˆæ–°MAXï¼‰è‡ªåŠ¨åˆ›å»ºçš„æŒ‡å®šæ–‡ä»¶å¤¹-// MAX_Imports
on btnBatchImportBip pressed do (
    g_lastAction = "ğŸ“¥æ‰¹é‡BIPå¯¼å…¥"
    updateModeStatus()
    -- 1. è·å–å¾…å¤„ç†æ–‡ä»¶åˆ—è¡¨ 
    local processFiles = #()
    local anyItemChecked = false
    
    -- æ£€æµ‹æ˜¯å¦æœ‰å‹¾é€‰é¡¹
    for i=0 to (Lv_model.Items.Count-1) do (
        if Lv_model.Items.Item[i].Checked do (
            anyItemChecked = true
            exit
        )
    )
    
    -- æ„å»ºå¤„ç†åˆ—è¡¨
    for i=0 to (Lv_model.Items.Count-1) do (
        local item = Lv_model.Items.Item[i]
        local fPath = item.Tag as String
        
        if (toLower (getFilenameType fPath)) == ".bip" do (
            case of (
                (anyItemChecked and item.Checked): append processFiles fPath
                (not anyItemChecked): append processFiles fPath
            )
        )
    )
    
    -- æœ‰æ•ˆæ€§éªŒè¯
    if processFiles.count == 0 do (
        messageBox "æœªæ‰¾åˆ°æœ‰æ•ˆBIPæ–‡ä»¶ï¼" title:"æ“ä½œä¸­æ­¢"
        return undefined
    )
    
    -- 2. åˆ›å»ºè¾“å‡ºç›®å½• ---------------------------------------------------
    local outputDir = pathConfig.appendPath (getDir #scene) "MAX_Imports"
    makeDir outputDir all:true
    
    -- 3. è¿›åº¦æ§åˆ¶åˆå§‹åŒ– -------------------------------------------------
    local successCount = 0
    pbProgress.value = 0
    pbProgress.maximum = processFiles.count
    lblProgressInfo.text = "å‡†å¤‡å¼€å§‹æ‰¹é‡å¯¼å…¥..."
    g_exportAbortFlag = false
    
    -- 4. ä¸»å¤„ç†å¾ªç¯ -----------------------------------------------------
    disableSceneRedraw()
    try (
        for i=1 to processFiles.count where not g_exportAbortFlag do (
            if keyboard.escPressed do (
                g_exportAbortFlag = true
                lblProgressInfo.text = "ç”¨æˆ·ä¸­æ–­æ“ä½œï¼"
                exit
            )
            
            local bipPath = processFiles[i]
            lblProgressInfo.text = "æ­£åœ¨å¯¼å…¥ï¼š" + filenameFromPath bipPath
            -- ä¿å­˜åŸå§‹åœºæ™¯çŠ¶æ€
            local originalScene = holdMaxFile()
            -- æ‰§è¡ŒBIPå¯¼å…¥
            if SilentBipedImport bipPath do (
                -- ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
                --local newName = uniqueFileName outputDir (getFilenameFile maxFileName) ".max"
                local newName = GenerateTargetPath bipPath outputDir
                -- å†²çªå¤„ç†ï¼ˆåŒåæ–‡ä»¶è‡ªåŠ¨ç¼–å·ï¼‰
                --local finalName = uniqueFileNameFromTemplate newName
                -- å®‰å…¨ä¿å­˜æ–‡ä»¶
            if saveMaxFile newName then (
                successCount += 1
                format "[æˆåŠŸ] ä¿å­˜è‡³ï¼š%\n" newName
            )
        )
            -- æ¢å¤åŸå§‹åœºæ™¯
            --fetchMaxFile originalScene quiet:true
            -- æ›´æ–°è¿›åº¦
            pbProgress.value = i
            lblProgressInfo.text = "è¿›åº¦ï¼š" + ((100.0*i/processFiles.count) as integer) as string + "%"
            windows.processPostedMessages()
            
            -- å†…å­˜ä¼˜åŒ–
            if mod i 5 == 0 do (gc(); freeSceneBitmaps())
        )
    )
    catch (
        format "[è‡´å‘½é”™è¯¯] %\n" (getCurrentException())
        messageBox "æ‰¹é‡å¯¼å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿä¸¥é‡é”™è¯¯ï¼" title:"é”™è¯¯" beep:true
    )
    enableSceneRedraw()
    updateModeStatus()
    -- 5. å®Œæˆå¤„ç† -------------------------------------------------------
    lblProgressInfo.text = "æ‰¹é‡-BIP-å¯¼å…¥å®Œæˆï¼ï¼ï¼æˆåŠŸå¯¼å…¥ " + successCount as string + "/" + processFiles.count as string + " ä¸ªBIPæ–‡ä»¶"
    if successCount > 0 do (
        ShellLaunch "explorer.exe" outputDir
        messageBox ("æ–‡ä»¶å·²ä¿å­˜åˆ°ï¼š\n" + outputDir) title:"å®Œæˆ" beep:false
    )
    --cleanupBipedNodes()
)

-- å¼ºåŒ–äº‹ä»¶å¤„ç†
on btnImportBip pressed do 
(
    g_lastAction = "ğŸ®åŠ è½½BIP"
    updateModeStatus()
    try(BsBipedImport())catch(
        messageBox ("å¯¼å…¥å¤±è´¥ï¼š\n" + getCurrentException()) title:"BipedTools" beep:true
    )
    --cleanupBipedNodes()
)

on btnExportBip pressed do 
(
    g_lastAction = "ğŸ’¾ä¿å­˜BIP"
    updateModeStatus()
    try(BsBipedExport())catch(
        messageBox ("å¯¼å‡ºå¤±è´¥ï¼š\n" + getCurrentException()) title:"BipedTools" beep:true
    )
    --cleanupBipedNodes()
)

-- æŒ‰é’®äº‹ä»¶å¤„ç†--false
--on btn_exportCurrentBIP pressed do (
    
    --if processCurrentBipExport != undefined then processCurrentBipExport()
    --else messageBox "å¯¼å‡ºå‡½æ•°æœªåˆå§‹åŒ–ï¼" title:"ä¸¥é‡é”™è¯¯"
--)


-- ä¿æŒåŸæœ‰æŒ‰é’®äº‹ä»¶ç»‘å®š
on btn_bipBatchChecked pressed do (
    g_lastAction = "ğŸï¸CK-å¯¼å‡ºBIP" 
    updateModeStatus()
    -- æ£€æŸ¥å‰ç½®æ¡ä»¶
    if model_files_array.count == 0 do (
        messageBox "          æ–‡ä»¶åˆ—è¡¨ä¸ºç©ºï¼" title:"æ“ä½œä¸­æ­¢" beep:false
        for c in AutoExportTool_Pro.controls do c.enabled = true
        return undefined
    )
-
    updateModeStatus()
    processBipFiles rdo_bipMode.state true
    --cleanupBipedNodes()
)

on btn_bipBatchAll pressed do (
    g_lastAction = "ğŸ’¤ALL-å¯¼å‡ºBIP" 
    updateModeStatus()
    -- æ£€æŸ¥å‰ç½®æ¡ä»¶
    if model_files_array.count == 0 do (
        messageBox "          æ–‡ä»¶åˆ—è¡¨ä¸ºç©ºï¼" title:"æ“ä½œä¸­æ­¢" beep:false
        for c in AutoExportTool_Pro.controls do c.enabled = true
        return undefined
    )
    
    updateModeStatus()
    processBipFiles rdo_bipMode.state false
    --cleanupBipedNodes()
)
----------------------------------------------------------------
----------------------------------------------------------------
--false
on btn_pauseResume pressed do (   
        g_processPaused = not g_processPaused
        btn_pauseResume.text = if g_processPaused then "â–¶ç»§ç»­" else "â¸æš‚åœ"
    )
    ----------------------------------------------------------------
    -- ===================== æ‰¹é‡å¯¼å‡º -ï¼ˆä¸»æ‰§è¡Œäº‹ä»¶ï¼‰===========================
    
-- æ‰¹é‡å¯¼å‡º-lv åˆ—è¡¨ æ‰€æœ‰æ–‡ä»¶--éå‹¾é€‰--å¯¼å‡ºäº‹ä»¶å¤„ç†-- å¼ºåŒ–å¯¼å‡ºä¸»æµç¨‹ï¼ˆæ·»åŠ å¤šå±‚ä¿æŠ¤ï¼‰ï¼ˆè·³è¿‡é”™è¯¯æ–‡ä»¶ï¼‰ï¼ˆè¿›åº¦æ¡æ˜¾ç¤ºï¼‰...

----------------------------------------------------------------
-- LV-åˆ—è¡¨å…¨éƒ¨å¯¼å‡º // FBX-æ‰¹é‡å¯¼å‡ºåˆ—è¡¨å…¨éƒ¨ MAX æ–‡ä»¶
on btn_aotu_model pressed do (
    g_lastAction = "âš¡æ‰¹é‡å¯¼å‡º"
    updateModeStatus()
    
    -- æ£€æŸ¥æ–‡ä»¶åˆ—è¡¨æ˜¯å¦ä¸ºç©º
    if model_files_array.count == 0 do (
        messageBox "æ–‡ä»¶åˆ—è¡¨ä¸ºç©ºï¼" title:"æ“ä½œä¸­æ­¢" beep:true
        return undefined
    )
    
    -- æ£€æŸ¥é€‰æ‹©é›†æ˜¯å¦é…ç½®
    if export_setsets.count == 0 do (
        messageBox "å¯¼å‡ºé€‰æ‹©é›†æœªé…ç½®ï¼" title:"æ“ä½œä¸­æ­¢" beep:true
        return undefined
    )

    -- é‡ç½®ä¸­æ–­æ ‡å¿—
    g_exportAbortFlag = false
    clearlistener()
    
    -- åˆå§‹åŒ–è¿›åº¦æ§åˆ¶
    local totalProgress = 0.0
    pbProgress.value = 0
    pbProgress.maximum = model_files_array.count * 100  -- æ¯ä¸ªé¡¹ç›®é¢„ç•™100%è¿›åº¦ç©ºé—´
    pbProgress.Refresh()
    btn_aotu_model.enabled = false
    
    local successCount = 0
    
    -- ä¸»å¤„ç†å¾ªç¯
    for i = 1 to model_files_array.count where not g_exportAbortFlag do (
        -- ESCé”®æ£€æµ‹
        if keyboard.escPressed do (
            g_exportAbortFlag = true
            format "[ç”¨æˆ·ä¸­æ–­] å¯¼å‡ºè¿›ç¨‹å·²è¢«æ‰‹åŠ¨ç»ˆæ­¢\n"
            lblProgressInfo.text = "æ“ä½œå·²ä¸­æ–­ï¼" 
            windows.processPostedMessages()
            messageBox "å¯¼å‡ºè¿›ç¨‹å·²è¢«ç”¨æˆ·ä¸­æ–­ï¼" title:"æ“ä½œæç¤º" beep:true
            exit
        )

        -- å¤„ç†å½“å‰é¡¹ç›®
        local currentItem = model_files_array[i]
        
        -- æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡ä»¶å¤¹é¡¹
        if matchPattern currentItem pattern:"[DIR]*" then (
            -- å¤„ç†æ–‡ä»¶å¤¹
            local folderPath = substring currentItem 6 -1  -- ç§»é™¤"[DIR]"å‰ç¼€
            
            lblProgressInfo.text = "æ­£åœ¨å¤„ç†æ–‡ä»¶å¤¹ï¼š" + filenameFromPath folderPath
            
            -- è·å–æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰maxæ–‡ä»¶
            local folderFiles = getFiles (folderPath + "\\*.max")
            local folderFileCount = folderFiles.count
            
            -- ä¸ºå½“å‰è§’è‰²æ–‡ä»¶å¤¹åˆ›å»ºFBXå¯¼å‡ºå­ç›®å½•
            local fbxExportDir = folderPath + "\\FBX_Export"
            if not doesDirectoryExist fbxExportDir do (
                makeDir fbxExportDir all:true
                format "[åˆ›å»ºç›®å½•] %\n" fbxExportDir
            )
            
            if folderFileCount > 0 then (
                -- å¤„ç†æ–‡ä»¶å¤¹ä¸­çš„æ¯ä¸ªæ–‡ä»¶ / å¤„ç†æ–‡ä»¶å¤¹ä¸­çš„æ¯ä¸ªæ–‡ä»¶ - æ·»åŠ ä¸­æ–­æ£€æµ‹
                for j = 1 to folderFileCount do (
                    -- å®æ—¶æ£€æµ‹ESCé”®
                    if keyboard.escPressed do (
                        g_exportAbortFlag = true
                        format "[ç”¨æˆ·ä¸­æ–­] æ–‡ä»¶å¤¹å¤„ç†å·²è¢«ç»ˆæ­¢\n"
                        lblProgressInfo.text = "æ“ä½œå·²ä¸­æ–­ï¼" 
                        windows.processPostedMessages()
                        exit
                    )
                    
                    local currentFile = folderFiles[j]
                    
                    lblProgressInfo.text = "å¤„ç†æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶ï¼š" + filenameFromPath currentFile
                    
                    -- åŠ è½½å¹¶å¯¼å‡ºæ–‡ä»¶
                    if (load_file currentFile) then (
                        export_mod_fn rdo_exportMode.state
                        refreshSceneSetsCache()
                        
                        -- éªŒè¯é€‰æ‹©é›†æœ‰æ•ˆæ€§
                        local validSets = for s in export_setsets where (findItem g_sceneSetsCache s > 0) collect s
                        
                        if validSets.count > 0 do (
                            -- åº”ç”¨æŒ‚ç‚¹å½’é›¶
                            if auto_socket.checked do resetSocketTransforms()
                            
                            for setName in validSets do (
                                if selectExportobject setName and (export_file currentFile setName fbxExportDir) do (
                                    successCount += 1
                                )
                            -- æ·»åŠ é¢å¤–ä¸­æ–­æ£€æŸ¥ç‚¹
                            if keyboard.escPressed do (
                                g_exportAbortFlag = true
                                format "[ç”¨æˆ·ä¸­æ–­] é€‰æ‹©é›†å¤„ç†å·²è¢«ç»ˆæ­¢\n"
                                lblProgressInfo.text = "æ“ä½œå·²ä¸­æ–­ï¼" 
                                windows.processPostedMessages()
                                exit
                            )
                            
                        )
                        
                      )
                    )
                    else (
                        format "[é”™è¯¯] æ— æ³•åŠ è½½æ–‡ä»¶ï¼š%\n" currentFile
                    )
                    
                    -- æ›´æ–°è¿›åº¦
                    totalProgress += (100.0 / folderFileCount)
                    pbProgress.value = totalProgress as integer
                )
            )
            else (
                format "[è·³è¿‡] æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰.maxæ–‡ä»¶ï¼š%\n" folderPath
                totalProgress += 100  -- è·³è¿‡ç©ºæ–‡ä»¶å¤¹ä»ç„¶è®¡å…¥è¿›åº¦
                pbProgress.value = totalProgress as integer
            )
        )
        else (
            -- å¤„ç†å•ä¸ªæ–‡ä»¶
            lblProgressInfo.text = "æ­£åœ¨å¤„ç†æ–‡ä»¶ï¼š" + filenameFromPath currentItem
             -- ç¡®å®šå¯¼å‡ºè·¯å¾„
             local enginePath = getEngineExportPath currentItem
             local targetPath = if enginePath != undefined and doesDirectoryExist enginePath then enginePath else edtExportPath.text
            -- åŠ è½½æ–‡ä»¶
            if (load_file currentItem) then (
                export_mod_fn rdo_exportMode.state
                refreshSceneSetsCache()
                -- åº”ç”¨æŒ‚ç‚¹å½’é›¶
                if auto_socket.checked do resetSocketTransforms()
                -- éªŒè¯é€‰æ‹©é›†æœ‰æ•ˆæ€§
                local validSets = for s in export_setsets where (findItem g_sceneSetsCache s > 0) collect s
                
                if validSets.count > 0 do (
                    for setName in validSets do (
                        if selectExportobject setName and (export_file currentItem setName targetPath) do (
                            successCount += 1
                        )
                    )
                )
            )
            else (
                format "[é”™è¯¯] æ— æ³•åŠ è½½æ–‡ä»¶ï¼š%\n" currentItem
            )
            
            -- æ›´æ–°è¿›åº¦
            totalProgress += 100
            pbProgress.value = totalProgress as integer
        )
        
        -- æ›´æ–°è¿›åº¦æ˜¾ç¤º
        lblProgressInfo.text = "è¿›åº¦ï¼š" + ((totalProgress / model_files_array.count) as integer) as string + "%"
        windows.processPostedMessages()
        
    )

    -- å®Œæˆå¤„ç†
    lblProgressInfo.text = "æ‰¹é‡å¯¼å‡ºå®Œæˆï¼æˆåŠŸå¯¼å‡º " + (successCount as string) + " ä¸ªæ–‡ä»¶"
    btn_aotu_model.enabled = true
    
    -- æ–°å¢ï¼šå¯¼å‡ºå®Œæˆååˆ·æ–°åˆ—è¡¨
    refreshFileListView forceRefresh:true
    format "[åˆ—è¡¨æ›´æ–°] æ‰¹é‡å¯¼å‡ºååˆ·æ–°æ–‡ä»¶åˆ—è¡¨\n"
    
    if chk_autoOpenDir.checked do ShellLaunch "explorer.exe" edtExportPath.text 
)

----------------------------------------------------------------
-- LV-åˆ—è¡¨å‹¾é€‰å¯¼å‡º--æ‰¹é‡å¯¼å‡ºäº‹ä»¶å¤„ç†--æ–°å¢
-- å¯¼å‡ºå‹¾é€‰æ–‡ä»¶å¤„ç†ï¼ˆæ”¯æŒæ–‡ä»¶å¤¹é€’å½’ï¼‰
on btn_export_checked pressed do (
    g_lastAction = "ğŸš€å¯¼å‡ºå‹¾é€‰"
    updateModeStatus()
    
    -- é€’å½’è·å–æ–‡ä»¶å¤¹å†…æ‰€æœ‰.maxæ–‡ä»¶
    fn getAllMaxFilesInFolder folderPath = (
        local maxFiles = #()
        local files = getFiles (folderPath + "\\*.max")
        join maxFiles files
        
        -- é€’å½’å­æ–‡ä»¶å¤¹
        local subDirs = getDirectories (folderPath + "\\*")
        for dir in subDirs do (
            join maxFiles (getAllMaxFilesInFolder dir)
        )
        maxFiles
    )
    
    -- æ”¶é›†æ‰€æœ‰éœ€è¦å¯¼å‡ºçš„æ–‡ä»¶
    local filesToExport = #()
    
    -- éå†å‹¾é€‰é¡¹
    for i = 0 to (Lv_model.Items.Count - 1) do (
        if Lv_model.Items.Item[i].Checked do (
            local itemPath = Lv_model.Items.Item[i].Tag as String
            
            -- å¤„ç†æ–‡ä»¶å¤¹é¡¹
            if matchPattern itemPath pattern:"[DIR]*" then (
                local folderPath = substring itemPath 6 -1
                if doesDirectoryExist folderPath do (
                    join filesToExport (getAllMaxFilesInFolder folderPath)
                )
            )
            -- å¤„ç†å•ä¸ªæ–‡ä»¶é¡¹
            else (
                if (getFilenameType itemPath) == ".max" and doesFileExist itemPath do (
                    append filesToExport itemPath
                )
            )
        )
    )
    
    -- æ£€æŸ¥å‰ç½®æ¡ä»¶
    if filesToExport.count == 0 do (
        messageBox "å‹¾é€‰å¯¼å‡ºä¸æ”¯æŒæ–‡ä»¶å¤¹å¯¼å‡ºï¼" title:"æç¤º" beep:true
        return undefined
    )
    
    if export_setsets.count == 0 do (
        messageBox "è¯·å…ˆæ·»åŠ å¯¼å‡ºé€‰æ‹©é›†ï¼" title:"æç¤º" beep:true
        return undefined
    )

    -- è·å–å¯¼å‡ºåŸºç¡€è·¯å¾„
    local exportBasePath = edtExportPath.text
    
    -- åˆå§‹åŒ–è¿›åº¦æ§åˆ¶
    local totalProgress = 0.0
    pbProgress.value = 0
    pbProgress.maximum = filesToExport.count * 100
    pbProgress.Style = (dotNetClass "System.Windows.Forms.ProgressBarStyle").Continuous
    btn_export_checked.enabled = false
    clearlistener()
    g_exportAbortFlag = false

    -- åœ¨å¯¼å‡ºå‰è®¾ç½®FBXå‚æ•°
    export_mod_fn rdo_exportMode.state
    
    local successCount = 0
    for filePath in filesToExport where not g_exportAbortFlag do (
        -- ESCé”®æ£€æµ‹
        if keyboard.escPressed do (
            g_exportAbortFlag = true
            lblProgressInfo.text = "æ“ä½œå·²ä¸­æ–­ï¼"
            messageBox "å¯¼å‡ºè¿›ç¨‹å·²è¢«ç”¨æˆ·ä¸­æ–­ï¼" title:"æ“ä½œæç¤º" beep:true
            exit
        )

        lblProgressInfo.text = "æ­£åœ¨å¤„ç†ï¼š" + filenameFromPath filePath
        windows.processPostedMessages()

        -- åŠ è½½æ–‡ä»¶
        if (loadMaxFile filePath quiet:true) do (
            -- æŒ‚ç‚¹å½’é›¶
            if auto_socket.checked do resetSocketTransforms()
            
            -- åˆ·æ–°åœºæ™¯é€‰æ‹©é›†ç¼“å­˜
            refreshSceneSetsCache()
            
            -- éªŒè¯é€‰æ‹©é›†æœ‰æ•ˆæ€§
            local validSets = #()
            local validCount = 0
            for o in export_setsets do (
                if findItem g_sceneSetsCache o > 0 do (
                    append validSets o
                    validCount += 1
                )
            )
            
            -- æ‰§è¡Œå¯¼å‡º
            local fileSuccess = 0
            for o in validSets do (
                if selectExportobject o and (export_file filePath o exportBasePath) do (
                    successCount += 1
                    fileSuccess += 1
                )
            )
            
            format "[æˆåŠŸ] æ–‡ä»¶ % å¯¼å‡º %/% ä¸ªé€‰æ‹©é›†\n" filePath fileSuccess validCount
            
            -- æ›´æ–°è¿›åº¦
            totalProgress += 100
            pbProgress.value = totalProgress as integer
            lblProgressInfo.text = "è¿›åº¦ï¼š" + ((totalProgress / filesToExport.count) as integer) as string + "%"
            windows.processPostedMessages()
        )
    )
    
    -- å®Œæˆå¤„ç†
    lblProgressInfo.text = "æ–‡ä»¶å‹¾é€‰å¯¼å‡ºå®Œæˆï¼æˆåŠŸå¤„ç† " + (successCount as string) + " ä¸ªæ–‡ä»¶"
    btn_export_checked.enabled = true
    
    -- æ–°å¢ï¼šå¯¼å‡ºå®Œæˆååˆ·æ–°åˆ—è¡¨
    refreshFileListView forceRefresh:true
    format "[åˆ—è¡¨æ›´æ–°] å‹¾é€‰å¯¼å‡ºååˆ·æ–°æ–‡ä»¶åˆ—è¡¨\n"
    
    if chk_autoOpenDir.checked and doesDirectoryExist exportBasePath do (
        ShellLaunch "explorer.exe" exportBasePath
    )
    
    gc light:true
    freeSceneBitmaps()
)

--æ‰‹åŠ¨FBXå¯¼å‡ºæ¨¡å¼--å¯¼å‡ºå½“å‰åœºæ™¯--å•ä¸ªæ–‡ä»¶--å¯¼å‡ºäº‹ä»¶å¤„ç†
   
on btn_exp_M_fbx pressed do (
    g_lastAction = "ğŸ¯å¯¼å‡ºå½“å‰"
    updateModeStatus()
    -- ä¿®æ”¹åçš„éªŒè¯é€»è¾‘
    if rdo_exportMode.state == 3 do (
        if animationRange.end <= animationRange.start do (
            msg = case of (
            (animationRange.end <= animationRange.start): "åŠ¨ç”»èŒƒå›´æ— æ•ˆï¼ˆèµ·å§‹å¸§å¿…é¡»å°äºç»“æŸå¸§ï¼‰ï¼"
            )
            messageBox msg title:"Bakeæ¨¡å¼é”™è¯¯"
            return undefined
        )
    )
    -- é‡ç½®è¿›åº¦æ¡å¹¶å¼ºåˆ¶é¢œè‰²åˆ·æ–°
    pbProgress.value = 0
    windows.processPostedMessages()  -- å…³é”®ï¼ç¡®ä¿UIæ›´æ–°
    
    clearlistener()
    
    -- æ£€æŸ¥é€‰æ‹©é›†é…ç½®
    if export_setsets.count == 0 do (
        messageBox "è¯·å…ˆæ·»åŠ å¯¼å‡ºé€‰æ‹©é›†ï¼" title:"æ“ä½œä¸­æ­¢" 
        return undefined
    )
    
    -- åˆ·æ–°åœºæ™¯é€‰æ‹©é›†ç¼“å­˜
    refreshSceneSetsCache()
    
    -- éªŒè¯é€‰æ‹©é›†æœ‰æ•ˆæ€§
    local validSets = for o in export_setsets where (findItem g_sceneSetsCache o > 0) collect o
    local missingSets = for o in export_setsets where (findItem g_sceneSetsCache o == 0) collect o
    
    -- å•ä¸ªé€‰æ‹©é›†ä¸å­˜åœ¨æ—¶ç«‹å³ä¸­æ–­
    if export_setsets.count == 1 and validSets.count == 0 do (
        msg = "é€‰æ‹©é›† [" + export_setsets[1] + "] ä¸å­˜åœ¨ï¼\nè¯·åˆ›å»ºé€‰æ‹©é›†åé‡è¯•ï¼"
        messageBox msg title:"å¯¼å‡ºä¸­æ–­"
        return undefined
    )
    
    -- å¤šé€‰æ‹©é›†éƒ¨åˆ†ç¼ºå¤±æç¤º
    if missingSets.count > 0 do (
        missingInfo = "ä»¥ä¸‹é€‰æ‹©é›†ä¸å­˜åœ¨ï¼š\n" + (join missingSets "\n")
        if queryBox (missingInfo + "\n\næ˜¯å¦ç»§ç»­å¯¼å‡ºæœ‰æ•ˆé€‰æ‹©é›†ï¼Ÿ") title:"é€‰æ‹©é›†ç¼ºå¤±è­¦å‘Š" == false do (
            return undefined
        )
    )
    
    -- è·å–å½“å‰åœºæ™¯è·¯å¾„å¹¶æ£€æŸ¥æœ‰æ•ˆæ€§
    local exportPath = edtExportPath.text
    if exportPath == undefined or exportPath == "" do (
        messageBox "å¯¼å‡ºè·¯å¾„æœªè®¾ç½®ï¼" title:"é”™è¯¯"
        return undefined
    )
    makeDir exportPath all:true  -- ç¡®ä¿ç›®å½•å­˜åœ¨
    
    -- é…ç½®è¿›åº¦æ¡ï¼ˆæ ¹æ®å®é™…æœ‰æ•ˆé›†æ•°é‡ï¼‰
    pbProgress.maximum = validSets.count
    pbProgress.Refresh()
    lblProgressInfo.text = "å¼€å§‹å¯¼å‡ºå½“å‰åœºæ™¯..."
    
    -- æ‰§è¡Œå¯¼å‡º
    export_mod_fn rdo_exportMode.state
    local successCount = 0
    for i = 1 to validSets.count do (
        -- æ£€æµ‹ESCä¸­æ–­
        if keyboard.escPressed do (
            g_exportAbortFlag = true
            format "[ç”¨æˆ·ä¸­æ–­] å¯¼å‡ºè¿›ç¨‹å·²è¢«æ‰‹åŠ¨ç»ˆæ­¢\n"
            lblProgressInfo.text = "æ“ä½œå·²ä¸­æ–­ï¼" 
            windows.processPostedMessages()
            messageBox "å¯¼å‡ºè¿›ç¨‹å·²è¢«ç”¨æˆ·ä¸­æ–­ï¼" title:"æ“ä½œæç¤º" beep:true
            exit  -- ç›´æ¥é€€å‡ºå¾ªç¯
        )
        
        local setName = validSets[i]
        if selectExportobject setName then (
            local objCount = selection.count  -- è·å–å½“å‰é€‰æ‹©é›†ç‰©ä½“æ•°
            if (export_file maxFilePath setName exportPath) then (
                -- åº”ç”¨æŒ‚ç‚¹å½’é›¶
                if auto_socket.checked do resetSocketTransforms()
                successCount += 1
                format "[Object/æ•°é‡] % â†’ å¯¼å‡ºç‰©ä½“: % ä¸ª\n" setName objCount  -- æ–°å¢ç‰©ä½“æ•°æ˜¾ç¤º
                format "[Export//è·¯å¾„] å·²å¯¼å‡ºï¼š% åˆ° %\n" setName exportPath
            ) else (
                format "[å¤±è´¥] å¯¼å‡ºé€‰æ‹©é›†ï¼š%\n" setName
            )
            
            pbProgress.value = i
            progressPercent = (100.0 * i / validSets.count) as integer
            lblProgressInfo.text = "è¿›åº¦ï¼š" + progressPercent as string + "%"
            windows.processPostedMessages()
        )
        
    )
    
    -- å®Œæˆå¤„ç†ï¼ˆä»…åœ¨æœªä¸­æ–­æ—¶æ‰§è¡Œï¼‰
    if not g_exportAbortFlag do (
        finalPercent = (100.0 * successCount / validSets.count) as integer
        lblProgressInfo.text = "å½“å‰å¯¼å‡ºåœºæ™¯-å®Œæˆï¼ï¼ï¼"+ "-*FBX* â†’Objects: " + selection.count as string +" ä¸ª//Prog-è¿›åº¦ï¼š" + finalPercent as string + "%"
        if chk_autoOpenDir.checked do ShellLaunch "explorer.exe" exportPath
        
        -- å¼‚å¸¸æƒ…å†µæç¤º
        case of (
            (successCount == 0): (
                messageBox "æ‰€æœ‰é€‰æ‹©é›†å¯¼å‡ºå¤±è´¥ï¼" title:"å¯¼å‡ºç»“æœ"
            )
            (successCount < validSets.count): (
                msg = "éƒ¨åˆ†å¯¼å‡ºæˆåŠŸï¼š\næˆåŠŸï¼š" + successCount as string + "\nå¤±è´¥ï¼š" + (validSets.count - successCount) as string
                messageBox msg title:"å¯¼å‡ºç»“æœ"
            )
        )
    )
    refreshFileListView forceRefresh:true
    -- é‡ç½®ä¸­æ–­æ ‡å¿—å¹¶æ¢å¤æ§ä»¶
    g_exportAbortFlag = false
    for c in AutoExportTool_Pro.controls do c.enabled = true
)

    ----------------------------------------------------------------
    -- å“åº”æ–‡æœ¬å˜åŒ–çš„å®æ—¶è°ƒæ•´
    on btn_aotu_model text changed newText do updateButtonLayout()
    on btn_exp_M_fbx text changed newText do updateButtonLayout()
    -- æ·»åŠ å¸¸ç”¨è·¯å¾„æŒ‰é’®äº‹ä»¶
on btnAddLikedDir pressed do (
    createdialog rolAddExportPath pos:mouse.screenpos
)

on btnAddLikedDir rightclick do (
    if ltbLikedDir.selection > 0 do (
        deleteItem iniLikedDir (iniLikedFolder.count + 1 - ltbLikedDir.selection)
        ltbLikedDir.items = for i = iniLikedFolder.count to 1 by -1 collect iniLikedFolder[i].name
        fnSaveConfig()
    )
)

-- åŒå‡»å¸¸ç”¨ç›®å½•è·³è½¬
on ltbLikedDir doubleClicked idx do (
    local dir = iniLikedFolder[iniLikedFolder.count + 1 - idx].dir
    if doesDirectoryExist dir do (
        edtExportPath.text = dir
        model_files_array = #()
        Lv_model.items.clear()
        local maxFiles = getFiles (dir + "\\*.max")
        for f in maxFiles do additem_lv Lv_model f
    )
)
    
on AutoExportTool_Pro close do (
    saveUIConfig()
    setINISetting g_ConfigPath "Layout" "CustomMode" (g_forceCustomLayout as string)
	setINISetting g_ConfigPath "Font" "UseAlternate" (chkChangeFont.checked as string)
    FbxExporterSetParam "ResetExport"  -- å…³é”®ä¿®å¤ï¼šå…³é—­æ—¶å¼ºåˆ¶é‡ç½®
    --try(destroyDialog rolVersionManager )catch()   -- false
    
    try(destroyDialog rolXAFEditor)catch()
    try(destroyDialog rolCharacterMapping)catch()   -- true
    try(destroyDialog rolPathManager)catch()   -- true
    
    --try(destroyDialog rolSelSetTools)catch()   -- false / æ²‰æ·€ä»£ç 
    
    try (
        -- å®‰å…¨åœæ­¢å®šæ—¶å™¨ ------------------------------------
        if g_refreshTimer != undefined do (
            if g_refreshTimer.Enabled do (
                g_refreshTimer.Stop()
                dotNet.removeAllEventHandlers g_refreshTimer
                format "[è°ƒè¯•] å®šæ—¶å™¨å·²åœæ­¢\n"
            )
            g_refreshTimer = undefined  -- é‡Šæ”¾å¼•ç”¨
        )
    ) catch (
        format "[è­¦å‘Š] å®šæ—¶å™¨å…³é—­å¼‚å¸¸: %\n" (getCurrentException())
    )
-- 1. ä¿å­˜ç”¨æˆ·è·¯å¾„é…ç½®
    saveConfig()
  -- 2. ä¿å­˜çª—å£ä½ç½®åˆ°ç‹¬ç«‹æ–‡ä»¶
    try (
        -- ç¡®ä¿çª—å£ä½ç½®é…ç½®æ–‡ä»¶ç›®å½•å­˜åœ¨
        local windowPosDir = getFilenamePath g_WindowPosPath
        makeDir windowPosDir all:true
        
        -- è·å–å¹¶ä¿å­˜å½“å‰çª—å£ä½ç½®
        local currentPos = GetDialogPos AutoExportTool_Pro
        if classOf currentPos == Point2 do (
            setIniSetting g_WindowPosPath "WindowSettings" "LastPos" (currentPos as string)
            format "[posé…ç½®] çª—å£ä½ç½®å·²ä¿å­˜åˆ°ï¼š%\n" g_WindowPosPath
        )
    ) catch (
        format "[è­¦å‘Š] æ— æ³•ä¿å­˜çª—å£ä½ç½®ï¼š%\n" (getCurrentException())
    )
    -- åœæ­¢æ–‡ä»¶ç›‘æ§
    try (
        if g_autoSaveWatcher != undefined do (
            g_autoSaveWatcher.EnableRaisingEvents = false
            dotNet.removeAllEventHandlers g_autoSaveWatcher
        )
    ) catch ()
    -- 3. é”€æ¯å¯¹è¯æ¡†
    destroyDialog AutoExportTool_Pro
)

--ä¸»æ’ä»¶æ‰“å¼€/åˆå§‹åŒ–
on AutoExportTool_Pro open do (
    -- åŠ è½½è‡ªåŠ¨æ£€æŸ¥æ›´æ–°è®¾ç½®
    local autoCheckSetting = getINISetting g_UIConfigPath "Settings" "AutoCheckUpdate"
    if autoCheckSetting != "" do (
        g_autoCheckUpdate = (autoCheckSetting == "true")
    )
    
    -- è‡ªåŠ¨æ£€æŸ¥æ›´æ–°ï¼ˆå¦‚æœä¸æ˜¯é™é»˜æ¨¡å¼ï¼‰
    if g_autoCheckUpdate do (
        checkForUpdates silent:true
    )
    
    -- æ·»åŠ æ’ä»¶æ¢å¤æ£€æŸ¥
    try (
        if not doesFileExist g_pluginPath and doesFileExist g_backupPluginPath do (
            -- ä»å¤‡ä»½æ¢å¤æ’ä»¶
            makeDir (getFilenamePath g_pluginPath) all:true
            copyFile g_backupPluginPath g_pluginPath
            format "[æ¢å¤] æ’ä»¶å·²ä»å¤‡ä»½æ¢å¤: %\n" g_pluginPath
        )
    )
    catch (
        format "[æ’ä»¶æ¢å¤é”™è¯¯] %\n" (getCurrentException())
    )
    
    loadCharacterMappings()
    checkAndRecoverPlugin()
    -- è®¾ç½®æ‹–åŠ¨åŒºåŸŸçš„æ ·å¼
    lblTitle.text = "ğŸ–±ï¸ Mouse â‡† â‡³â€‹ Move - ğŸ‘† æ‹–æ‹½æ­¤å¤„ç§»åŠ¨çª—å£"
    lblTitle.backColor = (dotNetClass "System.Drawing.Color").FromArgb 50 50 50
    lblTitle.foreColor = (dotNetClass "System.Drawing.Color").FromArgb 220 220 255
    lblTitle.TextAlign = (dotNetClass "System.Drawing.ContentAlignment").MiddleCenter
    lblTitle.Font = dotNetObject "System.Drawing.Font" "Microsoft YaHei UI" 10 ((dotNetClass "System.Drawing.FontStyle").Bold)
    lblTitle.Cursor = (dotNetClass "System.Windows.Forms.Cursors").SizeAll
    
    -- 1. ç¡®ä¿é…ç½®æ–‡ä»¶å­˜åœ¨----------------------------------------
        local configDir = getFilenamePath g_UIConfigPath
        makeDir configDir all:true  -- åˆ›å»ºé…ç½®ç›®å½•
        
    -- ç¡®ä¿INIå­˜åœ¨
    try (
        -- 1. é…ç½®æ–‡ä»¶åˆå§‹åŒ–---------------------------------------
        if not doesFileExist g_UIConfigPath do (
            -- åˆ›å»ºé…ç½®æ–‡ä»¶å¹¶å†™å…¥é»˜è®¤å€¼
            makeDir (getFilenamePath g_UIConfigPath) all:true
            setINISetting g_UIConfigPath "Settings" "BgGrayValue" "45"
            format "[åˆå§‹åŒ–] åˆ›å»ºæ–°é…ç½®æ–‡ä»¶ï¼š%\n" g_UIConfigPath
            
            -- ç«‹å³åº”ç”¨ç¡¬ç¼–ç é»˜è®¤å€¼
            sldBgColor.value = 45
            Lv_model.BackColor = (dotNetClass "System.Drawing.Color").FromArgb 45 45 45
        )
        
        -- 2. åŠ è½½æ ¸å¿ƒé…ç½®-----------------------------------------
        loadConfig()   -- åŠ è½½æ–‡ä»¶è·¯å¾„ï¼›å¸¸ç”¨ç›®å½•..ç­‰é…ç½® /ï¼ˆä¸­æ–‡å…¼å®¹ï¼‰
        loadUIConfig() -- åŠ è½½UIé…ç½®ï¼ˆå¿…é¡»åœ¨å…¶ä»–UIæ“ä½œå‰è°ƒç”¨ï¼‰
         -- ä¿®å¤èƒŒæ™¯è‰²åˆå§‹åŒ–
        local bgValue = executeSafe (getINISetting g_UIConfigPath "Settings" "BgGrayValue") g_defaultBgValue
        bgValue = amax 0 (amin 255 bgValue)
        sldBgColor.value = bgValue
        setBackgroundColor bgValue  -- ç¡®ä¿è°ƒç”¨è®¾ç½®å‡½æ•°
        -- 3. UIåˆå§‹åŒ–---------------------------------------------
        adjustColumnWidths forceCustom:chkChangeFont.checked
        Lv_model.Font = if chkChangeFont.checked then g_alternateFont else g_defaultFont
        
        -- 4. æœ€ç»ˆéªŒè¯---------------------------------------------
        format "[UIåˆå§‹åŒ–å®Œæˆ] å½“å‰æ»‘å—å€¼ï¼š% | èƒŒæ™¯è‰²ï¼š%\n" \
            sldBgColor.value \
            Lv_model.BackColor.ToString()
    )
    catch (
        format "[åˆå§‹åŒ–é”™è¯¯] %\n" (getCurrentException())
    )
    
    --local fontState = getINISetting g_ConfigPath "Font" "UseAlternate" / false
    --chkChangeFont.checked = if fontState == "true" then true else false /false
    
    chkChangeFont.checked = true  -- è¦†ç›–INIé…ç½®ï¼Œå¼ºåˆ¶å‹¾é€‰
    g_forceCustomLayout = true    -- åŒæ­¥å…¨å±€çŠ¶æ€
    adjustColumnWidths forceCustom:true -- ç«‹å³åº”ç”¨åˆ—å®½
    Lv_model.Font = g_alternateFont     -- å¼ºåˆ¶åº”ç”¨å­—ä½“
  
    -- è®¾ç½®æ»‘æ¡åˆå§‹å€¼ä¸åˆ—è¡¨èƒŒæ™¯åŒæ­¥ / false / æ²‰æ·€ä»£ç 
    --sldBgColor.value = 55
    --Lv_model.BackColor = (dotNetClass "System.Drawing.Color").FromArgb 55  55  55

    -- åŠ¨æ€ç»‘å®šå‡½æ•°åˆ°Rollout / false / æ²‰æ·€ä»£ç 
    --AutoExportTool_Pro.getProcessFiles = getProcessFiles
    --AutoExportTool_Pro.batchProcessSelSets = batchProcessSelSets

    --å¸¸ç”¨ç›®å½•çš„æ ¸å¿ƒä¸‹æ‹‰åˆ—è¡¨æ›´æ–° / true 
    ddlLikedPaths.items = for f in g_likedFolders collect f.name
    --loadRecentFiles()
    
    --è¯»å–çª—å£ä½ç½®--ä½ç½®è®°å¿†ï¼ˆopenï¼‰-- true--éªŒè¯å®ç°
     -- å®šä¹‰é»˜è®¤ä½ç½®--ä¿®å¤çª—å£ä½ç½®--åˆå§‹åŒ–æ— æ³•æ¢å¤ï¼ˆä¸€é—ªè€Œè¿‡çš„é—®é¢˜ï¼‰
    local defaultPos = [100, 100]
    --local g_ConfigPath = (getDir #scripts) + "\\FBX_ExporTools_UserPath.ini"
    local iniPath = (getDir #maxData) + "\\AutoExportTool_Pro.ini"
    
    -- æ£€æŸ¥INIæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»º
    if not doesFileExist iniPath do (
        makeDir (getFilenamePath iniPath) all:true  -- ç¡®ä¿ç›®å½•å­˜åœ¨
        setIniSetting iniPath "Settings" "LastPos" (defaultPos as string)  -- å†™å…¥é»˜è®¤å€¼
    )
    
    -- è¯»å–ä½ç½®ä¿¡æ¯å¹¶éªŒè¯
    try (
        local posStr = getIniSetting g_WindowPosPath "WindowSettings" "LastPos"
        if posStr != "" do (
            local pos = execute ("(" + posStr + ")")
            if classOf pos == Point2 do (
                SetDialogPos AutoExportTool_Pro pos
                format "[ä¿¡æ¯] å·²æ¢å¤çª—å£ä½ç½®ï¼š%\n" pos
            )
        )
    ) catch (
        format "[è­¦å‘Š] åŠ è½½çª—å£ä½ç½®å¤±è´¥ï¼š%\n" (getCurrentException())
        
        SetDialogPos AutoExportTool_Pro defaultPos  -- å›é€€åˆ°é»˜è®¤ä½ç½®
        setIniSetting iniPath "Settings" "LastPos" (defaultPos as string)  -- ä¿®å¤INIæ–‡ä»¶
		)
	
        --æ—¥æœŸæ—¶é—´æ˜¾ç¤º--å¹´/æœˆ/æ˜ŸæœŸ/æ—¶ï¼Œåˆ†ï¼Œç§’ 
	try (
            fnRefreshDate()  -- åˆå§‹æ˜¾ç¤º
        -- æ·»åŠ å®šæ—¶åˆ·æ–°ï¼ˆæ¯ç§’æ›´æ–°ï¼‰----------------------------------------
        global refreshTimer = dotNetObject "System.Windows.Forms.Timer"
        refreshTimer.Interval = 1000
        dotNet.addEventHandler refreshTimer "Tick" fnRefreshDate
        refreshTimer.Start()
        ) catch (
            lblDateTime.text = "æ—¶é—´æ¨¡å—åˆå§‹åŒ–å¤±è´¥"
		  )   
        -- åˆå§‹åŒ–è‡ªåŠ¨ä¿å­˜ç›‘æ§
    try (
        g_autoSaveWatcher = dotNetObject "System.IO.FileSystemWatcher"
        g_autoSaveWatcher.Path = g_autoSavePath
        g_autoSaveWatcher.Filter = "*.max"
        g_autoSaveWatcher.EnableRaisingEvents = true
        
        -- æ–‡ä»¶åˆ›å»ºäº‹ä»¶å¤„ç†
        dotNet.addEventHandler g_autoSaveWatcher "Created" (fn s e = (
            -- å»¶è¿Ÿç¡®ä¿æ–‡ä»¶å†™å…¥å®Œæˆ / false 
            --dotNet.invokeMethod (dotnetclass "System.Threading.Thread") "Sleep" 1000
            --dotNetClass "System.Threading.Thread").Sleep(1000)
            dotNet.invokeMethod (dotNetClass "System.Threading.Thread") "Sleep" #(1000)
            -- æ·»åŠ åˆ°åˆ—è¡¨
            if doesFileExist e.FullPath do (
                additem_lv Lv_model e.FullPath
            )
        ))
    ) catch (
        format "[é”™è¯¯] è‡ªåŠ¨ä¿å­˜ç›‘æ§åˆå§‹åŒ–å¤±è´¥: %\n" (getCurrentException())
    )
        
        -- å¼ºåˆ¶åˆå§‹åŒ–å…³é”®å˜é‡
        model_files_array = #()  -- æ¸…ç©ºæ–‡ä»¶æ•°ç»„
        edtExportPath.text = getDir #scene  -- é‡ç½®ä¸ºæœ‰æ•ˆè·¯å¾„
        g_showRecentFiles = false  -- ç¡®ä¿åˆå§‹ä¸ºæ™®é€šæ¨¡å¼
        -- å¼ºåˆ¶è®¾ç½®åˆå§‹æ»šåŠ¨æ¨¡å¼
        --Lv_model.HorizontalScrollable = false -- æ˜¾å¼ç¦ç”¨æ°´å¹³æ»šåŠ¨
        Lv_model.Scrollable = false
        Lv_model.Scrollable = true -- å…è®¸å‚ç›´æ»šåŠ¨
        start_Lv_model()            -- ex file list å¯¼å‡ºåˆ—è¡¨ / é»˜è®¤ é€šç”¨ListView / åˆ—è¡¨åˆ·æ–°
        initLvModel()                -- é»˜è®¤ é€šç”¨ListView / â€‹åˆ—å®šä¹‰ä¸é…ç½® / â€‹â€‹åˆå§‹åŒ– ListViewï¼ˆåˆ—è¡¨è§†å›¾ï¼‰æ•°æ®æ¨¡å‹â€‹â€‹ çš„å‡½æ•°ï¼Œä¸»è¦å¤„ç† â€‹â€‹æ•°æ®åŠ è½½ã€æ ¼å¼è½¬æ¢â€‹â€‹ å’Œ â€‹â€‹UI ç»‘å®šâ€‹â€‹
	    -- å¸¦å®‰å…¨æ£€æŸ¥çš„åˆ—å®½è°ƒæ•´
        if Lv_model.Columns.count >= 3 do (
            adjustColumnWidths forceCustom:g_forceCustomLayout
        )
        
        -- å¼ºåˆ¶åº”ç”¨å­—ä½“çŠ¶æ€
        Lv_model.Font = if chkChangeFont.checked then g_alternateFont else g_defaultFont
        
        initlvHeader()
        lvHeader.Columns.Item[2].Width = if chkChangeFont.checked then 145 else 125
		--lvHeader.Columns.Item[2].Width = 125 -- ç›´æ¥è®¾ç½®ç±»å‹åˆ—å®½
		initModeStatus()
        lblCount.text = "æ–‡ä»¶ï¼š0"  -- å¼ºåˆ¶åˆå§‹ä¸º0
        
        updateModeStatus()  -- æ›´æ–° äº‹ä»¶ ACT ''æ³¨é‡Š'' / åˆ—è¡¨æ–‡ä»¶ä½ç½®åç§° / æ–‡ä»¶è®¡æ•° = çŠ¶æ€æ 
        
        -- å¼ºåˆ¶åˆ›å»ºåˆå§‹çŠ¶æ€é¡¹
        if ModeStatus.Items.Count == 0 do (
        local li = dotNetObject "System.Windows.Forms.ListViewItem" "åˆå§‹åŒ–..."
        li.SubItems.Add("")
        li.SubItems.Add("æ–‡ä»¶ï¼š0")
        ModeStatus.Items.Add li
        ModeStatus.Refresh()
        )
        
        isValidScene()             --  æ’ä»¶åˆå§‹åŒ–æ—¶æ£€æŸ¥åœºæ™¯åŸºç¡€æ¡ä»¶/æ‰¹é‡å¤„ç†å‰çš„å®‰å…¨éªŒè¯/è‡ªåŠ¨ä¿å­˜å‰çš„çŠ¶æ€æ£€æŸ¥/åœºæ™¯å¯¼å…¥;å¯¼å‡ºå‰çš„åˆè§„æ€§æ£€æµ‹
        
        initPluginSystem()         --  checkbox å‹¾é€‰ç›’å­
        
        updateButtonLayout()       -- ListView è‡ªé€‚åº”/å®½é«˜
        
        updateExportPath()         --  å¯¼å‡º/ä¿å­˜è·¯å¾„
        checkAndRecoverPlugin()    -- æ¢å¤ å¤‡ä»½è·¯å¾„
        createBackup()             --  æ‹–å…¥å¹¶åŒæ—¶å¤‡ä»½ä¸»æ’ä»¶åˆ°ä¸€ä¸ªå¤‡ä»½ç›®å½•åœ°å€/åŠŸèƒ½/é˜²æ­¢ æ‹–å…¥ ä½ç½®æ„å¤– åˆ é™¤ å·¥å…·æ  æ‰“å¼€ ä¸»æ’ä»¶ æ— æ³•è¯»å–çš„æƒ…å†µ 
        savePluginPath()           -- è®°å½• æ’ä»¶é»˜è®¤ æ‰“å¼€ - ï¼ˆæ’ä»¶æ–‡ä»¶ä½ç½® ï¼‰          
        
        initAutoStartSetting()     -- è·ŸéšMAX è‡ªå¯ è®¾ç½®   -  ï¼ˆæ£€æµ‹ è®°å½•è¯»å– è‡ªå¯ å‹¾é€‰çŠ¶æ€ï¼‰
        initToolbarSetting()       -- å¤–éƒ¨ å·¥å…·æ  MAX èœå•  -  ï¼ˆæ£€æµ‹æ˜¯å¦ æ·»åŠ  å·¥å…·æ  - è”åŠ¨ ä¸»æ’ä»¶ å·¥å…·æ æ·»åŠ çŠ¶æ€ï¼‰
        --é¦–æ¬¡æ·»åŠ  å·¥å…·æ  /æ£€æµ‹/è®°å½•/è¯»å–
        autoAddToolbarOnFirstRun() 
        --åˆ·æ–° é€‰æ‹©é›†
        GetSetFormScene()
        --åˆ·æ–° æ—¥æœŸ
        fnRefreshDate ()
        
        pbProgress.style = (dotNetClass "System.Windows.Forms.ProgressBarStyle").Continuous  --  è¿›åº¦æ¡dotNet-UIæ§ä»¶
        
        -- åˆ—è¡¨ä¸»æ›´æ–°/åˆ·æ–°
        refreshFileListView()
        setupFileOpenCallback()
        -- é¢„åŠ è½½æœ€è¿‘æ–‡ä»¶åˆ—è¡¨
        loadRecentFilesFromXML()
        initAutoSaveWatcher() -- ç¡®ä¿åœ¨openäº‹ä»¶ä¸­åˆå§‹åŒ–ç›‘æ§
        format "[æœ€è¿‘æ–‡ä»¶åˆå§‹åŒ–] é¢„åŠ è½½æœ€è¿‘æ–‡ä»¶æ•°ï¼š%\n" g_recentFiles.count
        -- è°ƒç”¨æ–‡ä»¶å±æ€§åˆå§‹åŒ–
        setupContextMenu()
        -- åˆå§‹åŒ–é”®ç›˜äº‹ä»¶ / false ï¼ˆæœªå®ç°å‚æ•°ï¼‰
        --initKeyboardEvents()
        -- åŒé‡éªŒè¯å¤é€‰æ¡†çŠ¶æ€
        if chkChangeFont.checked do (
        Lv_model.Font = g_alternateFont
        adjustColumnWidths forceCustom:true
        )

        format "[åˆå§‹åŒ–] ç•Œé¢åŠ è½½å®Œæˆ.\n"
	)

)


-- åˆ›å»ºæ’ä»¶ä¸»çª—å£ /  æ— è¾¹æ¡† æ˜¾ç¤º æ¨¡å¼ / å¢åŠ  catch é˜²å¾¡æ€§ / åˆ›å»º æ’ä»¶èœå•UI ä¸»æ¡†æ¶ / MainScript createDialog  AutoExportTool_Pro 
-- è·å–3ds Maxç‰ˆæœ¬ä¿¡æ¯ (é’ˆå¯¹3ds Max 2014çš„ç‰¹å®šè¡Œä¸ºï¼ŒåŒæ—¶ä¿æŒå…¶ä»–ç‰ˆæœ¬çš„ç¨³å®šæ€§ï¼Œè§„é¿å¼‚å¸¸å¼¹çª—msboxæ”¹ä¸ºfomat)
maxVersionInfo = maxVersion()
maxMajorVersion = maxVersionInfo[1]  -- ä¸»ç‰ˆæœ¬å·

if maxMajorVersion == 16 then (  -- 16å¯¹åº”3ds Max 2014
    -- 2014ç‰ˆæœ¬ç›´æ¥åˆ›å»ºå¯¹è¯æ¡†
    createDialog AutoExportTool_Pro style:#() modal:false
) else (
    -- å…¶ä»–ç‰ˆæœ¬ä½¿ç”¨å¸¦é”™è¯¯å¤„ç†çš„åˆ›å»ºæ–¹å¼
    try (
        createDialog AutoExportTool_Pro style:#() modal:false
    ) catch (
        format "åˆ›å»ºå¯¹è¯æ¡†æ—¶å‡ºé”™ï¼Œè¯·æ£€æŸ¥è„šæœ¬!(max2014ç¯å¢ƒå¼€å¯æ’ä»¶è™šå‡å‡ºé”™ï¼Œåªè¦æ’ä»¶ç•Œé¢æ­£å¸¸æ˜¾ç¤ºå°±æ— éœ€ç†ä¼š...)"
    )
)